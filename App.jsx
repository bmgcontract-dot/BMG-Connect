import React, { useState, useEffect, useRef } from 'react';
import { 
  Users, Building2, BarChart3, Settings, LogOut, 
  Plus, Search, FileText, Download, Trash2, Edit, 
  CheckCircle, AlertTriangle, Wrench, Calendar, 
  ClipboardList, Droplet, Zap, Shield, 
  Clock, ArrowRight, ClipboardCheck,
  Briefcase, Globe, Printer, Loader2, X, Upload, User, CheckSquare, Square,
  XCircle, Image as ImageIcon, File, Hourglass, Phone, Mail, LayoutGrid, List, ChevronDown, Save,
  ChevronLeft, ChevronRight, MousePointer2, FileCheck, DollarSign, Camera,
  MapPin, Box, PenTool, Printer as PrinterIcon, History, Folder, Lock,
  Eye, EyeOff, Hammer, Layers, Link as LinkIcon, Sun, Moon, Heart, Cloud, Unlock, BookOpen, Info, HelpCircle, Maximize2
} from 'lucide-react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer,
  PieChart, Pie, Cell, LineChart, Line
} from 'recharts';

import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

// --- Firebase Initialization ---
// üî¥üî¥üî¥ ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ Deploy ‡∏ö‡∏ô GitHub Pages üî¥üî¥üî¥
// ‡πÉ‡∏´‡πâ‡∏ô‡∏≥ Config ‡∏à‡∏≤‡∏Å Firebase Project ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏ß‡πâ) ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
// ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ // ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÑ‡∏õ
const userFirebaseConfig = {
 
  apiKey: "AIzaSyAy03rxniCLFDYT4ztY_Ry2zh0ddzdBoPE",
  authDomain: "bmg-connect-3e99a.firebaseapp.com",
  projectId: "bmg-connect-3e99a",
  storageBucket: "bmg-connect-3e99a.firebasestorage.app",
  messagingSenderId: "707276998308",
  appId: "1:707276998308:web:1a5364f7a94cfe06c08831",
  measurementId: "G-4B69L2731M"
};

let app, auth, db, appId;
try {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏±‡∏ô‡∏ö‡∏ô Server ‡∏à‡∏£‡∏¥‡∏á
  if (typeof __firebase_config !== 'undefined' && __firebase_config !== '{}') {
    const firebaseConfig = JSON.parse(__firebase_config);
    app = initializeApp(firebaseConfig);
    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  } else if (Object.keys(userFirebaseConfig).length > 0) {
    // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô GitHub Pages
    app = initializeApp(userFirebaseConfig);
    appId = 'bmg-production-app'; // ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  } else {
    console.warn("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ userFirebaseConfig: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠");
  }

  if (app) {
      auth = getAuth(app);
      db = getFirestore(app);
  }
} catch (e) {
  console.error("Firebase init failed", e);
}

// --- Configuration & Constants ---
const THEME = {
  primary: '#FF4D00', // Red-Orange
  secondary: '#FF7A00',
  bg: '#F3F4F6',
  sidebar: '#1F2937',
  text: '#111827'
};

const PROJECT_TYPES = ['Condo', 'Village', 'Office Building'];
const PROJECT_TYPE_CODES = {
  'Condo': 'C',
  'Village': 'V',
  'Office Building': 'O'
};

const EMPLOYEE_POSITIONS = [
  "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Area Manager)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR Officer)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏° (Engineering Officer)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (QC Officer)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢ Support (Support Officer)",
  "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Building Manager)",
  "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô (Village Manager)",
  "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Assistant Manager)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Building Officer)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Finance Officer)",
  "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£ (Admin Officer)",
  "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Chief Technician)",
  "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á (Assistant Chief Technician)",
  "‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (Technician)",
  "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏) / Other (Please specify)"
];

// Contract Types & Services
const CONTRACT_TYPES = {
  INCOME: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏ö (Income)',
  EXPENSE: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πà‡∏≤‡∏¢ (Expense)',
  CONTRACTOR: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ (Contractor)'
};

const SERVICE_TYPES = {
  [CONTRACT_TYPES.EXPENSE]: [
    '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Management)',
    '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Security)',
    '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Cleaning)',
    '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏ß‡∏ô (Gardening)',
    '‡∏á‡∏≤‡∏ô‡∏Å‡∏ß‡∏≤‡∏î‡∏ñ‡∏ô‡∏ô (Road Sweeping)',
    '‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå (Elevator Maintenance)',
    '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢ (Insurance)',
    '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á (Pest Control)',
    '‡∏™‡∏π‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏è‡∏¥‡∏Å‡∏π‡∏• (Septic Tank Cleaning)',
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)'
  ],
  [CONTRACT_TYPES.INCOME]: [
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏π‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï (Internet Cabinet)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏π‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Signal Cabinet)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏ú‡πâ‡∏≤ (Washing Machine)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç (Water Vending Machine)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏à‡∏≠‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ (Advertising Screen)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏π‡πâ ATM (ATM Cabinet)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏™‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ (Communication Tower)',
    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Common Area)',
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ)'
  ],
  [CONTRACT_TYPES.CONTRACTOR]: [
    '‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Transformer)',
    '‡∏ï‡∏π‡πâ MDB / DB / Load Center',
    '‡∏™‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ / ‡∏™‡∏≤‡∏¢‡∏î‡∏¥‡∏ô / Grounding',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Lighting)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô-‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ü‡πâ‡∏≤‡∏ú‡πà‡∏≤ (Lightning Protection)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏£‡∏±‡πà‡∏ß (ELCB / RCCB)',
    '‡∏£‡∏∞‡∏ö‡∏ö ATS (Automatic Transfer Switch)',
    '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Generator)',
    '‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á (Battery Bank)',
    '‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Generator',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏µ (Booster Pump)',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏¥‡∏ö',
    '‡∏ñ‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏ö‡∏ô‡∏î‡∏¥‡∏ô / ‡πÉ‡∏ï‡πâ‡∏î‡∏¥‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏ß‡∏≤‡∏•‡πå‡∏ß / ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥',
    'Float Valve / Level Sensor',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢ / ‡∏õ‡∏±‡πä‡∏°‡∏ö‡πà‡∏≠‡∏î‡∏±‡∏Å‡πÑ‡∏Ç‡∏°‡∏±‡∏ô',
    '‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢ (STP / Septic Tank)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏î‡∏±‡∏Å‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (Grease Trap)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏û‡∏±‡∏Å (Manhole)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î',
    'Chiller / VRF / Split Type',
    'Cooling Tower',
    'AHU / FCU',
    'Blower / Exhaust Fan',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏•‡∏° / Duct',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Thermostat / Control Panel)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏£‡∏ñ',
    'Fire Pump / Jockey Pump',
    '‡∏ñ‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á',
    'Fire Alarm System',
    'Smoke Detector / Heat Detector',
    'Manual Call Point',
    'Fire Hose Cabinet',
    'Sprinkler System',
    'Fire Extinguisher',
    '‡∏£‡∏∞‡∏ö‡∏ö Fire Command Center',
    '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£',
    '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
    '‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)',
    '‡∏£‡∏∞‡∏ö‡∏ö Emergency Lift',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏•‡∏¥‡∏ü‡∏ï‡πå',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå',
    'CCTV',
    'Access Control',
    'Key Card / Bluetooth System',
    'Intercom',
    'Visitor Management System',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Barrier Gate)',
    'License Plate Recognition (LPR)',
    'Network System',
    'Server / NVR',
    '‡∏£‡∏∞‡∏ö‡∏ö Smart Building',
    '‡∏£‡∏∞‡∏ö‡∏ö BMS (Building Management System)',
    'IoT Sensor',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏û‡∏∏ / ‡∏ô‡πâ‡∏≥‡∏ï‡∏Å',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏ô‡∏≤‡∏°',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ñ‡∏ô‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏ß‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏ö‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå / ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô',
    'Solar Cell System',
    'EV Charger',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (EMS)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Ç‡∏¢‡∏∞',
    '‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞ / ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏Ç‡∏¢‡∏∞',
    '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
    '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡∏µ‡πÑ‡∏ü',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ï‡∏π',
    '‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤ / ‡∏Å‡∏±‡∏ô‡∏ã‡∏∂‡∏°',
    '‡∏£‡∏∞‡∏ö‡∏ö Drainage',
    'Expansion Joint',
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)'
  ]
};

// Machine Systems for PM
const MACHINE_SYSTEMS = [
    '‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Transformer)',
    '‡∏ï‡∏π‡πâ MDB / DB / Load Center',
    '‡∏™‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ / ‡∏™‡∏≤‡∏¢‡∏î‡∏¥‡∏ô / Grounding',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Emergency Lighting)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô-‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ü‡πâ‡∏≤‡∏ú‡πà‡∏≤ (Lightning Protection)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏£‡∏±‡πà‡∏ß (ELCB / RCCB)',
    '‡∏£‡∏∞‡∏ö‡∏ö ATS (Automatic Transfer Switch)',
    '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Generator)',
    '‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á (Battery Bank)',
    '‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Generator',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏µ (Booster Pump)',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏¥‡∏ö',
    '‡∏ñ‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏ö‡∏ô‡∏î‡∏¥‡∏ô / ‡πÉ‡∏ï‡πâ‡∏î‡∏¥‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏ß‡∏≤‡∏•‡πå‡∏ß / ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥',
    'Float Valve / Level Sensor',
    '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢ / ‡∏õ‡∏±‡πä‡∏°‡∏ö‡πà‡∏≠‡∏î‡∏±‡∏Å‡πÑ‡∏Ç‡∏°‡∏±‡∏ô',
    '‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢ (STP / Septic Tank)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏î‡∏±‡∏Å‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (Grease Trap)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏û‡∏±‡∏Å (Manhole)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ö‡πà‡∏≠‡∏ö‡∏≥‡∏ö‡∏±‡∏î',
    'Chiller / VRF / Split Type',
    'Cooling Tower',
    'AHU / FCU',
    'Blower / Exhaust Fan',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡πà‡∏≠‡∏•‡∏° / Duct',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Thermostat / Control Panel)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏•‡∏≤‡∏ô‡∏à‡∏≠‡∏î‡∏£‡∏ñ',
    'Fire Pump / Jockey Pump',
    '‡∏ñ‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á',
    'Fire Alarm System',
    'Smoke Detector / Heat Detector',
    'Manual Call Point',
    'Fire Hose Cabinet',
    'Sprinkler System',
    'Fire Extinguisher',
    '‡∏£‡∏∞‡∏ö‡∏ö Fire Command Center',
    '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£',
    '‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
    '‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)',
    '‡∏£‡∏∞‡∏ö‡∏ö Emergency Lift',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏•‡∏¥‡∏ü‡∏ï‡πå',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå',
    'CCTV',
    'Access Control',
    'Key Card / Bluetooth System',
    'Intercom',
    'Visitor Management System',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Barrier Gate)',
    'License Plate Recognition (LPR)',
    'Network System',
    'Server / NVR',
    '‡∏£‡∏∞‡∏ö‡∏ö Smart Building',
    '‡∏£‡∏∞‡∏ö‡∏ö BMS (Building Management System)',
    'IoT Sensor',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥‡∏û‡∏∏ / ‡∏ô‡πâ‡∏≥‡∏ï‡∏Å',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏ô‡∏≤‡∏°',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ñ‡∏ô‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏™‡∏ß‡∏ô',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏ö‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå / ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô',
    'Solar Cell System',
    'EV Charger',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (EMS)',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Ç‡∏¢‡∏∞',
    '‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞ / ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏Ç‡∏¢‡∏∞',
    '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
    '‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡∏µ‡πÑ‡∏ü',
    '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ï‡∏π',
    '‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤ / ‡∏Å‡∏±‡∏ô‡∏ã‡∏∂‡∏°',
    '‡∏£‡∏∞‡∏ö‡∏ö Drainage',
    'Expansion Joint',
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)'
];

const AUDIT_FORM_TEMPLATE = [
    { title: '1. ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£', items: ['‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö', '‡∏´‡πâ‡∏≠‡∏¢‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô', '‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏™‡∏µ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö', '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏´‡∏∏‡πâ‡∏°‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏™‡∏∏‡∏†‡∏≤‡∏û', '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'] },
    { title: '2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢', items: ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', '‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡πà‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô'] },
    { title: '3. ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏î‡∏£‡∏ñ/‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å', items: ['‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡∏•‡∏π‡∏ó‡∏π‡∏ò‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏ï‡πä‡∏≠‡∏Å', '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', '‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å-‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'] },
    { title: '4. ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á', items: ['‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü', '‡∏ñ‡∏∏‡∏á‡∏Ç‡∏¢‡∏∞‡∏î‡∏≥', '‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà', '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö'] },
    { title: '5. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á', items: ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö', '‡∏°‡∏µ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠', '‡∏°‡∏µ‡πÅ‡∏ú‡∏ô PM ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠'] },
    { title: '6. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• / ‡∏´‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á / ‡∏™‡πÇ‡∏°‡∏™‡∏£ / ‡∏õ‡πâ‡∏≠‡∏° ‡∏£‡∏õ‡∏†.', items: ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà'] },
    { title: '7. ‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå', items: ['‡∏õ‡∏¥‡∏î‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô', '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏¢‡πÉ‡∏ô update ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô/‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢'] },
    { title: '8. ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Debt Collection)', items: ['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ (Target: 3%=1, 5%=2, 7%=3, 10%=4, >10%=5)', '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Aging Report)', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ (Call Log/Letter)', '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢/‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'] },
    { title: '9. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Application (App Adoption)', items: ['‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Target: >80%=5, >60%=4, >40%=3)', '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active Users) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°/‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°, ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô, ‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏)', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Profile Completeness)', '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Support)'] },
    { title: '10. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Readiness)', items: ['‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'] }
];

// Standard Forms Data
const STANDARD_FORMS = [
    // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)
    { id: 'f1', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô (Move-In Request Form)', format: 'PDF', size: '120 KB', lastUpdated: '2025-01-15', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Used for residents who wish to bring large items or furniture into the premises. Must be submitted at least 3 working days in advance.)' },
    { id: 'f2', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô (Move-Out Request Form)', format: 'PDF', size: '120 KB', lastUpdated: '2025-01-15', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Used for residents who wish to move out or remove large items. Approval is required to prevent property loss.)' },
    { id: 'f3', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (Sticker Request Form)', format: 'PDF', size: '100 KB', lastUpdated: '2025-02-01', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (Used for residents to request annual parking stickers for cars or motorcycles.)' },
    { id: 'f4', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå/‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (Vehicle Registration Form)', format: 'PDF', size: '110 KB', lastUpdated: '2024-11-20', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Used to register residents\' vehicles in the Juristic Person\'s database.)' },
    { id: 'f5', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î/‡∏ö‡∏•‡∏π‡∏ó‡∏π‡∏ò (Keycard/Bluetooth Purchase Form)', format: 'PDF', size: '95 KB', lastUpdated: '2025-01-10', description: '‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ (Used when residents need to purchase additional access cards/Bluetooth devices or replace lost/damaged ones.)' },
    { id: 'f6', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ù‡∏≤‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à (Key Deposit Form)', format: 'PDF', size: '85 KB', lastUpdated: '2024-10-05', description: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å/‡∏ö‡πâ‡∏≤‡∏ô ‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Consent form to deposit house/room keys with the Juristic Person or security guards.)' },
    { id: 'f7', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à (Key Return Request Form)', format: 'PDF', size: '85 KB', lastUpdated: '2024-10-05', description: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ô‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å/‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Form acknowledging the return of house/room keys from the Juristic Person.)' },

    // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maintenance)
    { id: 'f8', category: '‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° (Renovation Request Form)', format: 'PDF', size: '150 KB', lastUpdated: '2025-02-10', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å/‡∏ö‡πâ‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Used for co-owners planning to renovate or repair their units. Requires attached floor plans and a security deposit.)' },
    { id: 'f9', category: '‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Work Permit)', format: 'PDF', size: '140 KB', lastUpdated: '2025-02-10', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (Used for external contractors to request area access, including details of the workers.)' },
    { id: 'f10', category: '‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair Request Form)', format: 'PDF', size: '130 KB', lastUpdated: '2025-01-20', description: '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Form to report issues or request repairs for common property or private units.)' },
    { id: 'f17', category: '‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á (Renovation Deposit Refund Form)', format: 'PDF', size: '115 KB', lastUpdated: '2026-02-22', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß (Used to request a refund of the renovation deposit after work completion and inspection.)' },

    // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Management)
    { id: 'f11', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Complaint Form)', format: 'PDF', size: '105 KB', lastUpdated: '2024-12-01', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Used to submit general complaints, suggestions, or report issues to the management team for resolution.)' },
    { id: 'f12', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î (CCTV Footage Request Form)', format: 'PDF', size: '160 KB', lastUpdated: '2025-01-25', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏î‡∏π‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏î‡∏π (Used to request CCTV footage playback. Requires a police report as supporting evidence.)' },
    { id: 'f13', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏±‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Document Request Form)', format: 'PDF', size: '115 KB', lastUpdated: '2024-09-15', description: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡∏Ø‡∏•‡∏Ø (Form for residents requesting copies of official documents such as meeting minutes, receipts, etc.)' },
    { id: 'f16', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Installment Payment Request Form)', format: 'PDF', size: '110 KB', lastUpdated: '2026-02-22', description: '‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (Used for co-owners requesting an installment plan for overdue common area fees.)' },

    // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal HR / Finance) - ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏Ø
    { id: 'f14', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal)', name: '‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô / ‡∏•‡∏≤‡∏Å‡∏¥‡∏à / ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (Leave Request)', format: 'PDF', size: '120 KB', lastUpdated: '2025-01-05', description: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Leave request form for annual, personal, or sick leave for employees and site staff.)' },
    { id: 'f15', category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal)', name: '‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢ (Petty Cash Voucher)', format: 'Excel', size: '45 KB', lastUpdated: '2025-01-05', description: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏î‡∏£‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Form for requesting petty cash reimbursement or advance payments for site operations.)' },
];

// Shift Codes
const SHIFTS = [
  { id: 'M1', label_th: 'M1 - ‡∏ú‡∏•‡∏±‡∏î‡πÄ‡∏ä‡πâ‡∏≤ (08.00-17.00)', label_en: 'M1 - Morning (08.00-17.00)', time: '08:00 - 17:00', color: 'bg-green-50 text-green-700 border-green-200' },
  { id: 'M2', label_th: 'M2 - ‡∏ú‡∏•‡∏±‡∏î‡πÄ‡∏ä‡πâ‡∏≤ (08.30-17.30)', label_en: 'M2 - Morning (08.30-17.30)', time: '08:30 - 17:30', color: 'bg-green-50 text-green-700 border-green-200' },
  { id: 'M3', label_th: 'M3 - ‡∏ú‡∏•‡∏±‡∏î‡πÄ‡∏ä‡πâ‡∏≤ (09.00-18.00)', label_en: 'M3 - Morning (09.00-18.00)', time: '09:00 - 18:00', color: 'bg-green-50 text-green-700 border-green-200' },
  { id: 'M4', label_th: 'M4 - ‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ (10.00-19.00)', label_en: 'M4 - Day (10.00-19.00)', time: '10:00 - 19:00', color: 'bg-green-50 text-green-700 border-green-200' },
  { id: 'A', label_th: 'A - ‡∏ú‡∏•‡∏±‡∏î‡∏ö‡πà‡∏≤‡∏¢ (14.00-23.00)', label_en: 'A - Afternoon (14.00-23.00)', time: '14:00 - 23:00', color: 'bg-orange-50 text-orange-700 border-orange-200' },
  { id: 'N', label_th: 'N - ‡∏ú‡∏•‡∏±‡∏î‡∏î‡∏∂‡∏Å (23.00-08.00)', label_en: 'N - Night (23.00-08.00)', time: '23:00 - 08:00', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' },
  { id: 'O', label_th: 'O - ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', label_en: 'O - Weekly Off', time: '-', color: 'bg-gray-100 text-gray-600 border-gray-200' },
  { id: 'H', label_th: 'H - ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå', label_en: 'H - Public Holiday', time: '-', color: 'bg-red-50 text-red-700 border-red-200' },
  { id: 'V', label_th: 'V - ‡∏ß‡∏±‡∏ô‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', label_en: 'V - Vacation', time: '-', color: 'bg-blue-50 text-blue-700 border-blue-200' },
  { id: 'SE', label_th: 'SE - ‡∏≠‡∏ö‡∏£‡∏°/‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤', label_en: 'SE - Seminar', time: '08:00 - 17:00', color: 'bg-purple-50 text-purple-700 border-purple-200' },
  { id: 'BL', label_th: 'BL - ‡∏•‡∏≤‡∏Å‡∏¥‡∏à', label_en: 'BL - Business Leave', time: '-', color: 'bg-pink-50 text-pink-700 border-pink-200' },
  { id: 'S', label_th: 'S - ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', label_en: 'S - Sick Leave', time: '-', color: 'bg-red-50 text-red-800 border-red-200' },
  { id: 'BD', label_th: 'BD - ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î', label_en: 'BD - Birthday', time: '-', color: 'bg-teal-50 text-teal-700 border-teal-200' }
];

const AVAILABLE_MENUS = [
  { id: 'dashboard', label: 'menu_dashboard' },
  { id: 'users', label: 'menu_users' },
  { 
    id: 'projects', 
    label: 'menu_projects',
    submenus: [
        { id: 'proj_overview', label: 'tab_overview' },
        { id: 'proj_contracts', label: 'tab_contracts' },
        { id: 'proj_staff', label: 'tab_staff' },
        { id: 'proj_schedule', label: 'tab_schedule' },
        { id: 'proj_daily', label: 'tab_daily' },
        { id: 'proj_assets', label: 'tab_assets' },
        { id: 'proj_tools', label: 'tab_tools' },
        { id: 'proj_pm', label: 'tab_pm' },
        { id: 'proj_repair', label: 'tab_repair' },
        { id: 'proj_utilities', label: 'tab_utilities' },
        { id: 'proj_action', label: 'tab_action' },
        { id: 'proj_audit', label: 'tab_audit' },
        { id: 'proj_forms', label: 'tab_forms' },
        { id: 'proj_contractors', label: 'menu_contractors' },
        { id: 'proj_others', label: 'tab_others' }
    ]
  },
  { id: 'audits', label: 'menu_audits' },
  { id: 'manual', label: 'menu_manual' },
  { id: 'settings', label: 'menu_settings' }
];

const getDefaultPermissions = () => {
    const perms = {};
    AVAILABLE_MENUS.forEach(m => {
        perms[m.id] = { view: false, save: false, edit: false, approve: false, delete: false, print: false };
        if (m.submenus) {
            m.submenus.forEach(sub => {
                perms[sub.id] = { view: false, save: false, edit: false, approve: false, delete: false, print: false };
            });
        }
    });
    if (perms.dashboard) perms.dashboard.view = true;
    return perms;
};

const getFullPermissions = () => {
    const perms = {};
    AVAILABLE_MENUS.forEach(m => {
        perms[m.id] = { view: true, save: true, edit: true, approve: true, delete: true, print: true };
        if (m.submenus) {
            m.submenus.forEach(sub => {
                perms[sub.id] = { view: true, save: true, edit: true, approve: true, delete: true, print: true };
            });
        }
    });
    return perms;
};

const PROJECT_TABS = [
  { id: 'overview', label: 'tab_overview', icon: BarChart3 },
  { id: 'contracts', label: 'tab_contracts', icon: Briefcase },
  { id: 'staff', label: 'tab_staff', icon: Users },
  { id: 'schedule', label: 'tab_schedule', icon: Calendar },
  { id: 'daily', label: 'tab_daily', icon: FileText },
  { id: 'assets', label: 'tab_assets', icon: Shield },
  { id: 'tools', label: 'tab_tools', icon: Wrench },
  { id: 'pm', label: 'tab_pm', icon: Zap },
  { id: 'repair', label: 'tab_repair', icon: Hammer },
  { id: 'utilities', label: 'tab_utilities', icon: Droplet },
  { id: 'action', label: 'tab_action', icon: CheckCircle },
  { id: 'audit', label: 'tab_audit', icon: ClipboardCheck },
  { id: 'forms', label: 'tab_forms', icon: Folder },
  { id: 'contractors', label: 'menu_contractors', icon: Search },
  { id: 'others', label: 'tab_others', icon: Layers },
];

// --- Translation Dictionary ---
const TRANSLATIONS = {
  th: {
    // General
    appTitle: "‡πÄ‡∏ö‡∏™‡∏ó‡πå ‡∏°‡∏¥‡∏•‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏ô",
    appSubtitle: "‡∏Å‡∏£‡∏∏‡πä‡∏õ ‡∏à‡∏≥‡∏Å‡∏±‡∏î",
    systemMgmt: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£",
    signIn: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    username: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    password: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
    poweredBy: "Powered by Best Million Group IT",
    signOut: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
    myWorkspace: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",

    // Sidebar
    menu_dashboard: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£",
    menu_users: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    menu_projects: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    menu_audits: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Audit)",
    menu_contractors: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ supplier",
    menu_manual: "‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    menu_settings: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",

    // Dashboard
    corpDashboard: "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
    overview: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£",
    exportReport: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV",
    exportPDF: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF",
    totalProjects: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    totalEmployees: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
    pendingTasks: "‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    pmDue: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏£‡∏≠‡∏ö PM",
    projPerformance: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    taskDist: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",

    // Users
    userMgmt: "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    addUser: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    printPDF: "‡∏û‡∏¥‡∏°‡∏û‡πå/PDF",
    col_name: "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    col_role: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á",
    col_dept: "‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î",
    col_email: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    col_status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
    col_actions: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£",
    col_seq: "‡∏•‡∏≥‡∏î‡∏±‡∏ö",
    col_photo: "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
    col_empId: "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",

    // User Modal
    newUserTitle: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
    editUserTitle: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    uploadPhoto: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
    removePhoto: "‡∏•‡∏ö‡∏£‡∏π‡∏õ",
    empId: "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    firstName: "‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á",
    lastName: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    position: "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á",
    specifyOther: "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á",
    currentDept: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    accessibleDepts: "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ",
    selectDept: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô...",
    addDept: "‡πÄ‡∏û‡∏¥‡πà‡∏°",
    permissions: "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π",
    phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
    cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    loginInfo: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",
    personalInfo: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß",
    accessControl: "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå",

    // Projects
    projectList: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    newProject: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    manager: "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£",
    start: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
    // Project Modal
    newProjectTitle: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà",
    projLogo: "‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    uploadLogo: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ",
    projCode: "‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    projName: "‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    projType: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    projAddress: "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    officePhone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    taxId: "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ",
    contractStartDate: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    contractEndDate: "‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    daysRemaining: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    days: "‡∏ß‡∏±‡∏ô",
    uploadDocs: "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç",
    doc_orchor: "‡∏≠‡∏ä.13 / ‡∏à‡∏™.‡∏Å.10",
    doc_committee: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£",
    doc_regulations: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö",
    doc_resident_rules: "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢",
    tab_condo: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏∏‡∏î",
    tab_village: "‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£",
    tab_office: "‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",

    // Contractors
    contractorList: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supplier",
    managePartners: "‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å",
    addNew: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠",
    searchPlaceholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, ‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠...",
    filter: "‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    col_company: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó",
    col_type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó",
    col_category: "‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô",
    col_contact: "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠",
    col_phoneEmail: "‡πÇ‡∏ó‡∏£ / ‡∏≠‡∏µ‡πÄ‡∏°‡∏•",

    // Audit
    globalAudit: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)",
    auditDesc: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ Audit ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    newAudit: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à",
    auditPass: "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå (>90%)",
    auditConcern: "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (70-89%)",
    auditCritical: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (<70%)",
    col_date: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à",
    col_project: "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô",
    col_score: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
    col_inspector: "‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à",
    col_remarks: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏",
    col_file: "‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö",

    // Project Detail Tabs
    tab_overview: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°",
    tab_contracts: "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á",
    tab_staff: "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£",
    tab_schedule: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô",
    tab_daily: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
    tab_assets: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    tab_tools: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á",
    tab_pm: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/PM",
    tab_repair: "‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°",
    tab_utilities: "‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü",
    tab_action: "Action Plan",
    tab_audit: "Audit",
    tab_forms: "‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô",
    tab_others: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Others)",

    // Project Detail Content
    projectKPI: "KPI ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    recentAlerts: "‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
    activeContracts: "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà",
    addContract: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    col_vendor: "‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤",
    col_subject: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    col_duration: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    col_amount: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    projectStaff: "‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    addStaff: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
    col_phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
    workSchedule: "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
    createTask: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô",
    col_task: "‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô",
    col_assignee: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
    col_time: "‡πÄ‡∏ß‡∏•‡∏≤",
    dailyReports: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
    createReport: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
    col_details: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î",
    col_image: "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
    col_reporter: "‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
    regAssets: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    addAsset: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    col_assetName: "‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    col_assetCode: "‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    col_location: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á",
    col_serial: "Serial No.",
    col_value: "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤",
    toolsRegistry: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á",
    regTool: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á",
    col_toolName: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
    col_toolCode: "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠",
    col_qty: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
    col_condition: "‡∏™‡∏†‡∏≤‡∏û",
    col_responsible: "‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á",
    col_lastCheck: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
    machineryPM: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô PM",
    addMachine: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
    col_machineName: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
    col_machineCode: "‡∏£‡∏´‡∏±‡∏™",
    col_system: "‡∏£‡∏∞‡∏ö‡∏ö",
    col_model: "‡∏£‡∏∏‡πà‡∏ô",
    col_lastPM: "PM ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
    col_nextPM: "PM ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
    meterReadings: "‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü)",
    recordReading: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤",
    col_prev: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤",
    col_curr: "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô",
    col_usage: "‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ",
    col_recorder: "‡∏ú‡∏π‡πâ‡∏à‡∏î",
    consumptionTrend: "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    actionPlan: "Action Plan / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå",
    newReport: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á",
    col_issue: "‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠",
    col_solution: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
    col_deadline: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à",
    internalAudit: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Audit)",
    exportInfo: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV",
    exportCSV: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV",
    downloading: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...",
    col_shift: "‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
    col_shift_time: "‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô",
    col_note: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏",
    saveSuccess: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    close: "‡∏õ‡∏¥‡∏î",
    downloadPDF: "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF",
    
    // PM Tabs
    pm_registry: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
    pm_plan: "‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô",
    pm_calendar: "‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô",
    pm_form: "‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° PM",
    pm_history: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥",
    pm_registry_title: "‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine Registry)",
    pm_dashboard: "‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î",
    
    // PM Plan
    pm_plan_title: "‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (PM Plan)",
    addPmPlan: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô PM",
    pmTaskName: "‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ",
    pmFrequency: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Frequency)",
    freq_Daily: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Daily)",
    freq_Weekly: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (Weekly)",
    freq_Monthly: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly)",
    freq_Yearly: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (Yearly)",
    col_schedule: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£",

    // Statuses & Common
    active: "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    inactive: "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
    warning: "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô",
    good: "‡∏î‡∏µ",
    fair: "‡∏û‡∏≠‡πÉ‡∏ä‡πâ",
    normal: "‡∏õ‡∏Å‡∏ï‡∏¥",
    repair: "‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°",
    pending: "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    approved: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß",
    completed: "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",
    expiringSoon: "‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    expired: "‡∏´‡∏°‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    to: "‡∏ñ‡∏∂‡∏á",
    noData: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    reportHeader: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
    generatedOn: "‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠",
    contractType: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏±‡∏ç‡∏ç‡∏≤",
    contractCategory: "‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£",
    paymentCycle: "‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢",
    monthly: "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
    yearly: "‡∏£‡∏≤‡∏¢‡∏õ‡∏µ",
    beforeVat: "(‡∏Å‡πà‡∏≠‡∏ô VAT)",
    col_contact_person: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠",
    col_contact_phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    
    // Daily Report Translation
    dailyReportTitle: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
    manpowerReport: "1. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
    performanceReport: "2. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô",
    incomeReport: "3. ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
    additionalDetails: "4. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
    dept_juristic: "‡∏ù‡πà‡∏≤‡∏¢‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ø",
    dept_security: "‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
    dept_cleaning: "‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î",
    dept_gardening: "‡∏ù‡πà‡∏≤‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏ß‡∏ô",
    dept_sweeper: "‡∏Ñ‡∏ô‡∏Å‡∏ß‡∏≤‡∏î",
    dept_other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)",
    inc_commonFee: "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ",
    inc_lateFee: "‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤",
    inc_water: "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤",
    inc_parking: "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏ñ",
    inc_violation: "‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö",
    inc_other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏)",
    totalIncome: "‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô",
    reporter: "‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
    uploadImage: "‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
    createDailyReport: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
    
    // Asset Translation
    registerAsset: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô",
    assetDetails: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
  },
  en: {
    // ... (Keep existing English translations)
    appTitle: "BEST MILLION",
    appSubtitle: "GROUP CO., LTD.",
    systemMgmt: "System Management",
    signIn: "Sign In",
    username: "Username",
    password: "Password",
    poweredBy: "Powered by Best Million Group IT",
    signOut: "Sign Out",
    myWorkspace: "My Workspace",
    menu_dashboard: "Dashboard",
    menu_users: "User Management",
    menu_projects: "Projects / Units",
    menu_audits: "Internal Audit",
    menu_contractors: "Search Supplier",
    menu_manual: "User Manual",
    menu_settings: "Settings",
    corpDashboard: "Corporate Dashboard",
    overview: "Overview of organization performance",
    exportReport: "Export CSV",
    exportPDF: "Export PDF",
    totalProjects: "Total Projects",
    totalEmployees: "Total Employees",
    pendingTasks: "Pending Tasks",
    pmDue: "PM Due Soon",
    projPerformance: "Project Performance",
    taskDist: "Task Status Distribution",
    userMgmt: "User Management",
    addUser: "Add User",
    printPDF: "Export PDF",
    col_name: "Name",
    col_role: "Position",
    col_dept: "Department",
    col_email: "Email",
    col_status: "Status",
    col_actions: "Actions",
    col_seq: "No.",
    col_photo: "Photo",
    col_empId: "Employee ID",
    newUserTitle: "Add New User / Employee",
    editUserTitle: "Edit User / Employee",
    uploadPhoto: "Upload Photo",
    removePhoto: "Remove",
    empId: "Employee ID",
    firstName: "First Name",
    lastName: "Last Name",
    position: "Position",
    specifyOther: "Please specify position",
    currentDept: "Current Department / Unit",
    accessibleDepts: "Accessible Departments",
    selectDept: "Select Department...",
    addDept: "Add Dept",
    permissions: "Menu Permissions",
    phone: "Phone Number",
    save: "Save",
    cancel: "Cancel",
    loginInfo: "Login Information",
    personalInfo: "Personal Information",
    accessControl: "Access Control",
    projectList: "Projects & Units",
    newProject: "New Project",
    manager: "Manager",
    start: "Start",
    newProjectTitle: "Add New Project / Unit",
    projLogo: "Project Logo",
    uploadLogo: "Upload Logo",
    projCode: "Project Code",
    projName: "Project Name",
    projType: "Project Type",
    projAddress: "Address",
    officePhone: "Office Phone",
    taxId: "Tax ID",
    contractStartDate: "Contract Start Date",
    contractEndDate: "Contract End Date",
    daysRemaining: "Days Remaining",
    days: "Days",
    uploadDocs: "Project Documents",
    doc_orchor: "Or Chor 13 / Jor Sor Gor 10",
    doc_committee: "Committee Registration",
    doc_regulations: "Rules & Regulations",
    doc_resident_rules: "Residency Rules",
    tab_condo: "Condominium",
    tab_village: "Housing Estate",
    tab_office: "Office Building",
    contractorList: "Search Supplier",
    managePartners: "Manage external partners and service providers",
    addNew: "Add New",
    searchPlaceholder: "Search by Company Name, Category, or Contact Person...",
    filter: "Filter",
    col_company: "Company Name",
    col_type: "Type",
    col_category: "Category",
    col_contact: "Contact Person",
    col_phoneEmail: "Phone / Email",
    globalAudit: "Internal Audit (All Projects)",
    auditDesc: "Centralized audit records for all units",
    newAudit: "New Audit",
    auditPass: "Pass (>90%)",
    auditConcern: "Concern (70-89%)",
    auditCritical: "Critical (<70%)",
    col_date: "Date",
    col_project: "Project / Unit",
    col_score: "Score",
    col_inspector: "Inspector",
    col_remarks: "Remarks",
    col_file: "File",
    tab_overview: "Overview",
    tab_contracts: "Contracts",
    tab_staff: "Staff",
    tab_schedule: "Schedule",
    tab_daily: "Daily Report",
    tab_assets: "Assets",
    tab_tools: "Tools",
    tab_pm: "Machinery / PM",
    tab_repair: "Repair",
    tab_utilities: "Water/Fire",
    tab_action: "Action Plan",
    tab_audit: "Audit",
    tab_forms: "Standard Forms",
    tab_others: "Others",
    projectKPI: "Project KPI",
    recentAlerts: "Recent Alerts",
    activeContracts: "Active Contracts / Service Agreements",
    addContract: "Add Contract",
    col_vendor: "Vendor/Contractor",
    col_subject: "Service Type",
    col_duration: "Duration",
    col_amount: "Amount",
    projectStaff: "Project Staff",
    addStaff: "Add Staff",
    col_phone: "Phone",
    workSchedule: "Work Schedule",
    createTask: "Create Task",
    col_task: "Task",
    col_assignee: "Assignee",
    col_time: "Time",
    dailyReports: "Daily Reports",
    createReport: "Create Report",
    col_details: "Details",
    col_image: "Image",
    col_reporter: "Reporter",
    regAssets: "Registered Assets",
    addAsset: "Add Asset",
    col_assetName: "Asset Name",
    col_assetCode: "Asset Code",
    col_location: "Location",
    col_serial: "Serial No.",
    col_value: "Value",
    toolsRegistry: "Tools Registry",
    regTool: "Register Tool",
    col_toolName: "Tool/Machine Name",
    col_toolCode: "Tool Code",
    col_qty: "Qty",
    col_condition: "Condition",
    col_responsible: "Responsible",
    col_lastCheck: "Last Check",
    machineryPM: "Machinery & PM Schedule",
    addMachine: "Add Machine",
    col_machineName: "Machine Name",
    col_machineCode: "Code",
    col_system: "System",
    col_model: "Model",
    col_lastPM: "Last PM",
    col_nextPM: "Next PM",
    meterReadings: "Meter Readings (Water/Fire)",
    recordReading: "Record Reading",
    col_prev: "Prev",
    col_curr: "Curr",
    col_usage: "Usage",
    col_recorder: "Recorder",
    consumptionTrend: "Consumption Trend",
    actionPlan: "Action Plan / Incident Report",
    newReport: "New Report",
    col_issue: "Issue",
    col_solution: "Solution",
    col_deadline: "Deadline",
    internalAudit: "Internal Audit Records",
    exportInfo: "Export CSV",
    exportCSV: "Export CSV",
    downloading: "Downloading...",
    col_shift: "Shift",
    col_shift_time: "Time",
    col_note: "Note",
    saveSuccess: "Saved Successfully",
    close: "Close",
    active: "Active",
    inactive: "Inactive",
    warning: "Warning",
    good: "Good",
    fair: "Fair",
    normal: "Normal",
    repair: "Repair",
    pending: "Pending",
    approved: "Approved",
    completed: "Completed",
    expiringSoon: "Expiring Soon",
    expired: "Expired",
    to: "to",
    noData: "No data available.",
    reportHeader: "OFFICIAL REPORT",
    generatedOn: "Generated on",
    contractType: "Contract Type",
    contractCategory: "Service Type",
    paymentCycle: "Payment Cycle",
    monthly: "Monthly",
    yearly: "Yearly",
    beforeVat: "(Excl. VAT)",
    col_contact_person: "Contact Person",
    col_contact_phone: "Phone",
    dailyReportTitle: "Daily Report",
    manpowerReport: "1. Manpower Report",
    performanceReport: "2. Performance Report",
    incomeReport: "3. Income Summary",
    additionalDetails: "4. Additional Details",
    dept_juristic: "Juristic Person",
    dept_security: "Security Guard",
    dept_cleaning: "Cleaning",
    dept_gardening: "Gardening",
    dept_sweeper: "Road Sweeper",
    dept_other: "Other (Specify)",
    inc_commonFee: "Common Area Fee",
    inc_lateFee: "Late Payment Fee",
    inc_water: "Water Fee",
    inc_parking: "Parking Fee",
    inc_violation: "Violation Fee",
    inc_other: "Other (Specify)",
    totalIncome: "Total Daily Income",
    reporter: "Reporter",
    uploadImage: "Upload Image",
    createDailyReport: "Create Report",
    registerAsset: "Register Asset",
    assetDetails: "Additional Details",
    downloadPDF: "Download PDF",
    pm_dashboard: "Dashboard",
    pm_registry: "Registry",
    pm_plan: "Plan",
    pm_calendar: "Calendar",
    pm_form: "PM Form",
    pm_history: "History",
    pm_registry_title: "Machine Registry",
    pm_plan_title: "PM Plan",
    addPmPlan: "Add PM Plan",
    pmTaskName: "Task Name / Checklist",
    pmFrequency: "Frequency",
    freq_Daily: "Daily",
    freq_Weekly: "Weekly",
    freq_Monthly: "Monthly",
    freq_Yearly: "Yearly",
    col_schedule: "Schedule",
  }
};

// --- Mock Data Generator & Initial Data ---
const generateId = () => Math.random().toString(36).substr(2, 9);
const INITIAL_USERS = [ { id: 'u1', username: 'admin', password: 'bosskim', firstName: 'Admin', lastName: 'Master', position: 'Super Admin', department: 'Head Office', projectId: null, status: 'Active', created_at: new Date().toISOString(), permissions: getFullPermissions() }, { id: 'u2', username: 'manager1', password: '123', firstName: 'Somsak', lastName: 'Jai dee', position: 'Building Manager', department: 'The Privacy Condo', projectId: 'p1', status: 'Active', created_at: new Date().toISOString() }, { id: 'u3', username: 'staff1', password: '123', firstName: 'Wichai', lastName: 'Khonngan', position: 'Technician', department: 'The Privacy Condo', projectId: 'p1', status: 'Active', created_at: new Date().toISOString() }, { id: 'u4', username: 'tech1', password: '123', firstName: 'Manop', lastName: 'Chang', position: 'Technician', department: 'Golden Village', projectId: 'p2', status: 'Active', created_at: new Date().toISOString() }, ];
const INITIAL_PROJECTS = [ { id: 'p1', code: 'C-001', name: 'The Privacy Condo', type: 'Condo', address: 'Sukhumvit 101', phone: '02-111-2222', taxId: '1234567890123', contractStartDate: '2025-01-01', contractEndDate: '2025-12-31', contractValue: 150000, status: 'Active', logo: null }, { id: 'p2', code: 'V-001', name: 'Golden Village', type: 'Village', address: 'Bangna KM.7', phone: '02-333-4444', taxId: '9876543210987', contractStartDate: '2024-06-15', contractEndDate: '2026-06-14', contractValue: 85000, status: 'Active', logo: null }, ];
const INITIAL_CONTRACTS = [ { id: 'ct1', projectId: 'p1', type: CONTRACT_TYPES.EXPENSE, category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Security)', vendorName: 'SafeGuard Security Ltd.', contactPerson: 'Mr. Somchai', contactPhone: '081-111-2222', startDate: '2025-01-01', endDate: '2025-12-31', amount: 100000, paymentCycle: 'Monthly', status: 'Active', fileUrl: 'contract_sec_2025.pdf' }, { id: 'ct2', projectId: 'p1', type: CONTRACT_TYPES.EXPENSE, category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Cleaning)', vendorName: 'Clean & Clear Service Co.', contactPerson: 'Ms. Yupin', contactPhone: '089-222-3333', startDate: '2025-01-01', endDate: '2025-12-31', amount: 80000, paymentCycle: 'Monthly', status: 'Active', fileUrl: 'contract_clean_2025.pdf' }, { id: 'ct3', projectId: 'p1', type: CONTRACT_TYPES.EXPENSE, category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏ß‡∏ô (Gardening)', vendorName: 'Green Garden Supply', contactPerson: 'Mrs. Noi', contactPhone: '086-333-4444', startDate: '2024-06-01', endDate: '2025-05-31', amount: 30000, paymentCycle: 'Monthly', status: 'Expiring Soon', fileUrl: 'contract_garden.pdf' }, ];
const INITIAL_ASSETS = []; 
const INITIAL_MACHINES = [
    { id: 'm1', projectId: 'p1', code: 'BMG-M-001', name: 'Main Pump A', system: '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏µ (Booster Pump)', qty: 1, location: '‡∏ä‡∏±‡πâ‡∏ô‡∏î‡∏≤‡∏î‡∏ü‡πâ‡∏≤', photo: null },
    { id: 'm2', projectId: 'p1', code: 'BMG-M-002', name: 'Generator 500kVA', system: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Generator)', qty: 1, location: '‡∏´‡πâ‡∏≠‡∏á Generator', photo: null },
];
const INITIAL_PM_PLANS = [
    { id: 'pmp1', projectId: 'p1', machineId: 'm1', frequency: 'Monthly', scheduleDetails: { date: '5' }, status: 'Active' },
    { id: 'pmp2', projectId: 'p1', machineId: 'm2', frequency: 'Weekly', scheduleDetails: { dayOfWeek: '5' }, status: 'Active' }, // 5 = Friday
];
const INITIAL_PM_HISTORY = [];
const INITIAL_REPAIRS = [];
const INITIAL_OTHERS = [];

// NEW: Custom 3D Bar Shapes
const ThreeDBar = (props) => {
    const { fill, x, y, width, height } = props;
    const depth = 8;
    if (!height || height <= 0 || width <= 0) return null;
    
    return (
        <g style={{ filter: 'drop-shadow(3px 6px 5px rgba(0,0,0,0.25))' }}>
            <path d={`M${x},${y} L${x + depth},${y - depth} L${x + width + depth},${y - depth} L${x + width},${y} Z`} fill={fill} />
            <path d={`M${x},${y} L${x + depth},${y - depth} L${x + width + depth},${y - depth} L${x + width},${y} Z`} fill="#ffffff" fillOpacity={0.3} />
            <path d={`M${x + width},${y} L${x + width + depth},${y - depth} L${x + width + depth},${y + height - depth} L${x + width},${y + height} Z`} fill={fill} />
            <path d={`M${x + width},${y} L${x + width + depth},${y - depth} L${x + width + depth},${y + height - depth} L${x + width},${y + height} Z`} fill="#000000" fillOpacity={0.25} />
            <path d={`M${x},${y} L${x + width},${y} L${x + width},${y + height} L${x},${y + height} Z`} fill={fill} />
        </g>
    );
};

const ThreeDBarHorizontal = (props) => {
    const { fill, x, y, width, height } = props;
    const depth = 8;
    if (!width || width <= 0 || height <= 0) return null;

    return (
        <g style={{ filter: 'drop-shadow(3px 6px 5px rgba(0,0,0,0.25))' }}>
            <path d={`M${x},${y} L${x + depth},${y - depth} L${x + width + depth},${y - depth} L${x + width},${y} Z`} fill={fill} />
            <path d={`M${x},${y} L${x + depth},${y - depth} L${x + width + depth},${y - depth} L${x + width},${y} Z`} fill="#ffffff" fillOpacity={0.3} />
            <path d={`M${x + width},${y} L${x + width + depth},${y - depth} L${x + width + depth},${y + height - depth} L${x + width},${y + height} Z`} fill={fill} />
            <path d={`M${x + width},${y} L${x + width + depth},${y - depth} L${x + width + depth},${y + height - depth} L${x + width},${y + height} Z`} fill="#000000" fillOpacity={0.25} />
            <path d={`M${x},${y} L${x + width},${y} L${x + width},${y + height} L${x},${y + height} Z`} fill={fill} />
        </g>
    );
};

const ChartGradients = () => (
  <svg width="0" height="0" style={{ position: 'absolute', pointerEvents: 'none' }}>
    <defs>
      <linearGradient id="colorBlue" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#60a5fa" />
        <stop offset="100%" stopColor="#2563eb" />
      </linearGradient>
      <linearGradient id="colorGreen" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#34d399" />
        <stop offset="100%" stopColor="#059669" />
      </linearGradient>
      <linearGradient id="colorOrange" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#fbbf24" />
        <stop offset="100%" stopColor="#d97706" />
      </linearGradient>
      <linearGradient id="colorRed" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#f87171" />
        <stop offset="100%" stopColor="#dc2626" />
      </linearGradient>
      <linearGradient id="colorCyan" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#22d3ee" />
        <stop offset="100%" stopColor="#0891b2" />
      </linearGradient>
      <linearGradient id="colorPurple" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#a78bfa" />
        <stop offset="100%" stopColor="#7c3aed" />
      </linearGradient>
      <linearGradient id="colorGray" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stopColor="#9ca3af" />
        <stop offset="100%" stopColor="#4b5563" />
      </linearGradient>
      <linearGradient id="cylOrange" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stopColor="#fdba74" />
        <stop offset="50%" stopColor="#ea580c" />
        <stop offset="100%" stopColor="#c2410c" />
      </linearGradient>
      <linearGradient id="cylBlue" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stopColor="#93c5fd" />
        <stop offset="50%" stopColor="#2563eb" />
        <stop offset="100%" stopColor="#1d4ed8" />
      </linearGradient>
      <linearGradient id="cylGreen" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stopColor="#6ee7b7" />
        <stop offset="50%" stopColor="#059669" />
        <stop offset="100%" stopColor="#047857" />
      </linearGradient>
      <linearGradient id="cylGray" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%" stopColor="#d1d5db" />
        <stop offset="50%" stopColor="#4b5563" />
        <stop offset="100%" stopColor="#374151" />
      </linearGradient>
    </defs>
  </svg>
);

// NEW: Initial data for Company Profile
const INITIAL_COMPANY_INFO = {
    name: 'BM GROUP',
    subtitle: 'Enterprise ERP',
    logo: null,
    address: '99/9 ‡∏´‡∏°‡∏π‡πà 1 ‡∏ñ‡∏ô‡∏ô‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡∏ï‡∏£‡∏≤‡∏î ‡∏Å‡∏°.7 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡∏ß ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540',
    phone: '02-111-2222'
};

// NEW: Initial data for Utilities
const INITIAL_METERS = [
  { id: 'mt1', projectId: 'p1', code: 'W-01', name: '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ ‡πÄ‡∏°‡∏ô', type: 'Water', lastReading: 1250, lastDate: '2026-01-20' },
  { id: 'mt2', projectId: 'p1', code: 'E-01', name: '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡πÄ‡∏°‡∏ô', type: 'Electricity', lastReading: 55400, lastDate: '2026-01-20' },
];
const INITIAL_READINGS = [
    { id: 'rd1', meterId: 'mt1', date: '2026-01-20', value: 1250, prevValue: 1200, usage: 50, recorder: 'Admin Master' },
    { id: 'rd2', meterId: 'mt2', date: '2026-01-20', value: 55400, prevValue: 54000, usage: 1400, recorder: 'Admin Master' },
];

const INITIAL_DAILY_REPORTS = []; const INITIAL_AUDITS = [ { id: 'au1', projectId: 'p1', date: '2025-02-10', category: 'Safety Standards', score: 95, remarks: 'Excellent adherence to safety protocols.', inspector: 'Admin Master', fileUrl: 'audit_safety_feb.pdf' }, { id: 'au2', projectId: 'p1', date: '2025-02-10', category: 'Cleanliness', score: 78, remarks: 'Lobby area needs improved dusting.', inspector: 'Admin Master', fileUrl: 'audit_clean_feb.pdf' }, { id: 'au3', projectId: 'p2', date: '2025-02-12', category: 'Security Guards', score: 88, remarks: 'Guards are attentive but uniform needs check.', inspector: 'Admin Master', fileUrl: 'audit_sec_feb.pdf' }, ]; const INITIAL_TOOLS = []; const INITIAL_UTILITY_READINGS = []; const INITIAL_ACTION_PLANS = [ { id: 'ap1', projectId: 'p1', issue: 'Leaking pipe at 5th floor', details: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ã‡∏µ‡∏•‡∏¢‡∏≤‡∏á‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏ó‡∏¥‡πâ‡∏á', responsible: 'Wichai Khonngan (Technician)', startDate: '2025-02-10', deadline: '2025-02-15', status: 'Pending' }, { id: 'ap2', projectId: 'p1', issue: 'Security gate noise', details: '‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô‡∏ö‡∏≤‡∏ô‡∏û‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå', responsible: 'Manop Chang (Technician)', startDate: '2025-02-08', deadline: '2025-02-10', status: 'Completed' }, ]; const INITIAL_SCHEDULES = []; const INITIAL_CONTRACTORS = [ { id: 'c1', name: 'Clean & Clear Service Co.', type: 'Vendor', category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Cleaning)', contact: 'Ms. Yupin', phone: '081-555-6666', email: 'contact@clean.com', status: 'Active' }, { id: 'c2', name: 'SafeGuard Security Ltd.', type: 'Contractor', category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Security)', contact: 'Mr. Somchai', phone: '02-999-8888', email: 'sales@safeguard.com', status: 'Active' }, { id: 'c3', name: 'Elevator Maintenance Experts', type: 'Contractor', category: '‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå (Elevator Maintenance)', contact: 'Mr. David', phone: '089-111-2222', email: 'service@eme.com', status: 'Active' }, { id: 'c4', name: 'Green Garden Supply', type: 'Vendor', category: '‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏ß‡∏ô (Gardening)', contact: 'Mrs. Noi', phone: '086-333-4444', email: 'noi@greengarden.com', status: 'Inactive' }, ];

// --- NEW: Helper for Image Compression ---
const compressImage = (file, maxWidth = 800, maxHeight = 800, quality = 0.5) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô Max Width/Height
                if (width > height) {
                    if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                } else {
                    if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                // ‡πÉ‡∏™‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å PNG
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JPEG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå quality ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
        };
    });
};

// ... (Components Card, Button, KPICard remain same) ...
const Card = ({ children, className = "", id, onClick }) => ( <div id={id} className={`bg-white rounded-lg shadow-sm border border-gray-200 ${className}`} onClick={onClick}> {children} </div> );
const Button = ({ children, onClick, variant = 'primary', size = 'md', className = "", icon: Icon, disabled = false }) => { const baseStyle = "rounded-md font-medium transition-colors flex items-center justify-center gap-2"; const sizeStyles = { sm: "px-2 py-1 text-xs", md: "px-4 py-2 text-sm", lg: "px-6 py-3 text-base" }; const variants = { primary: "bg-orange-600 text-white hover:bg-orange-700 disabled:bg-gray-400", secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400", danger: "bg-red-50 text-red-600 hover:bg-red-100", outline: "border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:border-gray-200 disabled:text-gray-300", success: "bg-green-600 text-white hover:bg-green-700" }; return ( <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${sizeStyles[size]} ${variants[variant]} ${className}`}> {Icon && <Icon size={size === 'sm' ? 14 : 18} />} {children} </button> ); };

// UPDATED: Make KPICard clickable
const KPICard = ({ title, value, icon: Icon, color, onClick }) => ( 
  <Card className={`p-5 flex items-center gap-4 ${onClick ? 'cursor-pointer hover:shadow-md hover:border-orange-300 transition-all group' : ''}`} onClick={onClick}> 
    <div className={`p-3 rounded-full bg-${color}-100 text-${color}-600 ${onClick ? 'group-hover:scale-110 transition-transform' : ''}`}> 
      <Icon size={24} /> 
    </div> 
    <div> 
      <div className="text-sm text-gray-500">{title}</div> 
      <div className="text-2xl font-bold text-gray-800 flex items-center gap-2">
        {value}
        {onClick && <ArrowRight size={14} className="text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity" />}
      </div> 
    </div> 
  </Card> 
);

// --- IndexedDB for Large Files Storage ---
const DB_NAME = 'BMG_Files_DB';
const STORE_NAME = 'files';

const initDB = () => {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
};

const saveFileLocally = async (fileId, data) => {
    try {
        const db = await initDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.put(data, fileId);
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
        });
    } catch (e) { console.error("IDB Save Error", e); }
};

const getFileLocally = async (fileId) => {
    try {
        const db = await initDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(fileId);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } catch (e) { console.error("IDB Get Error", e); return null; }
};

const getAllFilesLocally = async () => {
    try {
        const db = await initDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            const keysRequest = store.getAllKeys();
            
            request.onsuccess = () => {
                keysRequest.onsuccess = () => {
                    const files = {};
                    keysRequest.result.forEach((key, index) => {
                        files[key] = request.result[index];
                    });
                    resolve(files);
                };
            };
            request.onerror = () => reject(request.error);
        });
    } catch (e) { 
        console.error("IDB GetAll Error", e); 
        return {}; 
    }
};

// --- Custom Hook for Persistent Storage (Firebase + LocalStorage Fallback) ---
function usePersistentState(key, initialValue, fbUser) {
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å LocalStorage ‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏£‡∏Å ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠ Firebase
  const getInitial = () => {
      const local = localStorage.getItem(key);
      if (local) {
          try { return JSON.parse(local); } catch(e){}
      }
      return initialValue;
  };

  const [state, setState] = useState(getInitial);
  const [isSynced, setIsSynced] = useState(false);

  useEffect(() => {
    if (!fbUser || !db || !appId) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_state', key);
    
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        try {
          const val = JSON.parse(docSnap.data().value);
          setState(val);
          localStorage.setItem(key, JSON.stringify(val)); // ‡πÅ‡∏ö‡πá‡∏Ñ‡∏≠‡∏±‡∏û‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        } catch(e) { console.error("Parse error", key, e); }
      } else if (!isSynced) {
        setDoc(docRef, { value: JSON.stringify(state) }).catch(console.error);
      }
      setIsSynced(true);
    }, (err) => {
      console.error("Sync error", key, err);
    });

    return () => unsubscribe();
  }, [fbUser, key]);

  const setPersistentValue = (newValue) => {
    const valueToStore = typeof newValue === 'function' ? newValue(state) : newValue;
    setState(valueToStore);
    localStorage.setItem(key, JSON.stringify(valueToStore)); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (fbUser && db && appId) {
       const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_state', key);
       setDoc(docRef, { value: JSON.stringify(valueToStore) }).catch(console.error);
    }
  };

  return [state, setPersistentValue];
}

// --- Custom Hook for User Specific Persistent Storage ---
function useUserPersistentState(key, initialValue, fbUser) {
  const getInitial = () => {
      const local = localStorage.getItem(key);
      if (local) {
          try { return JSON.parse(local); } catch(e){}
      }
      return initialValue;
  };

  const [state, setState] = useState(getInitial);
  const [isSynced, setIsSynced] = useState(false);

  useEffect(() => {
    if (!fbUser || !db || !appId) return;
    const docRef = doc(db, 'artifacts', appId, 'users', fbUser.uid, 'user_preferences', key);
    
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        try {
          const val = JSON.parse(docSnap.data().value);
          setState(val);
          localStorage.setItem(key, JSON.stringify(val));
        } catch(e) { console.error("Parse error", key, e); }
      } else if (!isSynced) {
        setDoc(docRef, { value: JSON.stringify(state) }).catch(console.error);
      }
      setIsSynced(true);
    }, (err) => {
      console.error("Sync error", key, err);
    });

    return () => unsubscribe();
  }, [fbUser, key]);

  const setPersistentValue = (newValue) => {
    const valueToStore = typeof newValue === 'function' ? newValue(state) : newValue;
    setState(valueToStore);
    localStorage.setItem(key, JSON.stringify(valueToStore));
    if (fbUser && db && appId) {
       const docRef = doc(db, 'artifacts', appId, 'users', fbUser.uid, 'user_preferences', key);
       setDoc(docRef, { value: JSON.stringify(valueToStore) }).catch(console.error);
    }
  };

  return [state, setPersistentValue];
}

// --- Main Application ---

export default function App() {
  const [fbUser, setFbUser] = useState(null);

  useEffect(() => {
    // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÑ‡∏ß‡πâ ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö Anonymous ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ
    const initAuth = async () => {
      if (!auth) return;
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Auth error", e);
      }
    };
    initAuth();
    if (auth) {
        const unsubscribe = onAuthStateChanged(auth, setFbUser);
        return () => unsubscribe();
    }
  }, []);

  const [currentUser, setCurrentUser] = useState(null);
  const [activeMenu, setActiveMenu] = useState('dashboard');
  const [selectedProject, setSelectedProject] = useState(null);
  const [projectTab, setProjectTab] = useState('overview');
  const [contractFilter, setContractFilter] = useState('All'); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤
  const [actionPlanFilter, setActionPlanFilter] = useState('All'); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á Action Plan
  const [repairFilter, setRepairFilter] = useState('All'); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
  const [staffViewMode, setStaffViewMode] = useState('list');
  const [selectedShift, setSelectedShift] = useState(null);
  const [selectedDailyReport, setSelectedDailyReport] = useState(null); // NEW: Track report to view/print
  const [selectedContractView, setSelectedContractView] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤
  const [isEditingContract, setIsEditingContract] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const [lang, setLang] = useState('th'); // Set default language to 'th'
  const [isExporting, setIsExporting] = useState(false);
  const [isBackingUp, setIsBackingUp] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏î Export Backup
  const [isRestoring, setIsRestoring] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á Import Restore
  const [isEditingUser, setIsEditingUser] = useState(false);
  const [scheduleNote, setScheduleNote] = useState(''); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Note ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
  const [scheduleNotes, setScheduleNotes] = usePersistentState('bmg_scheduleNotes', {}, fbUser); // NEW: Persistent state for schedule notes
  const [scheduleApprovals, setScheduleApprovals] = usePersistentState('bmg_scheduleApprovals', {}, fbUser); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
  const [selectedKpiDetail, setSelectedKpiDetail] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î KPI
  const [isSyncingSheets, setIsSyncingSheets] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
  const [isBackingUpToDrive, setIsBackingUpToDrive] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive

  // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Confirm Modal ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null });

  // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  const [userDeptFilter, setUserDeptFilter] = useState('');
  const [userRoleFilter, setUserRoleFilter] = useState('');
  const [userSortOrder, setUserSortOrder] = useState('desc');

  // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  const [projectTypeFilter, setProjectTypeFilter] = useState('');
  const [projectSortOrder, setProjectSortOrder] = useState('expiry_asc');
  const [projectViewMode, setProjectViewMode] = useState('grid');

  // Company Info State
  const [companyInfo, setCompanyInfo] = usePersistentState('bmg_companyInfo', INITIAL_COMPANY_INFO, fbUser);
  const [showEditCompanyModal, setShowEditCompanyModal] = useState(false);
  const [editCompanyForm, setEditCompanyForm] = useState({ ...INITIAL_COMPANY_INFO });

  // Add Contract Modal State
  const [showAddContractModal, setShowAddContractModal] = useState(false);
  const [newContract, setNewContract] = useState({ type: CONTRACT_TYPES.EXPENSE, category: '', customCategory: '', vendorName: '', contactPerson: '', contactPhone: '', startDate: '', endDate: '', amount: '', paymentCycle: 'Monthly', file: null });

  // Add Daily Report Modal State
  const [showAddDailyReportModal, setShowAddDailyReportModal] = useState(false);
  const [newDailyReport, setNewDailyReport] = useState({
      date: new Date().toISOString().split('T')[0],
      manpower: { juristic: 0, security: 0, cleaning: 0, gardening: 0, sweeper: 0, other: 0, otherLabel: '' },
      performance: { 
          juristic: { details: '', images: [] }, security: { details: '', images: [] }, cleaning: { details: '', images: [] },
          gardening: { details: '', images: [] }, sweeper: { details: '', images: [] }, other: { details: '', images: [] }
      },
      income: { commonFee: 0, lateFee: 0, water: 0, parking: 0, violation: 0, other: 0, otherLabel: '' },
      note: '', reporter: ''
  });

  // Assets Management State
  const [assets, setAssets] = usePersistentState('bmg_assets', INITIAL_ASSETS, fbUser);
  const [showAddAssetModal, setShowAddAssetModal] = useState(false);
  const [selectedAssetView, setSelectedAssetView] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
  const [isEditingAsset, setIsEditingAsset] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  const [newAsset, setNewAsset] = useState({
      code: '',
      name: '',
      qty: 1,
      location: '',
      photo: null,
      details: ''
  });

  // Tools Management State
  const [tools, setTools] = usePersistentState('bmg_tools', INITIAL_TOOLS, fbUser);
  const [showAddToolModal, setShowAddToolModal] = useState(false);
  const [selectedToolView, setSelectedToolView] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
  const [isEditingTool, setIsEditingTool] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  const [newTool, setNewTool] = useState({
      code: '',
      name: '',
      qty: 1,
      location: '',
      photo: null,
      details: ''
  });

  // Machine Management State (PM)
  const [machines, setMachines] = usePersistentState('bmg_machines', INITIAL_MACHINES, fbUser);
  const [showAddMachineModal, setShowAddMachineModal] = useState(false);
  const [isEditingMachine, setIsEditingMachine] = useState(false);
  const [pmSubTab, setPmSubTab] = useState('dashboard'); // 'dashboard', 'registry', 'plan', 'calendar', 'form', 'history'
  const [newMachine, setNewMachine] = useState({
      code: '',
      name: '',
      system: '',
      qty: 1,
      location: '',
      photo: null
  });

  // PM Plan State
  const [pmPlans, setPmPlans] = usePersistentState('bmg_pmPlans', INITIAL_PM_PLANS, fbUser);
  const [showAddPmPlanModal, setShowAddPmPlanModal] = useState(false);
  const [newPmPlan, setNewPmPlan] = useState({
      id: null,
      machineId: '',
      frequency: 'Monthly',
      scheduleDetails: { dayOfWeek: '1', date: '1', month: '1' }
  });
  
  const [selectedDateTasks, setSelectedDateTasks] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PM ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô
  
  // PM History State
  const [pmHistoryList, setPmHistoryList] = usePersistentState('bmg_pmHistoryList', INITIAL_PM_HISTORY, fbUser);
  const [selectedPmHistory, setSelectedPmHistory] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π
  const [selectedMachineDetails, setSelectedMachineDetails] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  const [selectedFormSystem, setSelectedFormSystem] = useState(''); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤
  const [selectedPmStatusDetail, setSelectedPmStatusDetail] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PM

  // NEW: PM Form State
  const [showPmFormModal, setShowPmFormModal] = useState(false);
  const [currentPmTask, setCurrentPmTask] = useState(null);
  const [pmFormAnswers, setPmFormAnswers] = useState({});
  const [pmFormIssues, setPmFormIssues] = useState({}); // ‡πÄ‡∏û‡∏¥‡πà‡∏° State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠
  const [pmFormRemark, setPmFormRemark] = useState('');
  const [pmFormImages, setPmFormImages] = useState([]); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° PM

  // NEW: Utilities State
  const [meters, setMeters] = usePersistentState('bmg_meters', INITIAL_METERS, fbUser);
  const [utilityReadings, setUtilityReadings] = usePersistentState('bmg_utilityReadings', INITIAL_READINGS, fbUser);
  const [utilitySubTab, setUtilitySubTab] = useState('record'); // 'record', 'registry', 'analysis'
  const [utilityChartType, setUtilityChartType] = useState('bar'); // 'bar', 'line'
  
  // --- NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü ---
  const [hiddenAnalysisMeters, setHiddenAnalysisMeters] = useState(new Set());
  const [waterAnalysisMode, setWaterAnalysisMode] = useState('combined'); // 'combined', 'separate'
  const [elecAnalysisMode, setElecAnalysisMode] = useState('combined'); // 'combined', 'separate'
  // ------------------------------------

  const [utilityForm, setUtilityForm] = useState({
      id: null, // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      meterId: '',
      date: new Date().toISOString().split('T')[0],
      currentValue: ''
  });
  const currentValueRef = useRef(null); // NEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö focus ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
  
  // NEW: Add Meter Modal State
  const [showAddMeterModal, setShowAddMeterModal] = useState(false);
  const [newMeter, setNewMeter] = useState({
      id: null, // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      type: 'Water',
      code: '',
      name: '',
      location: '',
      initialValue: ''
  });

  // Repair Request State
  const [repairs, setRepairs] = usePersistentState('bmg_repairs', INITIAL_REPAIRS, fbUser);
  const [showAddRepairModal, setShowAddRepairModal] = useState(false);
  const [selectedRepairView, setSelectedRepairView] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞ Print/View
  const [newRepair, setNewRepair] = useState({
      id: null,
      code: '',
      roomNo: '',
      floor: '',
      requesterName: '',
      phone: '',
      issueType: '',
      issueTypeOther: '',
      issueDetails: '',
      inspectionResult: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
      staffDetails: '',
      cost: '',
      staffName: '',
      requesterSignName: ''
  });

  // Action Plan State
  const [actionPlans, setActionPlans] = usePersistentState('bmg_actionPlans', INITIAL_ACTION_PLANS, fbUser);
  const [showAddActionPlanModal, setShowAddActionPlanModal] = useState(false);
  const [newActionPlan, setNewActionPlan] = useState({
      id: null,
      issue: '',
      details: '',
      responsible: '',
      otherResponsible: '',
      startDate: new Date().toISOString().split('T')[0],
      deadline: '',
      status: 'Pending'
  });

  // Supplier Search & Filter State
  const [supplierSearch, setSupplierSearch] = useState('');
  const [supplierTypeFilter, setSupplierTypeFilter] = useState('');
  const [supplierCategoryFilter, setSupplierCategoryFilter] = useState('');
  const [selectedSupplierDetails, setSelectedSupplierDetails] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supplier ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å

  // Form Details Modal State
  const [selectedFormDetails, setSelectedFormDetails] = useState(null);
  const [isEditingForm, setIsEditingForm] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°

  // --- NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ---
  const [formsList, setFormsList] = usePersistentState('bmg_forms_list', STANDARD_FORMS, fbUser);
  const [showAddFormModal, setShowAddFormModal] = useState(false);
  const [newFormItem, setNewFormItem] = useState({ id: null, category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '', format: 'PDF', size: '100 KB', description: '' });

  // Audit Form State
  const [showAddAuditModal, setShowAddAuditModal] = useState(false);
  const [selectedAuditReport, setSelectedAuditReport] = useState(null); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Audit ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  const [showAuditRankingModal, setShowAuditRankingModal] = useState(false); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Modal ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit
  const [newAudit, setNewAudit] = useState({
      projectId: '',
      date: new Date().toISOString().split('T')[0],
      inspector: '',
      type: 'Internal Audit',
      scores: {},
      remarks: {},
      additionalComments: ''
  });

  const [showAddUserModal, setShowAddUserModal] = useState(false);
  const [newUser, setNewUser] = useState({ employeeId: '', firstName: '', lastName: '', position: EMPLOYEE_POSITIONS[0], otherPosition: '', department: '', accessibleDepts: [], phone: '', username: '', password: '', photo: null, permissions: getDefaultPermissions() });

  const [showAddProjectModal, setShowAddProjectModal] = useState(false);
  const [isEditingProject, setIsEditingProject] = useState(false);
  const [newProject, setNewProject] = useState({ logo: null, code: '', name: '', type: 'Condo', address: '', phone: '', taxId: '', contractStartDate: '', contractEndDate: '', contractValue: '', status: 'Active', files: { orchor: null, committee: null, regulations: null, resident_rules: null } });

  const [users, setUsers] = usePersistentState('bmg_users', INITIAL_USERS, fbUser);
  const [projects, setProjects] = usePersistentState('bmg_projects', INITIAL_PROJECTS, fbUser);
  const [contracts, setContracts] = usePersistentState('bmg_contracts', INITIAL_CONTRACTS, fbUser);
  const [audits, setAudits] = usePersistentState('bmg_audits', INITIAL_AUDITS, fbUser);
  const [dailyReports, setDailyReports] = usePersistentState('bmg_dailyReports', INITIAL_DAILY_REPORTS, fbUser);
  const [contractors, setContractors] = usePersistentState('bmg_contractors', INITIAL_CONTRACTORS, fbUser);
  const [schedules, setSchedules] = usePersistentState('bmg_schedules', {}, fbUser);
  
  const getLocalMonthStr = () => {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
  };
  const [currentMonth, setCurrentMonth] = useState(getLocalMonthStr());
  const [pmMonth, setPmMonth] = useState(getLocalMonthStr());

  const [projectStaffOrder, setProjectStaffOrder] = usePersistentState('bmg_projectStaffOrder', {}, fbUser); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô
  const dragItem = useRef(null); // NEW: Ref ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏î‡∏à‡∏≥ index ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å
  const dragOverItem = useRef(null); // NEW: Ref ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏î‡∏à‡∏≥ index ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á

  // Others Module State
  const [othersData, setOthersData] = usePersistentState('bmg_othersData', INITIAL_OTHERS, fbUser);
  const [showAddOtherModal, setShowAddOtherModal] = useState(false);
  const [newOther, setNewOther] = useState({
      id: null,
      title: '',
      details: '',
      link: ''
  });

  // NEW: Theme State (‡πÅ‡∏¢‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
  const [theme, setTheme] = useUserPersistentState('bmg_theme', 'light', fbUser);

  // NEW: Role Permissions State
  const [rolePermissions, setRolePermissions] = usePersistentState('bmg_rolePermissions', {}, fbUser);
  const [showRolePermModal, setShowRolePermModal] = useState(false);
  const [editingRole, setEditingRole] = useState(EMPLOYEE_POSITIONS[0]);
  const [editingRolePerms, setEditingRolePerms] = useState(getDefaultPermissions());

  const [activeManualTab, setActiveManualTab] = useState('intro'); // NEW: State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginError, setLoginError] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false); // NEW: Mobile Menu State
  const [isSidebarOpen, setIsSidebarOpen] = useUserPersistentState('bmg_sidebar_open', true, fbUser); // NEW: Sidebar Desktop State (‡πÅ‡∏¢‡∏Å‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
  const [fullScreenChart, setFullScreenChart] = useState(null); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏¢‡πâ‡∏≤‡∏¢ State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Full Screen Chart ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  // NEW: Helper for downloading files safely (especially large base64 PDFs)
  const handleDownloadFile = async (fileObj, defaultName = 'document.pdf') => {
      try {
          if (!fileObj) return;
          
          let fileName = fileObj?.name || defaultName;
          let fileData = null;

          // ‚ùó ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Drive ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
          // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÅ‡∏ö‡∏ö Web App (doGet)
          const GOOGLE_SCRIPT_GET_FILE_URL = 'https://script.google.com/macros/s/AKfycbzQYEwfj3xz-kACA43pNbnpcuPY9p3Vg039t-HqDaAIU7hf7WXswEf1MXlapdv3jU5tnw/exec'; 

          // --- 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local (IndexedDB) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô ---
          if (fileObj?.isLocal && fileObj?.fileId) {
              fileData = await getFileLocally(fileObj.fileId);
          }

          // --- 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô) ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Drive ---
          if (!fileData && GOOGLE_SCRIPT_GET_FILE_URL && GOOGLE_SCRIPT_GET_FILE_URL !== 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE') {
              console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Google Drive...`);
              try {
                  // ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤ Backup ‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á Drive ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ Document_{fileId}.pdf
                  const searchName = fileObj.fileId ? `Document_${fileObj.fileId}.pdf` : fileName;
                  
                  const response = await fetch(`${GOOGLE_SCRIPT_GET_FILE_URL}?filename=${encodeURIComponent(searchName)}&fallbackName=${encodeURIComponent(fileName)}`);
                  const result = await response.json();
                  
                  if (result.status === 'success' && result.data) {
                      fileData = result.data;
                      // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Drive ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ (Cache) ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏≠‡∏µ‡∏Å
                      if (fileObj.fileId) {
                          await saveFileLocally(fileObj.fileId, fileData);
                      }
                  } else {
                      console.warn("Drive fetch failed:", result.message);
                  }
              } catch (e) {
                  console.error("Error fetching from Drive:", e);
              }
          }

          // --- 3. Fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å State/URL ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ---
          if (!fileData) {
              fileData = fileObj?.data || fileObj?.fileUrl;
              if (typeof fileObj === 'string') {
                   fileName = fileObj;
                   fileData = null;
                   if (fileObj.startsWith('data:')) {
                       fileData = fileObj;
                       fileName = defaultName;
                   }
              }
          }

          // --- 4. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Download / ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå ---
          if (fileData && typeof fileData === 'string' && fileData.startsWith('data:')) {
              // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å fetch(DataURI) ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á Base64 ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Blob ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
              try {
                  const arr = fileData.split(',');
                  const mime = arr[0].match(/:(.*?);/)[1];
                  const bstr = atob(arr[1]);
                  let n = bstr.length;
                  const u8arr = new Uint8Array(n);
                  while (n--) {
                      u8arr[n] = bstr.charCodeAt(n);
                  }
                  const blob = new Blob([u8arr], { type: mime });
                  const url = URL.createObjectURL(blob);
                  
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = fileName;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  setTimeout(() => URL.revokeObjectURL(url), 1000); // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
              } catch (convErr) {
                  console.error("Blob conversion error, using fallback Data URL", convErr);
                  const a = document.createElement('a');
                  a.href = fileData;
                  a.download = fileName;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
              }
          } else {
              console.warn(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á ${fileName}`);
              // ‡πÉ‡∏ä‡πâ showConfirm ‡πÅ‡∏ó‡∏ô alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
              showConfirm(
                  '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå',
                  `‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå ${fileName} ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Drive ‡πÑ‡∏î‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Backup ‡∏•‡∏á Drive ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)`,
                  () => {} 
              );
          }
      } catch (error) {
          console.error("Download error:", error);
      }
  };

  // NEW: Helper Functions for Confirmation
  const showConfirm = (title, message, onConfirm) => {
      setConfirmModal({ isOpen: true, title, message, onConfirm });
  };
  const closeConfirm = () => {
      setConfirmModal({ isOpen: false, title: '', message: '', onConfirm: null });
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Permission Checker)
  const hasPerm = (menuId, action = 'view') => {
      if (!currentUser) return false;
      if (currentUser.username === 'admin') return true; // Admin ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á
      
      const perms = currentUser.permissions || {};
      return !!perms[menuId]?.[action];
  };

  // NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const canAccessMultipleProjects = () => {
      if (!currentUser) return false;
      if (currentUser.username === 'admin') return true;
      
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
      const accessibleDeptsStr = currentUser.accessibleDepts || '';
      const accessibleArray = typeof accessibleDeptsStr === 'string' ? accessibleDeptsStr.split(', ').filter(Boolean) : accessibleDeptsStr;
      
      if (accessibleArray.includes('All') || accessibleArray.length > 0) return true;
      return false; // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ
  };

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ PDF ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏∂‡πâ‡∏ô (‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Cross-Origin ‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)
  useEffect(() => { 
      if (!document.getElementById('html2pdf-script')) {
          const script = document.createElement('script'); 
          script.id = 'html2pdf-script';
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"; 
          script.async = true; 
          document.body.appendChild(script); 
      }
  }, []);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (C, V, O)
  useEffect(() => { 
      if (showAddProjectModal && !isEditingProject) { 
          const prefix = PROJECT_TYPE_CODES[newProject.type]; 
          // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          const existingCodes = projects
              .filter(p => p.type === newProject.type && p.code && p.code.startsWith(prefix + '-'))
              .map(p => parseInt(p.code.split('-')[1], 10))
              .filter(n => !isNaN(n));
          const maxCount = existingCodes.length > 0 ? Math.max(...existingCodes) : 0;
          const nextCount = maxCount + 1;
          const code = `${prefix}-${String(nextCount).padStart(3, '0')}`;
          setNewProject(prev => prev.code !== code ? { ...prev, code } : prev);
      } 
  }, [newProject.type, showAddProjectModal, projects, isEditingProject]);

  useEffect(() => { if (showAddContractModal) { setNewContract(prev => ({ ...prev, category: '', customCategory: '' })); } }, [newContract.type, showAddContractModal]);

  // Asset Code Generation Effect
  useEffect(() => {
    if (showAddAssetModal && selectedProject && !isEditingAsset) {
        const projectAssets = assets.filter(a => a.projectId === selectedProject.id);
        const nextNum = projectAssets.length + 1;
        const generatedCode = `${selectedProject.code}-A-${String(nextNum).padStart(3, '0')}`;
        setNewAsset(prev => ({ ...prev, code: generatedCode }));
    }
  }, [showAddAssetModal, selectedProject, assets, isEditingAsset]);

  // Tool Code Generation Effect
  useEffect(() => {
    if (showAddToolModal && selectedProject && !isEditingTool) {
        const projectTools = tools.filter(t => t.projectId === selectedProject.id);
        const nextNum = projectTools.length + 1;
        const generatedCode = `${selectedProject.code}-T-${String(nextNum).padStart(3, '0')}`;
        setNewTool(prev => ({ ...prev, code: generatedCode }));
    }
  }, [showAddToolModal, selectedProject, tools, isEditingTool]);

  // Machine Code Generation Effect
  useEffect(() => {
    if (showAddMachineModal && selectedProject && !isEditingMachine) {
        const projectMachines = machines.filter(m => m.projectId === selectedProject.id);
        const nextNum = projectMachines.length + 1;
        const generatedCode = `BMG-M-${String(nextNum).padStart(3, '0')}`;
        setNewMachine(prev => ({ ...prev, code: generatedCode }));
    }
  }, [showAddMachineModal, selectedProject, machines, isEditingMachine]);

  // Repair Code Generation Effect
  useEffect(() => {
    if (showAddRepairModal && selectedProject && !newRepair.id && !newRepair.code) {
        const projectRepairs = repairs.filter(r => r.projectId === selectedProject.id);
        const existingCodes = projectRepairs
            .map(r => parseInt(r.code.split('-REP-')[1], 10))
            .filter(n => !isNaN(n));
        const maxCount = existingCodes.length > 0 ? Math.max(...existingCodes) : 0;
        const nextNum = maxCount + 1;
        const generatedCode = `${selectedProject.code}-REP-${String(nextNum).padStart(3, '0')}`;
        setNewRepair(prev => prev.code === generatedCode ? prev : { ...prev, code: generatedCode });
    }
  }, [showAddRepairModal, selectedProject, repairs, newRepair.id, newRepair.code]);

  // Sync Schedule Note when month or project changes
  useEffect(() => {
      if (selectedProject && currentMonth) {
          const noteKey = `${selectedProject.id}_${currentMonth}`;
          setScheduleNote(scheduleNotes[noteKey] || '');
      }
  }, [selectedProject, currentMonth, scheduleNotes]);

  const t = (key) => TRANSLATIONS[lang][key] || key;
  const changeMonth = (increment) => { const [year, month] = currentMonth.split('-').map(Number); const date = new Date(year, month - 1 + increment, 1); const newYear = date.getFullYear(); const newMonth = String(date.getMonth() + 1).padStart(2, '0'); setCurrentMonth(`${newYear}-${newMonth}`); }; const getDaysInMonth = (year, month) => { const date = new Date(year, month - 1, 1); const days = []; while (date.getMonth() === month - 1) { days.push(new Date(date)); date.setDate(date.getDate() + 1); } return days; }; 
  
  const handleSaveSchedule = () => { 
      if (selectedProject) {
          const noteKey = `${selectedProject.id}_${currentMonth}`;
          setScheduleNotes(prev => ({ ...prev, [noteKey]: scheduleNote }));
          
          // --- NEW: Workflow Logic ---
          const approvalKey = `${selectedProject.id}_${currentMonth}`;
          const currentApproval = scheduleApprovals[approvalKey] || {};
          
          const isManager = currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') || currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô');
          const isAdmin = currentUser?.username === 'admin';
          
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠ Admin ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡πÄ‡∏ï‡πá‡∏õ‡πÑ‡∏õ‡∏£‡∏≠ HR ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏•‡∏¢
          // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
          const nextStatus = (isManager || isAdmin) ? 'Pending HR' : 'Pending Manager';
          
          setScheduleApprovals(prev => ({
              ...prev,
              [approvalKey]: {
                  ...currentApproval,
                  status: nextStatus,
                  preparedBy: `${currentUser.firstName} ${currentUser.lastName}`,
                  preparedByRole: currentUser.position,
                  managerApprovedBy: (isManager || isAdmin) ? `${currentUser.firstName} ${currentUser.lastName}` : null, // Auto-sign manager if prepared by manager
                  updatedAt: new Date().toISOString()
              }
          }));

          alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ ${(isManager || isAdmin) ? '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR)' : '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'} ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß`); 
      }
  }; 

  // --- NEW: Handle Schedule Approval ---
  const handleApproveSchedule = () => {
      if (!selectedProject) return;
      const approvalKey = `${selectedProject.id}_${currentMonth}`;
      const currentApproval = scheduleApprovals[approvalKey];
      if (!currentApproval) return;

      const isHR = currentUser?.position.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•') || currentUser?.username === 'admin';
      const isManager = currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') || currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô') || currentUser?.username === 'admin';

      let nextStatus = currentApproval.status;
      let updates = {};

      if (currentApproval.status === 'Pending Manager' && isManager) {
          nextStatus = 'Pending HR';
          updates.managerApprovedBy = `${currentUser.firstName} ${currentUser.lastName}`;
          alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
      } else if (currentApproval.status === 'Pending HR' && isHR) {
          nextStatus = 'Approved';
          updates.hrApprovedBy = `${currentUser.firstName} ${currentUser.lastName}`;
          alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö "‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
      }

      setScheduleApprovals(prev => ({
          ...prev,
          [approvalKey]: {
              ...currentApproval,
              ...updates,
              status: nextStatus,
              updatedAt: new Date().toISOString()
          }
      }));
  };

  const handleLockSchedule = () => {
      if (!selectedProject) return;
      const approvalKey = `${selectedProject.id}_${currentMonth}`;
      const currentApproval = scheduleApprovals[approvalKey];
      if (!currentApproval) return;
      
      setScheduleApprovals(prev => ({
          ...prev,
          [approvalKey]: {
              ...currentApproval,
              isLocked: true,
              lockedBy: `${currentUser.firstName} ${currentUser.lastName}`,
              updatedAt: new Date().toISOString()
          }
      }));
      alert('‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•(‡∏ó‡∏±‡πâ‡∏á Plan ‡πÅ‡∏•‡∏∞ Act) ‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ');
  };

  const handleUnlockSchedule = () => {
      if (!selectedProject) return;
      const approvalKey = `${selectedProject.id}_${currentMonth}`;
      const currentApproval = scheduleApprovals[approvalKey];
      if (!currentApproval) return;
      
      setScheduleApprovals(prev => ({
          ...prev,
          [approvalKey]: {
              ...currentApproval,
              isLocked: false,
              status: 'Pending HR', // ‡∏¢‡πâ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ Plan ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢
              hrApprovedBy: null,
              updatedAt: new Date().toISOString()
          }
      }));
      alert('‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
  };

  const Badge = ({ status }) => { const statusText = t(status.charAt(0).toLowerCase() + status.slice(1).replace(/ /g, '')) || status; const colors = { 'Active': 'bg-green-100 text-green-800', 'Inactive': 'bg-gray-100 text-gray-800', 'Warning': 'bg-yellow-100 text-yellow-800', 'Good': 'bg-green-100 text-green-800', 'Fair': 'bg-yellow-100 text-yellow-800', 'Normal': 'bg-blue-100 text-blue-800', 'Repair': 'bg-red-100 text-red-800', 'Pending': 'bg-orange-100 text-orange-800', 'Approved': 'bg-green-100 text-green-800', 'Completed': 'bg-green-100 text-green-800', 'Expiring Soon': 'bg-orange-100 text-orange-800', 'Expired': 'bg-red-100 text-red-800' }; return <span className={`px-2 py-1 rounded-full text-xs font-semibold ${colors[status] || 'bg-gray-100 text-gray-800'}`}>{statusText}</span>; };
  
  // Helpers for PM Calendar
  const changePmMonth = (increment) => {
    const [year, month] = pmMonth.split('-').map(Number);
    const date = new Date(year, month - 1 + increment, 1);
    const newYear = date.getFullYear();
    const newMonth = String(date.getMonth() + 1).padStart(2, '0');
    setPmMonth(`${newYear}-${newMonth}`);
  };

  const getCalendarDays = (year, month) => {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const days = [];
    for (let i = 0; i < firstDay.getDay(); i++) {
        const d = new Date(year, month - 1, -firstDay.getDay() + i + 1);
        days.push({ date: d, isCurrentMonth: false });
    }
    for (let i = 1; i <= lastDay.getDate(); i++) {
        days.push({ date: new Date(year, month - 1, i), isCurrentMonth: true });
    }
    return days;
  };

  // NEW: Dynamic Checklist Generator based on System Type
  const getChecklistForSystem = (systemName) => {
      const sys = systemName ? systemName.toLowerCase() : '';
      
      if (sys.includes('transformer') || sys.includes('‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á')) {
          return [
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡∏â‡∏ô‡∏ß‡∏ô (Bushing)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏°‡πâ‡∏≠‡πÅ‡∏õ‡∏•‡∏á', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏ã‡∏¥‡∏•‡∏¥‡∏Å‡πâ‡∏≤‡πÄ‡∏à‡∏• (Silica Gel)', '‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏ö'
          ];
      }
      if (sys.includes('generator') || sys.includes('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î')) {
           return [
               '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á (Fuel)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô (Engine Oil)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß',
               '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏Å‡∏•‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏•‡πà‡∏≠‡∏•‡∏∑‡πà‡∏ô‡∏£‡∏≠‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (No Load Test / Warm up)'
           ];
      }
      if (sys.includes('pump') || sys.includes('‡∏õ‡∏±‡πä‡∏°')) {
           return [
               '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Suction Pressure)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (Discharge Pressure)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå',
               '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏ã‡∏µ‡∏• (Mechanical Seal)', '‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Amp) ‡∏Ç‡∏ì‡∏∞‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Pressure Switch/Sensor', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏±‡πä‡∏°'
           ];
      }
      if (sys.includes('chiller') || sys.includes('air') || sys.includes('‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®') || sys.includes('ahu') || sys.includes('fcu')) {
          return [
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ô‡πâ‡∏≥/‡∏•‡∏° ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏û‡∏£‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå',
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (Filter)', '‡∏ß‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏û‡∏£‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏±‡∏î‡∏•‡∏°', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏±‡∏î‡∏•‡∏°‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡∏¥‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏¢‡∏≤'
          ];
      }
      if (sys.includes('fire') || sys.includes('‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á') || sys.includes('sprinkler')) {
          return [
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Auto)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Jockey Pump)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏≤‡∏•‡πå‡∏ß‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡πä‡∏° ‡∏ó‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏â‡∏µ‡∏î‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î', '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô'
          ];
      }
      if (sys.includes('lift') || sys.includes('‡∏•‡∏¥‡∏ü‡∏ï‡πå') || sys.includes('‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô')) {
          return [
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ö‡∏≤‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå (‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏î‡∏•‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£', '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (Intercom / Alarm)',
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏î‡∏ï‡∏£‡∏á‡∏ä‡∏±‡πâ‡∏ô (Leveling)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡∏•‡∏¥‡∏ü‡∏ï‡πå‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏µ‡∏ö‡∏õ‡∏£‡∏∞‡∏ï‡∏π'
          ];
      }
      if (sys.includes('cctv') || sys.includes('‡∏Å‡∏•‡πâ‡∏≠‡∏á') || sys.includes('access control')) {
          return [
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î/‡πÅ‡∏™‡∏á)', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Æ‡∏≤‡∏£‡πå‡∏î‡∏î‡∏¥‡∏™‡∏Å‡πå (NVR/DVR)',
              '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ü (UPS)', '‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏ô‡∏™‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á'
          ];
      }

      // Default Checklist for any other system
      return [
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡πà‡∏ß‡∏ã‡∏∂‡∏° (‡∏ô‡πâ‡∏≥, ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏•‡∏°)',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡πá‡∏≠‡∏ï‡∏¢‡∏∂‡∏î',
          '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á',
          '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (Basic Function Test)'
      ];
  };

  const handleOpenPmForm = (task, machine, plannedDateString = null) => {
      setCurrentPmTask({ task, machine, plannedDateString });
      const systemChecklist = getChecklistForSystem(machine.system);
      
      // Initialize empty answers
      const initialAnswers = {};
      const initialIssues = {};
      systemChecklist.forEach((_, idx) => {
          initialAnswers[`item_${idx}`] = ''; // '' = unselected, 'pass', 'fail', 'na'
          initialIssues[`item_${idx}`] = '';
      });
      
      setPmFormAnswers(initialAnswers);
      setPmFormIssues(initialIssues);
      setPmFormRemark('');
      setPmFormImages([]); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà
      setShowPmFormModal(true);
  };

  const handlePmFormImageUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressedBase64 = await compressImage(file);
          setPmFormImages(prev => [...prev, compressedBase64]);
      }
  };

  const removePmFormImage = (index) => {
      setPmFormImages(prev => prev.filter((_, i) => i !== index));
  };

  const handleSavePmForm = (e) => {
      e.preventDefault();
      
      // Calculate Pass/Fail status
      let passCount = 0;
      let failCount = 0;
      let naCount = 0;
      Object.values(pmFormAnswers).forEach(val => {
          if (val === 'pass') passCount++;
          if (val === 'fail') failCount++;
          if (val === 'na') naCount++;
      });

      const overallStatus = failCount > 0 ? 'Fail' : 'Pass';

      // --- NEW: Approval Flow Logic ---
      const isChief = (user) => user?.position.includes('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á');
      const isManager = (user) => user?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£') && !user?.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢');
      const isAdmin = (user) => user?.username === 'admin' || user?.position === 'Super Admin';

      const projectStaff = users.filter(u => u.department === selectedProject.name);
      const hasChiefInProject = projectStaff.some(u => isChief(u));
      
      let initialApprovalStatus = 'Pending Chief';
      let initialApproverRole = '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á';

      // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/Admin ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
      if (isAdmin(currentUser) || isManager(currentUser)) {
          initialApprovalStatus = 'Approved';
          initialApproverRole = 'None';
      } 
      // ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      else if (isChief(currentUser) || !hasChiefInProject) {
          initialApprovalStatus = 'Pending Manager';
          initialApproverRole = '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
      }

      const todayLocal = new Date();
      const localDateString = `${todayLocal.getFullYear()}-${String(todayLocal.getMonth() + 1).padStart(2, '0')}-${String(todayLocal.getDate()).padStart(2, '0')}`;

      // --- NEW: Calculate Timing Status ---
      let timingStatus = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô';
      if (currentPmTask.plannedDateString) {
          const planD = new Date(currentPmTask.plannedDateString);
          const execD = new Date(localDateString);
          planD.setHours(0,0,0,0);
          execD.setHours(0,0,0,0);

          if (execD < planD) {
              timingStatus = '‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô';
          } else if (execD > planD) {
              timingStatus = '‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô';
          }
      }
      // ------------------------------------

      // Create new history record
      const newHistoryRecord = {
          id: generateId(),
          projectId: selectedProject.id,
          machineId: currentPmTask.machine.id,
          machineCode: currentPmTask.machine.code,
          machineName: currentPmTask.machine.name,
          pmPlanId: currentPmTask.task.id,
          date: currentPmTask.plannedDateString || localDateString,
          executedDate: localDateString,
          executionTimingStatus: timingStatus, // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤
          inspector: `${currentUser?.firstName} ${currentUser?.lastName}`,
          status: overallStatus,
          totalItems: Object.keys(pmFormAnswers).length,
          passedItems: passCount,
          failedItems: failCount,
          naItems: naCount,
          remark: pmFormRemark,
          images: pmFormImages, // ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
          answers: { ...pmFormAnswers },
          issues: { ...pmFormIssues },
          // Approval Fields
          approvalStatus: initialApprovalStatus,
          pendingApproverRole: initialApproverRole,
          approvals: [] // Track ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡πâ‡∏≤‡∏á
      };

      // Add to history state (putting newest first)
      setPmHistoryList([newHistoryRecord, ...pmHistoryList]);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      if (selectedPmStatusDetail && selectedPmStatusDetail.status === 'Not Started') {
          setSelectedPmStatusDetail(prev => ({
              ...prev,
              tasks: prev.tasks.filter(t => !(t.plan.id === currentPmTask.task.id && t.dateString === currentPmTask.plannedDateString))
          }));
      }

      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
      setShowPmFormModal(false);
      setCurrentPmTask(null);
  };

  // --- NEW: Handle PM Approval Actions ---
  const handleApprovePmAction = (record, action) => {
      const isChiefUser = currentUser?.position.includes('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á');
      const isManagerUser = currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£') && !currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢');
      const isAdminUser = currentUser?.username === 'admin' || currentUser?.position === 'Super Admin';

      let nextStatus = record.approvalStatus;
      let nextRole = record.pendingApproverRole;

      if (action === 'Rejected') {
          nextStatus = 'Rejected';
          nextRole = 'None';
      } else { // Approved
          if (record.approvalStatus === 'Pending Chief' && (isChiefUser || isAdminUser)) {
              nextStatus = 'Pending Manager';
              nextRole = '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£';
          } else if (record.approvalStatus === 'Pending Manager' && (isManagerUser || isAdminUser)) {
              nextStatus = 'Approved';
              nextRole = 'None';
          } else if (isAdminUser) {
              nextStatus = 'Approved';
              nextRole = 'None';
          }
      }

      const approvalRecord = {
          approver: `${currentUser.firstName} ${currentUser.lastName}`,
          role: currentUser.position,
          date: new Date().toISOString(),
          action: action
      };

      const updatedRecord = {
          ...record,
          approvalStatus: nextStatus,
          pendingApproverRole: nextRole,
          approvals: [...(record.approvals || []), approvalRecord]
      };

      setPmHistoryList(pmHistoryList.map(h => h.id === record.id ? updatedRecord : h));
      setSelectedPmHistory(updatedRecord);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      if (selectedPmStatusDetail) {
          setSelectedPmStatusDetail(prev => ({
              ...prev,
              tasks: prev.tasks.filter(t => t.historyRecord?.id !== record.id)
          }));
      }
  };

  const handleLogin = (e) => { 
      e.preventDefault(); 
      const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password); 
      if (user) { 
          setCurrentUser(user); 
          setNewDailyReport(prev => ({...prev, reporter: `${user.firstName} ${user.lastName}`})); 
          setLoginError(''); 
          
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          if (user.department && user.department !== 'Head Office') {
              // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ department
              const assignedProject = projects.find(p => p.name === user.department);
              if (assignedProject) {
                  setSelectedProject(assignedProject); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                  setActiveMenu('projects');
                  setProjectTab('overview');
              } else {
                  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                  setSelectedProject(null);
                  setActiveMenu('dashboard');
              }
          } else {
              // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Head Office ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏´‡∏•‡∏±‡∏Å
              setSelectedProject(null);
              setActiveMenu('dashboard');
          }
      } else { 
          setLoginError('‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)'); 
      } 
  };
  const handleLogout = () => { setCurrentUser(null); setLoginForm({ username: '', password: '' }); setActiveMenu('dashboard'); setSelectedProject(null); };
  const getKPIs = () => ({ projects: projects.length, employees: users.length, pendingTasks: 0, pmDue: 0 });
  const exportToCSV = (data, filename) => { if (!data || data.length === 0) return alert('No data to export'); const headers = Object.keys(data[0]); const csvContent = [headers.join(','), ...data.map(row => headers.map(fieldName => `"${row[fieldName] || ''}"`).join(','))].join('\n'); const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `${filename}.csv`; link.click(); }; 
  
  // --- NEW: Helper Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡πÅ‡∏•‡∏∞ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡∏•‡∏á‡πÉ‡∏ô PDF ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ---
  const generateHeaderImage = async (proj, comp, orientation) => {
      const A4_WIDTH_PORTRAIT = 210;
      const A4_WIDTH_LANDSCAPE = 297;
      const scale = 4; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û
      const mmToPx = (mm) => (mm * 3.7795) * scale; 
      
      const widthMm = orientation === 'landscape' ? A4_WIDTH_LANDSCAPE : A4_WIDTH_PORTRAIT;
      const canvasWidth = mmToPx(widthMm);
      
      const hCanvas = document.createElement('canvas');
      hCanvas.width = canvasWidth;
      hCanvas.height = mmToPx(22); // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 22mm ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
      const ctxH = hCanvas.getContext('2d');
      
      // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
      ctxH.fillStyle = '#ffffff';
      ctxH.fillRect(0, 0, hCanvas.width, hCanvas.height);
      
      const name = proj?.name || comp?.name || 'BEST MILLION GROUP';
      const address = proj?.address || comp?.address || '';
      const logoSrc = proj?.logo || comp?.logo || null;
      
      let textStartX = mmToPx(10); 
      
      // ‡∏ß‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ
      if (logoSrc) {
          await new Promise(resolve => {
              const img = new Image();
              img.crossOrigin = 'Anonymous';
              img.onload = () => {
                  const imgHeight = mmToPx(14); 
                  const imgWidth = (img.width / img.height) * imgHeight;
                  ctxH.drawImage(img, mmToPx(10), mmToPx(4), imgWidth, imgHeight); // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô
                  textStartX = mmToPx(10) + imgWidth + mmToPx(5);
                  resolve();
              };
              img.onerror = resolve; 
              img.src = logoSrc;
          });
      }
      
      // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)
      ctxH.textBaseline = 'top';
      ctxH.fillStyle = '#FF4D00'; 
      ctxH.font = `bold ${Math.round(mmToPx(5))}px 'Noto Sans Thai', sans-serif`;
      ctxH.fillText(name, textStartX, mmToPx(4)); // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
      
      ctxH.fillStyle = '#4B5563'; 
      ctxH.font = `normal ${Math.round(mmToPx(3.5))}px 'Noto Sans Thai', sans-serif`;
      ctxH.fillText(address, textStartX, mmToPx(11)); // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏∂‡πâ‡∏ô
      
      // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
      ctxH.beginPath();
      ctxH.moveTo(mmToPx(10), hCanvas.height - mmToPx(2));
      ctxH.lineTo(hCanvas.width - mmToPx(10), hCanvas.height - mmToPx(2));
      ctxH.strokeStyle = '#E5E7EB';
      ctxH.lineWidth = mmToPx(0.5);
      ctxH.stroke();
      
      return hCanvas.toDataURL('image/jpeg', 1.0);
  };

  const generateFooterImage = (pageNum, totalPages, orientation) => {
      const A4_WIDTH_PORTRAIT = 210;
      const A4_WIDTH_LANDSCAPE = 297;
      const scale = 4;
      const mmToPx = (mm) => (mm * 3.7795) * scale; 
      
      const widthMm = orientation === 'landscape' ? A4_WIDTH_LANDSCAPE : A4_WIDTH_PORTRAIT;
      const canvasWidth = mmToPx(widthMm);
      
      const fCanvas = document.createElement('canvas');
      fCanvas.width = canvasWidth;
      fCanvas.height = mmToPx(20); // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© 20mm
      const ctxF = fCanvas.getContext('2d');
      
      ctxF.fillStyle = '#ffffff';
      ctxF.fillRect(0, 0, fCanvas.width, fCanvas.height);
      
      // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏ö‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
      ctxF.beginPath();
      ctxF.moveTo(mmToPx(10), mmToPx(2));
      ctxF.lineTo(fCanvas.width - mmToPx(10), mmToPx(2));
      ctxF.strokeStyle = '#E5E7EB';
      ctxF.lineWidth = mmToPx(0.5);
      ctxF.stroke();
      
      // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡∏ã‡πâ‡∏≤‡∏¢)
      ctxF.textBaseline = 'middle';
      ctxF.fillStyle = '#6B7280'; 
      ctxF.font = `bold ${Math.round(mmToPx(3.5))}px 'Noto Sans Thai', sans-serif`;
      ctxF.fillText('Managed by Best Million Group Co., Ltd.', mmToPx(10), mmToPx(10));
      
      // ‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ (‡∏Ç‡∏ß‡∏≤)
      const pageText = `Page ${pageNum} of ${totalPages}`;
      ctxF.textAlign = 'right';
      ctxF.fillText(pageText, fCanvas.width - mmToPx(10), mmToPx(10));
      
      return fCanvas.toDataURL('image/jpeg', 1.0);
  };
  // --------------------------------------------------------------------------

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå orientation ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô portrait (A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á)
  const handleExportPDF = async (elementId = 'print-area', filename = 'document.pdf', orientation = 'portrait', customMargin = null) => { 
      if (!window.html2pdf) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ PDF ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); return; } 
      setIsExporting(true); 
      
      try {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏£‡∏≠‡πÑ‡∏ß‡πâ
          const headerImg = await generateHeaderImage(selectedProject, companyInfo, orientation);
          
          setTimeout(() => { 
              const element = document.getElementById(elementId); 
              if(!element) { 
                  alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå (Element ID: ${elementId})`);
                  setIsExporting(false); 
                  return; 
              }
              
              const opt = { 
                  margin: customMargin || [22, 10, 20, 10], // ‡∏õ‡∏£‡∏±‡∏ö Top Margin ‡∏Ñ‡πà‡∏≤ Default ‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 22mm
                  filename: filename, 
                  image: { type: 'jpeg', quality: 0.98 }, 
                  // ‡πÄ‡∏û‡∏¥‡πà‡∏° scrollY: 0 ‡πÅ‡∏•‡∏∞ letterRendering: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∞/‡∏ß‡∏£‡∏£‡∏ì‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î
                  html2canvas: { scale: 2, useCORS: true, scrollY: 0, letterRendering: true }, 
                  jsPDF: { unit: 'mm', format: 'a4', orientation: orientation },
                  pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
              }; 
              
              // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á html2pdf
              window.html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) {
                  const totalPages = pdf.internal.getNumberOfPages();
                  const pageWidth = pdf.internal.pageSize.getWidth();
                  const pageHeight = pdf.internal.pageSize.getHeight();
                  
                  // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏≤ (Stamp) ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏á‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
                  for (let i = 1; i <= totalPages; i++) {
                      pdf.setPage(i);
                      
                      // ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (Y=0, Height=22) ‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏°‡∏õ‡∏Å‡∏±‡∏ö‡∏°‡∏≤‡∏£‡πå‡∏à‡∏¥‡∏ô‡∏ö‡∏ô‡∏û‡∏≠‡∏î‡∏µ
                      pdf.addImage(headerImg, 'JPEG', 0, 0, pageWidth, 22);
                      
                      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ (Y=‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏ö 20, Height=20)
                      const footerImg = generateFooterImage(i, totalPages, orientation);
                      pdf.addImage(footerImg, 'JPEG', 0, pageHeight - 20, pageWidth, 20);
                  }
              }).save().then(() => setIsExporting(false)).catch(err => { 
                  console.error(err); 
                  setIsExporting(false); 
                  alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF"); 
              }); 
          }, 800); 
      } catch (err) {
          console.error(err);
          setIsExporting(false);
      }
  }; 
  
  // ‡∏ã‡πà‡∏≠‡∏ô Header ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö Header ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô PDF ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
  const ReportHeader = () => { return null; };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î PDF ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏õ‡πä‡∏∞)
  const exportSchedulePDF = async () => {
      if (!window.html2pdf) { alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ PDF ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); return; }
      setIsExporting(true);
      
      try {
          // ‡πÉ‡∏ä‡πâ A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (Landscape) ‡∏Ç‡∏ô‡∏≤‡∏î = 297mm x 210mm
          const orientation = 'landscape';
          const headerImg = await generateHeaderImage(selectedProject, companyInfo, orientation);
          
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ UI ‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô mm ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏†‡∏≤‡∏û
          setTimeout(() => {
              const element = document.getElementById('print-schedule-area');
              
              if (!element) {
                  setIsExporting(false);
                  return;
              }

              // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Margin: [Top, Left, Bottom, Right] ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ mm
              // ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ = 297 - 10(‡∏ã‡πâ‡∏≤‡∏¢) - 10(‡∏Ç‡∏ß‡∏≤) = 277mm
              const opt = { 
                  margin: [22, 10, 20, 10], 
                  filename: `Work_Schedule_${selectedProject?.name || 'Project'}_${currentMonth}.pdf`, 
                  image: { type: 'jpeg', quality: 1 }, 
                  html2canvas: { 
                      scale: 3, // ‡∏Ç‡∏¢‡∏≤‡∏¢ Scale ‡πÄ‡∏õ‡πá‡∏ô 3 ‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå
                      useCORS: true, 
                      letterRendering: true,
                      scrollY: 0,
                      scrollX: 0
                  }, 
                  jsPDF: { unit: 'mm', format: 'a4', orientation: orientation },
                  pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
              };

              window.html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) {
                  const totalPages = pdf.internal.getNumberOfPages();
                  const pageWidth = pdf.internal.pageSize.getWidth();
                  const pageHeight = pdf.internal.pageSize.getHeight();
                  
                  // ‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ï‡∏£‡∏≤‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
                  for (let i = 1; i <= totalPages; i++) {
                      pdf.setPage(i);
                      // ‡∏ß‡∏≤‡∏á Header ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î Y=0, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 22mm ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö Top Margin
                      pdf.addImage(headerImg, 'JPEG', 0, 0, pageWidth, 22);
                      
                      // ‡∏ß‡∏≤‡∏á Footer ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á 20mm ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö Bottom Margin
                      const footerImg = generateFooterImage(i, totalPages, orientation);
                      pdf.addImage(footerImg, 'JPEG', 0, pageHeight - 20, pageWidth, 20);
                  }
              }).save().then(() => {
                  setIsExporting(false);
              }).catch(err => { 
                  console.error(err); 
                  setIsExporting(false); 
                  alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF"); 
              });
          }, 1000); 
      } catch (err) {
          console.error(err);
          setIsExporting(false);
      }
  };

  // New Handlers for Daily Report
  const handleDailyManpowerChange = (field, value) => {
      setNewDailyReport(prev => ({ ...prev, manpower: { ...prev.manpower, [field]: value } }));
  };
  const handleDailyPerformanceChange = (dept, value) => {
      setNewDailyReport(prev => ({ 
          ...prev, 
          performance: { 
              ...prev.performance, 
              [dept]: { ...(prev.performance[dept] || { images: [] }), details: value } 
          } 
      }));
  };
  const handleDailyIncomeChange = (field, value) => {
      setNewDailyReport(prev => ({ ...prev, income: { ...prev.income, [field]: value } }));
  };
  const calculateTotalDailyIncome = () => {
      const { commonFee, lateFee, water, parking, violation, other } = newDailyReport.income;
      return Number(commonFee) + Number(lateFee) + Number(water) + Number(parking) + Number(violation) + Number(other);
  };
  const handleSaveDailyReport = (e) => {
      e.preventDefault();
      let savedReport;
      if (newDailyReport.id) {
          // Update existing report
          savedReport = { ...newDailyReport };
          setDailyReports(dailyReports.map(r => r.id === newDailyReport.id ? savedReport : r));
      } else {
          // Create new report
          const id = generateId();
          savedReport = { ...newDailyReport, id, projectId: selectedProject.id };
          setDailyReports([...dailyReports, savedReport]);
      }
      setShowAddDailyReportModal(false);
      setSelectedDailyReport(savedReport); // Open view modal immediately
  };

  const handleEditDailyReport = (report) => {
      setSelectedDailyReport(null); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
      setNewDailyReport({ ...report });
      setShowAddDailyReportModal(true); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  };

  // Image Upload for Daily Report
  const handleDailyPerformanceImageUpload = async (dept, file) => {
    if (file) {
        const compressedBase64 = await compressImage(file);
        setNewDailyReport(prev => ({
            ...prev,
            performance: {
                ...prev.performance,
                [dept]: {
                    ...(prev.performance[dept] || { details: '' }),
                    images: [...(prev.performance[dept]?.images || []), compressedBase64]
                }
            }
        }));
    }
  };

  const removeDailyPerformanceImage = (dept, index) => {
      setNewDailyReport(prev => ({
          ...prev,
          performance: {
              ...prev.performance,
              [dept]: {
                  ...(prev.performance[dept] || { details: '' }),
                  images: (prev.performance[dept]?.images || []).filter((_, i) => i !== index)
              }
          }
      }));
  };

  // Asset Handlers
  const handleAssetPhotoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressedBase64 = await compressImage(file);
          setNewAsset(prev => ({ ...prev, photo: compressedBase64 }));
      }
  };

  const handleSaveAsset = (e) => {
      e.preventDefault();
      if (isEditingAsset) {
          setAssets(assets.map(a => a.id === newAsset.id ? { ...newAsset } : a));
          // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
          if (selectedAssetView?.id === newAsset.id) setSelectedAssetView({ ...newAsset });
      } else {
          const id = generateId();
          setAssets([...assets, { id, projectId: selectedProject.id, ...newAsset }]);
      }
      setShowAddAssetModal(false);
      setIsEditingAsset(false);
      setNewAsset({ code: '', name: '', qty: 1, location: '', photo: null, details: '' }); // Reset form
      alert(t('saveSuccess'));
  };

  const handleEditAsset = (asset) => {
      setSelectedAssetView(null); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      setNewAsset({ ...asset });
      setIsEditingAsset(true);
      setShowAddAssetModal(true);
  };

  // Tool Handlers
  const handleToolPhotoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressedBase64 = await compressImage(file);
          setNewTool(prev => ({ ...prev, photo: compressedBase64 }));
      }
  };

  const handleSaveTool = (e) => {
      e.preventDefault();
      if (isEditingTool) {
          setTools(tools.map(t => t.id === newTool.id ? { ...newTool } : t));
          if (selectedToolView?.id === newTool.id) setSelectedToolView({ ...newTool });
      } else {
          const id = generateId();
          setTools([...tools, { id, projectId: selectedProject.id, ...newTool }]);
      }
      setShowAddToolModal(false);
      setIsEditingTool(false);
      setNewTool({ code: '', name: '', qty: 1, location: '', photo: null, details: '' }); // Reset form
      alert(t('saveSuccess'));
  };

  const handleEditTool = (tool) => {
      setSelectedToolView(null); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      setNewTool({ ...tool });
      setIsEditingTool(true);
      setShowAddToolModal(true);
  };

  // Machine Handlers
  const handleMachinePhotoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressedBase64 = await compressImage(file);
          setNewMachine(prev => ({ ...prev, photo: compressedBase64 }));
      }
  };

  const handleSaveMachine = (e) => {
      e.preventDefault();
      if (isEditingMachine) {
          setMachines(machines.map(m => m.id === newMachine.id ? { ...newMachine } : m));
          if (selectedMachineDetails?.id === newMachine.id) setSelectedMachineDetails({ ...newMachine });
      } else {
          const id = generateId();
          setMachines([...machines, { id, projectId: selectedProject.id, ...newMachine }]);
      }
      setShowAddMachineModal(false);
      setIsEditingMachine(false);
      setNewMachine({ code: '', name: '', system: '', qty: 1, location: '', photo: null }); // Reset form
      alert(t('saveSuccess'));
  };

  const handleEditMachine = (machine) => {
      setSelectedMachineDetails(null);
      setNewMachine({ ...machine });
      setIsEditingMachine(true);
      setShowAddMachineModal(true);
  };

  // PM Plan Handlers
  const handleSavePmPlan = (e) => {
      e.preventDefault();
      if (newPmPlan.id) {
          // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          setPmPlans(pmPlans.map(p => p.id === newPmPlan.id ? { ...newPmPlan } : p));
      } else {
          // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
          const id = generateId();
          setPmPlans([...pmPlans, { id, projectId: selectedProject.id, status: 'Active', ...newPmPlan }]);
      }
      setShowAddPmPlanModal(false);
      setNewPmPlan({ id: null, machineId: '', frequency: 'Monthly', scheduleDetails: { dayOfWeek: '1', date: '1', month: '1' } });
      alert(t('saveSuccess'));
  };

  // Repair Handlers
  const handleSaveRepair = (e) => {
      e.preventDefault();
      let savedRepair;
      const existingIndex = repairs.findIndex(r => r.code === newRepair.code);
      
      if (newRepair.id || existingIndex >= 0) {
          // Edit existing repair (‡πÉ‡∏ä‡πâ newRepair.id ‡∏´‡∏£‡∏∑‡∏≠ fallback ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ id ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ä‡∏≥‡∏£‡∏∏‡∏î)
          savedRepair = { ...newRepair, id: newRepair.id || repairs[existingIndex].id };
          setRepairs(repairs.map(r => r.code === newRepair.code ? savedRepair : r));
      } else {
          // Add new repair
          const id = generateId();
          savedRepair = { ...newRepair, id, projectId: selectedProject.id, date: new Date().toISOString().split('T')[0] };
          setRepairs([...repairs, savedRepair]);
      }
      setShowAddRepairModal(false);
      setNewRepair({ id: null, code: '', roomNo: '', floor: '', requesterName: '', phone: '', issueType: '', issueTypeOther: '', issueDetails: '', inspectionResult: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', staffDetails: '', cost: '', staffName: '', requesterSignName: '' });
      setSelectedRepairView(savedRepair); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á Print ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  };

  const handleEditRepair = (rep) => {
      setSelectedRepairView(null); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      setNewRepair({ ...rep });
      setShowAddRepairModal(true);
  };

  // Utilities Handlers
  const handleSaveUtilityReading = (e) => {
      e.preventDefault();
      if (!utilityForm.meterId || !utilityForm.currentValue) return;

      const projectMeters = meters.filter(m => m.projectId === selectedProject.id);
      const currentMeterIndex = projectMeters.findIndex(m => m.id === utilityForm.meterId);
      const meter = projectMeters[currentMeterIndex];

      const currentValNum = parseFloat(utilityForm.currentValue);

      if (utilityForm.id) {
          // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Mode)
          const existingReading = utilityReadings.find(r => r.id === utilityForm.id);
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤ (prevValue) ‡πÄ‡∏î‡∏¥‡∏°
          const updatedUsage = currentValNum - (existingReading ? existingReading.prevValue : 0);
          
          const updatedReading = {
              ...existingReading,
              date: utilityForm.date,
              value: currentValNum,
              usage: updatedUsage,
              recorder: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'System'
          };

          const newUtilityReadings = utilityReadings.map(r => r.id === utilityForm.id ? updatedReading : r);
          setUtilityReadings(newUtilityReadings);
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          const meterReadings = newUtilityReadings.filter(r => r.meterId === meter.id);
          const latestReading = meterReadings.sort((a,b) => new Date(b.date) - new Date(a.date))[0];
          if (latestReading) {
              setMeters(meters.map(m => m.id === meter.id ? { ...m, lastReading: latestReading.value, lastDate: latestReading.date } : m));
          }

          alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          setUtilityForm({ id: null, meterId: utilityForm.meterId, date: new Date().toISOString().split('T')[0], currentValue: '' });

      } else {
          // ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà (Create Mode)
          const prevVal = meter ? meter.lastReading : 0;
          const usage = currentValNum - prevVal;

          const newReading = {
              id: generateId(),
              meterId: utilityForm.meterId,
              date: utilityForm.date,
              value: currentValNum,
              prevValue: prevVal,
              usage: usage,
              recorder: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'System'
          };

          setUtilityReadings([...utilityReadings, newReading]);
          
          // Update meter's last reading
          setMeters(meters.map(m => 
              m.id === utilityForm.meterId 
                  ? { ...m, lastReading: currentValNum, lastDate: utilityForm.date }
                  : m
          ));

          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
          if (currentMeterIndex >= 0 && currentMeterIndex < projectMeters.length - 1) {
              const nextMeterId = projectMeters[currentMeterIndex + 1].id;
              setUtilityForm({ id: null, meterId: nextMeterId, date: new Date().toISOString().split('T')[0], currentValue: '' }); // Reset ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
              
              // Focus ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
              setTimeout(() => {
                  if (currentValueRef.current) {
                      currentValueRef.current.focus();
                  }
              }, 50);
          } else {
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß
              setUtilityForm({ id: null, meterId: '', date: new Date().toISOString().split('T')[0], currentValue: '' });
              alert('üéâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
          }
      }
  };

  const handleEditUtilityReading = (reading) => {
      setUtilityForm({
          id: reading.id,
          meterId: reading.meterId,
          date: reading.date,
          currentValue: reading.value.toString()
      });
      // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Scroll ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡∏∞ Focus ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
      setTimeout(() => {
          if (currentValueRef.current) {
              currentValueRef.current.focus();
          }
      }, 50);
  };

  const handleSaveMeter = (e) => {
      e.preventDefault();
      const initVal = parseFloat(newMeter.initialValue) || 0;
      
      if (newMeter.id) {
          // Edit Mode
          setMeters(meters.map(m => m.id === newMeter.id ? {
              ...m,
              type: newMeter.type,
              code: newMeter.code,
              name: newMeter.name || (newMeter.type === 'Water' ? '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤'),
              location: newMeter.location,
              lastReading: initVal // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤/‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ
          } : m));
      } else {
          // Create Mode
          const id = generateId();
          const meterToAdd = {
              id,
              projectId: selectedProject.id,
              type: newMeter.type,
              code: newMeter.code,
              name: newMeter.name || (newMeter.type === 'Water' ? '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : '‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤'),
              location: newMeter.location,
              lastReading: initVal,
              lastDate: new Date().toISOString().split('T')[0]
          };
          setMeters([...meters, meterToAdd]);
      }
      
      setShowAddMeterModal(false);
      setNewMeter({ id: null, type: 'Water', code: '', name: '', location: '', initialValue: '' });
      alert(t('saveSuccess'));
  };

  const handleEditMeter = (meter) => {
      setNewMeter({
          id: meter.id,
          type: meter.type,
          code: meter.code,
          name: meter.name,
          location: meter.location || '',
          initialValue: meter.lastReading.toString() // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ
      });
      setShowAddMeterModal(true);
  };

  // --- NEW: Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå ---
  const toggleMeterVisibility = (meterId) => {
      setHiddenAnalysisMeters(prev => {
          const nextSet = new Set(prev);
          if (nextSet.has(meterId)) nextSet.delete(meterId);
          else nextSet.add(meterId);
          return nextSet;
      });
  };
  // ----------------------------------------------------

  const handleSaveActionPlan = (e) => {
      e.preventDefault();
      
      const finalResponsible = newActionPlan.responsible?.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') ? newActionPlan.otherResponsible : newActionPlan.responsible;
      const dataToSave = { ...newActionPlan, responsible: finalResponsible };

      if (newActionPlan.id) {
          // Edit existing action plan
          setActionPlans(actionPlans.map(ap => ap.id === newActionPlan.id ? dataToSave : ap));
      } else {
          // Add new action plan
          const id = generateId();
          setActionPlans([...actionPlans, { ...dataToSave, id, projectId: selectedProject.id }]);
      }
      setShowAddActionPlanModal(false);
      setNewActionPlan({ id: null, issue: '', details: '', responsible: '', otherResponsible: '', startDate: new Date().toISOString().split('T')[0], deadline: '', status: 'Pending' });
      alert(t('saveSuccess'));
  };

  const handleSaveCompanyInfo = (e) => {
      e.preventDefault();
      setCompanyInfo(editCompanyForm);
      setShowEditCompanyModal(false);
      alert(t('saveSuccess'));
  };

  const handleEditActionPlan = (ap) => {
      let resp = ap.responsible || '';
      let otherResp = '';
      
      if (resp && !EMPLOYEE_POSITIONS.includes(resp)) {
          otherResp = resp;
          const otherOption = EMPLOYEE_POSITIONS.find(p => p.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ'));
          resp = otherOption || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏) / Other (Please specify)';
      }

      setNewActionPlan({ ...ap, responsible: resp, otherResponsible: otherResp });
      setShowAddActionPlanModal(true);
  };
  
  const handleActionPlanStatusChange = (id, newStatus) => {
      setActionPlans(actionPlans.map(ap => ap.id === id ? { ...ap, status: newStatus } : ap));
  };

  const handleContractFileUpload = (e) => {
      const file = e.target.files[0];
      if (file) {
          const reader = new FileReader();
          reader.onloadend = async () => {
              const fileId = generateId();
              await saveFileLocally(fileId, reader.result);
              setNewContract(prev => ({ ...prev, file: { name: file.name, fileId: fileId, isLocal: true } }));
          };
          reader.readAsDataURL(file);
      }
  };

  const handleCompanyLogoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressedBase64 = await compressImage(file);
          setEditCompanyForm(prev => ({ ...prev, logo: compressedBase64 }));
      }
  };
  
  // Others Handlers
  const handleSaveOther = (e) => {
      e.preventDefault();
      if (newOther.id) {
          setOthersData(othersData.map(o => o.id === newOther.id ? { ...newOther } : o));
      } else {
          const id = generateId();
          setOthersData([...othersData, { ...newOther, id, projectId: selectedProject.id }]);
      }
      setShowAddOtherModal(false);
      setNewOther({ id: null, title: '', details: '', link: '' });
      alert(t('saveSuccess'));
  };

  // Audit Handlers
  const handleAuditScoreChange = (catIdx, itemIdx, score) => {
      setNewAudit(prev => ({
          ...prev,
          scores: { ...prev.scores, [`${catIdx}_${itemIdx}`]: score }
      }));
  };

  const handleAuditRemarkChange = (catIdx, itemIdx, text) => {
      setNewAudit(prev => ({
          ...prev,
          remarks: { ...prev.remarks, [`${catIdx}_${itemIdx}`]: text }
      }));
  };

  const calculateTotalAuditScore = () => {
      return Object.values(newAudit.scores).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
  };

  const handleSaveAudit = (e) => {
      e.preventDefault();
      if (!newAudit.projectId) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô");
          return;
      }
      
      const totalScore = calculateTotalAuditScore();
      const percentScore = Math.round((totalScore / 235) * 100);
      
      const id = generateId();
      const auditToSave = {
          id,
          projectId: newAudit.projectId,
          date: newAudit.date,
          category: newAudit.type,
          score: percentScore, // Save as percentage for compatibility with existing UI
          rawScore: totalScore,
          inspector: newAudit.inspector,
          remarks: newAudit.additionalComments || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
          fileUrl: null,
          itemScores: newAudit.scores, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠
          itemRemarks: newAudit.remarks // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠
      };
      
      setAudits([auditToSave, ...audits]);
      setShowAddAuditModal(false);
      setNewAudit({
          projectId: '',
          date: new Date().toISOString().split('T')[0],
          inspector: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : '',
          type: 'Internal Audit',
          scores: {},
          remarks: {},
          additionalComments: ''
      });
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  };

  // --- NEW: Handlers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ---
  const handleEditFormItem = (form) => {
      setNewFormItem({ ...form });
      setShowAddFormModal(true);
  };

  const handleSaveFormItem = (e) => {
      e.preventDefault();
      if (newFormItem.id) {
          setFormsList(formsList.map(f => f.id === newFormItem.id ? { ...newFormItem, lastUpdated: new Date().toISOString().split('T')[0] } : f));
      } else {
          const id = 'f_custom_' + generateId();
          setFormsList([...formsList, { ...newFormItem, id, lastUpdated: new Date().toISOString().split('T')[0] }]);
      }
      setShowAddFormModal(false);
      alert(t('saveSuccess'));
  };

  // --- NEW: Backup & Restore Handlers ---
  const handleExportBackup = async () => {
      setIsBackingUp(true);
      try {
          // ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å IndexedDB ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          const localFiles = await getAllFilesLocally();
          
          const backupData = {
              timestamp: new Date().toISOString(),
              version: '1.1', // Updated Version
              data: {
                  companyInfo,
                  users,
                  projects,
                  contracts,
                  assets,
                  tools,
                  machines,
                  pmPlans,
                  pmHistoryList,
                  meters,
                  utilityReadings,
                  repairs,
                  actionPlans,
                  contractors,
                  formsList,
                  audits,
                  dailyReports,
                  schedules,
                  scheduleNotes,
                  scheduleApprovals,
                  projectStaffOrder,
                  othersData,
                  theme,
                  rolePermissions, // Include role permissions in backup
                  localFiles // ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å IndexedDB ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
              }
          };
          
          const dataStr = JSON.stringify(backupData);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `BMG_System_Backup_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
      } catch (error) {
          console.error("Backup error:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      } finally {
          setIsBackingUp(false);
      }
  };

  const handleImportBackup = (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
          try {
              const importedData = JSON.parse(e.target.result);
              
              if (!importedData.data || !importedData.timestamp) {
                  alert("‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Invalid backup file format)");
                  return;
              }

              showConfirm(
                  '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)',
                  '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á: ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö (Overwrite) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Backup ‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?',
                  async () => {
                      setIsRestoring(true);
                      try {
                          const d = importedData.data;
                          
                          // 1. ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏•‡∏á IndexedDB
                          if (d.localFiles) {
                              for (const [fileId, fileData] of Object.entries(d.localFiles)) {
                                  await saveFileLocally(fileId, fileData);
                              }
                          }

                          // 2. ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô State ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                          if (d.companyInfo) setCompanyInfo(d.companyInfo);
                          if (d.users) setUsers(d.users);
                          if (d.projects) setProjects(d.projects);
                          if (d.contracts) setContracts(d.contracts);
                          if (d.assets) setAssets(d.assets);
                          if (d.tools) setTools(d.tools);
                          if (d.machines) setMachines(d.machines);
                          if (d.pmPlans) setPmPlans(d.pmPlans);
                          if (d.pmHistoryList) setPmHistoryList(d.pmHistoryList);
                          if (d.meters) setMeters(d.meters);
                          if (d.utilityReadings) setUtilityReadings(d.utilityReadings);
                          if (d.repairs) setRepairs(d.repairs);
                          if (d.actionPlans) setActionPlans(d.actionPlans);
                          if (d.contractors) setContractors(d.contractors);
                          if (d.formsList) setFormsList(d.formsList);
                          if (d.audits) setAudits(d.audits);
                          if (d.dailyReports) setDailyReports(d.dailyReports);
                          if (d.schedules) setSchedules(d.schedules);
                          if (d.scheduleNotes) setScheduleNotes(d.scheduleNotes);
                          if (d.scheduleApprovals) setScheduleApprovals(d.scheduleApprovals);
                          if (d.projectStaffOrder) setProjectStaffOrder(d.projectStaffOrder);
                          if (d.othersData) setOthersData(d.othersData);
                          if (d.theme) setTheme(d.theme);
                          if (d.rolePermissions) setRolePermissions(d.rolePermissions); // Restore role permissions

                          alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Restore successful)");
                      } catch (err) {
                          console.error("Restore state error:", err);
                          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                      } finally {
                          setIsRestoring(false);
                      }
                  }
              );
          } catch (error) {
              console.error("Import error:", error);
              alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Backup (.json) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          }
      };
      reader.readAsText(file);
  };

  // --- NEW: Google Sheets Sync Handler ---
  const handleSyncToGoogleSheets = async () => {
      // ‚ùó ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ô‡∏≥ Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzmNdR7LVpfUossHkcNH_onBPTG2dw6GuJzh5JilthkMwW-Sdr4s0lFjPKwSsCBTg/exec';
      
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤ Placeholder ‡πÄ‡∏î‡∏¥‡∏°
      if(!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_WEB_APP_URL_HERE') {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥ Web App URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
          return;
      }

      setIsSyncingSheets(true);
      try {
          // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheets
          const payload = {
              'Users_‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': users,
              'Projects_‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': projects,
              'Contracts_‡∏™‡∏±‡∏ç‡∏ç‡∏≤': contracts,
              'Contractors_‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤': contractors,
              'Assets_‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô': assets.map(a => ({...a, photo: a.photo ? 'Base64 Image' : ''})), // ‡∏ã‡πà‡∏≠‡∏ô Base64 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î
              'Tools_‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠': tools.map(t => ({...t, photo: t.photo ? 'Base64 Image' : ''})),
              'Machines_‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£': machines.map(m => ({...m, photo: m.photo ? 'Base64 Image' : ''})),
              'PM_Plans_‡πÅ‡∏ú‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤': pmPlans,
              'PM_History_‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥PM': pmHistoryList.map(h => ({...h, images: h.images?.length ? 'Photos attached' : ''})),
              'Repairs_‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°': repairs,
              'ActionPlans_‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô': actionPlans,
              'Audits_‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û': audits,
              'UtilityMeters_‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå': meters,
              'UtilityReadings_‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå': utilityReadings,
              'DailyReports_‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô': dailyReports
          };

          const response = await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              // ‡πÉ‡∏ä‡πâ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Browser ‡∏¢‡∏¥‡∏á OPTIONS preflight request ‡∏ó‡∏µ‡πà GAS ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (result.status === 'success') {
              alert("‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
          } else {
              alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: " + result.message);
          }
      } catch (error) {
          console.error("Sync error:", error);
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      } finally {
          setIsSyncingSheets(false);
      }
  };

  // --- NEW: Google Drive Backup Handler ---
  const handleBackupToDrive = async () => {
      // ‚ùó ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ô‡∏≥ Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Drive ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
      const GOOGLE_SCRIPT_DRIVE_URL = 'https://script.google.com/macros/s/AKfycbzQYEwfj3xz-kACA43pNbnpcuPY9p3Vg039t-HqDaAIU7hf7WXswEf1MXlapdv3jU5tnw/exec';
      
      if(!GOOGLE_SCRIPT_DRIVE_URL || GOOGLE_SCRIPT_DRIVE_URL === 'YOUR_GOOGLE_SCRIPT_DRIVE_URL_HERE') {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥ Web App URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Drive ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
          return;
      }

      setIsBackingUpToDrive(true);
      try {
          const filesToUpload = [];

          // 1. ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å IndexedDB (‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ)
          const localFiles = await getAllFilesLocally();
          for (const [fileId, fileData] of Object.entries(localFiles)) {
              if (typeof fileData === 'string' && fileData.includes('base64,')) {
                  filesToUpload.push({ name: `Document_${fileId}.pdf`, data: fileData });
              }
          }

          // 2. ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          if(companyInfo.logo) filesToUpload.push({ name: 'Company_Logo.jpg', data: companyInfo.logo });
          users.forEach(u => { if(u.photo) filesToUpload.push({ name: `User_${u.employeeId || u.id}.jpg`, data: u.photo }) });
          assets.forEach(a => { if(a.photo) filesToUpload.push({ name: `Asset_${a.code}.jpg`, data: a.photo }) });
          tools.forEach(t => { if(t.photo) filesToUpload.push({ name: `Tool_${t.code}.jpg`, data: t.photo }) });
          machines.forEach(m => { if(m.photo) filesToUpload.push({ name: `Machine_${m.code}.jpg`, data: m.photo }) });
          
          // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ PM (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)
          pmHistoryList.forEach(pm => {
              if (pm.images && pm.images.length > 0) {
                  pm.images.forEach((img, idx) => {
                      filesToUpload.push({ name: `PM_${pm.machineCode}_img${idx+1}.jpg`, data: img });
                  });
              }
          });

          if(filesToUpload.length === 0) {
              alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
              setIsBackingUpToDrive(false);
              return;
          }

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡πà‡∏≠‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏î Backup)
          const now = new Date();
          const folderDate = now.toLocaleDateString('th-TH', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
          const folderTime = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace(/:/g, '-');
          const autoFolderName = `BMG_Backup_${folderDate}_${folderTime}`;

          let successCount = 0;
          let failCount = 0;

          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î Payload ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á Apps Script
          for (let i = 0; i < filesToUpload.length; i++) {
              const file = filesToUpload[i];
              // ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (mimeType) ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (base64) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô
              const match = file.data.match(/^data:(.+);base64,(.+)$/);
              if (!match) continue;
              
              const mimeType = match[1];
              const base64Data = match[2];

              const payload = {
                  filename: file.name,
                  mimeType: mimeType,
                  data: base64Data,
                  folderName: autoFolderName // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script
              };

              try {
                  const response = await fetch(GOOGLE_SCRIPT_DRIVE_URL, {
                      method: 'POST',
                      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                      body: JSON.stringify(payload)
                  });
                  
                  if (!response.ok) {
                      throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  
                  const result = await response.json();
                  if (result.status === 'success') {
                      successCount++;
                  } else {
                      console.error("Script error:", result.message);
                      failCount++;
                  }
              } catch (err) {
                  console.error("Upload error for file:", file.name, err);
                  failCount++;
              }
          }

          alert(`‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡πÑ‡∏ü‡∏•‡πå\n‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failCount} ‡πÑ‡∏ü‡∏•‡πå\n\n‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ${autoFolderName}`);

      } catch (error) {
          console.error("Drive Backup error:", error);
          alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive");
      } finally {
          setIsBackingUpToDrive(false);
      }
  };
  // ----------------------------------------

  // --- Restored Handlers ---
  const calculateDaysRemaining = (endDateStr) => {
      if (!endDateStr) return 0;
      const end = new Date(endDateStr);
      const today = new Date();
      const diffTime = end.getTime() - today.getTime();
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  };

  const handlePhotoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressed = await compressImage(file);
          setNewUser(prev => ({ ...prev, photo: compressed }));
      }
  };

  const handleAddAccessibleDept = (e) => {
      const dept = e.target.value;
      if (dept && !newUser.accessibleDepts.includes(dept)) {
          setNewUser(prev => ({ ...prev, accessibleDepts: [...prev.accessibleDepts, dept] }));
      }
      e.target.value = "";
  };

  const removeAccessibleDept = (dept) => {
      setNewUser(prev => ({ ...prev, accessibleDepts: prev.accessibleDepts.filter(d => d !== dept) }));
  };

  const handlePermissionChange = (menuId, ptype, value) => {
      setNewUser(prev => ({
          ...prev,
          permissions: {
              ...prev.permissions,
              [menuId]: { ...(prev.permissions[menuId] || {}), [ptype]: value }
          }
      }));
  };

  const handlePermissionAll = (menuId, value) => {
      setNewUser(prev => ({
          ...prev,
          permissions: {
              ...prev.permissions,
              [menuId]: { view: value, save: value, edit: value, approve: value, delete: value, print: value }
          }
      }));
  };

  // NEW: Handlers for Role Permissions Modal
  const handleRolePermissionChange = (menuId, ptype, value) => {
      setEditingRolePerms(prev => ({
          ...prev,
          [menuId]: { ...(prev[menuId] || {}), [ptype]: value }
      }));
  };

  const handleRolePermissionAll = (menuId, value) => {
      setEditingRolePerms(prev => ({
          ...prev,
          [menuId]: { view: value, save: value, edit: value, approve: value, delete: value, print: value }
      }));
  };

  const handleSaveUser = (e) => {
      e.preventDefault();
      if (isEditingUser) {
          setUsers(users.map(u => u.id === newUser.id ? { ...newUser } : u));
      } else {
          setUsers([...users, { id: generateId(), status: 'Active', created_at: new Date().toISOString(), ...newUser }]);
      }
      setShowAddUserModal(false);
      alert(t('saveSuccess'));
  };

  const handleEditUser = (user) => {
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• accessibleDepts ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏™‡∏°‡∏≠ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error
      let depts = user.accessibleDepts || [];
      if (typeof depts === 'string') {
          depts = depts.split(', ').filter(Boolean);
      }

      setNewUser({ 
          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô undefined
          employeeId: '',
          firstName: '',
          lastName: '',
          otherPosition: '',
          department: '',
          phone: '',
          username: '',
          password: '',
          photo: null,
          ...user,
          // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å user ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          position: user.position || EMPLOYEE_POSITIONS[0],
          accessibleDepts: depts,
          permissions: user.permissions || getDefaultPermissions(),
      });
      setIsEditingUser(true);
      setShowAddUserModal(true);
  };

  const handleLogoUpload = async (e) => {
      const file = e.target.files[0];
      if (file) {
          const compressed = await compressImage(file);
          setNewProject(prev => ({ ...prev, logo: compressed }));
      }
  };

  const handleProjectFileUpload = (e, key) => {
      const file = e.target.files[0];
      if (file) {
          const reader = new FileReader();
          reader.onloadend = async () => {
              const fileId = generateId();
              await saveFileLocally(fileId, reader.result);
              setNewProject(prev => ({ 
                  ...prev, 
                  files: { 
                      ...(prev.files || {}), 
                      [key]: { name: file.name, fileId: fileId, isLocal: true } 
                  } 
              }));
          };
          reader.readAsDataURL(file);
      }
  };

  const handleSaveProject = (e) => {
      e.preventDefault();
      if (isEditingProject) {
          setProjects(projects.map(p => p.id === newProject.id ? { ...newProject } : p));
          if (selectedProject?.id === newProject.id) setSelectedProject({ ...newProject });
      } else {
          setProjects([...projects, { id: generateId(), ...newProject }]);
      }
      setShowAddProjectModal(false);
      alert(t('saveSuccess'));
  };

  const handleEditProjectClick = () => {
      setNewProject({ files: { orchor: null, committee: null, regulations: null, resident_rules: null }, ...selectedProject });
      setIsEditingProject(true);
      setShowAddProjectModal(true);
  };

  const handleSaveContract = (e) => {
      e.preventDefault();
      const finalCategory = newContract.category.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') ? newContract.customCategory : newContract.category;
      
      if (isEditingContract) {
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏î‡∏¥‡∏°
          const updatedContract = { ...newContract, category: finalCategory };
          setContracts(contracts.map(c => c.id === newContract.id ? updatedContract : c));
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
          if (selectedContractView?.id === newContract.id) {
              setSelectedContractView(updatedContract);
          }
      } else {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà
          setContracts([...contracts, { 
              id: generateId(), 
              projectId: selectedProject.id, 
              status: 'Active', 
              ...newContract,
              category: finalCategory
          }]);
      }
      
      setShowAddContractModal(false);
      setIsEditingContract(false);
      setNewContract({ type: CONTRACT_TYPES.EXPENSE, category: '', customCategory: '', vendorName: '', contactPerson: '', contactPhone: '', startDate: '', endDate: '', amount: '', paymentCycle: 'Monthly', file: null });
      alert(t('saveSuccess'));
  };

  const handleEditContract = (contract) => {
      setSelectedContractView(null); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      let cat = contract.category;
      let customCat = '';
      const availableCategories = SERVICE_TYPES[contract.type] || [];
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ category ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!availableCategories.includes(cat)) {
          customCat = cat;
          cat = availableCategories.find(c => c.includes('‡∏≠‡∏∑‡πà‡∏ô‡πÜ')) || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)';
      }
      
      setNewContract({ ...contract, category: cat, customCategory: customCat });
      setIsEditingContract(true);
      setShowAddContractModal(true);
  };

  const handleAddStaffToProject = () => {
      setIsEditingUser(false);
      setNewUser({ employeeId: '', firstName: '', lastName: '', position: EMPLOYEE_POSITIONS[0], otherPosition: '', department: selectedProject.name, accessibleDepts: [], phone: '', username: '', password: '', photo: null, permissions: getDefaultPermissions() });
      setShowAddUserModal(true);
  };

  const updateSchedule = (userId, dateString, shiftId, type = 'plan') => {
      const key = type === 'plan' ? `${userId}_${dateString}` : `${userId}_${dateString}_act`;
      setSchedules(prev => ({ ...prev, [key]: shiftId }));
  };

  // ... (View Components) ...
  const renderLoginView = () => (
    <div className="min-h-screen flex items-center justify-center bg-black p-4 relative overflow-hidden">
      {/* Decorative Background Elements */}
      <div className="absolute top-[10%] left-[15%] w-72 h-72 bg-orange-600 rounded-full filter blur-[120px] opacity-30"></div>
      <div className="absolute bottom-[10%] right-[15%] w-80 h-80 bg-red-600 rounded-full filter blur-[120px] opacity-30"></div>
      
      <div className="bg-gray-900/80 backdrop-blur-xl p-8 md:p-10 rounded-[2rem] shadow-2xl w-full max-w-md border border-gray-800 relative z-10">
        
        {/* Header Section */}
        <div className="flex flex-col items-center text-center mb-10">
          <h1 className="flex items-baseline justify-center gap-2 mb-2">
            <span 
                className="text-7xl font-black tracking-tighter z-10" 
                style={{ 
                    background: 'linear-gradient(to bottom, rgba(255, 255, 255, 0.95) 0%, rgba(253, 186, 116, 0.6) 45%, rgba(234, 88, 12, 0.4) 50%, rgba(194, 65, 12, 0.8) 100%)',
                    WebkitBackgroundClip: 'text',
                    WebkitTextFillColor: 'transparent',
                    filter: 'drop-shadow(0 8px 12px rgba(234, 88, 12, 0.4))',
                    WebkitTextStroke: '1.5px rgba(255, 255, 255, 0.8)'
                }}
            >
                BMG
            </span>
            <span className="text-5xl font-bold text-white transform -rotate-2" style={{ fontFamily: "'Caveat', cursive" }}>Connect</span>
          </h1>
          <p className="text-sm text-gray-400 font-medium tracking-wide mt-1 uppercase">{t('systemMgmt')} - {t('signIn')}</p>
        </div>
        
        {/* Login Form */}
        <form onSubmit={handleLogin} className="space-y-5">
          <div>
              <label className="block text-sm font-bold text-gray-300 mb-1.5 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
              <div className="relative">
                  <User className="absolute left-4 top-3.5 text-gray-500" size={18} />
                  <input 
                      type="text" 
                      className="pl-11 block w-full rounded-xl border-gray-700 shadow-sm p-3 border focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all bg-gray-800/50 text-white placeholder-gray-500 focus:bg-gray-800" 
                      value={loginForm.username} 
                      onChange={e => setLoginForm({...loginForm, username: e.target.value})} 
                      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" 
                  />
              </div>
          </div>
          <div>
              <label className="block text-sm font-bold text-gray-300 mb-1.5 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <div className="relative">
                  <Lock className="absolute left-4 top-3.5 text-gray-500" size={18} />
                  <input 
                      type={showPassword ? "text" : "password"} 
                      className="pl-11 pr-12 block w-full rounded-xl border-gray-700 shadow-sm p-3 border focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all bg-gray-800/50 text-white placeholder-gray-500 focus:bg-gray-800" 
                      value={loginForm.password} 
                      onChange={e => setLoginForm({...loginForm, password: e.target.value})} 
                      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
                  />
                  <button 
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-4 top-3.5 text-gray-500 hover:text-gray-300 focus:outline-none transition-colors"
                  >
                      {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                  </button>
              </div>
          </div>
          
          {loginError && (
              <div className="bg-red-900/30 text-red-400 text-sm p-3 rounded-xl border border-red-800/50 flex items-center gap-2 animate-fade-in">
                  <AlertTriangle size={16} className="shrink-0"/> {loginError}
              </div>
          )}
          
          <button 
              type="submit" 
              className="w-full text-white font-bold py-3.5 px-4 rounded-xl transform hover:-translate-y-1 hover:scale-[1.02] transition-all duration-300 mt-6 relative overflow-hidden group" 
              style={{
                  background: 'linear-gradient(135deg, rgba(255, 140, 0, 0.7) 0%, rgba(234, 67, 0, 0.95) 100%)',
                  backdropFilter: 'blur(10px)',
                  boxShadow: '0 8px 25px rgba(234, 88, 12, 0.5), inset 0 2px 2px rgba(255, 255, 255, 0.6), inset 0 -2px 4px rgba(0, 0, 0, 0.2)',
                  border: '1px solid rgba(255, 255, 255, 0.4)'
              }}
          >
              {/* ‡πÅ‡∏™‡∏á‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ß‡∏¥‡πà‡∏á‡∏û‡∏≤‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Hover */}
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 transform -translate-x-[150%] group-hover:translate-x-[150%] transition-transform duration-700 ease-in-out skew-x-12"></div>
              <span className="relative z-10 text-lg tracking-wider" style={{ textShadow: '0 2px 4px rgba(0,0,0,0.4)' }}>
                  {t('signIn')}
              </span>
          </button>
        </form>
        
        {/* Footer */}
        <div className="mt-8 text-center text-xs text-gray-500 border-t border-gray-800 pt-6">
            {t('poweredBy')}
        </div>
      </div>
    </div>
  );

  const Sidebar = () => {
    const canAccessMultiple = canAccessMultipleProjects();

    return (
      <>
        {/* Mobile Backdrop Overlay */}
        {isMobileMenuOpen && !isExporting && (
          <div 
            className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm transition-opacity"
            onClick={() => setIsMobileMenuOpen(false)}
          ></div>
        )}
        
        <div className={`w-64 bg-gray-900 text-white flex flex-col h-screen fixed left-0 top-0 overflow-y-auto custom-scrollbar z-50 transform transition-transform duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} ${isSidebarOpen ? 'lg:translate-x-0' : 'lg:-translate-x-full'} ${isExporting ? 'hidden' : ''}`}>
        <div 
          className={`p-6 border-b border-gray-800 flex justify-between items-start relative ${currentUser?.username === 'admin' ? 'cursor-pointer hover:bg-gray-800 transition-colors group' : ''}`}
          onClick={() => {
              if (currentUser?.username === 'admin') {
                  setEditCompanyForm({ ...companyInfo });
                  setShowEditCompanyModal(true);
                  setIsMobileMenuOpen(false);
              }
          }}
          title={currentUser?.username === 'admin' ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£" : ""}
        >
          <div className="flex items-center gap-3 overflow-hidden">
              {companyInfo.logo && (
                  <div className="w-10 h-10 bg-white rounded flex items-center justify-center shrink-0 overflow-hidden p-0.5">
                      <img src={companyInfo.logo} alt="Company Logo" className="w-full h-full object-contain" />
                  </div>
              )}
              <div className="flex-1 min-w-0">
                  <h2 className="text-xl font-bold tracking-wider text-orange-500 truncate flex items-center gap-2">
                      {companyInfo.name}
                      {currentUser?.username === 'admin' && <Edit size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" />}
                  </h2>
                  <p className="text-xs text-gray-400 mt-1 truncate">{companyInfo.subtitle}</p>
              </div>
          </div>
          <div className="absolute top-6 right-4 flex gap-1.5">
              <button 
                  onClick={(e) => { 
                      e.stopPropagation(); 
                      const themes = ['light', 'dark', 'sweet', 'crimson', 'sunset'];
                      const nextIndex = (themes.indexOf(theme) + 1) % themes.length;
                      setTheme(themes[nextIndex] || 'light');
                  }} 
                  className="text-gray-500 hover:text-white flex items-center justify-center w-7 h-7 border border-gray-700 rounded bg-gray-900 group-hover:bg-gray-800 transition-colors"
                  title={`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏° (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${theme})`}
              >
                  {theme === 'light' ? <Moon size={14} /> : 
                   theme === 'dark' ? <Heart size={14} className="text-pink-400" /> : 
                   theme === 'sweet' ? <Droplet size={14} className="text-red-600" /> : 
                   theme === 'crimson' ? <Sun size={14} className="text-orange-500" /> : 
                   <Sun size={14} className="text-yellow-400" />}
              </button>
              <button 
                  onClick={(e) => { e.stopPropagation(); setLang(lang === 'th' ? 'en' : 'th') }} 
                  className="text-gray-500 hover:text-white flex items-center gap-1 text-xs border border-gray-700 rounded px-2 py-1 bg-gray-900 group-hover:bg-gray-800 transition-colors"
                  title="Change Language"
              >
                  <Globe size={12} /> {lang.toUpperCase()}
              </button>
              <button 
                  onClick={(e) => { e.stopPropagation(); setIsMobileMenuOpen(false); setIsSidebarOpen(false); }} 
                  className="text-gray-400 hover:text-white flex items-center justify-center w-7 h-7 border border-gray-700 rounded bg-gray-900 hover:bg-red-500 hover:border-red-500 transition-colors ml-1"
                  title="‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π (Hide Menu)"
              >
                  <X size={14} className="lg:hidden" />
                  <ChevronLeft size={16} className="hidden lg:block" />
              </button>
          </div>
        </div>
        <nav className="flex-1 p-4 space-y-1">
          {!selectedProject ? (
              <>
                  {(canAccessMultiple && hasPerm('dashboard')) && <SidebarItem icon={BarChart3} label={t('menu_dashboard')} id="dashboard" />}
                  {(canAccessMultiple && hasPerm('users')) && <SidebarItem icon={Users} label={t('menu_users')} id="users" />}
                  {(canAccessMultiple && hasPerm('projects')) && <SidebarItem icon={Building2} label={t('menu_projects')} id="projects" />}
                  {(canAccessMultiple && hasPerm('audits')) && <SidebarItem icon={ClipboardCheck} label={t('menu_audits')} id="audits" />}
                  
                  {/* ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô */}
                  <SidebarItem icon={BookOpen} label={t('menu_manual')} id="manual" />

                  {/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô */}
                  {(canAccessMultiple && currentUser?.username === 'admin') && <SidebarItem icon={Settings} label={t('menu_settings')} id="settings" />}
                  
                  {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡πÄ‡∏ú‡∏•‡∏≠‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */}
                  {!canAccessMultiple && (
                      <div className="p-4 text-xs text-gray-500 text-center mt-4 border border-dashed border-gray-700 rounded-lg">
                          ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
                      </div>
                  )}
              </>
          ) : (
              <>
                  {/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô */}
                  {canAccessMultiple && (
                      <button 
                          onClick={() => { setSelectedProject(null); setIsMobileMenuOpen(false); }} 
                          className="w-full flex items-center gap-2 px-4 py-2 mb-4 text-sm text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors border border-gray-700"
                      >
                          <ArrowRight size={16} className="rotate-180" /> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                      </button>
                  )}
                  <div 
                      className={`px-4 mb-2 text-[11px] font-bold text-orange-400 uppercase tracking-wider truncate flex justify-between items-center group ${hasPerm('projects', 'edit') ? 'cursor-pointer hover:bg-gray-800 py-1.5 rounded mx-2 transition-colors' : ''}`} 
                      title={hasPerm('projects', 'edit') ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" : ""}
                      onClick={() => { if(hasPerm('projects', 'edit')) { handleEditProjectClick(); setIsMobileMenuOpen(false); } }}
                  >
                      <span className="truncate">{selectedProject.name}</span>
                      {hasPerm('projects', 'edit') && <Edit size={14} className="text-gray-500 group-hover:text-orange-400 transition-colors shrink-0" />}
                  </div>
                  {PROJECT_TABS.filter(tab => hasPerm(`proj_${tab.id}`)).map(tab => (
                      <button
                          key={tab.id}
                          onClick={() => { setProjectTab(tab.id); setIsMobileMenuOpen(false); }}
                          className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg transition-all text-sm mb-1 ${projectTab === tab.id ? 'bg-orange-600 text-white shadow-md font-medium' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}
                      >
                          <tab.icon size={18} />
                          <span>{t(tab.label)}</span>
                      </button>
                  ))}
              </>
          )}
        </nav>
        <div className="p-4 border-t border-gray-800">
          <div className="flex items-center gap-3 mb-4"><div className="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-sm font-bold">{currentUser?.firstName?.charAt(0) || 'U'}</div><div><div className="text-sm font-medium">{currentUser?.firstName}</div><div className="text-xs text-gray-400">{currentUser?.position}</div></div></div>
          <button onClick={handleLogout} className="flex items-center gap-2 text-red-400 hover:text-red-300 text-sm w-full"><LogOut size={16} /> {t('signOut')}</button>
        </div>
      </div>
      </>
    );
  };
  const SidebarItem = ({ icon: Icon, label, id }) => (<button onClick={() => { setActiveMenu(id); setSelectedProject(null); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeMenu === id && !selectedProject ? `bg-orange-600 text-white shadow-lg` : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}><Icon size={20} /><span>{label}</span></button>);
  
  const DashboardView = () => {
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö useState(null) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏Ç‡∏≠‡∏á React Hooks
      const currentMonthStr = new Date().toISOString().slice(0, 7);

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      const visibleProjectsDashboard = projects.filter(p => {
          if (currentUser?.username === 'admin') return true;
          const accessibleDeptsStr = currentUser?.accessibleDepts || '';
          const accessibleArray = typeof accessibleDeptsStr === 'string' ? accessibleDeptsStr.split(', ').filter(Boolean) : accessibleDeptsStr;
          if (accessibleArray.includes('All')) return true;
          return p.name === currentUser?.department || accessibleArray.includes(p.name);
      });

      // 1. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      const projectTypesCount = PROJECT_TYPES.map(type => {
           let label = type;
           if(type === 'Condo') label = '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏∏‡∏î';
           if(type === 'Village') label = '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£';
           if(type === 'Office Building') label = '‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
           return { name: label, value: visibleProjectsDashboard.filter(p => p.type === type).length };
      }).filter(d => d.value > 0);
      const PIE_COLORS = ['url(#colorBlue)', 'url(#colorGreen)', 'url(#colorOrange)', 'url(#colorPurple)'];

      // 2. ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
      const empByDeptMap = {};
      users.forEach(u => {
          const dept = u.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î';
          empByDeptMap[dept] = (empByDeptMap[dept] || 0) + 1;
      });
      const empByDeptData = Object.keys(empByDeptMap)
          .map(dept => ({ name: dept, employeeCount: empByDeptMap[dept] }))
          .sort((a, b) => b.employeeCount - a.employeeCount);

      // 3. ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit (‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
      const auditRankData = visibleProjectsDashboard.map(p => {
          const pAudits = audits.filter(a => a.projectId === p.id);
          const avg = pAudits.length > 0 ? (pAudits.reduce((sum, a) => sum + a.score, 0) / pAudits.length) : 0;
          return { name: p.name, avgScore: parseFloat(avg.toFixed(1)) };
      }).filter(d => d.avgScore > 0).sort((a, b) => b.avgScore - a.avgScore);

      // 4. ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
      const reportRankData = visibleProjectsDashboard.map(p => {
          const currentMonthReports = dailyReports.filter(r => r.projectId === p.id && r.date.startsWith(currentMonthStr));
          const uniqueReportDays = new Set(currentMonthReports.map(r => r.date)).size;
          return { name: p.name, submittedDays: uniqueReportDays };
      }).sort((a, b) => b.submittedDays - a.submittedDays);

      // 5. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Action Plan ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
      const actionPlanData = visibleProjectsDashboard.map(p => {
          const projAPs = actionPlans.filter(a => a.projectId === p.id);
          const counts = { name: p.name, pending: 0, inProgress: 0, completed: 0, cancelled: 0 };
          projAPs.forEach(ap => {
              if(ap.status === 'Pending') counts.pending++;
              if(ap.status === 'In Progress') counts.inProgress++;
              if(ap.status === 'Completed') counts.completed++;
              if(ap.status === 'Cancelled') counts.cancelled++;
          });
          return counts;
      }).filter(p => (p.pending + p.inProgress + p.completed + p.cancelled) > 0);

      // NEW: 6. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PM ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
      const pmStatusData = visibleProjectsDashboard.map(p => {
          const pPlans = pmPlans.filter(plan => plan.projectId === p.id && plan.status === 'Active');
          const [year, month] = currentMonthStr.split('-').map(Number);
          const daysInMonth = new Date(year, month, 0).getDate();

          let totalTasks = 0;
          let completedTasks = 0;

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô PM ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
          for (let d = 1; d <= daysInMonth; d++) {
              const dateObj = new Date(year, month - 1, d);
              const dateString = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

              pPlans.forEach(plan => {
                  let shouldRun = false;
                  if (plan.frequency === 'Daily') shouldRun = true;
                  if (plan.frequency === 'Weekly') shouldRun = dateObj.getDay() === parseInt(plan.scheduleDetails.dayOfWeek);
                  if (plan.frequency === 'Monthly') shouldRun = d === parseInt(plan.scheduleDetails.date);
                  if (plan.frequency === 'Yearly') shouldRun = d === parseInt(plan.scheduleDetails.date) && dateObj.getMonth() === parseInt(plan.scheduleDetails.month) - 1;

                  if (shouldRun) {
                      totalTasks++;
                      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                      const historyRecord = pmHistoryList.find(h => h.pmPlanId === plan.id && h.date === dateString);
                      if (historyRecord && historyRecord.approvalStatus !== 'Rejected') {
                          completedTasks++;
                      }
                  }
              });
          }

          return {
              name: p.name,
              completed: completedTasks,
              pending: totalTasks - completedTasks,
              total: totalTasks
          };
      }).filter(p => p.total > 0);

      // Summary KPIs
      const totalPendingAPs = actionPlans.filter(a => a.status === 'Pending' || a.status === 'In Progress').length;
      const totalAuditsAvg = audits.length > 0 ? (audits.reduce((s, a) => s + a.score, 0) / audits.length).toFixed(1) : 0;

      // 6. Project Contracts Expiry (Sorted from least days to most)
      const projectContractsData = visibleProjectsDashboard.map(p => {
          return {
              ...p,
              daysRemaining: calculateDaysRemaining(p.contractEndDate)
          };
      }).sort((a, b) => a.daysRemaining - b.daysRemaining);

      // --- Chart Rendering Helpers ---
      const renderCustomizedPieLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, name }) => {
          const RADIAN = Math.PI / 180;
          const radius = innerRadius + (outerRadius - innerRadius) * 0.5 + 50;
          const x = cx + radius * Math.cos(-midAngle * RADIAN);
          const y = cy + radius * Math.sin(-midAngle * RADIAN);
          return (
              <text x={x} y={y} fill="#4b5563" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize={14} fontWeight="bold">
                  {`${name} (${(percent * 100).toFixed(0)}%)`}
              </text>
          );
      };

      const renderProjectTypesChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <PieChart style={{ filter: 'drop-shadow(2px 6px 8px rgba(0,0,0,0.25))' }}>
                  <Pie data={projectTypesCount} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={isFull ? 180 : 100} innerRadius={isFull ? 80 : 45} label={isFull ? renderCustomizedPieLabel : true} stroke="none" isAnimationActive={true}>
                      {projectTypesCount.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />)}
                  </Pie>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Legend wrapperStyle={isFull ? { fontSize: '16px', paddingTop: '20px' } : {}}/>
              </PieChart>
          </ResponsiveContainer>
      );

      const renderEmpByDeptChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <BarChart data={empByDeptData} margin={{ top: 20, right: 30, left: 0, bottom: isFull ? 100 : 60 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: isFull ? 14 : 11}} interval={0} height={isFull ? 100 : 60} />
                  <YAxis tick={{fontSize: isFull ? 14 : 12}}/>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Bar dataKey="employeeCount" name="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" shape={<ThreeDBar fill="url(#colorGreen)" />} />
              </BarChart>
          </ResponsiveContainer>
      );

      const renderAuditRankChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <BarChart data={auditRankData} margin={{ top: 25, right: 30, left: 0, bottom: isFull ? 100 : 60 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: isFull ? 14 : 11}} interval={0} height={isFull ? 100 : 60} />
                  <YAxis domain={[0, 100]} tick={{fontSize: isFull ? 14 : 12}}/>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Bar dataKey="avgScore" name="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢" shape={<ThreeDBar />}>
                      {auditRankData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.avgScore >= 90 ? 'url(#colorGreen)' : entry.avgScore >= 70 ? 'url(#colorOrange)' : 'url(#colorRed)'} />
                      ))}
                  </Bar>
              </BarChart>
          </ResponsiveContainer>
      );

      const renderPmStatusChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <BarChart data={pmStatusData} margin={{ top: 25, right: 30, left: 0, bottom: isFull ? 100 : 60 }} style={{ filter: 'drop-shadow(3px 5px 6px rgba(0,0,0,0.2))' }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: isFull ? 14 : 11}} interval={0} height={isFull ? 100 : 60} />
                  <YAxis tick={{fontSize: isFull ? 14 : 12}}/>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Legend verticalAlign="top" height={36} wrapperStyle={isFull ? { fontSize: '16px', paddingBottom: '20px' } : {}}/>
                  <Bar dataKey="completed" name="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß" stackId="a" fill="url(#colorGreen)" stroke="#059669" strokeWidth={1} />
                  <Bar dataKey="pending" name="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏Ñ‡πâ‡∏≤‡∏á" stackId="a" fill="url(#colorRed)" stroke="#dc2626" strokeWidth={1} />
              </BarChart>
          </ResponsiveContainer>
      );

      const renderReportRankChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <BarChart data={reportRankData} margin={{ top: 20, right: 30, left: 0, bottom: isFull ? 100 : 60 }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: isFull ? 14 : 11}} interval={0} height={isFull ? 100 : 60} />
                  <YAxis domain={[0, 31]} tick={{fontSize: isFull ? 14 : 12}}/>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Bar dataKey="submittedDays" name="‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ß‡∏±‡∏ô)" shape={<ThreeDBar fill="url(#colorCyan)" />} />
              </BarChart>
          </ResponsiveContainer>
      );

      const renderActionPlanChart = (isFull = false) => (
          <ResponsiveContainer width="100%" height="100%">
              <BarChart data={actionPlanData} margin={{ top: 20, right: 30, left: 0, bottom: isFull ? 100 : 60 }} style={{ filter: 'drop-shadow(3px 5px 6px rgba(0,0,0,0.2))' }}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} />
                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: isFull ? 14 : 11}} interval={0} height={isFull ? 100 : 60} />
                  <YAxis tick={{fontSize: isFull ? 14 : 12}}/>
                  <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                  <Legend verticalAlign="top" height={36} wrapperStyle={isFull ? { fontSize: '16px', paddingBottom: '20px' } : {}}/>
                  <Bar dataKey="pending" name="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" stackId="a" fill="url(#cylOrange)" stroke="#ea580c" strokeWidth={1} />
                  <Bar dataKey="inProgress" name="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥" stackId="a" fill="url(#cylBlue)" stroke="#2563eb" strokeWidth={1} />
                  <Bar dataKey="completed" name="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" stackId="a" fill="url(#cylGreen)" stroke="#059669" strokeWidth={1} />
                  <Bar dataKey="cancelled" name="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" stackId="a" fill="url(#cylGray)" stroke="#4b5563" strokeWidth={1} />
              </BarChart>
          </ResponsiveContainer>
      );

      return (
          <div className="space-y-6 animate-fade-in relative">
              <ChartGradients />
              <ReportHeader />
              <header className="flex justify-between items-center mb-6">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-800">{t('corpDashboard')}</h1>
                      <p className="text-gray-500">{t('overview')}</p>
                  </div>
                  <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                      <Button variant="outline" icon={Download} onClick={() => exportToCSV(visibleProjectsDashboard, 'dashboard_summary')}>{t('exportReport')}</Button>
                      <Button variant="outline" icon={isExporting ? Loader2 : Printer} onClick={() => handleExportPDF('print-area', 'Dashboard_Report.pdf', 'portrait')} disabled={isExporting}>{isExporting ? t('downloading') : t('exportPDF')}</Button>
                  </div>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                  <KPICard title={t('totalProjects')} value={visibleProjectsDashboard.length} icon={Building2} color="blue" onClick={() => setSelectedKpiDetail('projects')} />
                  <KPICard title={t('totalEmployees')} value={users.length} icon={Users} color="green" onClick={() => setSelectedKpiDetail('employees')} />
                  <KPICard title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°" value={`${totalAuditsAvg}%`} icon={ClipboardCheck} color="purple" onClick={() => setSelectedKpiDetail('audits')} />
                  <KPICard title="‡∏á‡∏≤‡∏ô Action Plan ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà" value={totalPendingAPs} icon={Wrench} color="orange" onClick={() => setSelectedKpiDetail('actionPlans')} />
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* 1. Projects by Type */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('projectTypes')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Building2 size={20} className="text-blue-500"/> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
                      <div className="h-72 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('projectTypes')}>
                          {renderProjectTypesChart()}
                      </div>
                  </Card>

                  {/* 2. Employees by Dept */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('empByDept')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Users size={20} className="text-green-500"/> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
                      <div className="h-72 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('empByDept')}>
                          {renderEmpByDeptChart()}
                      </div>
                  </Card>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* 3. Audit Ranking */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('auditRank')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><ClipboardCheck size={20} className="text-purple-500"/> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit (‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)</h3>
                      <div className="h-80 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('auditRank')}>
                          {renderAuditRankChart()}
                      </div>
                  </Card>

                  {/* 4. PM Status by Project */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('pmStatus')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Settings size={20} className="text-red-500"/> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                      <div className="h-80 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('pmStatus')}>
                          {pmStatusData.length > 0 ? (
                              renderPmStatusChart()
                          ) : (
                              <div className="flex items-center justify-center h-full text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed">
                                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô PM ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                              </div>
                          )}
                      </div>
                  </Card>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* 5. Daily Report */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('reportRank')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><FileText size={20} className="text-cyan-500"/> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                      <div className="h-80 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('reportRank')}>
                          {renderReportRankChart()}
                      </div>
                  </Card>

                  {/* 6. Action Plan Status */}
                  <Card className="p-6 relative group">
                      <button onClick={() => setFullScreenChart('actionPlan')} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-orange-600 bg-gray-50 hover:bg-orange-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100 z-10" title="‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                          <Maximize2 size={16} />
                      </button>
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Wrench size={20} className="text-orange-500"/> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Action Plan ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h3>
                      <div className="h-80 cursor-pointer transition-transform hover:scale-[1.02]" onClick={() => setFullScreenChart('actionPlan')}>
                          {renderActionPlanChart()}
                      </div>
                  </Card>
              </div>

          {/* 7. Project Contract Expiration List */}
          <Card className="p-6">
              <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                  <Hourglass size={20} className="text-red-500"/> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)
              </h3>
              <div className="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar border border-gray-200 rounded-lg relative">
                  <table className="w-full text-sm text-left">
                      <thead className="bg-gray-50 text-gray-600 sticky top-0 z-20 shadow-sm">
                          <tr>
                              <th className="p-4 border-b w-16 text-center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                              <th className="p-4 border-b">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                              <th className="p-4 border-b text-center">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                              <th className="p-4 border-b text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                              <th className="p-4 border-b text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                              <th className="p-4 border-b text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                              <th className="p-4 border-b text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                          </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100 bg-white">
                          {projectContractsData.length > 0 ? projectContractsData.map((p, index) => {
                              const isExpired = p.daysRemaining <= 0;
                              return (
                                  <tr key={p.id} className="hover:bg-gray-50 transition-colors">
                                      <td className="p-4 text-center text-gray-500">{index + 1}</td>
                                      <td className="p-4 font-bold text-gray-800 flex items-center gap-2">
                                          <Building2 size={16} className={isExpired ? 'text-red-500' : p.daysRemaining <= 60 ? 'text-orange-500' : 'text-gray-400'}/>
                                          {p.name}
                                      </td>
                                      <td className="p-4 text-center text-gray-600">
                                          <div className="flex items-center justify-center gap-1">
                                              <Calendar size={14} className="text-gray-400"/> {p.contractStartDate || '-'}
                                          </div>
                                      </td>
                                      <td className="p-4 text-center text-gray-600">
                                          <div className="flex items-center justify-center gap-1">
                                              <Calendar size={14} className="text-gray-400"/> {p.contractEndDate || '-'}
                                          </div>
                                      </td>
                                      <td className="p-4 text-center">
                                          <span className={`font-bold px-3 py-1.5 rounded-full text-xs flex items-center justify-center gap-1 w-fit mx-auto ${
                                              isExpired ? 'bg-red-100 text-red-700 border border-red-200' : 
                                              p.daysRemaining <= 60 ? 'bg-orange-100 text-orange-700 border border-orange-200' : 
                                              'bg-green-100 text-green-700 border border-green-200'
                                          }`}>
                                              {isExpired ? <AlertTriangle size={12}/> : <Clock size={12}/>}
                                              {isExpired ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.daysRemaining} ‡∏ß‡∏±‡∏ô`}
                                          </span>
                                      </td>
                                      <td className="p-4 text-right font-medium text-gray-800">
                                          {p.contractValue ? Number(p.contractValue).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}
                                      </td>
                                      <td className="p-4 text-center"><Badge status={p.status} /></td>
                                  </tr>
                              );
                          }) : (
                              <tr><td colSpan="7" className="p-8 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</td></tr>
                          )}
                      </tbody>
                      {projectContractsData.length > 0 && (
                          <tfoot className="bg-orange-50 font-bold text-gray-800 sticky bottom-0 z-10 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
                          <tr>
                              <td colSpan="5" className="p-4 text-right border-t-2 border-orange-200 uppercase tracking-wide">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
                              <td className="p-4 text-right text-orange-700 border-t-2 border-orange-200 text-lg whitespace-nowrap">
                                  {projectContractsData.reduce((sum, p) => sum + Number(p.contractValue || 0), 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó
                              </td>
                              <td className="border-t-2 border-orange-200"></td>
                          </tr>
                      </tfoot>
                  )}
              </table>
          </div>
      </Card>

      {/* Full Screen Chart Modal */}
      {fullScreenChart && (
          <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 md:p-8 backdrop-blur-sm animate-fade-in" onClick={() => setFullScreenChart(null)}>
              <div className="bg-white rounded-2xl w-full h-full max-w-7xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl border border-gray-700" onClick={e => e.stopPropagation()}>
                  <div className="p-4 md:p-6 border-b flex justify-between items-center bg-gray-50 shrink-0">
                      <h2 className="text-xl md:text-2xl font-bold flex items-center gap-3 text-gray-800">
                          {fullScreenChart === 'projectTypes' && <><Building2 className="text-blue-500"/> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</>}
                          {fullScreenChart === 'empByDept' && <><Users className="text-green-500"/> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</>}
                          {fullScreenChart === 'auditRank' && <><ClipboardCheck className="text-purple-500"/> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit (‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)</>}
                          {fullScreenChart === 'pmStatus' && <><Settings className="text-red-500"/> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</>}
                          {fullScreenChart === 'reportRank' && <><FileText className="text-cyan-500"/> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</>}
                          {fullScreenChart === 'actionPlan' && <><Wrench className="text-orange-500"/> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Action Plan ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</>}
                      </h2>
                      <button onClick={() => setFullScreenChart(null)} className="p-2 hover:bg-red-100 text-gray-500 hover:text-red-600 rounded-full transition-colors"><X size={24} /></button>
                  </div>
                  <div className="flex-1 p-6 md:p-10 min-h-0 bg-white flex flex-col justify-center">
                      {fullScreenChart === 'projectTypes' && renderProjectTypesChart(true)}
                      {fullScreenChart === 'empByDept' && renderEmpByDeptChart(true)}
                      {fullScreenChart === 'auditRank' && renderAuditRankChart(true)}
                      {fullScreenChart === 'pmStatus' && (pmStatusData.length > 0 ? renderPmStatusChart(true) : <div className="flex items-center justify-center h-full text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed text-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô PM ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>)}
                      {fullScreenChart === 'reportRank' && renderReportRankChart(true)}
                      {fullScreenChart === 'actionPlan' && renderActionPlanChart(true)}
                  </div>
              </div>
          </div>
      )}
  </div>
);
};

  const UserManagement = () => {
      // Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
      const filteredUsers = users
          .filter(u => userDeptFilter ? u.department === userDeptFilter : true)
          .filter(u => userRoleFilter ? u.position === userRoleFilter : true)
          .sort((a, b) => {
              // FIX: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô String ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Number)
              const idA = String(a.employeeId || '');
              const idB = String(b.employeeId || '');
              if (userSortOrder === 'desc') return idB.localeCompare(idA); // ‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
              return idA.localeCompare(idB); // ‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
          });

      // --- NEW: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å Excel) ---
      const handleImportUsersCSV = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          
          // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô ArrayBuffer ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ (Decode) ‡πÄ‡∏≠‡∏á ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô ????
          reader.readAsArrayBuffer(file);
          
          reader.onload = (e) => {
              try {
                  const buffer = e.target.result;
                  let text = '';
                  
                  try {
                      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö UTF-8 (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô) ‡∏Å‡πà‡∏≠‡∏ô ‡πÇ‡∏î‡∏¢‡∏ï‡∏±‡πâ‡∏á fatal: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î Error ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å
                      text = new TextDecoder('utf-8', { fatal: true }).decode(buffer);
                  } catch (err) {
                      // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î Error (‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏ü‡∏à‡∏≤‡∏Å Excel ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ windows-874 / tis-620 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                      text = new TextDecoder('windows-874').decode(buffer);
                  }

                  const lines = text.split(/\r?\n/);
                  if (lines.length < 2) return alert('‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á');
                  
                  // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î ("")
                  const parseCSVLine = (line) => {
                      const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                      return line.split(regex).map(v => v.trim().replace(/^"|"$/g, ''));
                  };

                  const headers = parseCSVLine(lines[0]);
                  const newUsers = [];
                  
                  for (let i = 1; i < lines.length; i++) {
                      if (!lines[i].trim()) continue;
                      
                      const values = parseCSVLine(lines[i]);
                      const userObj = {};
                      headers.forEach((header, index) => {
                          userObj[header] = values[index];
                      });
                      
                      // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡∏Ñ‡∏∑‡∏≠ username ‡πÅ‡∏•‡∏∞ firstName
                      if (userObj.username && userObj.firstName) {
                          newUsers.push({
                              id: generateId(),
                              employeeId: userObj.employeeId || '',
                              firstName: userObj.firstName || '',
                              lastName: userObj.lastName || '',
                              position: userObj.position || EMPLOYEE_POSITIONS[0], // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                              department: userObj.department || 'Head Office',
                              phone: userObj.phone || '',
                              username: userObj.username,
                              password: userObj.password || '1234', // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏°‡∏≤
                              status: 'Active',
                              created_at: new Date().toISOString(),
                              accessibleDepts: [],
                              permissions: getDefaultPermissions(),
                              photo: null
                          });
                      }
                  }
                  
                  if (newUsers.length > 0) {
                      showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ${newUsers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                          setUsers(prev => [...prev, ...newUsers]);
                          alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
                      });
                  } else {
                      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå username ‡πÅ‡∏•‡∏∞ firstName)');
                  }
              } catch (error) {
                  alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå');
                  console.error(error);
              }
          };
          event.target.value = ''; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
      };

      return (
          <div className="space-y-6">
              <ReportHeader />
              <header className="flex justify-between items-center">
                  <h1 className="text-2xl font-bold text-gray-800">{t('userMgmt')}</h1>
                  <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                      {hasPerm('users', 'save') && (
                          <>
                              <Button variant="outline" className="border-orange-500 text-orange-600 hover:bg-orange-50 font-bold hidden md:flex" icon={Shield} onClick={() => {
                                  setEditingRole(EMPLOYEE_POSITIONS[0]);
                                  setEditingRolePerms(rolePermissions[EMPLOYEE_POSITIONS[0]] || getDefaultPermissions());
                                  setShowRolePermModal(true);
                              }}>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</Button>
                              <label className="cursor-pointer flex items-center justify-center gap-2 px-4 py-2 text-sm rounded-md font-medium transition-colors bg-green-600 text-white hover:bg-green-700 shadow-sm" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv">
                                  <Upload size={16} /> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV
                                  <input type="file" accept=".csv" className="hidden" onChange={handleImportUsersCSV} />
                              </label>
                              <Button icon={Plus} onClick={() => { setIsEditingUser(false); setShowAddUserModal(true); }}>{t('addUser')}</Button>
                          </>
                      )}
                      <Button variant="outline" icon={Download} onClick={() => exportToCSV(filteredUsers, 'users_list')}>CSV</Button>
                      <Button variant="outline" icon={isExporting ? Loader2 : Printer} onClick={() => handleExportPDF('print-area', 'User_List.pdf', 'landscape')} disabled={isExporting}>{isExporting ? t('downloading') : t('printPDF')}</Button>
                  </div>
              </header>

              {/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Filters) */}
              <Card className={`grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 ${isExporting ? 'hidden' : ''}`}>
                  <div>
                      <label className="block text-xs font-bold text-gray-500 mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                      <select 
                          className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition-colors cursor-pointer"
                          value={userSortOrder}
                          onChange={e => setUserSortOrder(e.target.value)}
                      >
                          <option value="desc">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (9-1, Z-A)</option>
                          <option value="asc">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å (1-9, A-Z)</option>
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-bold text-gray-500 mb-2">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Department)</label>
                      <select 
                          className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition-colors cursor-pointer"
                          value={userDeptFilter}
                          onChange={e => setUserDeptFilter(e.target.value)}
                      >
                          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All) --</option>
                          <option value="Head Office">Head Office</option>
                          {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-bold text-gray-500 mb-2">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Position)</label>
                      <select 
                          className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition-colors cursor-pointer"
                          value={userRoleFilter}
                          onChange={e => setUserRoleFilter(e.target.value)}
                      >
                          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All) --</option>
                          {EMPLOYEE_POSITIONS.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                      </select>
                  </div>
              </Card>

              <Card className="overflow-hidden">
                  <div className="overflow-x-auto">
                      <table className="w-full text-left text-sm">
                          <thead className="bg-gray-50 text-gray-600 uppercase">
                              <tr>
                                  <th className="p-4 w-16 text-center">{t('col_seq')}</th>
                                  <th className="p-4 w-32">{t('col_empId')}</th>
                                  <th className="p-4">{t('col_name')}</th>
                                  <th className="p-4">{t('col_role')}</th>
                                  <th className="p-4">{t('col_dept')}</th>
                                  <th className="p-4">{t('accessibleDepts')}</th>
                                  <th className="p-4">{t('username')}</th>
                                  <th className="p-4">{t('col_status')}</th>
                                  <th className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>{t('col_actions')}</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100 bg-white">
                              {filteredUsers.length > 0 ? filteredUsers.map((user, index) => (
                                  <tr key={user.id} className="hover:bg-gray-50 cursor-pointer group transition-colors" onClick={() => { if(hasPerm('users', 'edit')) handleEditUser(user); }}>
                                      <td className="p-4 text-center text-gray-500">{index + 1}</td>
                                      <td className="p-4 font-mono font-medium text-orange-600">{user.employeeId || '-'}</td>
                                      <td className="p-4 font-medium flex items-center gap-3">
                                          <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden text-xs shrink-0">
                                              {user.photo ? <img src={user.photo} alt="" className="w-full h-full object-cover" /> : <User size={16} className="text-gray-400" />}
                                          </div>
                                          <div className="group-hover:text-orange-600 transition-colors flex items-center gap-2">
                                              {user.firstName} {user.lastName} 
                                              {hasPerm('users', 'edit') && <Edit size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" />}
                                          </div>
                                      </td>
                                      <td className="p-4"><span className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-700">{user.position}</span></td>
                                      <td className="p-4 text-gray-800">{user.department || '-'}</td>
                                      <td className="p-4">
                                          {(() => {
                                              // FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Array .split() Error
                                              const depts = user.accessibleDepts;
                                              if (!depts || depts === '' || (Array.isArray(depts) && depts.length === 0)) {
                                                  return <span className="text-gray-400 text-xs">-</span>;
                                              }
                                              
                                              const deptsArray = Array.isArray(depts) ? depts : (typeof depts === 'string' ? depts.split(', ').filter(Boolean) : []);
                                              
                                              if (deptsArray.includes('All')) {
                                                  return <span className="bg-blue-100 text-blue-700 border border-blue-200 px-2 py-0.5 rounded text-[10px] font-bold whitespace-nowrap">All (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</span>;
                                              }
                                              
                                              return (
                                                  <div className="flex flex-wrap gap-1">
                                                      {deptsArray.map((d, i) => d ? <span key={i} className="bg-orange-50 text-orange-700 border border-orange-200 px-1.5 py-0.5 rounded text-[10px] whitespace-nowrap">{d}</span> : null)}
                                                  </div>
                                              );
                                          })()}
                                      </td>
                                      <td className="p-4 text-gray-600">{user.username}</td>
                                      <td className="p-4"><Badge status={user.status} /></td>
                                      <td className={`p-4 text-center space-x-1 ${isExporting ? 'hidden' : ''}`}>
                                          {hasPerm('users', 'edit') && <button className="text-gray-400 hover:text-blue-600 transition-colors p-1.5 rounded-md hover:bg-blue-50" onClick={(e) => { e.stopPropagation(); handleEditUser(user); }} title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><Edit size={16} /></button>}
                                          {hasPerm('users', 'delete') && <button className="text-gray-400 hover:text-red-600 transition-colors p-1.5 rounded-md hover:bg-red-50" onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${user.firstName} ${user.lastName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setUsers(users.filter(u => u.id !== user.id))); }} title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><Trash2 size={16} /></button>}
                                      </td>
                                  </tr>
                              )) : (
                                  <tr>
                                      <td colSpan="8" className="p-8 text-center text-gray-400 bg-gray-50 border-b border-dashed">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td>
                                  </tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </Card>
          </div>
      );
  };

  const ProjectList = () => {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Array.includes ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î)
      const visibleProjects = projects.filter(p => {
          if (currentUser?.username === 'admin') return true;
          
          const accessibleDeptsStr = currentUser?.accessibleDepts || '';
          const accessibleArray = typeof accessibleDeptsStr === 'string' ? accessibleDeptsStr.split(', ').filter(Boolean) : accessibleDeptsStr;
          
          if (accessibleArray.includes('All')) return true;
          
          return p.name === currentUser?.department || accessibleArray.includes(p.name);
      });

      // Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
      const filteredProjects = visibleProjects
          .filter(p => projectTypeFilter ? p.type === projectTypeFilter : true)
          .sort((a, b) => {
              if (projectSortOrder === 'expiry_asc') return calculateDaysRemaining(a.contractEndDate) - calculateDaysRemaining(b.contractEndDate);
              if (projectSortOrder === 'expiry_desc') return calculateDaysRemaining(b.contractEndDate) - calculateDaysRemaining(a.contractEndDate);
              return 0;
          });

      return (
          <div className="space-y-6">
              <ReportHeader />
              <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                  <h1 className="text-2xl font-bold text-gray-800">{t('projectList')}</h1>
                  <div className="flex gap-2 items-center w-full md:w-auto">
                      {/* Toggle Grid / List View */}
                  <div className={`flex bg-gray-100 p-1 rounded-lg mr-2 ${isExporting ? 'hidden' : ''}`}>
                      <button onClick={() => setProjectViewMode('grid')} className={`p-1.5 rounded-md transition-all ${projectViewMode === 'grid' ? 'bg-white shadow text-orange-600' : 'text-gray-400 hover:text-gray-600'}`} title="Grid View"><LayoutGrid size={18} /></button>
                      <button onClick={() => setProjectViewMode('list')} className={`p-1.5 rounded-md transition-all ${projectViewMode === 'list' ? 'bg-white shadow text-orange-600' : 'text-gray-400 hover:text-gray-600'}`} title="List View"><List size={18} /></button>
                  </div>
                  <div className={`flex gap-2 w-full md:w-auto overflow-x-auto ${isExporting ? 'hidden' : ''}`}>
                      {hasPerm('projects', 'save') && <Button icon={Plus} onClick={() => { setIsEditingProject(false); setNewProject({ logo: null, code: '', name: '', type: 'Condo', address: '', phone: '', taxId: '', contractStartDate: '', contractEndDate: '', contractValue: '', status: 'Active', files: { orchor: null, committee: null, regulations: null, resident_rules: null }}); setShowAddProjectModal(true); }}>{t('newProject')}</Button>}
                      <Button variant="outline" icon={Download} onClick={() => exportToCSV(filteredProjects, 'projects')}>Export</Button>
                      <Button variant="outline" icon={isExporting ? Loader2 : Printer} onClick={() => handleExportPDF('print-area', 'Project_List.pdf', 'landscape')} disabled={isExporting}>{isExporting ? t('downloading') : t('printPDF')}</Button>
                  </div>
              </div>
          </header>

              {/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Filters) */}
              <Card className={`grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 ${isExporting ? 'hidden' : ''}`}>
                  <div>
                      <label className="block text-xs font-bold text-gray-500 mb-2">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)</label>
                      <select 
                          className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition-colors cursor-pointer bg-white"
                          value={projectTypeFilter}
                          onChange={e => setProjectTypeFilter(e.target.value)}
                      >
                          <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All) --</option>
                          {PROJECT_TYPES.map(type => <option key={type} value={type}>{t(type === 'Condo' ? 'tab_condo' : type === 'Village' ? 'tab_village' : 'tab_office')}</option>)}
                      </select>
                  </div>
                  <div>
                      <label className="block text-xs font-bold text-gray-500 mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Expiration)</label>
                      <select 
                          className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition-colors cursor-pointer bg-white"
                          value={projectSortOrder}
                          onChange={e => setProjectSortOrder(e.target.value)}
                      >
                          <option value="expiry_asc">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å</option>
                          <option value="expiry_desc">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢</option>
                      </select>
                  </div>
              </Card>

              {projectViewMode === 'grid' ? (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {filteredProjects.length > 0 ? filteredProjects.map(project => { 
                          const remainingDays = calculateDaysRemaining(project.contractEndDate); 
                          const isExpired = remainingDays <= 0; 
                          return (
                              <div key={project.id} onClick={() => { setSelectedProject(project); setProjectTab('overview'); }} className="group bg-white rounded-xl shadow-sm border border-gray-200 p-6 cursor-pointer hover:shadow-md hover:border-orange-300 transition-all relative">
                                  <div className="flex justify-between items-start mb-4">
                                      <div className="p-3 bg-orange-50 rounded-lg group-hover:bg-orange-100 transition-colors">
                                          {project.logo ? <img src={project.logo} className="w-6 h-6 object-contain" /> : <Building2 className="text-orange-600" size={24} />}
                                      </div>
                                      <Badge status={project.status} />
                                  </div>
                                  <div className="flex justify-between items-center mb-1">
                                      <h3 className="text-lg font-bold text-gray-800 truncate pr-2">{project.name}</h3>
                                      <div className="flex gap-1">
                                          {hasPerm('projects', 'edit') && (
                                              <button 
                                                  onClick={(e) => { 
                                                      e.stopPropagation(); 
                                                      setNewProject({ files: { orchor: null, committee: null, regulations: null, resident_rules: null }, ...project }); 
                                                      setIsEditingProject(true); 
                                                      setShowAddProjectModal(true); 
                                                  }} 
                                                  className="text-gray-400 hover:text-orange-600 p-1.5 rounded-md hover:bg-orange-50 transition-colors opacity-0 group-hover:opacity-100 shrink-0 border border-transparent hover:border-orange-200"
                                                  title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"
                                              >
                                                  <Edit size={16} />
                                              </button>
                                          )}
                                          {hasPerm('projects', 'delete') && (
                                              <button 
                                                  onClick={(e) => { 
                                                      e.stopPropagation(); 
                                                      showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${project.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                                                          setProjects(projects.filter(p => p.id !== project.id));
                                                          if(selectedProject?.id === project.id) setSelectedProject(null);
                                                      });
                                                  }} 
                                                  className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100 shrink-0 border border-transparent hover:border-red-200"
                                                  title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"
                                              >
                                                  <Trash2 size={16} />
                                              </button>
                                          )}
                                      </div>
                                  </div>
                                  <p className="text-sm text-gray-500 mb-4 truncate">{project.address}</p>
                                  <div className="space-y-2 text-sm text-gray-600">
                                      <div className="flex items-center gap-2">
                                          <Clock size={16} className={isExpired ? "text-red-500" : "text-gray-400"} />
                                          <span className={isExpired ? "text-red-600 font-bold" : ""}>{isExpired ? t('expired') : `${remainingDays} ${t('days')} ${t('daysRemaining')}`}</span>
                                      </div>
                                      <div className="flex items-center gap-2">
                                          <Calendar size={16} className="text-gray-400" />
                                          <span>{t('start')}: {project.contractStartDate}</span>
                                      </div>
                                  </div>
                              </div>
                          ); 
                      }) : (
                          <div className="col-span-full p-10 text-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl text-gray-500">
                              ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                          </div>
                      )}
                  </div>
              ) : (
                  <Card className="overflow-hidden">
                      <div className="overflow-x-auto">
                          <table className="w-full text-left text-sm">
                              <thead className="bg-gray-50 text-gray-600 uppercase">
                                  <tr>
                                      <th className="p-4 w-16 text-center">{t('col_seq')}</th>
                                      <th className="p-4 w-20 text-center">‡πÇ‡∏•‡πÇ‡∏Å‡πâ</th>
                                      <th className="p-4">{t('projName')}</th>
                                      <th className="p-4">{t('projType')}</th>
                                      <th className="p-4">{t('contractEndDate')}</th>
                                      <th className="p-4 text-center">{t('col_status')}</th>
                                      <th className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>{t('col_actions')}</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-100 bg-white">
                                  {filteredProjects.length > 0 ? filteredProjects.map((project, index) => {
                                      const remainingDays = calculateDaysRemaining(project.contractEndDate); 
                                      const isExpired = remainingDays <= 0;
                                      return (
                                          <tr key={project.id} className="hover:bg-gray-50 cursor-pointer group transition-colors" onClick={() => { setSelectedProject(project); setProjectTab('overview'); }}>
                                              <td className="p-4 text-center text-gray-500">{index + 1}</td>
                                              <td className="p-4 text-center">
                                                  <div className="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center overflow-hidden mx-auto border border-orange-100">
                                                      {project.logo ? <img src={project.logo} className="w-full h-full object-cover" /> : <Building2 size={20} className="text-orange-500" />}
                                                  </div>
                                              </td>
                                              <td className="p-4">
                                                  <div className="font-bold text-gray-800 group-hover:text-orange-600 transition-colors">{project.name}</div>
                                                  <div className="text-xs text-gray-500 font-mono mt-0.5">{project.code}</div>
                                              </td>
                                              <td className="p-4 text-gray-700">
                                                  <span className="bg-gray-100 px-2 py-1 rounded text-xs">
                                                      {project.type === 'Condo' ? t('tab_condo') : project.type === 'Village' ? t('tab_village') : t('tab_office')}
                                                  </span>
                                              </td>
                                              <td className="p-4">
                                                  <div className="text-gray-700 flex items-center gap-1"><Calendar size={14} className="text-gray-400"/> {project.contractEndDate}</div>
                                                  <div className={`text-xs font-bold mt-1 ${isExpired ? 'text-red-600' : remainingDays < 30 ? 'text-orange-500' : 'text-green-600'}`}>
                                                      {isExpired ? t('expired') : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${remainingDays} ‡∏ß‡∏±‡∏ô`}
                                                  </div>
                                              </td>
                                              <td className="p-4 text-center"><Badge status={project.status} /></td>
                                              <td className={`p-4 text-center space-x-1 ${isExporting ? 'hidden' : ''}`} onClick={(e) => e.stopPropagation()}>
                                                  {hasPerm('projects', 'edit') && <button className="text-gray-400 hover:text-orange-600 transition-colors p-1.5 rounded-md hover:bg-orange-50" onClick={() => { setNewProject({ files: { orchor: null, committee: null, regulations: null, resident_rules: null }, ...project }); setIsEditingProject(true); setShowAddProjectModal(true); }} title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><Edit size={16} /></button>}
                                                  {hasPerm('projects', 'delete') && <button className="text-gray-400 hover:text-red-600 transition-colors p-1.5 rounded-md hover:bg-red-50" onClick={() => { showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${project.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => { setProjects(projects.filter(p => p.id !== project.id)); if(selectedProject?.id === project.id) setSelectedProject(null); }); }} title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"><Trash2 size={16} /></button>}
                                              </td>
                                          </tr>
                                      );
                                  }) : (
                                      <tr><td colSpan="7" className="p-8 text-center text-gray-400 bg-gray-50 border-b border-dashed">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </Card>
              )}
          </div>
      );
  };

  const GlobalAuditList = () => {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
      const auditRankData = projects.map(p => {
          const pAudits = audits.filter(a => a.projectId === p.id);
          const avg = pAudits.length > 0 ? (pAudits.reduce((sum, a) => sum + a.score, 0) / pAudits.length) : 0;
          return { name: p.name, avgScore: parseFloat(avg.toFixed(1)) };
      }).filter(d => d.avgScore > 0).sort((a, b) => b.avgScore - a.avgScore);

      return (
          <div id="print-global-audit" className={`space-y-6 animate-fade-in ${isExporting ? 'w-[190mm] min-w-[190mm] max-w-[190mm] mx-auto bg-white box-border' : ''}`}>
              <ReportHeader />
              <header className="flex justify-between items-center mb-6">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-800">{isExporting ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Global Audit)' : t('globalAudit')}</h1>
                      <p className="text-gray-500">{t('auditDesc')}</p>
                  </div>
                  <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                      {hasPerm('audits', 'save') && (
                          <Button icon={Plus} onClick={() => { setNewAudit(prev => ({...prev, projectId: '', inspector: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : ''})); setShowAddAuditModal(true); }}>
                              {t('newAudit')}
                          </Button>
                      )}
                      <Button variant="outline" icon={Download} onClick={() => exportToCSV(audits, 'global_audit_report')}>{t('exportCSV')}</Button>
                      <Button variant="outline" icon={isExporting ? Loader2 : Printer} onClick={() => {
                          const container = document.getElementById('print-global-audit');
                          if (container) container.scrollTop = 0;
                          handleExportPDF('print-global-audit', 'Global_Audit_Report.pdf', 'portrait', [22, 10, 20, 10]);
                      }} disabled={isExporting}>
                          {isExporting ? t('downloading') : t('printPDF')}
                      </Button>
                  </div>
              </header>

              {/* KPI Cards */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <Card className="p-6 border-l-4 border-green-500">
                      <div className="text-gray-500 mb-1">{t('auditPass')}</div>
                      <div className="text-2xl font-bold">{audits.filter(a => a.score >= 90).length} Reports</div>
                  </Card>
                  <Card className="p-6 border-l-4 border-yellow-500">
                      <div className="text-gray-500 mb-1">{t('auditConcern')}</div>
                      <div className="text-2xl font-bold">{audits.filter(a => a.score >= 70 && a.score < 90).length} Reports</div>
                  </Card>
                  <Card className="p-6 border-l-4 border-red-500">
                      <div className="text-gray-500 mb-1">{t('auditCritical')}</div>
                      <div className="text-2xl font-bold">{audits.filter(a => a.score < 70).length} Reports</div>
                  </Card>
              </div>

              {/* Audit Ranking Graph */}
              <Card className="p-6">
                  <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                      <BarChart3 size={20} className="text-blue-600"/> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)
                  </h3>
                  <div className="h-80">
                      {auditRankData.length > 0 ? (
                          <ResponsiveContainer width="100%" height="100%">
                              <BarChart data={auditRankData} margin={{ top: 20, right: 30, left: 0, bottom: 60 }}>
                                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                  <XAxis dataKey="name" angle={-45} textAnchor="end" tick={{fontSize: 11, fill: '#6b7280'}} interval={0} height={60} axisLine={false} tickLine={false} />
                                  <YAxis domain={[0, 100]} tick={{fontSize: 11, fill: '#6b7280'}} axisLine={false} tickLine={false} />
                                  <RechartsTooltip cursor={{fill: '#f3f4f6'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                  <Bar dataKey="avgScore" name="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢" radius={[4, 4, 0, 0]}>
                                      {auditRankData.map((entry, index) => (
                                          <Cell key={`cell-${index}`} fill={entry.avgScore >= 90 ? '#10b981' : entry.avgScore >= 70 ? '#f59e0b' : '#ef4444'} />
                                      ))}
                                  </Bar>
                              </BarChart>
                          </ResponsiveContainer>
                      ) : (
                          <div className="flex items-center justify-center h-full text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed">
                              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Audit) ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
                          </div>
                      )}
                  </div>
              </Card>

              {/* Detailed Audit Table */}
              <Card>
                  <div className={isExporting ? "w-full pb-4" : "overflow-x-auto"}>
                      <table className="w-full text-sm text-left table-fixed break-words">
                          <thead className="bg-gray-50 text-gray-600 uppercase">
                              <tr>
                                  <th className="p-4 w-[15%]">{t('col_date')}</th>
                                  <th className="p-4 w-[25%]">{t('col_project')}</th>
                                  <th className="p-4 w-[20%]">{t('col_category')}</th>
                                  <th className="p-4 text-center w-[15%]">{t('col_score')}</th>
                                  <th className="p-4 w-[25%]">{t('col_inspector')}</th>
                                  <th className={`p-4 text-right w-[15%] ${isExporting ? 'hidden' : ''}`}>{t('col_actions')}</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100">
                              {audits.length > 0 ? (
                                  audits.map(audit => { 
                                      const project = projects.find(p => p.id === audit.projectId); 
                                      return (
                                          <tr key={audit.id} className="hover:bg-gray-50 transition-colors">
                                              <td className="p-4 text-gray-600">{audit.date}</td>
                                              <td className="p-4 font-medium text-gray-800 break-words whitespace-normal">{project ? project.name : 'Unknown Project'}</td>
                                              <td className="p-4 text-gray-600 break-words whitespace-normal">{audit.category}</td>
                                              <td className="p-4 text-center">
                                                  <span className={`font-bold px-2 py-1 rounded text-xs ${audit.score >= 90 ? 'bg-green-100 text-green-700' : audit.score >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                                      {audit.rawScore ? `${audit.rawScore}/235` : `${audit.score}%`}
                                                  </span>
                                              </td>
                                              <td className="p-4 text-gray-700 break-words whitespace-normal">{audit.inspector}</td>
                                              <td className={`p-4 text-right space-x-2 ${isExporting ? 'hidden' : ''}`}>
                                                  <button className="text-gray-400 hover:text-blue-600 transition-colors p-1" onClick={() => setSelectedAuditReport(audit)} title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                                                      <FileText size={18} />
                                                  </button>
                                                  {hasPerm('audits', 'delete') && (
                                                      <button 
                                                          className="text-gray-400 hover:text-red-600 transition-colors p-1" 
                                                          onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => setAudits(audits.filter(a => a.id !== audit.id)))}
                                                          title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
                                                      >
                                                          <Trash2 size={18} />
                                                      </button>
                                                  )}
                                              </td>
                                          </tr>
                                      ); 
                                  })
                              ) : (
                                  <tr><td colSpan="6" className="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</td></tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </Card>
          </div>
      );
  };

  const ContractorVendorList = () => {
      // --- NEW: Aggregate suppliers from both manual list and all recorded contracts across all units ---
      const combinedSuppliersMap = new Map();
      
      // 1. Base contractors (Manual list)
      contractors.forEach(c => {
          if (c.name) combinedSuppliersMap.set(c.name.trim().toLowerCase(), { ...c });
      });

      // 2. Extract from ALL contracts (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)
      contracts.forEach(ct => {
          if (!ct.vendorName) return;
          const key = ct.vendorName.trim().toLowerCase();
          
          if (!combinedSuppliersMap.has(key)) {
              // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà
              combinedSuppliersMap.set(key, {
                  id: `auto_${ct.id}`,
                  name: ct.vendorName,
                  type: ct.type.split(' (')[0], // ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πà‡∏≤‡∏¢
                  category: ct.category,
                  contact: ct.contactPerson || '-',
                  phone: ct.contactPhone || '-',
                  email: '-',
                  status: 'Active',
                  isAuto: true // ‡πÅ‡∏ü‡∏•‡πá‡∏Å‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤
              });
          } else {
              // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ
              const existing = combinedSuppliersMap.get(key);
              if ((!existing.contact || existing.contact === '-') && ct.contactPerson) existing.contact = ct.contactPerson;
              if ((!existing.phone || existing.phone === '-') && ct.contactPhone) existing.phone = ct.contactPhone;
          }
      });

      const allSuppliersList = Array.from(combinedSuppliersMap.values());

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
      const availableTypes = [...new Set(allSuppliersList.map(c => c.type))].filter(Boolean);

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const filteredContractors = allSuppliersList.filter(c => {
          const searchLower = supplierSearch.toLowerCase();
          const matchSearch = (c.name && c.name.toLowerCase().includes(searchLower)) || 
                              (c.contact && c.contact.toLowerCase().includes(searchLower)) ||
                              (c.email && c.email.toLowerCase().includes(searchLower));
          
          const matchType = supplierTypeFilter ? c.type === supplierTypeFilter : true;
          const matchCategory = supplierCategoryFilter ? (c.category && c.category === supplierCategoryFilter) : true;
          
          return matchSearch && matchType && matchCategory;
      });

      return (
          <div className="space-y-6 animate-fade-in">
              <Card>
                  <div className="p-4 border-b flex justify-between items-center bg-white">
                      <div>
                          <h3 className="font-bold flex items-center gap-2 text-gray-800">
                              <Search size={20} className="text-orange-500" /> {t('contractorList')}
                          </h3>
                          <p className="text-sm text-gray-500 mt-1">{t('managePartners')}</p>
                      </div>
                      <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                          <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(filteredContractors, 'contractors_list')}>Export</Button>
                          {hasPerm('proj_contractors', 'save') && <Button size="sm" icon={Plus}>{t('addNew')}</Button>}
                      </div>
                  </div>

                  {/* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á */}
                  <div className={`p-4 bg-gray-50 border-b border-gray-200 ${isExporting ? 'hidden' : ''}`}>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                              <label className="block text-xs font-bold text-gray-500 mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Search)</label>
                              <div className="relative">
                                  <Search size={16} className="absolute left-3 top-2.5 text-gray-400" />
                                  <input 
                                      type="text"
                                      placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•..."
                                      className="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-all bg-white"
                                      value={supplierSearch}
                                      onChange={(e) => setSupplierSearch(e.target.value)}
                                  />
                              </div>
                          </div>
                          <div>
                              <label className="block text-xs font-bold text-gray-500 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)</label>
                              <select 
                                  className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none bg-white transition-all"
                                  value={supplierTypeFilter}
                                  onChange={(e) => setSupplierTypeFilter(e.target.value)}
                              >
                                  <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Types) --</option>
                                  {availableTypes.map(t => <option key={t} value={t}>{t}</option>)}
                              </select>
                          </div>
                          <div>
                              <label className="block text-xs font-bold text-gray-500 mb-2">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Category)</label>
                              <select 
                                  className="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none bg-white transition-all"
                                  value={supplierCategoryFilter}
                                  onChange={(e) => setSupplierCategoryFilter(e.target.value)}
                              >
                                  <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Categories) --</option>
                                  {Object.entries(SERVICE_TYPES).map(([typeKey, categories]) => (
                                      <optgroup key={typeKey} label={typeKey}>
                                          {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                      </optgroup>
                                  ))}
                              </select>
                          </div>
                      </div>
                  </div>

                  {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
                  <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                          <thead className="bg-gray-100 text-gray-600 uppercase">
                              <tr>
                                  <th className="p-4">{t('col_company')}</th>
                                  <th className="p-4">{t('col_type')}</th>
                                  <th className="p-4">{t('col_category')}</th>
                                  <th className="p-4">{t('col_contact')}</th>
                                  <th className="p-4">{t('col_phoneEmail')}</th>
                                  <th className="p-4 text-center">{t('col_status')}</th>
                                  <th className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100 bg-white">
                              {filteredContractors.length > 0 ? (
                                  filteredContractors.map(c => (
                                      <tr key={c.id} className="hover:bg-orange-50 transition-colors cursor-pointer group" onClick={() => setSelectedSupplierDetails(c)}>
                                          <td className="p-4">
                                              <div className="font-bold text-gray-800 group-hover:text-orange-600 transition-colors flex items-center gap-1.5">
                                                  {c.name}
                                                  <Search size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                                              </div>
                                          </td>
                                          <td className="p-4"><Badge status={c.type} /></td>
                                          <td className="p-4"><Badge status={c.category} /></td>
                                          <td className="p-4 text-gray-700 flex items-center gap-2">
                                              <User size={14} className="text-gray-400"/> {c.contact}
                                          </td>
                                          <td className="p-4">
                                              <div className="text-xs text-gray-800 flex items-center gap-1 mb-1"><Phone size={12} className="text-gray-400"/> {c.phone}</div>
                                              <div className="text-xs text-gray-500 flex items-center gap-1"><Mail size={12} className="text-gray-400"/> {c.email}</div>
                                          </td>
                                          <td className="p-4 text-center"><Badge status={c.status} /></td>
                                          <td className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>
                                              {hasPerm('proj_contractors', 'delete') && !c.isAuto && (
                                                  <button 
                                                      onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå ${c.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setContractors(contractors.filter(con => con.id !== c.id))); }}
                                                      className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                      title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                  >
                                                      <Trash2 size={16} />
                                                  </button>
                                              )}
                                              {c.isAuto && (
                                                  <span className="text-[10px] text-gray-400 border border-gray-200 px-1 py-0.5 rounded bg-gray-50 cursor-help" title="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤)">Auto</span>
                                              )}
                                          </td>
                                      </tr>
                                  ))
                              ) : (
                                  <tr>
                                      <td colSpan="7" className="p-12 text-center">
                                          <div className="flex flex-col items-center text-gray-400">
                                              <Search size={40} className="mb-2 text-gray-300"/>
                                              <div className="font-medium text-gray-500 text-base">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Supplier ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
                                              <div className="text-xs mt-1">‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                                          </div>
                                      </td>
                                  </tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </Card>
          </div>
      );
  };

  const ProjectDetail = () => {
    const remainingDays = calculateDaysRemaining(selectedProject.contractEndDate);

    // --- NEW: Drag & Drop Logic for Schedule ---
    const projectStaffForSchedule = users.filter(u => u.department === selectedProject.name);
    const currentOrder = projectStaffOrder[selectedProject.id] || [];
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const sortedStaff = [...projectStaffForSchedule].sort((a, b) => {
        let indexA = currentOrder.indexOf(a.id);
        let indexB = currentOrder.indexOf(b.id);
        if (indexA === -1) indexA = 9999; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
        if (indexB === -1) indexB = 9999;
        return indexA - indexB;
    });

    const handleDragEnd = () => {
        if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
            const newStaffOrder = [...sortedStaff];
            const draggedItemContent = newStaffOrder[dragItem.current];
            newStaffOrder.splice(dragItem.current, 1);
            newStaffOrder.splice(dragOverItem.current, 0, draggedItemContent);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á State ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£
            setProjectStaffOrder(prev => ({
                ...prev,
                [selectedProject.id]: newStaffOrder.map(u => u.id)
            }));
        }
        dragItem.current = null;
        dragOverItem.current = null;
    };
    // ------------------------------------------

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
    const canEditProfile = (targetUser) => {
        if (!currentUser) return false;
        return currentUser.username === 'admin' || currentUser.id === targetUser.id;
    };

    const getStaffHierarchy = () => {
        const projectStaff = users.filter(u => u.department === selectedProject.name);
        return {
        managers: projectStaff.filter(u => 
            (u.position.toLowerCase().includes('manager') || u.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£')) &&
            !u.position.toLowerCase().includes('assistant') && !u.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢')
        ),
        supervisors: projectStaff.filter(u => 
            u.position.toLowerCase().includes('chief') || u.position.includes('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤') || 
            u.position.toLowerCase().includes('assistant') || u.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢')
        ),
        staff: projectStaff.filter(u => 
            !u.position.toLowerCase().includes('manager') && !u.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£') &&
            !u.position.toLowerCase().includes('chief') && !u.position.includes('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤') &&
            !u.position.toLowerCase().includes('assistant') && !u.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢')
        )
        };
    };

    const OrgChartNode = ({ user, color = "blue" }) => (
      <div 
        className={`flex flex-col items-center bg-white p-3 rounded-xl shadow-sm border-t-4 border-${color}-500 w-48 text-center relative transition-transform hover:-translate-y-1 hover:shadow-md ${canEditProfile(user) ? 'cursor-pointer group' : ''}`}
        onClick={() => canEditProfile(user) && handleEditUser(user)}
        title={canEditProfile(user) ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß" : "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"}
      >
        {canEditProfile(user) && (
            <div className="absolute top-2 right-2 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                <Edit size={14} className="hover:text-orange-500" />
            </div>
        )}
        <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mb-2 border-2 border-white shadow-sm">
           {user.photo ? <img src={user.photo} alt="" className="w-full h-full object-cover" /> : <User size={24} className="text-gray-400"/>}
        </div>
        <div className={`font-bold text-gray-800 text-sm truncate w-full transition-colors ${canEditProfile(user) ? 'group-hover:text-orange-600' : ''}`}>{user.firstName} {user.lastName}</div>
        <div className="text-xs text-gray-500 truncate w-full mb-1">{user.position}</div>
        <div className="mt-1 flex gap-2 justify-center" onClick={e => e.stopPropagation()}>
            {user.phone && <a href={`tel:${user.phone}`} className="text-gray-400 hover:text-green-500"><Phone size={12}/></a>}
            {user.email && <a href={`mailto:${user.email}`} className="text-gray-400 hover:text-blue-500"><Mail size={12}/></a>}
        </div>
      </div>
    );

    return (
      <div className={`space-y-6 ${isExporting ? 'w-max min-w-full' : ''}`}>
        <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-start gap-4 mb-6 ${isExporting ? 'hidden' : ''}`}>
          <div>
            <div className={`flex items-center gap-3 mb-2 ${isExporting ? 'hidden' : ''}`}>
                <div 
                    className={`p-2 rounded-lg bg-orange-50 text-orange-600 ${hasPerm('projects', 'edit') ? 'cursor-pointer hover:bg-orange-100 transition-colors' : ''}`} 
                    onClick={() => hasPerm('projects', 'edit') && handleEditProjectClick()}
                    title={hasPerm('projects', 'edit') ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" : ""}
                >
                    {selectedProject.logo ? <img src={selectedProject.logo} className="w-8 h-8 object-contain" /> : <Building2 size={28} />}
                </div>
                <h1 
                    className={`text-2xl md:text-3xl font-black text-gray-800 flex items-center gap-2 transition-all ${hasPerm('projects', 'edit') ? 'cursor-pointer group' : ''}`}
                    onClick={() => hasPerm('projects', 'edit') && handleEditProjectClick()}
                    title={hasPerm('projects', 'edit') ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" : ""}
                >
                    <span className="group-hover:text-orange-600 group-hover:underline decoration-2 underline-offset-4 transition-all">
                        {selectedProject.name}
                    </span>
                    {hasPerm('projects', 'edit') && (
                        <Edit size={22} className="text-gray-400 group-hover:text-orange-500 transition-colors shrink-0 ml-1" />
                    )}
                </h1>
            </div>
            <h1 className={`text-3xl font-black text-gray-800 mb-2 ${isExporting ? 'block' : 'hidden'}`}>{selectedProject.name}</h1>
            <p className="text-gray-500 text-sm md:text-base mb-4 flex items-center gap-2">
                <MapPin size={16} className="text-gray-400"/> {selectedProject.type} - {selectedProject.address}
            </p>
            <div className="flex flex-wrap gap-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg inline-flex border border-gray-100">
                <div className="flex items-center gap-2"><Calendar size={16} className="text-blue-500"/> ‡πÄ‡∏£‡∏¥‡πà‡∏°: {selectedProject.contractStartDate} ‡∏ñ‡∏∂‡∏á {selectedProject.contractEndDate}</div>
                <div className="border-l border-gray-300 pl-4 flex items-center gap-2 font-semibold text-orange-600"><Hourglass size={16}/> {remainingDays > 0 ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${remainingDays} ${t('days')}` : t('expired')}</div>
            </div>
          </div>
          <div className={`flex flex-wrap items-start gap-2 shrink-0 ${isExporting ? 'hidden' : ''}`}>
              {hasPerm('projects', 'edit') && (
                  <Button 
                      variant="outline" 
                      className="border-orange-500 text-orange-600 hover:bg-orange-50 font-bold bg-white shadow-sm" 
                      icon={Edit} 
                      onClick={() => handleEditProjectClick()}
                  >
                      ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                  </Button>
              )}
              <Button variant="outline" onClick={() => exportToCSV([selectedProject], 'project_detail')}>{t('exportInfo')}</Button>
              <Button variant="outline" icon={isExporting ? Loader2 : Printer} onClick={() => handleExportPDF('print-area', 'Project_Overview.pdf', 'portrait')} disabled={isExporting}>{isExporting ? t('downloading') : t('printPDF')}</Button>
          </div>
        </div>
        
        <div className="min-h-[400px]">
          {projectTab === 'overview' && (
              <div className="space-y-6 animate-fade-in">
                  {(() => {
                      // --- Date Context ---
                      const today = new Date();
                      const currentY = today.getFullYear();
                      const currentM = today.getMonth(); // 0-11
                      const daysPassedInMonth = today.getDate();

                      // --- 1. Contracts expiring < 45 days ---
                      const expiringContracts = contracts.filter(c => 
                          c.projectId === selectedProject.id && 
                          c.status === 'Active' &&
                          calculateDaysRemaining(c.endDate) >= 0 && 
                          calculateDaysRemaining(c.endDate) <= 45
                      ).sort((a,b) => calculateDaysRemaining(a.endDate) - calculateDaysRemaining(b.endDate));

                      // --- 2. Leave Usage (H, V, BL, S) for current month ---
                      const projectStaffIds = users.filter(u => u.department === selectedProject.name).map(u => u.id);
                      const leaveCounts = { H: 0, V: 0, BL: 0, S: 0 };
                      const currentMonthStr = `${currentY}-${String(currentM + 1).padStart(2, '0')}`;
                      Object.keys(schedules).forEach(key => {
                          const [userId, dateStr] = key.split('_');
                          if (projectStaffIds.includes(userId) && dateStr.startsWith(currentMonthStr)) {
                              const shift = schedules[key];
                              if (['H', 'V', 'BL', 'S'].includes(shift)) {
                                  leaveCounts[shift]++;
                              }
                          }
                      });

                      // --- 3. Daily Reports Summary ---
                      const currentMonthReports = dailyReports.filter(r => {
                          if (r.projectId !== selectedProject.id) return false;
                          return r.date.startsWith(currentMonthStr);
                      });
                      // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                      const uniqueReportDays = new Set(currentMonthReports.map(r => r.date)).size;
                      const missingReportDays = Math.max(0, daysPassedInMonth - uniqueReportDays);

                      // --- 4. PM Status Summary ---
                      const activePmPlans = pmPlans.filter(p => p.projectId === selectedProject.id && p.status === 'Active');
                      const pmDoneThisMonth = pmHistoryList.filter(h => h.projectId === selectedProject.id && h.date.startsWith(currentMonthStr));
                      const uniqueMachinesPMd = new Set(pmDoneThisMonth.map(h => h.machineId)).size;
                      const totalMachinesToPM = activePmPlans.map(p => p.machineId); // Simplified: Assume 1 plan per machine for total base
                      const uniqueMachinesToPM = new Set(totalMachinesToPM).size;

                      // --- 5. Utility Meters Summary ---
                      const projMeters = meters.filter(m => m.projectId === selectedProject.id);
                      const expectedReadings = projMeters.length * daysPassedInMonth;
                      const currentMonthReadings = utilityReadings.filter(r => {
                          const m = projMeters.find(m => m.id === r.meterId);
                          return m && r.date.startsWith(currentMonthStr);
                      });
                      const missingReadings = Math.max(0, expectedReadings - currentMonthReadings.length);

                      // --- 6. Action Plan Summary ---
                      const projActionPlans = actionPlans.filter(a => a.projectId === selectedProject.id);
                      const apStatusCounts = { 'Pending': 0, 'In Progress': 0, 'Completed': 0, 'Cancelled': 0 };
                      projActionPlans.forEach(ap => { if (apStatusCounts[ap.status] !== undefined) apStatusCounts[ap.status]++; });
                      const totalAP = projActionPlans.length;

                      // --- 7. Audit Summary & Ranking ---
                      const projAudits = audits.filter(a => a.projectId === selectedProject.id);
                      const avgScore = projAudits.length > 0 ? (projAudits.reduce((sum, a) => sum + a.score, 0) / projAudits.length).toFixed(1) : 0;
                      
                      // Calculate rank across all projects
                      const projectAvgScores = projects.map(p => {
                          const pAudits = audits.filter(a => a.projectId === p.id);
                          const avg = pAudits.length > 0 ? (pAudits.reduce((sum, a) => sum + a.score, 0) / pAudits.length) : 0;
                          return { id: p.id, avg };
                      }).sort((a, b) => b.avg - a.avg);
                      
                      const rankIndex = projectAvgScores.findIndex(p => p.id === selectedProject.id);
                      const rankStr = rankIndex >= 0 && projAudits.length > 0 ? rankIndex + 1 : '-';
                      const totalProjectsWithAudit = projectAvgScores.filter(p => p.avg > 0).length;

                      return (
                          <>
                              {/* Row 1: High Priority Alerts */}
                              {expiringContracts.length > 0 && (
                                  <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg flex items-start gap-3 shadow-sm">
                                      <AlertTriangle className="text-red-500 shrink-0 mt-0.5" size={20} />
                                      <div className="flex-1">
                                          <h4 
                                            className="text-red-800 font-bold mb-1 cursor-pointer hover:underline flex items-center gap-1"
                                            onClick={() => setProjectTab('contracts')}
                                          >
                                            ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 45 ‡∏ß‡∏±‡∏ô) <ArrowRight size={14} />
                                          </h4>
                                          <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
                                              {expiringContracts.map(c => (
                                                  <div key={c.id} className="bg-white px-3 py-2 rounded border border-red-100 flex justify-between items-center text-sm">
                                                      <span className="font-medium text-gray-700 truncate pr-2" title={c.vendorName}>{c.vendorName}</span>
                                                      <span className="text-red-600 font-bold whitespace-nowrap bg-red-50 px-2 py-0.5 rounded">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {calculateDaysRemaining(c.endDate)} ‡∏ß‡∏±‡∏ô</span>
                                                  </div>
                                              ))}
                                          </div>
                                      </div>
                                  </div>
                              )}

                              {/* Row 2: Main Overview Cards */}
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                  
                                  {/* Card: Audit Rank */}
                                  <Card className="p-5 flex flex-col justify-center items-center text-center relative overflow-hidden group hover:shadow-md hover:border-blue-300 transition-all">
                                      {/* Background Icon - Clicking goes to Audit Tab */}
                                      <div 
                                          className="absolute -right-4 -top-4 text-blue-50 opacity-50 group-hover:scale-110 transition-transform cursor-pointer z-0"
                                          onClick={() => setProjectTab('audit')}
                                          title="‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Audit"
                                      >
                                          <ClipboardCheck size={100} />
                                      </div>
                                      
                                      <div className="relative z-10 flex flex-col items-center w-full">
                                          <h4 
                                              className="text-sm font-bold text-gray-500 mb-2 group-hover:text-blue-600 transition-colors flex items-center gap-1 cursor-pointer"
                                              onClick={() => setProjectTab('audit')}
                                          >
                                              ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <ArrowRight size={12} className="opacity-0 group-hover:opacity-100 transition-opacity" />
                                          </h4>
                                          <div 
                                              className="flex items-baseline gap-1 cursor-pointer"
                                              onClick={() => setProjectTab('audit')}
                                          >
                                              <span className="text-4xl font-black text-blue-600">{avgScore}%</span>
                                          </div>
                                          
                                          {/* The Ranking Button - Clicking opens the Modal */}
                                          <button 
                                              onClick={(e) => {
                                                  e.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡πÇ‡∏î‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                                                  setShowAuditRankingModal(true);
                                              }}
                                              className="mt-3 w-full flex justify-center items-center gap-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 hover:text-blue-800 px-3 py-2 rounded-lg text-xs font-bold border border-blue-200 shadow-sm cursor-pointer transition-all hover:shadow"
                                              title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                                          >
                                              <BarChart3 size={16} /> 
                                              {rankStr !== '-' ? `‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (‡∏ó‡∏µ‡πà ${rankStr} ‡∏à‡∏≤‡∏Å ${totalProjectsWithAudit})` : '‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                                          </button>
                                      </div>
                                  </Card>

                                  {/* Card: Daily Reports */}
                                  <Card className="p-5 flex flex-col hover:shadow-sm transition-all">
                                      <div 
                                        className="flex items-center gap-2 text-gray-700 font-bold mb-4 border-b pb-2 cursor-pointer hover:text-purple-600 group transition-colors"
                                        onClick={() => setProjectTab('daily')}
                                      >
                                        <FileText size={18} className="text-purple-500 group-hover:scale-110 transition-transform"/> 
                                        ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
                                        <ArrowRight size={14} className="ml-auto opacity-0 group-hover:opacity-100 transition-opacity" />
                                      </div>
                                      <div className="flex-1 flex flex-col justify-center gap-4">
                                          <div className="flex justify-between items-center">
                                              <span className="text-sm text-gray-600">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                                              <span className="text-lg font-bold text-green-600 bg-green-50 px-2 rounded">{uniqueReportDays} ‡∏ß‡∏±‡∏ô</span>
                                          </div>
                                          <div className="flex justify-between items-center">
                                              <span className="text-sm text-gray-600">‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</span>
                                              <span className={`text-lg font-bold px-2 rounded ${missingReportDays > 0 ? 'text-red-600 bg-red-50' : 'text-gray-400 bg-gray-50'}`}>{missingReportDays} ‡∏ß‡∏±‡∏ô</span>
                                          </div>
                                      </div>
                                      <div className="text-[10px] text-gray-400 mt-auto pt-2 text-right">*‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ({daysPassedInMonth} ‡∏ß‡∏±‡∏ô)</div>
                                  </Card>

                                  {/* Card: Meter Readings */}
                                  <Card className="p-5 flex flex-col hover:shadow-sm transition-all">
                                      <div 
                                        className="flex items-center gap-2 text-gray-700 font-bold mb-4 border-b pb-2 cursor-pointer hover:text-cyan-600 group transition-colors"
                                        onClick={() => setProjectTab('utilities')}
                                      >
                                        <Droplet size={18} className="text-cyan-500 group-hover:scale-110 transition-transform"/> 
                                        ‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
                                        <ArrowRight size={14} className="ml-auto opacity-0 group-hover:opacity-100 transition-opacity" />
                                      </div>
                                      <div className="flex-1 flex flex-col justify-center gap-4">
                                          <div className="flex justify-between items-center">
                                              <span className="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ</span>
                                              <span className="font-bold text-gray-800">{projMeters.length} ‡∏à‡∏∏‡∏î</span>
                                          </div>
                                          <div className="w-full bg-gray-100 rounded-full h-2.5 mb-1">
                                              <div className="bg-cyan-500 h-2.5 rounded-full" style={{ width: expectedReadings > 0 ? `${(currentMonthReadings.length/expectedReadings)*100}%` : '0%' }}></div>
                                          </div>
                                          <div className="flex justify-between items-center text-xs">
                                              <span className="text-gray-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <strong className="text-cyan-600">{currentMonthReadings.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                              <span className={missingReadings > 0 ? 'text-red-500 font-medium' : 'text-gray-400'}>‡∏Ñ‡πâ‡∏≤‡∏á: {missingReadings} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                          </div>
                                      </div>
                                  </Card>

                                  {/* Card: Leave Usage */}
                                  <Card className="p-5 flex flex-col hover:shadow-sm transition-all">
                                      <div 
                                        className="flex items-center gap-2 text-gray-700 font-bold mb-3 border-b pb-2 cursor-pointer hover:text-pink-600 group transition-colors"
                                        onClick={() => setProjectTab('schedule')}
                                      >
                                        <Calendar size={18} className="text-pink-500 group-hover:scale-110 transition-transform"/> 
                                        ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
                                        <ArrowRight size={14} className="ml-auto opacity-0 group-hover:opacity-100 transition-opacity" />
                                      </div>
                                      <div className="grid grid-cols-2 gap-3 flex-1">
                                          <div className="bg-gray-50 rounded p-2 text-center border border-gray-100 flex flex-col justify-center">
                                              <span className="text-[10px] font-bold text-gray-500 mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏Ø (H)</span>
                                              <span className="text-xl font-black text-red-500">{leaveCounts.H}</span>
                                          </div>
                                          <div className="bg-gray-50 rounded p-2 text-center border border-gray-100 flex flex-col justify-center">
                                              <span className="text-[10px] font-bold text-gray-500 mb-1">‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô (V)</span>
                                              <span className="text-xl font-black text-blue-500">{leaveCounts.V}</span>
                                          </div>
                                          <div className="bg-gray-50 rounded p-2 text-center border border-gray-100 flex flex-col justify-center">
                                              <span className="text-[10px] font-bold text-gray-500 mb-1">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (BL)</span>
                                              <span className="text-xl font-black text-pink-500">{leaveCounts.BL}</span>
                                          </div>
                                          <div className="bg-gray-50 rounded p-2 text-center border border-gray-100 flex flex-col justify-center">
                                              <span className="text-[10px] font-bold text-gray-500 mb-1">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (S)</span>
                                              <span className="text-xl font-black text-orange-500">{leaveCounts.S}</span>
                                          </div>
                                      </div>
                                  </Card>
                              </div>

                              {/* Row 3: AP & PM Status */}
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  {/* Action Plan Progress */}
                                  <Card className="p-6 hover:shadow-sm transition-all">
                                      <h3 
                                        className="font-bold mb-4 flex items-center gap-2 text-gray-800 cursor-pointer hover:text-green-600 group transition-colors w-fit"
                                        onClick={() => setProjectTab('action')}
                                      >
                                        <CheckCircle className="text-green-500 group-hover:scale-110 transition-transform" size={20}/> 
                                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô Action Plan
                                        <ArrowRight size={16} className="opacity-0 group-hover:opacity-100 transition-opacity ml-1" />
                                      </h3>
                                      {totalAP > 0 ? (
                                          <div className="space-y-4 mt-2">
                                              {/* Completed */}
                                              <div>
                                                  <div className="flex justify-between text-sm mb-1">
                                                      <span className="font-medium text-gray-700">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (Completed)</span>
                                                      <span className="font-bold text-green-600">{apStatusCounts['Completed']} / {totalAP}</span>
                                                  </div>
                                                  <div className="w-full bg-gray-100 rounded-full h-2">
                                                      <div className="bg-green-500 h-2 rounded-full" style={{ width: `${(apStatusCounts['Completed']/totalAP)*100}%` }}></div>
                                                  </div>
                                              </div>
                                              {/* In Progress */}
                                              <div>
                                                  <div className="flex justify-between text-sm mb-1">
                                                      <span className="font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ (In Progress)</span>
                                                      <span className="font-bold text-blue-600">{apStatusCounts['In Progress']} / {totalAP}</span>
                                                  </div>
                                                  <div className="w-full bg-gray-100 rounded-full h-2">
                                                      <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(apStatusCounts['In Progress']/totalAP)*100}%` }}></div>
                                                  </div>
                                              </div>
                                              {/* Pending */}
                                              <div>
                                                  <div className="flex justify-between text-sm mb-1">
                                                      <span className="font-medium text-gray-700">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Pending)</span>
                                                      <span className="font-bold text-orange-500">{apStatusCounts['Pending']} / {totalAP}</span>
                                                  </div>
                                                  <div className="w-full bg-gray-100 rounded-full h-2">
                                                      <div className="bg-orange-400 h-2 rounded-full" style={{ width: `${(apStatusCounts['Pending']/totalAP)*100}%` }}></div>
                                                  </div>
                                              </div>
                                          </div>
                                      ) : (
                                          <div className="h-32 flex items-center justify-center text-gray-400 text-sm border-2 border-dashed rounded-lg bg-gray-50">
                                              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Action Plan
                                          </div>
                                      )}
                                  </Card>

                                  {/* PM Maintenance Plan Status */}
                                  <Card className="p-6 hover:shadow-sm transition-all">
                                      <h3 
                                        className="font-bold mb-4 flex items-center gap-2 text-gray-800 cursor-pointer hover:text-orange-600 group transition-colors w-fit"
                                        onClick={() => setProjectTab('pm')}
                                      >
                                        <Wrench className="text-orange-500 group-hover:scale-110 transition-transform" size={20}/> 
                                        ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
                                        <ArrowRight size={16} className="opacity-0 group-hover:opacity-100 transition-opacity ml-1" />
                                      </h3>
                                      
                                      <div className="flex items-center justify-between gap-4 h-full pb-4">
                                          <div className="flex-1 bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                                              <div className="text-gray-500 text-sm font-bold mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á PM</div>
                                              <div className="text-3xl font-black text-gray-800">{uniqueMachinesToPM} <span className="text-sm font-normal text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö</span></div>
                                          </div>
                                          
                                          <div className="text-gray-300"><ArrowRight size={24} /></div>
                                          
                                          <div className="flex-1 bg-green-50 p-4 rounded-xl border border-green-200 text-center">
                                              <div className="text-green-700 text-sm font-bold mb-2">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</div>
                                              <div className="text-3xl font-black text-green-600">{uniqueMachinesPMd} <span className="text-sm font-normal text-green-600/70">‡∏£‡∏∞‡∏ö‡∏ö</span></div>
                                          </div>
                                      </div>
                                      
                                      {uniqueMachinesToPM > 0 && uniqueMachinesPMd < uniqueMachinesToPM && (
                                          <div className="text-xs text-red-600 font-medium text-center bg-red-50 py-2 rounded-md border border-red-100 mt-2">
                                              <AlertTriangle size={14} className="inline mr-1 -mt-0.5"/> 
                                              ‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô (‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤): {uniqueMachinesToPM - uniqueMachinesPMd} ‡∏£‡∏∞‡∏ö‡∏ö
                                          </div>
                                      )}
                                      {uniqueMachinesToPM > 0 && uniqueMachinesPMd >= uniqueMachinesToPM && (
                                          <div className="text-xs text-green-700 font-medium text-center bg-green-100 py-2 rounded-md border border-green-200 mt-2">
                                              <CheckCircle size={14} className="inline mr-1 -mt-0.5"/> 
                                              ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô 100%
                                          </div>
                                      )}
                                      {uniqueMachinesToPM === 0 && (
                                          <div className="text-xs text-gray-500 text-center py-2 mt-2">
                                              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô PM ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                          </div>
                                      )}
                                  </Card>
                              </div>

                              {/* Row 4: Project Documents */}
                              <Card className="p-6 hover:shadow-sm transition-all mt-6 border-t-4 border-blue-500">
                                  <h3 className="font-bold mb-4 flex items-center gap-2 text-gray-800">
                                      <FileText className="text-blue-500" size={20}/> 
                                      ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Project Documents)
                                  </h3>
                                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                      {[
                                          { key: 'orchor', label: t('doc_orchor') }, 
                                          { key: 'committee', label: t('doc_committee') }, 
                                          { key: 'regulations', label: t('doc_regulations') }, 
                                          { key: 'resident_rules', label: t('doc_resident_rules') }
                                      ].map((doc) => {
                                          const fileObj = selectedProject.files && selectedProject.files[doc.key];
                                          const hasFile = !!fileObj;
                                          const fileName = typeof fileObj === 'string' ? fileObj : fileObj?.name;

                                          return (
                                              <div key={doc.key} className={`border rounded-xl p-4 flex flex-col items-center text-center transition-all ${hasFile ? 'bg-white border-blue-200 shadow-sm' : 'bg-gray-50 border-gray-200'}`}>
                                                  <div className={`p-3 rounded-full mb-3 ${hasFile ? 'bg-blue-100 text-blue-600' : 'bg-gray-200 text-gray-400'}`}>
                                                      <FileText size={24} />
                                                  </div>
                                                  <div className="font-bold text-sm text-gray-700 mb-1">{doc.label}</div>
                                                  {hasFile ? (
                                                      <>
                                                          <div className="text-xs text-gray-500 mb-3 truncate w-full px-2" title={fileName}>
                                                              {fileName}
                                                          </div>
                                                          <Button 
                                                              size="sm" 
                                                              className="w-full flex items-center justify-center gap-2 bg-blue-50 hover:bg-blue-600 text-blue-700 hover:text-white border border-blue-200 hover:border-blue-600 transition-colors"
                                                              onClick={() => handleDownloadFile(fileObj, fileName || `${doc.key}.pdf`)}
                                                          >
                                                              <Download size={14} /> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                                                          </Button>
                                                      </>
                                                  ) : (
                                                      <div className="text-xs text-gray-400 mt-auto py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</div>
                                                  )}
                                              </div>
                                          );
                                      })}
                                  </div>
                              </Card>
                          </>
                      );
                  })()}
              </div>
          )}
          
          {projectTab === 'contracts' && (() => { 
            const filteredContracts = contracts.filter(c => c.projectId === selectedProject.id && (contractFilter === 'All' || c.type === contractFilter));
            const totalAmount = filteredContracts.reduce((sum, c) => sum + Number(c.amount || 0), 0);

            return (
            <Card>
                <div className="p-4 border-b flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                    <h3 className="font-bold">{t('activeContracts')}</h3>
                    
                    {/* Filter Buttons */}
                    <div className="flex bg-gray-100 p-1 rounded-lg w-full lg:w-auto overflow-x-auto">
                        <button
                            onClick={() => setContractFilter('All')}
                            className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all whitespace-nowrap ${contractFilter === 'All' ? 'bg-white shadow text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
                        >
                            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        {Object.values(CONTRACT_TYPES).map(type => (
                            <button
                                key={type}
                                onClick={() => setContractFilter(type)}
                                className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all whitespace-nowrap ${contractFilter === type ? 'bg-white shadow text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                {type.split(' (')[0]}
                            </button>
                        ))}
                    </div>

                    <div className={`flex gap-2 ${isExporting ? 'hidden' : ''} shrink-0`}>
                        <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(filteredContracts, 'contracts_list')}>{t('exportCSV')}</Button>
                        {hasPerm('proj_contracts', 'save') && <Button size="sm" icon={Plus} onClick={() => { setIsEditingContract(false); setNewContract({ type: CONTRACT_TYPES.EXPENSE, category: '', customCategory: '', vendorName: '', contactPerson: '', contactPhone: '', startDate: '', endDate: '', amount: '', paymentCycle: 'Monthly', file: null }); setShowAddContractModal(true); }}>{t('addContract')}</Button>}
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                <th className="p-3 text-left">{t('col_vendor')}</th>
                                <th className="p-3 text-left">{t('contractType')}</th>
                                <th className="p-3 text-left">{t('col_subject')}</th>
                                <th className="p-3 text-left">{t('col_duration')}</th>
                                <th className="p-3 text-right">{t('col_amount')}</th>
                                <th className="p-3 text-left">{t('col_status')}</th>
                                <th className="p-3 text-center w-28">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {filteredContracts.length > 0 ? (
                                filteredContracts.map((c, index) => {
                                    const remDays = calculateDaysRemaining(c.endDate);
                                    return (
                                        <tr key={c.id} className="hover:bg-gray-50 transition-colors">
                                            <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                            <td className="p-3 cursor-pointer group" onClick={() => setSelectedContractView(c)}>
                                                <div className="font-bold text-gray-800 group-hover:text-orange-600 transition-colors flex items-center gap-1.5">
                                                    {c.vendorName}
                                                    <Search size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                </div>
                                                <div className="text-xs text-gray-500 mt-0.5">{c.contactPerson} <span className="text-gray-400 ml-1">({c.contactPhone})</span></div>
                                            </td>
                                            <td className="p-3 text-xs">
                                                <span className={`px-2 py-1 rounded-full ${
                                                    c.type === CONTRACT_TYPES.INCOME ? 'bg-green-100 text-green-700' :
                                                    c.type === CONTRACT_TYPES.EXPENSE ? 'bg-red-100 text-red-700' :
                                                    'bg-blue-100 text-blue-700'
                                                }`}>
                                                    {c.type.split(' (')[0]}
                                                </span>
                                            </td>
                                            <td className="p-3 text-gray-600">{c.category}</td>
                                            <td className="p-3 text-xs">
                                                <div>{c.startDate} - {c.endDate}</div>
                                                <div className={`font-bold mt-1 ${remDays < 30 ? 'text-red-600' : remDays < 90 ? 'text-orange-500' : 'text-green-600'}`}>
                                                    {remDays} {t('daysRemaining')}
                                                </div>
                                            </td>
                                            <td className="p-3 text-right">
                                                <div className="font-medium">{Number(c.amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div>
                                                <div className="text-[10px] text-gray-400">{c.paymentCycle === 'Monthly' ? t('monthly') : t('yearly')}</div>
                                            </td>
                                            <td className="p-3"><Badge status={c.status} /></td>
                                            <td className="p-3 text-center">
                                                <div className="flex justify-center items-center gap-1">
                                                    {(c.fileUrl || (c.file && (c.file.data || c.file.isLocal))) ? (
                                                        <button 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                handleDownloadFile(c.file || { fileUrl: c.fileUrl, name: `${c.vendorName}_Contract.pdf` });
                                                            }}
                                                            className="text-blue-600 hover:text-blue-800 p-1.5 bg-blue-50 hover:bg-blue-100 rounded-md transition-colors"
                                                            title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤"
                                                        >
                                                            <Download size={14} />
                                                        </button>
                                                    ) : (
                                                        <span className="text-gray-300 px-2">-</span>
                                                    )}
                                                    {!isExporting && hasPerm('proj_contracts', 'delete') && (
                                                        <button 
                                                            onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${c.vendorName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setContracts(contracts.filter(contract => contract.id !== c.id)))}
                                                            className="text-red-500 hover:text-red-700 p-1.5 bg-red-50 hover:bg-red-100 rounded-md transition-colors"
                                                            title="‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤"
                                                        >
                                                            <Trash2 size={14} />
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })
                            ) : (
                                <tr><td colSpan="8" className="p-6 text-center text-gray-500">{t('noData')}</td></tr>
                            )}
                        </tbody>
                        {filteredContracts.length > 0 && (
                            <tfoot className="bg-orange-50 font-bold text-gray-800 border-t-2 border-orange-200">
                                <tr>
                                    <td colSpan="5" className="p-4 text-right uppercase tracking-wide text-xs md:text-sm">
                                        ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ({contractFilter === 'All' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : contractFilter.split(' (')[0]}):
                                    </td>
                                    <td className="p-4 text-right text-orange-700 text-base whitespace-nowrap">
                                        {totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó
                                    </td>
                                    <td colSpan="2"></td>
                                </tr>
                            </tfoot>
                        )}
                    </table>
                </div>
            </Card>
            );
          })()}
          
          {projectTab === 'staff' && (
            <div className="animate-fade-in">
              <div className="flex justify-between items-center mb-4">
                 <h3 className="font-bold text-lg">{t('projectStaff')}</h3>
                 <div className="flex gap-2">
                    <div className="bg-gray-100 p-1 rounded-lg flex gap-1">
                        <button onClick={() => setStaffViewMode('list')} className={`p-1.5 rounded-md transition-all ${staffViewMode === 'list' ? 'bg-white shadow text-orange-600' : 'text-gray-400 hover:text-gray-600'}`} title="List View"><List size={18} /></button>
                        <button onClick={() => setStaffViewMode('chart')} className={`p-1.5 rounded-md transition-all ${staffViewMode === 'chart' ? 'bg-white shadow text-orange-600' : 'text-gray-400 hover:text-gray-600'}`} title="Organization Chart"><LayoutGrid size={18} /></button>
                    </div>
                    <div className={`flex gap-2 ${isExporting ? 'hidden' : ''} border-l pl-2 ml-2`}>
                        <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(users.filter(u => u.department === selectedProject.name), 'staff_list')}>{t('exportCSV')}</Button>
                        {hasPerm('proj_staff', 'save') && <Button size="sm" icon={Plus} onClick={handleAddStaffToProject}>{t('addStaff')}</Button>}
                    </div>
                 </div>
              </div>

              {staffViewMode === 'list' ? (
                <Card>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-50 text-gray-600 uppercase">
                        <tr>
                          <th className="p-3 text-center w-16">{t('col_seq')}</th>
                          <th className="p-3 text-center w-20">{t('col_photo')}</th>
                          <th className="p-3 text-left">{t('col_empId')}</th>
                          <th className="p-3 text-left">{t('col_name')}</th>
                          <th className="p-3 text-left">{t('col_role')}</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100">
                        {users.filter(u => u.department === selectedProject.name).length > 0 ? (
                          users.filter(u => u.department === selectedProject.name).map((user, index) => (
                            <tr key={user.id} className={`hover:bg-gray-50 transition-colors ${canEditProfile(user) ? 'cursor-pointer group' : ''}`} onClick={() => canEditProfile(user) && handleEditUser(user)}>
                              <td className="p-3 text-center text-gray-500">{index + 1}</td>
                              <td className="p-3 text-center">
                                <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mx-auto border border-gray-300">
                                    {user.photo ? <img src={user.photo} alt="" className="w-full h-full object-cover" /> : <User size={20} className="text-gray-400"/>}
                                </div>
                              </td>
                              <td className="p-3 text-gray-600 font-mono">{user.employeeId || '-'}</td>
                              <td className={`p-3 font-medium text-gray-900 transition-colors flex items-center gap-2 ${canEditProfile(user) ? 'group-hover:text-orange-600' : ''}`}>
                                {user.firstName} {user.lastName}
                                {canEditProfile(user) && <Edit size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />}
                              </td>
                              <td className="p-3"><span className="bg-gray-100 px-2 py-1 rounded text-xs text-gray-700">{user.position}</span></td>
                            </tr>
                          ))
                        ) : (
                          <tr><td colSpan="5" className="p-8 text-center text-gray-400">{t('noData')}</td></tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </Card>
              ) : (
                <div className="bg-gray-50 p-8 rounded-xl border border-gray-200 min-h-[500px] overflow-auto">
                    {(() => {
                        const { managers, supervisors, staff } = getStaffHierarchy();
                        const hasManagers = managers.length > 0;
                        const hasSupervisors = supervisors.length > 0;
                        const hasStaff = staff.length > 0;

                        if (!hasManagers && !hasSupervisors && !hasStaff) { return <div className="text-center text-gray-400 py-10">{t('noData')}</div>; }

                        return (
                            <div className="flex flex-col items-center gap-8 min-w-[600px]">
                                {hasManagers && (
                                    <div className="flex flex-col items-center w-full">
                                        <div className="flex justify-center gap-6 flex-wrap">{managers.map(u => <OrgChartNode key={u.id} user={u} color="orange" />)}</div>
                                        {(hasSupervisors || hasStaff) && <div className="h-8 border-l-2 border-gray-300 mt-2"></div>}
                                    </div>
                                )}
                                {hasSupervisors && (
                                    <div className="flex flex-col items-center w-full relative">
                                        {supervisors.length > 1 && <div className="absolute top-0 h-4 border-t-2 border-l-2 border-r-2 border-gray-300 w-[80%] rounded-t-xl -mt-4"></div>}
                                        <div className="flex justify-center gap-6 flex-wrap relative z-10 -mt-2">
                                            {supervisors.map(u => (<div key={u.id} className="flex flex-col items-center"><div className="h-4 border-l-2 border-gray-300 mb-2"></div><OrgChartNode user={u} color="blue" /></div>))}
                                        </div>
                                        {hasStaff && <div className="h-8 border-l-2 border-gray-300 mt-2"></div>}
                                    </div>
                                )}
                                {hasStaff && (
                                    <div className="flex flex-col items-center w-full relative">
                                         {staff.length > 1 && <div className="absolute top-0 h-4 border-t-2 border-l-2 border-r-2 border-gray-300 w-[90%] rounded-t-xl -mt-4"></div>}
                                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 relative z-10 -mt-2">
                                            {staff.map(u => (<div key={u.id} className="flex flex-col items-center"><div className="h-4 border-l-2 border-gray-300 mb-2"></div><OrgChartNode user={u} color="gray" /></div>))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })()}
                </div>
              )}
            </div>
          )}

          {projectTab === 'schedule' && (() => {
            // --- NEW: Logic for Schedule Deadlines and Approvals ---
            const approval = scheduleApprovals[`${selectedProject.id}_${currentMonth}`] || {};
            const isApproved = approval.status === 'Approved';
            const isLocked = approval.isLocked === true;

            const isHR = currentUser?.position?.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•') || currentUser?.username === 'admin';
            
            // Plan ‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ ‡πÅ‡∏•‡∏∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 22 ‡∏≠‡∏≠‡∏Å)
            const canEditPlan = !isLocked && !isApproved;
            
            // ACT ‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ
            const canEditAct = !isLocked;

            return (
            <Card 
                className={`${isExporting ? 'border-none shadow-none bg-white mx-auto' : 'min-w-full overflow-hidden'}`} 
                style={isExporting ? { width: '277mm', minWidth: '277mm', maxWidth: '277mm', boxSizing: 'border-box' } : {}}
                id="print-schedule-area"
            >
                <div className={`p-4 border-b flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 bg-white ${isExporting ? 'pb-2 pt-0 px-2' : ''}`}>
                    <div className="flex items-center gap-3">
                        <h3 className={`font-bold flex items-center gap-2 text-gray-800 ${isExporting ? 'text-base' : 'text-lg'}`}>
                            <Calendar size={20} className={isExporting ? 'hidden' : ''} />
                            {isExporting ? `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Work Schedule) - ${selectedProject.name}` : t('workSchedule')}
                        </h3>
                        {/* Status Badge */}
                        {(() => {
                            if (!approval.status) return <span className="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-xs font-bold border">‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</span>;
                            if (approval.isLocked) return <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold border border-red-200 shadow-sm flex items-center gap-1"><Lock size={12}/> ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>;
                            if (approval.status === 'Pending Manager') return <span className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-xs font-bold border border-orange-200 shadow-sm flex items-center gap-1"><Clock size={12}/> ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>;
                            if (approval.status === 'Pending HR') return <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold border border-blue-200 shadow-sm flex items-center gap-1"><Clock size={12}/> ‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>;
                            if (approval.status === 'Approved') return <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-200 shadow-sm flex items-center gap-1"><CheckCircle size={12}/> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</span>;
                            return null;
                        })()}
                    </div>
                    
                    <div className="flex items-center gap-4 w-full xl:w-auto">
                        <div className={`flex items-center rounded-lg p-1 ${isExporting ? '' : 'bg-gray-100'}`}>
                            <button onClick={() => changeMonth(-1)} className={`p-1 hover:bg-white rounded shadow-sm transition ${isExporting ? 'hidden' : ''}`}><ChevronLeft size={18}/></button>
                            <span className={`px-4 font-semibold text-gray-700 ${isExporting ? 'text-xs' : 'text-sm'}`}>
                                ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {new Date(currentMonth + '-01').toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { month: 'long', year: 'numeric' })}
                            </span>
                            <button onClick={() => changeMonth(1)} className={`p-1 hover:bg-white rounded shadow-sm transition ${isExporting ? 'hidden' : ''}`}><ChevronRight size={18}/></button>
                        </div>
                        <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                            <Button variant="outline" size="sm" icon={isExporting ? Loader2 : PrinterIcon} onClick={exportSchedulePDF} disabled={isExporting}>
                                {isExporting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...' : t('printPDF')}
                            </Button>
                            
                            {/* Approval Action Buttons */}
                            {(() => {
                                const approval = scheduleApprovals[`${selectedProject.id}_${currentMonth}`];
                                if (!approval) return null; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                
                                const isHR = currentUser?.position.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•') || currentUser?.username === 'admin';
                                const isManager = currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') || currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô') || currentUser?.username === 'admin';

                                if (approval.status === 'Pending Manager' && isManager) {
                                    return <Button size="sm" variant="success" icon={CheckCircle} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', handleApproveSchedule)}>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</Button>;
                                }
                                if (approval.status === 'Pending HR' && isHR) {
                                    return <Button size="sm" variant="success" icon={CheckCircle} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (HR) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', handleApproveSchedule)}>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</Button>;
                                }
                                
                                if (approval.status === 'Approved' && isHR) {
                                    if (approval.isLocked) {
                                        return <Button size="sm" variant="secondary" icon={Unlock} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ', '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', handleUnlockSchedule)}>‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á</Button>;
                                    } else {
                                        return <Button size="sm" variant="danger" icon={Lock} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á', '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á Plan ‡πÅ‡∏•‡∏∞ ACT ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', handleLockSchedule)}>‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î)</Button>;
                                    }
                                }

                                return null;
                            })()}

                            {hasPerm('proj_schedule', 'save') && <Button size="sm" icon={Save} onClick={handleSaveSchedule}>{t('save')}</Button>}
                        </div>
                    </div>
                </div>
                
                <div id="schedule-table-container" className={`w-full overflow-hidden pb-4 bg-white rounded-b-lg ${isExporting ? 'px-2' : ''}`}>
                    {(() => {
                        const [year, month] = currentMonth.split('-').map(Number);
                        const daysInMonth = getDaysInMonth(year, month);
                        const dayNamesTh = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
                        const dayNamesEn = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                        
                        return (
                            <table className={`border-collapse table-fixed w-full ${isExporting ? 'text-[8.5px]' : 'text-[9px] xl:text-[10px] 2xl:text-xs'}`}>
                                <thead>
                                    <tr className="bg-gray-100 border-b border-gray-300">
                                        <th className="border-r border-gray-300 text-center p-1 w-[3%]" rowSpan="2">{t('col_seq')}</th>
                                        <th className="border-r border-gray-300 text-center p-1 w-[6%] truncate" rowSpan="2">{t('col_empId')}</th>
                                        <th className="border-r border-gray-300 text-left px-1.5 p-1 w-[13%] truncate" rowSpan="2">{t('col_name')}</th>
                                        <th className="border-r border-gray-300 text-left px-1.5 p-1 w-[10%] truncate" rowSpan="2">{t('col_role')}</th>
                                        <th className="border-r border-gray-300 text-center p-1 w-[4%] text-[10px]" rowSpan="2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                        {daysInMonth.map(date => (
                                            <th key={date.getDate()} className="border-r border-gray-300 text-center font-normal text-gray-600 p-0.5">
                                                {date.getDate()}
                                            </th>
                                        ))}
                                    </tr>
                                    <tr className="bg-gray-50 border-b border-gray-300">
                                        {daysInMonth.map(date => (
                                            <th key={date.getDate()} className={`border-r border-gray-300 text-center font-bold p-0 text-[7px] md:text-[8px] xl:text-[9px] ${date.getDay() === 0 || date.getDay() === 6 ? 'text-red-500 bg-red-50' : 'text-gray-700'}`}>
                                                {lang === 'th' ? dayNamesTh[date.getDay()] : dayNamesEn[date.getDay()]}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                {sortedStaff.map((user, index) => (
                                    <tbody 
                                        key={user.id} 
                                        className={`border-b-2 border-gray-400 transition-all ${!isExporting ? 'cursor-move' : ''}`}
                                        draggable={!isExporting}
                                        onDragStart={(e) => { 
                                            dragItem.current = index; 
                                            e.currentTarget.style.opacity = '0.5';
                                            e.dataTransfer.effectAllowed = 'move';
                                        }}
                                        onDragEnter={(e) => { 
                                            dragOverItem.current = index; 
                                        }}
                                        onDragEnd={(e) => {
                                            e.currentTarget.style.opacity = '1';
                                            handleDragEnd();
                                        }}
                                        onDragOver={(e) => e.preventDefault()}
                                        title={!isExporting ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Drag & Drop)" : ""}
                                    >
                                        <tr className="hover:bg-gray-50 border-b border-gray-200">
                                            <td className="border-r border-gray-300 text-center text-gray-500 p-1 truncate" rowSpan="2">
                                                <div className="flex items-center justify-center gap-1.5">
                                                    {!isExporting && (
                                                        <div className="flex flex-col gap-[2px] opacity-30 hover:opacity-100 cursor-grab" title="‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
                                                            <div className="w-1 h-1 bg-gray-800 rounded-full"></div>
                                                            <div className="w-1 h-1 bg-gray-800 rounded-full"></div>
                                                            <div className="w-1 h-1 bg-gray-800 rounded-full"></div>
                                                        </div>
                                                    )}
                                                    {index + 1}
                                                </div>
                                            </td>
                                            <td className="border-r border-gray-300 text-center text-gray-600 font-mono p-1 truncate" rowSpan="2">{user.employeeId || '-'}</td>
                                            <td className="border-r border-gray-300 font-medium text-gray-800 p-1 px-1.5 truncate" title={`${user.firstName} ${user.lastName}`} rowSpan="2">
                                                {user.firstName} {user.lastName}
                                            </td>
                                            <td className="border-r border-gray-300 text-gray-600 p-1 px-1.5 truncate" title={user.position} rowSpan="2">
                                                {user.position}
                                            </td>
                                            <td className="border-r border-gray-200 text-center font-bold text-[9px] bg-blue-50 text-blue-700 p-0">
                                                PLAN
                                            </td>
                                            {daysInMonth.map(date => {
                                                const dateString = date.toISOString().split('T')[0];
                                                const key = `${user.id}_${dateString}`;
                                                const val = schedules[key] || '';
                                                const shiftData = SHIFTS.find(s => s.id === val);
                                                const colorClass = shiftData ? shiftData.color : '';

                                                return (
                                                    <td key={dateString} className="p-0 border-r border-gray-200 text-center align-middle h-full bg-blue-50/20">
                                                        {isExporting ? (
                                                            <div className={`w-full h-full min-h-[22px] flex items-center justify-center p-0 text-[8px] font-bold uppercase ${colorClass}`}>{val}</div>
                                                        ) : (
                                                            <input 
                                                                type="text" 
                                                                className={`w-full h-full min-h-[26px] md:min-h-[28px] text-center text-[9px] xl:text-[10px] 2xl:text-xs p-0 m-0 focus:outline-none focus:ring-inset focus:ring-1 focus:ring-orange-500 uppercase transition-colors block ${colorClass} ${!canEditPlan ? 'cursor-not-allowed opacity-70' : selectedShift ? 'cursor-pointer' : 'cursor-text'}`}
                                                                value={val}
                                                                onClick={() => {
                                                                    if (canEditPlan && selectedShift) {
                                                                        updateSchedule(user.id, dateString, selectedShift, 'plan');
                                                                    }
                                                                }}
                                                                onChange={(e) => canEditPlan && updateSchedule(user.id, dateString, e.target.value.toUpperCase(), 'plan')}
                                                                readOnly={!canEditPlan || !!selectedShift}
                                                                disabled={!canEditPlan}
                                                                title={!canEditPlan ? "‡∏ï‡∏≤‡∏£‡∏≤‡∏á Plan ‡∏ñ‡∏π‡∏Å‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß" : "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Plan)"}
                                                            />
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                        <tr className="hover:bg-gray-50">
                                            <td className="border-r border-gray-200 text-center font-bold text-[9px] bg-green-50 text-green-700 p-0">
                                                ACT
                                            </td>
                                            {daysInMonth.map(date => {
                                                const dateString = date.toISOString().split('T')[0];
                                                const planKey = `${user.id}_${dateString}`;
                                                const actKey = `${user.id}_${dateString}_act`;
                                                const planVal = schedules[planKey] || '';
                                                // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å ACT ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PLAN ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô
                                                const actVal = schedules[actKey] !== undefined ? schedules[actKey] : planVal;
                                                const shiftData = SHIFTS.find(s => s.id === actVal);
                                                const colorClass = shiftData ? shiftData.color : '';

                                                return (
                                                    <td key={`${dateString}_act`} className="p-0 border-r border-gray-200 text-center align-middle h-full bg-green-50/20">
                                                        {isExporting ? (
                                                            <div className={`w-full h-full min-h-[22px] flex items-center justify-center p-0 text-[8px] font-bold uppercase ${colorClass}`}>{actVal}</div>
                                                        ) : (
                                                            <input 
                                                                type="text" 
                                                                className={`w-full h-full min-h-[26px] md:min-h-[28px] text-center text-[9px] xl:text-[10px] 2xl:text-xs p-0 m-0 focus:outline-none focus:ring-inset focus:ring-1 focus:ring-green-500 uppercase transition-colors block ${colorClass} ${!canEditAct ? 'cursor-not-allowed opacity-70' : selectedShift ? 'cursor-pointer' : 'cursor-text'}`}
                                                                value={actVal}
                                                                onClick={() => {
                                                                    if (canEditAct && selectedShift) {
                                                                        updateSchedule(user.id, dateString, selectedShift, 'act');
                                                                    }
                                                                }}
                                                                onChange={(e) => canEditAct && updateSchedule(user.id, dateString, e.target.value.toUpperCase(), 'act')}
                                                                readOnly={!canEditAct || !!selectedShift}
                                                                disabled={!canEditAct}
                                                                title={!canEditAct ? "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" : "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Actual)"}
                                                            />
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    </tbody>
                                ))}
                            </table>
                        );
                    })()}
                </div>

                {/* Shift Legend */}
                <div className={`border-t border-gray-200 ${isExporting ? 'bg-white pt-2 pb-1 px-2' : 'p-4 bg-gray-50'}`}>
                    <div className="flex justify-between items-center mb-2">
                        <h4 className={`font-bold text-gray-700 flex items-center gap-2 ${isExporting ? 'text-[11px]' : 'text-sm'}`}>
                            ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (Shift Legend) 
                        </h4>
                        {!isExporting && (
                            <div className="text-[10px] text-gray-400 flex items-center gap-1">
                                <MousePointer2 size={12} /> Click shift below to auto-fill
                            </div>
                        )}
                    </div>
                    <div className={`grid ${isExporting ? 'grid-cols-7 gap-y-1' : 'grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-y-2'} gap-x-2`}>
                        {SHIFTS.map(shift => (
                            <div 
                                key={shift.id} 
                                onClick={() => !isExporting && setSelectedShift(selectedShift === shift.id ? null : shift.id)}
                                className={`flex items-center gap-1.5 transition-all select-none ${isExporting ? 'text-[8.5px]' : 'text-xs cursor-pointer hover:bg-gray-200 p-1 rounded'} ${selectedShift === shift.id && !isExporting ? 'ring-2 ring-orange-500 bg-white shadow-md scale-105' : ''}`}
                            >
                                <span className={`inline-block text-center rounded font-bold border ${shift.color} ${isExporting ? 'w-6 py-0' : 'w-8 py-0.5'}`}>
                                    {shift.id}
                                </span>
                                <span className="text-gray-600 truncate" title={lang === 'th' ? shift.label_th : shift.label_en}>
                                    {lang === 'th' ? (shift.label_th.split(' - ')[1] || shift.label_th) : (shift.label_en.split(' - ')[1] || shift.label_en)}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Note Area */}
                <div className={`bg-white border-t border-gray-200 ${isExporting ? 'pt-2 pb-0 px-2' : 'p-4'}`}>
                    <label className={`block font-bold text-gray-700 mb-2 ${isExporting ? 'text-[11px]' : 'text-sm'}`}>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / Note:</label>
                    {isExporting ? (
                        <div className="w-full rounded-md p-2 text-[10px] min-h-[30px] whitespace-pre-wrap text-gray-800 bg-gray-50 border border-gray-200">
                            {scheduleNote || '-'}
                        </div>
                    ) : (
                        <textarea 
                            className="w-full border border-gray-300 rounded-md p-3 text-sm h-20 focus:ring-1 focus:ring-orange-500 outline-none resize-none bg-gray-50 focus:bg-white transition-colors"
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                            value={scheduleNote}
                            onChange={(e) => setScheduleNote(e.target.value)}
                        ></textarea>
                    )}
                </div>

                {/* Signatures Area - Dynamically populated based on Workflow */}
                <div className={`bg-white flex justify-between ${isExporting ? 'px-8 p-2 mt-1' : 'px-10 p-8 mt-6 pt-10 border-t border-gray-200'}`}>
                    {(() => {
                        const approval = scheduleApprovals[`${selectedProject.id}_${currentMonth}`] || {};
                        return (
                            <>
                                <div className="text-center w-1/3 px-2">
                                    <div className="border-b border-gray-400 mb-1.5 h-6 flex items-end justify-center pb-1">
                                        <span className="font-medium text-blue-800 font-serif italic text-base truncate w-full" title={approval.preparedBy || `${currentUser?.firstName} ${currentUser?.lastName}`}>
                                            {approval.preparedBy || `${currentUser?.firstName} ${currentUser?.lastName}`}
                                        </span>
                                    </div>
                                    <div className={`font-medium text-gray-600 truncate w-full ${isExporting ? 'text-[11px]' : 'text-sm'}`}>
                                        ( {approval.preparedBy || `${currentUser?.firstName} ${currentUser?.lastName}`} )
                                    </div>
                                    <div className={`text-gray-500 mt-1 ${isExporting ? 'text-[10px]' : 'text-sm'}`}>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (Prepared By)</div>
                                    <div className={`text-gray-400 font-medium truncate w-full ${isExporting ? 'text-[9px]' : 'text-xs'}`}>{approval.preparedByRole || currentUser?.position || '-'}</div>
                                </div>
                                <div className="text-center w-1/3 px-2">
                                    <div className="border-b border-gray-400 mb-1.5 h-6 flex items-end justify-center pb-1">
                                        <span className="font-medium text-blue-800 font-serif italic text-base truncate w-full" title={approval.managerApprovedBy || ''}>
                                            {approval.managerApprovedBy || ''}
                                        </span>
                                    </div>
                                    <div className={`font-medium text-gray-600 truncate w-full ${isExporting ? 'text-[11px]' : 'text-sm'}`}>
                                        ( {approval.managerApprovedBy || '.......................................................'} )
                                    </div>
                                    <div className={`text-gray-500 mt-1 ${isExporting ? 'text-[10px]' : 'text-sm'}`}>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checked By)</div>
                                    <div className={`text-gray-400 font-medium ${isExporting ? 'text-[9px]' : 'text-xs'}`}>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</div>
                                </div>
                                <div className="text-center w-1/3 px-2">
                                    <div className="border-b border-gray-400 mb-1.5 h-6 flex items-end justify-center pb-1">
                                        <span className="font-medium text-blue-800 font-serif italic text-base truncate w-full" title={approval.hrApprovedBy || ''}>
                                            {approval.hrApprovedBy || ''}
                                        </span>
                                    </div>
                                    <div className={`font-medium text-gray-600 truncate w-full ${isExporting ? 'text-[11px]' : 'text-sm'}`}>
                                        ( {approval.hrApprovedBy || '.......................................................'} )
                                    </div>
                                    <div className={`text-gray-500 mt-1 ${isExporting ? 'text-[10px]' : 'text-sm'}`}>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved By)</div>
                                    <div className={`text-gray-400 font-medium ${isExporting ? 'text-[9px]' : 'text-xs'}`}>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                                </div>
                            </>
                        );
                    })()}
                </div>
            </Card>
            );
          })()}

          {/* Tab for Asset Management */}
          {projectTab === 'assets' && (
            <Card>
                <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="font-bold flex items-center gap-2"><Shield size={20}/> {t('regAssets')}</h3>
                    <div className="flex gap-2">
                        {hasPerm('proj_assets', 'save') && <Button size="sm" icon={Plus} onClick={() => { setIsEditingAsset(false); setNewAsset({ code: '', name: '', qty: 1, location: '', photo: null, details: '' }); setShowAddAssetModal(true); }}>{t('registerAsset')}</Button>}
                        <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(assets.filter(a => a.projectId === selectedProject.id), 'asset_list')}>{t('exportCSV')}</Button>
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 text-gray-600 uppercase">
                            <tr>
                                <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                <th className="p-3 text-left w-20">{t('col_image')}</th>
                                <th className="p-3 text-left">{t('col_assetCode')}</th>
                                <th className="p-3 text-left">{t('col_assetName')}</th>
                                <th className="p-3 text-center">{t('col_qty')}</th>
                                <th className="p-3 text-left">{t('col_location')}</th>
                                <th className="p-3 text-left">{t('assetDetails')}</th>
                                <th className={`p-3 text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {assets.filter(a => a.projectId === selectedProject.id).length > 0 ? (
                                assets.filter(a => a.projectId === selectedProject.id).map((asset, index) => (
                                    <tr key={asset.id} className="hover:bg-gray-50">
                                        <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                        <td className="p-3">
                                            <div className="w-12 h-12 bg-gray-100 rounded border flex items-center justify-center overflow-hidden">
                                                {asset.photo ? <img src={asset.photo} className="w-full h-full object-cover" /> : <ImageIcon size={20} className="text-gray-400"/>}
                                            </div>
                                        </td>
                                        <td className="p-3 font-mono font-medium text-orange-600">{asset.code}</td>
                                        <td className="p-3 cursor-pointer group hover:bg-gray-200 transition-colors rounded-md" onClick={() => setSelectedAssetView(asset)}>
                                            <div className="font-bold text-gray-800 group-hover:text-orange-600 flex items-center gap-1">
                                                {asset.name} <Search size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                                            </div>
                                            <div className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                                        </td>
                                        <td className="p-3 text-center">{asset.qty}</td>
                                        <td className="p-3 text-gray-600">{asset.location}</td>
                                        <td className="p-3 text-gray-500 text-xs max-w-xs truncate">{asset.details || '-'}</td>
                                        <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                            <div className="flex justify-center items-center gap-1">
                                                {hasPerm('proj_assets', 'edit') && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); handleEditAsset(asset); }}
                                                        className="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors"
                                                        title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                    >
                                                        <Edit size={16} />
                                                    </button>
                                                )}
                                                {hasPerm('proj_assets', 'delete') && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ${asset.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setAssets(assets.filter(a => a.id !== asset.id))); }}
                                                        className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                        title="‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr><td colSpan="8" className="p-8 text-center text-gray-400">{t('noData')}</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </Card>
          )}

          {/* New Tab for Tools Management */}
          {projectTab === 'tools' && (
            <Card>
                <div className="p-4 border-b flex justify-between items-center">
                    <h3 className="font-bold flex items-center gap-2"><Wrench size={20}/> {t('toolsRegistry')}</h3>
                    <div className="flex gap-2">
                        {hasPerm('proj_tools', 'save') && <Button size="sm" icon={Plus} onClick={() => { setIsEditingTool(false); setNewTool({ code: '', name: '', qty: 1, location: '', photo: null, details: '' }); setShowAddToolModal(true); }}>{t('regTool')}</Button>}
                        <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(tools.filter(t => t.projectId === selectedProject.id), 'tools_list')}>{t('exportCSV')}</Button>
                    </div>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 text-gray-600 uppercase">
                            <tr>
                                <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                <th className="p-3 text-left w-20">{t('col_image')}</th>
                                <th className="p-3 text-left">{t('col_toolCode')}</th>
                                <th className="p-3 text-left">{t('col_toolName')}</th>
                                <th className="p-3 text-center">{t('col_qty')}</th>
                                <th className="p-3 text-left">{t('col_location')}</th>
                                <th className="p-3 text-left">{t('assetDetails')}</th>
                                <th className={`p-3 text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {tools.filter(t => t.projectId === selectedProject.id).length > 0 ? (
                                tools.filter(t => t.projectId === selectedProject.id).map((tool, index) => (
                                    <tr key={tool.id} className="hover:bg-gray-50">
                                        <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                        <td className="p-3">
                                            <div className="w-12 h-12 bg-gray-100 rounded border flex items-center justify-center overflow-hidden">
                                                {tool.photo ? <img src={tool.photo} className="w-full h-full object-cover" /> : <ImageIcon size={20} className="text-gray-400"/>}
                                            </div>
                                        </td>
                                        <td className="p-3 font-mono font-medium text-orange-600">{tool.code}</td>
                                        <td className="p-3 cursor-pointer group hover:bg-gray-200 transition-colors rounded-md" onClick={() => setSelectedToolView(tool)}>
                                            <div className="font-bold text-gray-800 group-hover:text-orange-600 flex items-center gap-1">
                                                {tool.name} <Search size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                                            </div>
                                            <div className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                                        </td>
                                        <td className="p-3 text-center">{tool.qty}</td>
                                        <td className="p-3 text-gray-600">{tool.location}</td>
                                        <td className="p-3 text-gray-500 text-xs max-w-xs truncate">{tool.details || '-'}</td>
                                        <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                            <div className="flex justify-center items-center gap-1">
                                                {hasPerm('proj_tools', 'edit') && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); handleEditTool(tool); }}
                                                        className="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors"
                                                        title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                    >
                                                        <Edit size={16} />
                                                    </button>
                                                )}
                                                {hasPerm('proj_tools', 'delete') && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á ${tool.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setTools(tools.filter(t => t.id !== tool.id))); }}
                                                        className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                        title="‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            ) : (
                                <tr><td colSpan="8" className="p-8 text-center text-gray-400">{t('noData')}</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </Card>
          )}

          {/* New PM / Machinery Tab */}
          {projectTab === 'pm' && (
              <div>
                  {/* PM Sub Tabs */}
                  <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                      {['dashboard', 'registry', 'plan', 'calendar', 'form', 'history'].map(sub => (
                          <button
                              key={sub}
                              onClick={() => setPmSubTab(sub)}
                              className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${pmSubTab === sub ? 'bg-white shadow text-red-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                          >
                              {t('pm_' + sub)}
                          </button>
                      ))}
                  </div>

                  {pmSubTab === 'dashboard' && (() => {
                      // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• PM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                      const [year, month] = pmMonth.split('-').map(Number);
                      const daysInMonth = new Date(year, month, 0).getDate();
                      const activePmPlans = pmPlans.filter(p => p.projectId === selectedProject.id && p.status === 'Active');

                      let allMonthlyTasks = [];

                      for (let d = 1; d <= daysInMonth; d++) {
                          const dateObj = new Date(year, month - 1, d);
                          const dateString = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                          activePmPlans.forEach(plan => {
                              let shouldRun = false;
                              if (plan.frequency === 'Daily') shouldRun = true;
                              if (plan.frequency === 'Weekly') shouldRun = dateObj.getDay() === parseInt(plan.scheduleDetails.dayOfWeek);
                              if (plan.frequency === 'Monthly') shouldRun = d === parseInt(plan.scheduleDetails.date);
                              if (plan.frequency === 'Yearly') shouldRun = d === parseInt(plan.scheduleDetails.date) && dateObj.getMonth() === parseInt(plan.scheduleDetails.month) - 1;

                              if (shouldRun) {
                                  const machine = machines.find(m => m.id === plan.machineId);
                                  const historyRecord = pmHistoryList.find(h => h.pmPlanId === plan.id && h.date === dateString);

                                  let status = 'Not Started';
                                  if (historyRecord) {
                                      if (historyRecord.approvalStatus === 'Approved') status = 'Approved';
                                      else if (historyRecord.approvalStatus === 'Rejected') status = 'Rejected';
                                      else status = 'Pending Approval';
                                  }

                                  allMonthlyTasks.push({
                                      dateString,
                                      dateObj,
                                      plan,
                                      machine,
                                      historyRecord,
                                      status
                                  });
                              }
                          });
                      }

                      // 2. ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                      const statusCounts = { 'Not Started': 0, 'Pending Approval': 0, 'Approved': 0, 'Rejected': 0 };
                      allMonthlyTasks.forEach(task => { statusCounts[task.status]++; });
                      const totalTasks = allMonthlyTasks.length;

                      // 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pie Chart
                      const pieData = [
                          { name: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', value: statusCounts['Not Started'], color: 'url(#colorOrange)', id: 'Not Started' },
                          { name: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', value: statusCounts['Pending Approval'], color: 'url(#colorBlue)', id: 'Pending Approval' },
                          { name: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)', value: statusCounts['Approved'], color: 'url(#colorGreen)', id: 'Approved' },
                          { name: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö)', value: statusCounts['Rejected'], color: 'url(#colorRed)', id: 'Rejected' }
                      ].filter(d => d.value > 0);

                      const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent }) => {
                          const RADIAN = Math.PI / 180;
                          const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
                          const x = cx + radius * Math.cos(-midAngle * RADIAN);
                          const y = cy + radius * Math.sin(-midAngle * RADIAN);
                          return (
                              <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize={12} fontWeight="bold" style={{ textShadow: '1px 1px 3px rgba(0,0,0,0.8)' }}>
                                  {`${(percent * 100).toFixed(0)}%`}
                              </text>
                          );
                      };

                      return (
                          <div className="space-y-6 animate-fade-in">
                              <ChartGradients />
                              <Card className="p-6 border-t-4 border-red-500">
                                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4 gap-4">
                                      <h3 className="font-bold flex items-center gap-3 text-gray-800">
                                          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center text-white shadow-md">
                                              <BarChart3 size={20} /> 
                                          </div>
                                          ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (PM Dashboard)
                                      </h3>
                                      <div className="flex items-center bg-gray-100 rounded-lg p-1">
                                          <button onClick={() => changePmMonth(-1)} className="p-1 hover:bg-white rounded shadow-sm transition"><ChevronLeft size={18}/></button>
                                          <span className="px-4 text-sm font-semibold text-gray-700 w-36 text-center">
                                              {new Date(pmMonth + '-01').toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { month: 'long', year: 'numeric' })}
                                          </span>
                                          <button onClick={() => changePmMonth(1)} className="p-1 hover:bg-white rounded shadow-sm transition"><ChevronRight size={18}/></button>
                                      </div>
                                  </div>

                                  {totalTasks === 0 ? (
                                      <div className="text-center text-gray-400 py-16 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                                          <Settings size={48} className="mx-auto mb-3 text-gray-300"/>
                                          ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô PM ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                                      </div>
                                  ) : (
                                      <div className="flex flex-col lg:flex-row items-center gap-10">
                                          {/* Pie Chart */}
                                          <div className="w-full lg:w-5/12 h-[320px] flex justify-center relative cursor-pointer" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
                                              <div className="absolute top-[15%] bottom-[15%] left-[15%] right-[15%] bg-gradient-to-b from-gray-50 to-gray-200 rounded-full scale-[0.8] opacity-60 blur-xl"></div>
                                              <ResponsiveContainer width="100%" height="100%">
                                                  <PieChart style={{ filter: 'drop-shadow(3px 8px 10px rgba(0,0,0,0.25))' }}>
                                                      <Pie
                                                          data={pieData}
                                                          cx="50%"
                                                          cy="50%"
                                                          labelLine={false}
                                                          label={renderCustomizedLabel}
                                                          outerRadius={120}
                                                          innerRadius={50}
                                                          dataKey="value"
                                                          stroke="#ffffff"
                                                          strokeWidth={2}
                                                          onClick={(data) => setSelectedPmStatusDetail({ status: data.id, label: data.name, tasks: allMonthlyTasks.filter(t => t.status === data.id) })}
                                                      >
                                                          {pieData.map((entry, index) => (
                                                              <Cell key={`cell-${index}`} fill={entry.color} className="hover:opacity-80 transition-opacity outline-none" />
                                                          ))}
                                                      </Pie>
                                                      <RechartsTooltip 
                                                          formatter={(value) => [`${value} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}
                                                          contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 25px -5px rgba(0,0,0,0.2)' }}
                                                      />
                                                      <Legend verticalAlign="bottom" height={36} iconType="circle" />
                                                  </PieChart>
                                              </ResponsiveContainer>
                                          </div>
                                          
                                          {/* Stats Cards */}
                                          <div className="w-full lg:w-7/12 grid grid-cols-2 gap-5">
                                              <div 
                                                  className="relative bg-gradient-to-b from-white to-orange-50 border border-orange-100 p-5 rounded-2xl text-center shadow-sm transform transition-all hover:-translate-y-1 hover:shadow-md cursor-pointer group"
                                                  onClick={() => setSelectedPmStatusDetail({ status: 'Not Started', label: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', tasks: allMonthlyTasks.filter(t => t.status === 'Not Started') })}
                                              >
                                                  <div className="absolute -top-3 -right-3 w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 shadow-sm group-hover:scale-110 transition-transform">
                                                      <Clock size={18}/>
                                                  </div>
                                                  <div className="text-orange-600 text-sm font-bold mb-1">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                                  <div className="text-4xl font-black text-orange-700">{statusCounts['Not Started']}</div>
                                                  <div className="text-xs text-orange-500 mt-2 font-medium">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</div>
                                              </div>
                                              
                                              <div 
                                                  className="relative bg-gradient-to-b from-white to-blue-50 border border-blue-100 p-5 rounded-2xl text-center shadow-sm transform transition-all hover:-translate-y-1 hover:shadow-md cursor-pointer group"
                                                  onClick={() => setSelectedPmStatusDetail({ status: 'Pending Approval', label: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', tasks: allMonthlyTasks.filter(t => t.status === 'Pending Approval') })}
                                              >
                                                  <div className="absolute -top-3 -right-3 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-sm group-hover:scale-110 transition-transform">
                                                      <ClipboardList size={18}/>
                                                  </div>
                                                  <div className="text-blue-600 text-sm font-bold mb-1">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                                                  <div className="text-4xl font-black text-blue-700">{statusCounts['Pending Approval']}</div>
                                                  <div className="text-xs text-blue-500 mt-2 font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                                              </div>
                                              
                                              <div 
                                                  className="relative bg-gradient-to-b from-white to-green-50 border border-green-100 p-5 rounded-2xl text-center shadow-sm transform transition-all hover:-translate-y-1 hover:shadow-md cursor-pointer group"
                                                  onClick={() => setSelectedPmStatusDetail({ status: 'Approved', label: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)', tasks: allMonthlyTasks.filter(t => t.status === 'Approved') })}
                                              >
                                                  <div className="absolute -top-3 -right-3 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 shadow-sm group-hover:scale-110 transition-transform">
                                                      <CheckCircle size={18}/>
                                                  </div>
                                                  <div className="text-green-600 text-sm font-bold mb-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</div>
                                                  <div className="text-4xl font-black text-green-700">{statusCounts['Approved']}</div>
                                                  <div className="text-xs text-green-500 mt-2 font-medium">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
                                              </div>
                                              
                                              <div 
                                                  className="relative bg-gradient-to-b from-white to-red-50 border border-red-100 p-5 rounded-2xl text-center shadow-sm transform transition-all hover:-translate-y-1 hover:shadow-md cursor-pointer group"
                                                  onClick={() => setSelectedPmStatusDetail({ status: 'Rejected', label: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö)', tasks: allMonthlyTasks.filter(t => t.status === 'Rejected') })}
                                              >
                                                  <div className="absolute -top-3 -right-3 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-600 shadow-sm group-hover:scale-110 transition-transform">
                                                      <XCircle size={18}/>
                                                  </div>
                                                  <div className="text-red-600 text-sm font-bold mb-1">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö)</div>
                                                  <div className="text-4xl font-black text-red-700">{statusCounts['Rejected']}</div>
                                                  <div className="text-xs text-red-500 mt-2 font-medium">‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà</div>
                                              </div>
                                          </div>
                                      </div>
                                  )}
                              </Card>
                          </div>
                      );
                  })()}

                  {pmSubTab === 'registry' && (
                    <Card className="border-t-4 border-red-500">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2 text-gray-800">{t('pm_registry_title')}</h3>
                            <div className="flex gap-2">
                                <Button variant="outline" size="sm" icon={PrinterIcon}>{t('downloadPDF')}</Button>
                                {hasPerm('proj_pm', 'save') && <Button size="sm" icon={Plus} onClick={() => { setIsEditingMachine(false); setNewMachine({ code: '', name: '', system: '', qty: 1, location: '', photo: null }); setShowAddMachineModal(true); }} className="bg-red-600 hover:bg-red-700">{t('addMachine')}</Button>}
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-red-50 text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                        <th className="p-3 text-left w-32">{t('col_machineCode')}</th>
                                        <th className="p-3 text-center w-20">{t('col_photo')}</th>
                                        <th className="p-3 text-left">{t('col_machineName')}</th>
                                        <th className="p-3 text-left">{t('col_system')}</th>
                                        <th className="p-3 text-center w-20">{t('col_qty')}</th>
                                        <th className="p-3 text-left">{t('col_location')}</th>
                                        <th className={`p-3 text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {machines.filter(m => m.projectId === selectedProject.id).length > 0 ? (
                                        machines.filter(m => m.projectId === selectedProject.id).map((machine, index) => (
                                            <tr key={machine.id} className="hover:bg-gray-50">
                                                <td className="p-4 text-center text-gray-500 font-medium">{index + 1}</td>
                                                <td className="p-4 font-mono font-bold text-gray-700">{machine.code}</td>
                                                <td className="p-4 text-center">
                                                    <div className="w-10 h-10 bg-gray-100 rounded border flex items-center justify-center mx-auto text-gray-400">
                                                        {machine.photo ? <img src={machine.photo} className="w-full h-full object-cover" /> : <Settings size={20} />}
                                                    </div>
                                                </td>
                                                <td className="p-4 cursor-pointer hover:bg-gray-200 transition-colors group rounded-md" onClick={() => setSelectedMachineDetails(machine)}>
                                                    <div className="font-bold text-gray-800 group-hover:text-blue-700 flex items-center gap-1">
                                                        {machine.name} <Search size={14} className="text-gray-400 group-hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" />
                                                    </div>
                                                    <div className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                                                </td>
                                                <td className="p-4 text-gray-600">{machine.system}</td>
                                                <td className="p-4 text-center font-bold">{machine.qty}</td>
                                                <td className="p-4 text-gray-600">{machine.location}</td>
                                                <td className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>
                                                    <div className="flex justify-center items-center gap-1">
                                                        {hasPerm('proj_pm', 'edit') && (
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleEditMachine(machine); }}
                                                                className="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors"
                                                                title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                            >
                                                                <Edit size={16} />
                                                            </button>
                                                        )}
                                                        {hasPerm('proj_pm', 'delete') && (
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ${machine.name} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setMachines(machines.filter(m => m.id !== machine.id))); }}
                                                                className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                                title="‡∏•‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"
                                                            >
                                                                <Trash2 size={16} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr><td colSpan="8" className="p-8 text-center text-gray-400">{t('noData')}</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                  )}
                  
                  {pmSubTab === 'plan' && (
                    <Card className="border-t-4 border-blue-500">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2 text-gray-800"><Calendar size={20}/> {t('pm_plan_title')}</h3>
                            <div className="flex gap-2">
                                <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(pmPlans.filter(p => p.projectId === selectedProject.id), 'pm_plans')}>{t('exportCSV')}</Button>
                                {hasPerm('proj_pm', 'save') && <Button size="sm" icon={Plus} onClick={() => { setNewPmPlan({ id: null, machineId: '', frequency: 'Monthly', scheduleDetails: { dayOfWeek: '1', date: '1', month: '1' } }); setShowAddPmPlanModal(true); }} className="bg-blue-600 hover:bg-blue-700">{t('addPmPlan')}</Button>}
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-blue-50 text-gray-700 uppercase">
                                    <tr>
                                        <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                        <th className="p-3 text-left w-48">{t('col_machineName')}</th>
                                        <th className="p-3 text-center w-32">{t('pmFrequency')}</th>
                                        <th className="p-3 text-left">{t('col_schedule')}</th>
                                        <th className="p-3 text-center w-24">{t('col_status')}</th>
                                        <th className={`p-3 text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {pmPlans.filter(p => p.projectId === selectedProject.id).length > 0 ? (
                                        pmPlans.filter(p => p.projectId === selectedProject.id).map((plan, index) => {
                                            const machine = machines.find(m => m.id === plan.machineId);
                                            
                                            // Format Schedule Details
                                            let scheduleText = '-';
                                            const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
                                            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                                            
                                            if (plan.frequency === 'Weekly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô${days[plan.scheduleDetails.dayOfWeek] || ''}`;
                                            else if (plan.frequency === 'Monthly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${plan.scheduleDetails.date} ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                                            else if (plan.frequency === 'Yearly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${plan.scheduleDetails.date} ${months[parseInt(plan.scheduleDetails.month)-1] || ''}`;
                                            else if (plan.frequency === 'Daily') scheduleText = '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (Everyday)';

                                            return (
                                                <tr key={plan.id} className="hover:bg-gray-50 transition-colors">
                                                    <td className="p-4 text-center text-gray-500 font-medium">{index + 1}</td>
                                                    <td className={`p-4 ${hasPerm('proj_pm', 'edit') ? 'cursor-pointer group hover:bg-blue-50 rounded-md transition-colors' : ''}`} onClick={() => { if(hasPerm('proj_pm', 'edit')) { setNewPmPlan({...plan}); setShowAddPmPlanModal(true); } }}>
                                                        <div className="font-bold text-gray-800 flex items-center gap-1 group-hover:text-blue-700">
                                                            {machine ? machine.name : 'Unknown'}
                                                            {hasPerm('proj_pm', 'edit') && <Edit size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />}
                                                        </div>
                                                        {hasPerm('proj_pm', 'edit') && <div className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô</div>}
                                                        <div className="text-xs text-gray-500 font-mono mt-0.5">{machine ? machine.code : '-'}</div>
                                                    </td>
                                                    <td className="p-4 text-center">
                                                        <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold whitespace-nowrap">
                                                            {t(`freq_${plan.frequency}`)}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 text-gray-600 font-medium">{scheduleText}</td>
                                                    <td className="p-4 text-center">
                                                        {/* Status Toggle on click (Optional enhancement for quick enable/disable) */}
                                                        <span 
                                                            className={`px-2 py-1 rounded-full text-xs font-semibold cursor-pointer ${plan.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}
                                                            onClick={(e) => {
                                                                if(hasPerm('proj_pm', 'edit')) {
                                                                    e.stopPropagation();
                                                                    setPmPlans(pmPlans.map(p => p.id === plan.id ? {...p, status: p.status === 'Active' ? 'Inactive' : 'Active'} : p));
                                                                }
                                                            }}
                                                            title={hasPerm('proj_pm', 'edit') ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" : ""}
                                                        >
                                                            {plan.status === 'Active' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                                                        </span>
                                                    </td>
                                                    <td className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>
                                                        <div className="flex justify-center items-center gap-1">
                                                            {hasPerm('proj_pm', 'delete') && (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô PM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setPmPlans(pmPlans.filter(p => p.id !== plan.id))); }}
                                                                    className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                                    title="‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô"
                                                                >
                                                                    <Trash2 size={16} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    ) : (
                                        <tr><td colSpan="6" className="p-8 text-center text-gray-400">{t('noData')}</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                  )}

                  {pmSubTab === 'calendar' && (
                      <Card className="border-t-4 border-purple-500">
                          <div className="p-4 border-b flex justify-between items-center bg-white">
                              <h3 className="font-bold flex items-center gap-2 text-gray-800"><Calendar size={20}/> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ú‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (PM Calendar)</h3>
                              <div className="flex items-center gap-4">
                                  <div className={`flex items-center bg-gray-100 rounded-lg p-1 ${isExporting ? 'hidden' : ''}`}>
                                      <button onClick={() => changePmMonth(-1)} className="p-1 hover:bg-white rounded shadow-sm transition"><ChevronLeft size={18}/></button>
                                      <span className="px-4 text-sm font-semibold text-gray-700 w-32 text-center">
                                          {new Date(pmMonth + '-01').toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-US', { month: 'long', year: 'numeric' })}
                                      </span>
                                      <button onClick={() => changePmMonth(1)} className="p-1 hover:bg-white rounded shadow-sm transition"><ChevronRight size={18}/></button>
                                  </div>
                                  <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                                      <Button 
                                          variant="outline" 
                                          size="sm" 
                                          icon={Download} 
                                          onClick={() => {
                                              const csvData = [];
                                              const [y, m] = pmMonth.split('-').map(Number);
                                              const days = getCalendarDays(y, m);
                                              
                                              days.forEach(dayObj => {
                                                  if(!dayObj.isCurrentMonth) return;
                                                  const date = dayObj.date;
                                                  const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                                                  
                                                  const dayTasks = pmPlans.filter(p => p.projectId === selectedProject.id).filter(plan => {
                                                      if (plan.status !== 'Active') return false;
                                                      if (plan.frequency === 'Daily') return true;
                                                      if (plan.frequency === 'Weekly') return date.getDay() === parseInt(plan.scheduleDetails.dayOfWeek);
                                                      if (plan.frequency === 'Monthly') return date.getDate() === parseInt(plan.scheduleDetails.date);
                                                      if (plan.frequency === 'Yearly') return date.getDate() === parseInt(plan.scheduleDetails.date) && date.getMonth() === parseInt(plan.scheduleDetails.month) - 1;
                                                      return false;
                                                  });

                                                  dayTasks.forEach(task => {
                                                      const machine = machines.find(mac => mac.id === task.machineId);
                                                      csvData.push({
                                                          '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)': dateString,
                                                          '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Code)': machine?.code || '-',
                                                          '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Name)': machine?.name || 'Unknown',
                                                          '‡∏£‡∏∞‡∏ö‡∏ö (System)': machine?.system || '-',
                                                          '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Frequency)': t(`freq_${task.frequency}`)
                                                      });
                                                  });
                                              });
                                              exportToCSV(csvData, `PM_Calendar_${selectedProject.code}_${pmMonth}`);
                                          }}
                                      >
                                          {t('exportCSV')}
                                      </Button>
                                      <Button 
                                          variant="outline" 
                                          size="sm" 
                                          icon={isExporting ? Loader2 : PrinterIcon} 
                                          onClick={() => handleExportPDF('print-pm-calendar-area', `PM_Calendar_${selectedProject.code}_${pmMonth}.pdf`, 'landscape')} 
                                          disabled={isExporting}
                                      >
                                          {isExporting ? t('downloading') : t('downloadPDF')}
                                      </Button>
                                  </div>
                              </div>
                          </div>
                          <div id="print-pm-calendar-area" className={isExporting ? 'w-[277mm] h-[165mm] min-w-[277mm] max-w-[277mm] mx-auto bg-white flex flex-col box-border' : 'p-4'}>
                              {isExporting && (
                                  <div className="text-center mb-2 shrink-0">
                                      <h2 className="text-xl font-bold text-gray-800">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ú‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (PM Calendar)</h2>
                                      <p className="text-xs text-gray-600 font-medium mt-1">
                                          ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {selectedProject.name} | ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {new Date(pmMonth + '-01').toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}
                                      </p>
                                  </div>
                              )}
                              
                              {(() => {
                                  const calendarDaysArr = getCalendarDays(parseInt(pmMonth.split('-')[0]), parseInt(pmMonth.split('-')[1]));
                                  const numWeeks = Math.ceil(calendarDaysArr.length / 7);
                                  
                                  return (
                                      <div 
                                          className={`grid grid-cols-7 border-t border-l border-gray-200 bg-white rounded-lg overflow-hidden ${isExporting ? 'flex-1' : ''}`}
                                          style={isExporting ? { gridTemplateRows: `auto repeat(${numWeeks}, minmax(0, 1fr))` } : {}}
                                      >
                                          {['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'].map(d => (
                                              <div key={d} className={`text-center font-bold bg-gray-50 border-r border-b border-gray-200 text-gray-600 ${isExporting ? 'py-1 text-[10px]' : 'p-2 text-xs'}`}>{d}</div>
                                          ))}
                                          {calendarDaysArr.map((dayObj, idx) => {
                                              const date = dayObj.date;
                                              
                                              // Local date string construction to avoid timezone issues
                                              const yyyy = date.getFullYear();
                                              const mm = String(date.getMonth() + 1).padStart(2, '0');
                                              const dd = String(date.getDate()).padStart(2, '0');
                                              const dateString = `${yyyy}-${mm}-${dd}`;
                                              
                                              const todayDate = new Date();
                                              const isToday = date.getDate() === todayDate.getDate() && date.getMonth() === todayDate.getMonth() && date.getFullYear() === todayDate.getFullYear();

                                              // Find tasks scheduled for this day
                                              const dayTasks = pmPlans.filter(p => p.projectId === selectedProject.id).filter(plan => {
                                                  if (plan.status !== 'Active') return false;
                                                  if (plan.frequency === 'Daily') return true;
                                                  if (plan.frequency === 'Weekly') return date.getDay() === parseInt(plan.scheduleDetails.dayOfWeek);
                                                  if (plan.frequency === 'Monthly') return date.getDate() === parseInt(plan.scheduleDetails.date);
                                                  if (plan.frequency === 'Yearly') return date.getDate() === parseInt(plan.scheduleDetails.date) && date.getMonth() === parseInt(plan.scheduleDetails.month) - 1;
                                                  return false;
                                              });

                                              if (!dayObj.isCurrentMonth) {
                                                  return <div key={idx} className={`${isExporting ? 'h-full min-h-0' : 'min-h-[120px]'} bg-transparent`}></div>;
                                              }

                                              const isFirstDayOfMonth = date.getDate() === 1;
                                              const needsLeftBorder = isFirstDayOfMonth && date.getDay() !== 0;

                                              return (
                                                  <div key={idx} className={`${isExporting ? 'h-full min-h-0 p-0.5' : 'min-h-[120px] p-1'} border-r border-b border-gray-200 transition-colors bg-white hover:bg-gray-50 flex flex-col ${needsLeftBorder ? 'border-l' : ''}`}>
                                                      <div className={`flex justify-end ${isExporting ? 'p-0.5' : 'p-1'} shrink-0`}>
                                                          <span className={`font-medium flex items-center justify-center rounded-full ${isToday && !isExporting ? 'bg-orange-500 text-white shadow-sm w-6 h-6 text-xs' : isToday && isExporting ? 'border border-orange-500 text-orange-600 w-4 h-4 text-[9px]' : isExporting ? 'w-4 h-4 text-[9px] text-gray-800' : 'w-6 h-6 text-xs text-gray-800'}`}>
                                                              {date.getDate()}
                                                          </span>
                                                      </div>
                                                      <div className={`mt-0.5 flex flex-col gap-0.5 px-0.5 ${isExporting ? 'flex-1 overflow-hidden' : 'h-20 overflow-y-auto custom-scrollbar'}`}>
                                                          {dayTasks.slice(0, 3).map(task => {
                                                              const machine = machines.find(m => m.id === task.machineId);
                                                              const historyRecord = pmHistoryList.find(h => h.pmPlanId === task.id && h.date === dateString);
                                                              
                                                              let itemClass = '';
                                                              let statusText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                                                              
                                                              if (historyRecord) {
                                                                  if (historyRecord.approvalStatus === 'Approved') {
                                                                      itemClass = 'bg-green-500 border-green-600 text-white';
                                                                      statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                                                                  } else if (historyRecord.approvalStatus === 'Pending Chief' || historyRecord.approvalStatus === 'Pending Manager') {
                                                                      itemClass = 'bg-yellow-400 border-yellow-500 text-yellow-900';
                                                                      statusText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                                                                  } else {
                                                                      itemClass = 'bg-blue-500 border-blue-600 text-white';
                                                                      statusText = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                                                                  }
                                                              } else {
                                                                  itemClass = 'bg-white border-gray-300 border-dashed text-gray-600 hover:border-solid hover:border-gray-400 hover:bg-gray-50';
                                                              }

                                                              return (
                                                                  <div 
                                                                      key={task.id} 
                                                                      onClick={() => !isExporting && handleOpenPmForm(task, machine, dateString)}
                                                                      className={`${isExporting ? 'text-[8.5px] p-0.5 px-1 leading-tight' : 'text-[10px] p-1.5'} border rounded truncate transition-colors shadow-sm font-bold ${itemClass} ${!isExporting ? 'cursor-pointer hover:opacity-90 hover:shadow-md' : ''}`} 
                                                                      title={!isExporting ? `‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£: ${machine?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}\n‡∏£‡∏´‡∏±‡∏™: ${machine?.code || '-'}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText} (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)` : ''}
                                                                  >
                                                                      {machine?.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                                                                  </div>
                                                              )
                                                          })}
                                                          {dayTasks.length > 3 && (
                                                              <div 
                                                                  onClick={() => !isExporting && setSelectedDateTasks({ dateString: dateString, tasks: dayTasks, dateObj: date })}
                                                                  className={`${isExporting ? 'text-[8.5px] p-0.5' : 'text-[10px] p-1 cursor-pointer hover:bg-gray-200'} text-center font-bold text-gray-500 bg-gray-100 rounded mt-0.5 border border-gray-200`}
                                                              >
                                                                  + {dayTasks.length - 3} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                                              </div>
                                                          )}
                                                      </div>
                                                  </div>
                                              );
                                          })}
                                      </div>
                                  );
                              })()}
                              
                              <div className={`flex flex-wrap items-center gap-4 text-gray-600 shrink-0 ${isExporting ? 'text-[10px] mt-2' : 'text-xs mt-4 font-medium'}`}>
                                  <div className="flex items-center gap-1.5"><span className={`rounded border border-gray-300 border-dashed bg-white inline-block ${isExporting ? 'w-2 h-2' : 'w-4 h-3'}`}></span> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                  <div className="flex items-center gap-1.5"><span className={`rounded border border-blue-600 bg-blue-500 inline-block ${isExporting ? 'w-2 h-2' : 'w-4 h-3'}`}></span> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</div>
                                  <div className="flex items-center gap-1.5"><span className={`rounded border border-yellow-500 bg-yellow-400 inline-block ${isExporting ? 'w-2 h-2' : 'w-4 h-3'}`}></span> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                                  <div className="flex items-center gap-1.5"><span className={`rounded border border-green-700 bg-green-600 inline-block ${isExporting ? 'w-2 h-2' : 'w-4 h-3'}`}></span> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div>
                                  {!isExporting && <div className="flex items-center gap-1.5 ml-auto"><span className="w-3 h-3 rounded-full bg-orange-500 inline-block shadow-sm"></span> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>}
                              </div>
                          </div>
                      </Card>
                  )}

                  {pmSubTab === 'form' && (
                      <Card className="border-t-4 border-orange-500">
                          <div className="p-4 border-b flex justify-between items-center bg-white">
                              <h3 className="font-bold flex items-center gap-2 text-gray-800"><FileText size={20}/> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (Blank PM Forms)</h3>
                              <div className="flex items-center gap-4">
                                  <select
                                      className="border border-gray-300 rounded-md p-2 text-sm bg-gray-50 focus:bg-white outline-none focus:ring-1 focus:ring-orange-500 w-64"
                                      value={selectedFormSystem}
                                      onChange={(e) => setSelectedFormSystem(e.target.value)}
                                  >
                                      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° --</option>
                                      {MACHINE_SYSTEMS.map(sys => (
                                          <option key={sys} value={sys}>{sys}</option>
                                      ))}
                                  </select>
                                  <Button
                                      variant="outline"
                                      size="sm"
                                      icon={PrinterIcon}
                                      onClick={() => {
                                          const container = document.getElementById('print-blank-pm-form');
                                          if (container) {
                                              container.scrollTop = 0;
                                              const parentWrapper = container.closest('.overflow-x-auto');
                                              if (parentWrapper) parentWrapper.scrollLeft = 0;
                                          }
                                          // ‡πÉ‡∏ä‡πâ Custom Margin: [Top 22mm, Left 10mm, Bottom 20mm, Right 10mm]
                                          setTimeout(() => handleExportPDF('print-blank-pm-form', `Blank_PM_Form_${selectedFormSystem.replace(/\//g, '_')}.pdf`, 'portrait', [22, 10, 20, 10]), 100);
                                      }}
                                      disabled={!selectedFormSystem || isExporting}
                                  >
                                      {isExporting ? t('downloading') : t('downloadPDF')}
                                  </Button>
                              </div>
                          </div>

                          <div className="p-8 bg-gray-50 flex justify-center overflow-x-auto">
                              {selectedFormSystem ? (
                                  <div id="print-blank-pm-form" className={`bg-white mx-auto box-border flex flex-col ${isExporting ? 'w-[190mm] min-w-[190mm] max-w-[190mm] p-[5mm] border-none shadow-none' : 'p-10 w-[210mm] shadow-sm border border-gray-200'}`}>
                                      <div className="text-center mb-8">
                                          <h2 className="text-2xl font-bold text-gray-800">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (PM Checklist)</h2>
                                          <h3 className="text-lg text-gray-600 mt-2 font-medium">‡∏£‡∏∞‡∏ö‡∏ö: {selectedFormSystem}</h3>
                                      </div>
                                      
                                      <div className="grid grid-cols-2 gap-x-8 gap-y-4 mb-8 text-sm text-gray-700">
                                          <div className="flex"><span className="w-24 font-bold shrink-0">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <div className="flex-1 border-b border-gray-400 border-dotted"></div></div>
                                          <div className="flex"><span className="w-24 font-bold shrink-0">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <div className="flex-1 border-b border-gray-400 border-dotted"></div></div>
                                          <div className="flex"><span className="w-24 font-bold shrink-0">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:</span> <div className="flex-1 border-b border-gray-400 border-dotted"></div></div>
                                          <div className="flex"><span className="w-24 font-bold shrink-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span> <div className="flex-1 border-b border-gray-400 border-dotted"></div></div>
                                      </div>

                                      <table className="w-full text-sm border-collapse mb-10 table-fixed break-words">
                                          <thead className="bg-gray-100 text-gray-800">
                                              <tr>
                                                  <th className="p-2 border border-gray-300 text-center w-[10%]">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                                  <th className="p-2 border border-gray-300 text-left w-[45%]">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspection Item)</th>
                                                  <th className="p-2 border border-gray-300 text-center w-[10%]">‡∏õ‡∏Å‡∏ï‡∏¥</th>
                                                  <th className="p-2 border border-gray-300 text-center w-[10%]">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th>
                                                  <th className="p-2 border border-gray-300 text-center w-[10%]">N/A</th>
                                                  <th className="p-2 border border-gray-300 text-left w-[15%]">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                              {getChecklistForSystem(selectedFormSystem).map((item, idx) => (
                                                  <tr key={idx}>
                                                      <td className="p-2 border border-gray-300 text-center text-gray-600">{idx + 1}</td>
                                                      <td className="p-2 border border-gray-300 font-medium text-gray-800 break-words whitespace-normal">{item}</td>
                                                      <td className="p-2 border border-gray-300 text-center"><div className="w-4 h-4 border border-gray-400 mx-auto"></div></td>
                                                      <td className="p-2 border border-gray-300 text-center"><div className="w-4 h-4 border border-gray-400 mx-auto"></div></td>
                                                      <td className="p-2 border border-gray-300 text-center"><div className="w-4 h-4 border border-gray-400 mx-auto"></div></td>
                                                      <td className="p-2 border border-gray-300"></td>
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>

                                      <div className="mb-16">
                                          <h4 className="font-bold text-gray-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (Remarks):</h4>
                                          <div className="border-b border-gray-400 border-dotted mb-6 h-4"></div>
                                          <div className="border-b border-gray-400 border-dotted mb-6 h-4"></div>
                                          <div className="border-b border-gray-400 border-dotted mb-6 h-4"></div>
                                      </div>

                                      <div className="flex justify-between px-4 pt-8">
                                          <div className="text-center">
                                              <div className="border-b border-gray-400 w-48 mb-2 h-8"></div>
                                              <div className="text-sm text-gray-600">( .................................................... )</div>
                                              <div className="text-sm font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspector)</div>
                                              <div className="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ....... / ....... / ...........</div>
                                          </div>
                                          <div className="text-center">
                                              <div className="border-b border-gray-400 w-48 mb-2 h-8"></div>
                                              <div className="text-sm text-gray-600">( .................................................... )</div>
                                              <div className="text-sm font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Manager)</div>
                                              <div className="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ....... / ....... / ...........</div>
                                          </div>
                                      </div>
                                  </div>
                              ) : (
                                  <div className="text-center text-gray-400 py-20 flex flex-col items-center">
                                      <div className="bg-white p-4 rounded-full shadow-sm border border-gray-200 mb-4">
                                          <FileText size={48} className="text-orange-300"/>
                                      </div>
                                      <p className="text-lg font-bold text-gray-600">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Blank Form)</p>
                                      <p className="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (System) ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</p>
                                  </div>
                              )}
                          </div>
                      </Card>
                  )}

                  {pmSubTab === 'history' && (
                      <Card className="border-t-4 border-gray-600">
                          <div className="p-4 border-b flex justify-between items-center bg-white">
                              <h3 className="font-bold flex items-center gap-2 text-gray-800"><History size={20}/> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (PM History)</h3>
                              <div className="flex gap-2">
                                  <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(pmHistoryList.filter(h => h.projectId === selectedProject.id), 'pm_history_list')}>{t('exportCSV')}</Button>
                              </div>
                          </div>
                          <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                  <thead className="bg-gray-100 text-gray-700 uppercase">
                                      <tr>
                                          <th className="p-3 text-center w-12">{t('col_seq')}</th>
                                          <th className="p-3 text-left w-32">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô)</th>
                                          <th className="p-3 text-left">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</th>
                                          <th className="p-3 text-center w-32">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th>
                                          <th className="p-3 text-center w-36">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                                          <th className="p-3 text-left w-40">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                                          <th className={`p-3 text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                      </tr>
                                  </thead>
                                  <tbody className="divide-y divide-gray-200">
                                      {pmHistoryList.filter(h => h.projectId === selectedProject.id).length > 0 ? (
                                          pmHistoryList.filter(h => h.projectId === selectedProject.id).map((hist, index) => (
                                              <tr key={hist.id} className="hover:bg-gray-50">
                                                  <td className="p-4 text-center text-gray-500 font-medium">{index + 1}</td>
                                                  <td className="p-4">
                                                      <div className="text-gray-700 font-medium">{new Date(hist.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                                                      {hist.executionTimingStatus && (
                                                          <div className={`text-[10px] font-bold mt-1 inline-block px-1.5 py-0.5 rounded-md ${
                                                              hist.executionTimingStatus === '‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? 'bg-blue-100 text-blue-700' :
                                                              hist.executionTimingStatus === '‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? 'bg-red-100 text-red-700' :
                                                              'bg-green-100 text-green-700'
                                                          }`}>
                                                              {hist.executionTimingStatus}
                                                          </div>
                                                      )}
                                                  </td>
                                                  <td className="p-4 cursor-pointer hover:bg-gray-200 transition-colors group rounded-md" onClick={() => setSelectedPmHistory(hist)}>
                                                      <div className="font-bold text-gray-800 group-hover:text-blue-700 flex items-center gap-1">
                                                          {hist.machineName} <FileText size={14} className="text-gray-400 group-hover:text-blue-500"/>
                                                      </div>
                                                      <div className="text-xs text-gray-500 font-mono">{hist.machineCode}</div>
                                                  </td>
                                                  <td className="p-4 text-center">
                                                      {hist.status === 'Pass' ? (
                                                          <span className="bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded text-xs font-bold flex items-center justify-center gap-1 w-fit mx-auto">
                                                              <CheckCircle size={12}/> ‡∏ú‡πà‡∏≤‡∏ô ({hist.passedItems}/{hist.totalItems})
                                                          </span>
                                                      ) : (
                                                          <span className="bg-red-100 text-red-700 border border-red-200 px-2 py-1 rounded text-xs font-bold flex items-center justify-center gap-1 w-fit mx-auto">
                                                              <AlertTriangle size={12}/> ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ({hist.failedItems} ‡∏à‡∏∏‡∏î)
                                                          </span>
                                                      )}
                                                  </td>
                                                  <td className="p-4 text-center">
                                                      {hist.approvalStatus === 'Approved' || !hist.approvalStatus ? (
                                                          <span className="bg-green-100 text-green-700 border border-green-200 px-2 py-1 rounded text-[10px] font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                                                      ) : hist.approvalStatus === 'Pending Chief' ? (
                                                          <span className="bg-orange-100 text-orange-700 border border-orange-200 px-2 py-1 rounded text-[10px] font-bold whitespace-nowrap">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                                      ) : hist.approvalStatus === 'Pending Manager' ? (
                                                          <span className="bg-blue-100 text-blue-700 border border-blue-200 px-2 py-1 rounded text-[10px] font-bold whitespace-nowrap">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                                      ) : hist.approvalStatus === 'Rejected' ? (
                                                          <span className="bg-red-100 text-red-700 border border-red-200 px-2 py-1 rounded text-[10px] font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                                      ) : null}
                                                  </td>
                                                  <td className="p-4 text-gray-700 flex items-center gap-2 truncate" title={hist.inspector}><User size={14} className="text-gray-400 shrink-0"/> <span className="truncate">{hist.inspector}</span></td>
                                                  <td className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>
                                                      {hasPerm('proj_pm', 'delete') && (
                                                          <button 
                                                              onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ PM ‡∏Ç‡∏≠‡∏á ${hist.machineName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setPmHistoryList(pmHistoryList.filter(h => h.id !== hist.id))); }}
                                                              className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                              title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"
                                                          >
                                                              <Trash2 size={16} />
                                                          </button>
                                                      )}
                                                  </td>
                                              </tr>
                                          ))
                                      ) : (
                                          <tr><td colSpan="7" className="p-10 text-center text-gray-400 bg-gray-50 border-b border-dashed">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</td></tr>
                                      )}
                                  </tbody>
                              </table>
                          </div>
                      </Card>
                  )}

                  {!['registry', 'plan', 'calendar', 'history', 'form'].includes(pmSubTab) && (
                      <div className="flex flex-col items-center justify-center h-64 bg-white rounded-lg border border-dashed text-gray-400">
                          <Wrench size={48} className="mb-2 opacity-50"/>
                          <p>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á {t('pm_' + pmSubTab)} ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤</p>
                          <p className="text-xs">Feature under construction</p>
                      </div>
                  )}
              </div>
          )}

          {projectTab === 'utilities' && (
              <Card className="p-0 overflow-hidden">
                  {/* Header */}
                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center p-6 border-b border-gray-200 gap-4">
                      <div className="flex items-center gap-4">
                          <div className="w-10 h-10 bg-orange-50 rounded-lg flex items-center justify-center border border-orange-100">
                              <Zap className="text-orange-500" size={20}/>
                          </div>
                          <h2 className="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü (Utility)</h2>
                      </div>
                      
                      {/* Sub-tabs */}
                      <div className="flex flex-wrap gap-4 md:gap-6 mt-2 md:mt-0 w-full md:w-auto">
                          <button onClick={() => setUtilitySubTab('record')} className={`font-bold pb-2 border-b-2 transition-colors ${utilitySubTab === 'record' ? 'text-red-600 border-red-600' : 'text-gray-500 border-transparent hover:text-gray-700'}`}>‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Record)</button>
                          <button onClick={() => setUtilitySubTab('registry')} className={`font-bold pb-2 border-b-2 transition-colors ${utilitySubTab === 'registry' ? 'text-red-600 border-red-600' : 'text-gray-500 border-transparent hover:text-gray-700'}`}>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Registry)</button>
                          <button onClick={() => setUtilitySubTab('analysis')} className={`font-bold pb-2 border-b-2 transition-colors ${utilitySubTab === 'analysis' ? 'text-red-600 border-red-600' : 'text-gray-500 border-transparent hover:text-gray-700'}`}>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analysis)</button>
                      </div>

                      {/* Action Buttons */}
                      <div className="flex gap-2">
                          <Button variant="outline" size="sm" className="flex items-center gap-2"><FileText size={16}/> CSV</Button>
                          <Button variant="outline" size="sm" className="flex items-center gap-2" onClick={() => handleExportPDF('utility-print-area', 'Utility_Report.pdf')} disabled={isExporting}>
                              {isExporting ? <Loader2 size={16} className="animate-spin" /> : <PrinterIcon size={16}/>} PDF
                          </Button>
                      </div>
                  </div>

                  <div className="p-6" id="utility-print-area">
                      {utilitySubTab === 'record' && (
                          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                              {/* Form Column */}
                              <div className="col-span-1 border border-red-100 rounded-xl overflow-hidden bg-white shadow-sm flex flex-col h-fit">
                                  <div className="bg-[#fff5f5] text-[#9b2c2c] font-bold p-4 border-b border-red-100 flex justify-between items-center">
                                      <span>{utilityForm.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'}</span>
                                      {utilityForm.meterId && !utilityForm.id && (
                                          <span className="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                                              {meters.filter(m => m.projectId === selectedProject.id).findIndex(m => m.id === utilityForm.meterId) + 1} / {meters.filter(m => m.projectId === selectedProject.id).length}
                                          </span>
                                      )}
                                      {utilityForm.id && (
                                          <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-medium animate-pulse">
                                              ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                          </span>
                                      )}
                                  </div>
                                  <form onSubmit={handleSaveUtilityReading} className="p-5 space-y-5">
                                      <div>
                                          <label className="block text-sm font-bold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</label>
                                          <select
                                              className="w-full border border-red-500 rounded-lg p-2.5 focus:ring-2 focus:ring-red-200 outline-none text-sm bg-white"
                                              value={utilityForm.meterId}
                                              onChange={(e) => {
                                                  setUtilityForm({...utilityForm, meterId: e.target.value});
                                                  setTimeout(() => currentValueRef.current?.focus(), 50);
                                              }}
                                              required
                                          >
                                              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå --</option>
                                              {meters.filter(m => m.projectId === selectedProject.id).map(m => (
                                                  <option key={m.id} value={m.id}>{m.name} ({m.code})</option>
                                              ))}
                                          </select>

                                          {/* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó & ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á) */}
                                          {utilityForm.meterId && (() => {
                                              const m = meters.find(meter => meter.id === utilityForm.meterId);
                                              if (!m) return null;
                                              return (
                                                  <div className="mt-3 bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs space-y-2 shadow-inner">
                                                      <div className="flex justify-between items-center">
                                                          <span className="text-gray-500 font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                                                          <span className="font-bold text-gray-800 flex items-center gap-1.5 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">
                                                              {m.type === 'Water' ? <Droplet size={14} className="text-blue-500"/> : <Zap size={14} className="text-orange-500"/>}
                                                              {m.type === 'Water' ? '‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤'}
                                                          </span>
                                                      </div>
                                                      <div className="flex justify-between items-center border-t border-gray-200 pt-2 mt-2">
                                                          <span className="text-gray-500 font-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:</span>
                                                          <span className="font-medium text-gray-800 flex items-center gap-1 text-right max-w-[150px] truncate" title={m.location || '-'}>
                                                              <MapPin size={12} className="text-gray-400 shrink-0"/>
                                                              <span className="truncate">{m.location || '-'}</span>
                                                          </span>
                                                      </div>
                                                  </div>
                                              );
                                          })()}
                                      </div>
                                      <div>
                                          <label className="block text-sm font-bold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î</label>
                                          <input
                                              type="date"
                                              className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-red-200 outline-none text-sm text-gray-700 bg-white"
                                              value={utilityForm.date}
                                              onChange={(e) => setUtilityForm({...utilityForm, date: e.target.value})}
                                              required
                                          />
                                      </div>
                                      <div>
                                          <div className="flex justify-between items-end mb-2">
                                              <label className="block text-sm font-bold text-gray-700">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Current)</label>
                                              {utilityForm.meterId && (
                                                  <span className="text-xs text-gray-500 font-medium bg-gray-100 px-2 py-1 rounded">
                                                      ‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤: <span className="text-gray-800 font-bold">{meters.find(m => m.id === utilityForm.meterId)?.lastReading || 0}</span>
                                                  </span>
                                              )}
                                          </div>
                                          <input
                                              ref={currentValueRef}
                                              type="number"
                                              step="0.01"
                                              className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-red-200 outline-none text-sm bg-white"
                                              placeholder="0.00"
                                              value={utilityForm.currentValue}
                                              onChange={(e) => setUtilityForm({...utilityForm, currentValue: e.target.value})}
                                              required
                                          />
                                      </div>
                                      <button 
                                          type="submit" 
                                          className={`w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors mt-2 ${utilityForm.id ? 'bg-orange-600 hover:bg-orange-700 shadow-md' : 'bg-[#b91c1c] hover:bg-red-800'}`}
                                      >
                                          <Save size={18}/> {utilityForm.id ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Enter)'}
                                      </button>
                                      {utilityForm.id && (
                                          <button 
                                              type="button" 
                                              onClick={() => setUtilityForm({ id: null, meterId: utilityForm.meterId, date: new Date().toISOString().split('T')[0], currentValue: '' })}
                                              className="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors mt-2 border border-gray-200"
                                          >
                                              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                          </button>
                                      )}
                                      
                                      {/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å User ‡∏ó‡∏µ‡πà Log in */}
                                      <div className="mt-3 flex items-center justify-center gap-2 text-xs text-gray-500 bg-gray-50 py-2 rounded-lg border border-gray-100">
                                          <User size={14} className="text-red-600" /> ‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: <span className="font-bold text-gray-700">{currentUser?.firstName} {currentUser?.lastName}</span>
                                      </div>
                                  </form>
                              </div>

                              {/* Right Column (Placeholder or History) */}
                              <div className="col-span-1 lg:col-span-2 border-2 border-dashed border-gray-200 rounded-xl bg-[#fafafa] flex flex-col items-center justify-center min-h-[450px]">
                                  {utilityForm.meterId ? (
                                      <div className="w-full h-full p-6 flex flex-col">
                                          <div className="flex justify-between items-center mb-4 border-b pb-2">
                                              <h3 className="font-bold text-gray-700">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏î (History)</h3>
                                              <span className="text-sm font-mono font-bold text-red-600 bg-red-50 px-2 py-1 rounded">
                                                  {meters.find(m => m.id === utilityForm.meterId)?.code}
                                              </span>
                                          </div>
                                          <div className="flex-1 overflow-auto">
                                              {utilityReadings.filter(r => r.meterId === utilityForm.meterId).length > 0 ? (
                                                  <table className="w-full text-sm text-left">
                                                      <thead className="bg-white text-gray-600 border-b border-gray-200">
                                                          <tr>
                                                              <th className="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏î</th>
                                                              <th className="p-3 text-right">‡πÄ‡∏•‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</th>
                                                              <th className="p-3 text-right">‡πÄ‡∏•‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                                              <th className="p-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
                                                              <th className="p-3 text-center">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                                          </tr>
                                                      </thead>
                                                      <tbody className="divide-y divide-gray-100">
                                                          {utilityReadings.filter(r => r.meterId === utilityForm.meterId).sort((a,b) => new Date(b.date) - new Date(a.date)).map(r => (
                                                              <tr key={r.id} className="hover:bg-gray-50 transition-colors">
                                                                  <td className="p-3 text-blue-600 font-medium cursor-pointer hover:underline flex items-center gap-1 group" onClick={() => handleEditUtilityReading(r)} title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                                                      {new Date(r.date).toLocaleDateString('th-TH')}
                                                                      <Edit size={12} className="text-gray-400 group-hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"/>
                                                                  </td>
                                                                  <td className="p-3 text-right text-gray-500">{r.prevValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                                                  <td className="p-3 text-right font-bold text-gray-800">{r.value.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                                                  <td className="p-3 text-right font-bold text-red-600">+{r.usage.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                                                  <td className="p-3 text-center text-gray-500 text-xs">
                                                                      <span className="bg-gray-100 px-2 py-1 rounded border border-gray-200">{r.recorder}</span>
                                                                  </td>
                                                              </tr>
                                                          ))}
                                                      </tbody>
                                                  </table>
                                              ) : (
                                                  <div className="text-center text-gray-400 py-20 flex flex-col items-center">
                                                      <ClipboardList size={48} className="text-gray-300 mb-2"/>
                                                      <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ</p>
                                                  </div>
                                              )}
                                          </div>
                                      </div>
                                  ) : (
                                      <div className="text-center text-gray-400 flex flex-col items-center">
                                          <Zap size={64} className="mb-4 text-gray-300 -rotate-12" strokeWidth={1.5} />
                                          <p className="font-bold text-lg text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
                                      </div>
                                  )}
                              </div>
                          </div>
                      )}
                      
                      {utilitySubTab === 'registry' && (
                          <div className="flex flex-col h-full">
                              <div className="flex justify-between items-center mb-4 pb-4 border-b">
                                  <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                      <Box size={20} className="text-red-500" /> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                  </h3>
                                  {hasPerm('proj_utilities', 'save') && <Button size="sm" icon={Plus} onClick={() => { setNewMeter({ id: null, type: 'Water', code: '', name: '', location: '', initialValue: '' }); setShowAddMeterModal(true); }} className="bg-red-600 hover:bg-red-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</Button>}
                              </div>
                              <div className="overflow-x-auto">
                                  {meters.filter(m => m.projectId === selectedProject.id).length > 0 ? (
                                      <table className="w-full text-sm text-left border border-gray-200 rounded-lg overflow-hidden">
                                          <thead className="bg-gray-100 text-gray-600">
                                              <tr>
                                                  <th className="p-3 border-b text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                                  <th className="p-3 border-b w-32">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                                  <th className="p-3 border-b">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Code)</th>
                                                  <th className="p-3 border-b">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</th>
                                                  <th className="p-3 border-b">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</th>
                                                  <th className="p-3 text-right border-b">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô/‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                                  <th className={`p-3 text-center border-b w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                              </tr>
                                          </thead>
                                          <tbody className="divide-y divide-gray-200 bg-white">
                                              {meters.filter(m => m.projectId === selectedProject.id).map((m, idx) => (
                                                  <tr key={m.id} className="hover:bg-gray-50 transition-colors">
                                                      <td className="p-3 text-gray-500 text-center">{idx + 1}</td>
                                                      <td className="p-3">
                                                          <span className={`px-2 py-1 rounded-md text-xs font-bold flex items-center gap-1 w-fit ${m.type === 'Water' ? 'bg-blue-100 text-blue-700 border border-blue-200' : 'bg-orange-100 text-orange-700 border border-orange-200'}`}>
                                                              {m.type === 'Water' ? <Droplet size={12}/> : <Zap size={12}/>}
                                                              {m.type === 'Water' ? '‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤'}
                                                          </span>
                                                      </td>
                                                      <td className="p-3 font-mono font-medium text-gray-800 bg-gray-50 rounded">{m.code}</td>
                                                      <td className={`p-3 ${hasPerm('proj_utilities', 'edit') ? 'cursor-pointer group' : ''}`} onClick={() => hasPerm('proj_utilities', 'edit') && handleEditMeter(m)}>
                                                          <div className={`font-bold text-gray-700 flex items-center gap-1.5 ${hasPerm('proj_utilities', 'edit') ? 'group-hover:text-red-600 transition-colors' : ''}`}>
                                                              {m.name}
                                                              {hasPerm('proj_utilities', 'edit') && <Edit size={14} className="text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" />}
                                                          </div>
                                                          {hasPerm('proj_utilities', 'edit') && <div className="text-[10px] text-gray-400 mt-0.5 opacity-0 group-hover:opacity-100 transition-opacity">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>}
                                                      </td>
                                                      <td className="p-3 text-gray-600">
                                                          <div className="flex items-center gap-1">
                                                              <MapPin size={14} className="text-gray-400"/> {m.location || '-'}
                                                          </div>
                                                      </td>
                                                      <td className="p-3 text-right font-bold text-gray-800">
                                                          {m.lastReading.toLocaleString(undefined, {minimumFractionDigits: 2})}
                                                      </td>
                                                      <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                                          {hasPerm('proj_utilities', 'delete') && (
                                                              <button 
                                                                  onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏£‡∏´‡∏±‡∏™ ${m.code} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setMeters(meters.filter(meter => meter.id !== m.id)))}
                                                                  className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                                  title="‡∏•‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå"
                                                              >
                                                                  <Trash2 size={16} />
                                                              </button>
                                                          )}
                                                      </td>
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>
                                  ) : (
                                      <div className="text-center text-gray-400 py-20 flex flex-col items-center border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                                          <Box size={48} className="text-gray-300 mb-4"/>
                                          <p className="font-bold text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</p>
                                          <p className="text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                                      </div>
                                  )}
                              </div>
                          </div>
                      )}
                      
                      {utilitySubTab === 'analysis' && (
                          <div className="space-y-6">
                              <div className="flex justify-between items-center mb-4 border-b pb-4">
                                  <h3 className="font-bold text-gray-700 flex items-center gap-2">
                                      <BarChart3 size={20} className="text-red-500" /> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô (Energy Analysis)
                                  </h3>
                                  <div className="flex items-center gap-1 bg-gray-100 p-1 rounded-lg border border-gray-200">
                                      <button 
                                          onClick={() => setUtilityChartType('bar')} 
                                          className={`px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${utilityChartType === 'bar' ? 'bg-white shadow-sm text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                      >
                                          ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar)
                                      </button>
                                      <button 
                                          onClick={() => setUtilityChartType('line')} 
                                          className={`px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${utilityChartType === 'line' ? 'bg-white shadow-sm text-gray-800' : 'text-gray-500 hover:text-gray-700'}`}
                                      >
                                          ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô (Line)
                                      </button>
                                  </div>
                              </div>
                              
                              {(() => {
                                  // Data Processing for Chart
                                  const projectMeters = meters.filter(m => m.projectId === selectedProject.id);
                                  const waterMeters = projectMeters.filter(m => m.type === 'Water');
                                  const elecMeters = projectMeters.filter(m => m.type === 'Electricity');

                                  const activeWaterMeters = waterMeters.filter(m => !hiddenAnalysisMeters.has(m.id));
                                  const activeElecMeters = elecMeters.filter(m => !hiddenAnalysisMeters.has(m.id));

                                  const projectMeterIds = projectMeters.map(m => m.id);
                                  const projectReadings = utilityReadings.filter(r => projectMeterIds.includes(r.meterId));

                                  const chartDataMap = {};
                                  projectReadings.forEach(r => {
                                      const meter = projectMeters.find(m => m.id === r.meterId);
                                      if (!meter) return;
                                      
                                      const dateObj = new Date(r.date);
                                      const displayDate = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
                                      
                                      if (!chartDataMap[r.date]) {
                                          chartDataMap[r.date] = { rawDate: r.date, date: displayDate };
                                      }
                                      
                                      // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏Ç‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô Key
                                      const meterKey = `${meter.name} (${meter.code})`;
                                      chartDataMap[r.date][meterKey] = (chartDataMap[r.date][meterKey] || 0) + r.usage;
                                  });

                                  const chartData = Object.values(chartDataMap).sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));

                                  if (chartData.length === 0) {
                                      return (
                                          <div className="text-center text-gray-400 py-20 flex flex-col items-center border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">
                                              <BarChart3 size={48} className="text-gray-300 mb-4"/>
                                              <p className="font-bold text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                                              <p className="text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</p>
                                          </div>
                                      );
                                  }

                                  // ‡∏ä‡∏∏‡∏î‡∏™‡∏µ
                                  const waterColors = ['#3b82f6', '#0ea5e9', '#6366f1', '#06b6d4', '#8b5cf6', '#2563eb'];
                                  const elecColors = ['#f97316', '#f59e0b', '#ef4444', '#eab308', '#f43f5e', '#ea580c'];

                                  return (
                                      <div className="flex flex-col gap-8">
                                          {/* --- Water Consumption Section --- */}
                                          {waterMeters.length > 0 && (
                                              <div className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                                                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                                                      <h4 className="font-bold text-blue-700 flex items-center gap-2">
                                                          <Droplet size={18}/> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤
                                                      </h4>
                                                      <div className="flex items-center bg-blue-50 rounded-lg p-1 border border-blue-100">
                                                          <button onClick={() => setWaterAnalysisMode('combined')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-colors ${waterAnalysisMode === 'combined' ? 'bg-white text-blue-700 shadow-sm' : 'text-blue-500 hover:text-blue-800'}`}>‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏≤‡∏ü (Combined)</button>
                                                          <button onClick={() => setWaterAnalysisMode('separate')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-colors ${waterAnalysisMode === 'separate' ? 'bg-white text-blue-700 shadow-sm' : 'text-blue-500 hover:text-blue-800'}`}>1 ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≠ 1 ‡∏Å‡∏£‡∏≤‡∏ü (Separate)</button>
                                                      </div>
                                                  </div>
                                                  
                                                  {/* Filter */}
                                                  <div className="flex flex-wrap gap-2 mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                      <div className="text-xs font-bold text-gray-500 mr-2 flex items-center"><Search size={14} className="mr-1"/> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå:</div>
                                                      {waterMeters.map((m, idx) => (
                                                          <label key={m.id} className={`flex items-center gap-1.5 text-xs cursor-pointer px-2.5 py-1 rounded-md border transition-all ${!hiddenAnalysisMeters.has(m.id) ? 'bg-blue-100 border-blue-300 text-blue-800 font-medium shadow-sm' : 'bg-white border-gray-200 text-gray-400 hover:bg-gray-50'}`}>
                                                              <input type="checkbox" checked={!hiddenAnalysisMeters.has(m.id)} onChange={() => toggleMeterVisibility(m.id)} className="accent-blue-600 w-3.5 h-3.5" />
                                                              <span className="truncate max-w-[150px]" title={`${m.name} (${m.code})`}>{m.name}</span>
                                                          </label>
                                                      ))}
                                                  </div>

                                                  {activeWaterMeters.length === 0 ? (
                                                      <div className="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border border-dashed">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</div>
                                                  ) : waterAnalysisMode === 'combined' ? (
                                                      // Combined Chart
                                                      <div className="h-80 bg-blue-50/30 rounded-xl border border-blue-50 p-4">
                                                          <ResponsiveContainer width="100%" height="100%">
                                                              {utilityChartType === 'bar' ? (
                                                                  <BarChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                                                      <XAxis dataKey="date" tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} dy={10} />
                                                                      <YAxis tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} />
                                                                      <RechartsTooltip cursor={{fill: '#f3f4f6'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                      <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '20px' }} />
                                                                      {activeWaterMeters.map((m, idx) => (
                                                                          <Bar key={m.id} dataKey={`${m.name} (${m.code})`} fill={waterColors[idx % waterColors.length]} radius={[4, 4, 0, 0]} maxBarSize={40} />
                                                                      ))}
                                                                  </BarChart>
                                                              ) : (
                                                                  <LineChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                                                      <XAxis dataKey="date" tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} dy={10} />
                                                                      <YAxis tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} />
                                                                      <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                      <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '20px' }} />
                                                                      {activeWaterMeters.map((m, idx) => (
                                                                          <Line key={m.id} type="monotone" dataKey={`${m.name} (${m.code})`} stroke={waterColors[idx % waterColors.length]} strokeWidth={3} dot={{ r: 4, strokeWidth: 2 }} activeDot={{ r: 6 }} />
                                                                      ))}
                                                                  </LineChart>
                                                              )}
                                                          </ResponsiveContainer>
                                                      </div>
                                                  ) : (
                                                      // Separate Charts
                                                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                          {activeWaterMeters.map((m, idx) => {
                                                              const meterKey = `${m.name} (${m.code})`;
                                                              const color = waterColors[idx % waterColors.length];
                                                              return (
                                                                  <div key={m.id} className="border border-blue-100 rounded-xl p-4 bg-white shadow-sm hover:shadow transition-shadow">
                                                                      <h5 className="text-xs font-bold text-blue-800 text-center mb-4 bg-blue-50 py-1.5 rounded-md truncate px-2" title={meterKey}>{meterKey}</h5>
                                                                      <div className="h-48">
                                                                          <ResponsiveContainer width="100%" height="100%">
                                                                              {utilityChartType === 'bar' ? (
                                                                                  <BarChart data={chartData} margin={{ top: 5, right: 5, left: -25, bottom: 0 }}>
                                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                                                      <XAxis dataKey="date" tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} dy={5} />
                                                                                      <YAxis tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} />
                                                                                      <RechartsTooltip cursor={{fill: '#f9fafb'}} contentStyle={{ fontSize: '12px', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                                      <Bar dataKey={meterKey} name="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥" fill={color} radius={[3, 3, 0, 0]} maxBarSize={30} />
                                                                                  </BarChart>
                                                                              ) : (
                                                                                  <LineChart data={chartData} margin={{ top: 5, right: 5, left: -25, bottom: 0 }}>
                                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                                                      <XAxis dataKey="date" tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} dy={5} />
                                                                                      <YAxis tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} />
                                                                                      <RechartsTooltip contentStyle={{ fontSize: '12px', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                                      <Line type="monotone" dataKey={meterKey} name="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥" stroke={color} strokeWidth={2} dot={{ r: 3, strokeWidth: 1 }} activeDot={{ r: 5 }} />
                                                                                  </LineChart>
                                                                              )}
                                                                          </ResponsiveContainer>
                                                                      </div>
                                                                  </div>
                                                              )
                                                          })}
                                                      </div>
                                                  )}
                                              </div>
                                          )}
                                          
                                          {/* --- Electricity Consumption Section --- */}
                                          {elecMeters.length > 0 && (
                                              <div className="bg-white border border-gray-200 rounded-xl p-5 shadow-sm">
                                                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                                                      <h4 className="font-bold text-orange-600 flex items-center gap-2">
                                                          <Zap size={18}/> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
                                                      </h4>
                                                      <div className="flex items-center bg-orange-50 rounded-lg p-1 border border-orange-100">
                                                          <button onClick={() => setElecAnalysisMode('combined')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-colors ${elecAnalysisMode === 'combined' ? 'bg-white text-orange-700 shadow-sm' : 'text-orange-500 hover:text-orange-800'}`}>‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏≤‡∏ü (Combined)</button>
                                                          <button onClick={() => setElecAnalysisMode('separate')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-colors ${elecAnalysisMode === 'separate' ? 'bg-white text-orange-700 shadow-sm' : 'text-orange-500 hover:text-orange-800'}`}>1 ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≠ 1 ‡∏Å‡∏£‡∏≤‡∏ü (Separate)</button>
                                                      </div>
                                                  </div>

                                                  {/* Filter */}
                                                  <div className="flex flex-wrap gap-2 mb-6 bg-gray-50 p-3 rounded-lg border border-gray-100">
                                                      <div className="text-xs font-bold text-gray-500 mr-2 flex items-center"><Search size={14} className="mr-1"/> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå:</div>
                                                      {elecMeters.map((m, idx) => (
                                                          <label key={m.id} className={`flex items-center gap-1.5 text-xs cursor-pointer px-2.5 py-1 rounded-md border transition-all ${!hiddenAnalysisMeters.has(m.id) ? 'bg-orange-100 border-orange-300 text-orange-800 font-medium shadow-sm' : 'bg-white border-gray-200 text-gray-400 hover:bg-gray-50'}`}>
                                                              <input type="checkbox" checked={!hiddenAnalysisMeters.has(m.id)} onChange={() => toggleMeterVisibility(m.id)} className="accent-orange-600 w-3.5 h-3.5" />
                                                              <span className="truncate max-w-[150px]" title={`${m.name} (${m.code})`}>{m.name}</span>
                                                          </label>
                                                      ))}
                                                  </div>

                                                  {activeElecMeters.length === 0 ? (
                                                      <div className="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border border-dashed">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</div>
                                                  ) : elecAnalysisMode === 'combined' ? (
                                                      // Combined Chart
                                                      <div className="h-80 bg-orange-50/30 rounded-xl border border-orange-50 p-4">
                                                          <ResponsiveContainer width="100%" height="100%">
                                                              {utilityChartType === 'bar' ? (
                                                                  <BarChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                                                      <XAxis dataKey="date" tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} dy={10} />
                                                                      <YAxis tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} />
                                                                      <RechartsTooltip cursor={{fill: '#f3f4f6'}} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                      <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '20px' }} />
                                                                      {activeElecMeters.map((m, idx) => (
                                                                          <Bar key={m.id} dataKey={`${m.name} (${m.code})`} fill={elecColors[idx % elecColors.length]} radius={[4, 4, 0, 0]} maxBarSize={40} />
                                                                      ))}
                                                                  </BarChart>
                                                              ) : (
                                                                  <LineChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                                                      <XAxis dataKey="date" tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} dy={10} />
                                                                      <YAxis tick={{fontSize: 12, fill: '#6b7280'}} axisLine={false} tickLine={false} />
                                                                      <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                      <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '20px' }} />
                                                                      {activeElecMeters.map((m, idx) => (
                                                                          <Line key={m.id} type="monotone" dataKey={`${m.name} (${m.code})`} stroke={elecColors[idx % elecColors.length]} strokeWidth={3} dot={{ r: 4, strokeWidth: 2 }} activeDot={{ r: 6 }} />
                                                                      ))}
                                                                  </LineChart>
                                                              )}
                                                          </ResponsiveContainer>
                                                      </div>
                                                  ) : (
                                                      // Separate Charts
                                                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                          {activeElecMeters.map((m, idx) => {
                                                              const meterKey = `${m.name} (${m.code})`;
                                                              const color = elecColors[idx % elecColors.length];
                                                              return (
                                                                  <div key={m.id} className="border border-orange-100 rounded-xl p-4 bg-white shadow-sm hover:shadow transition-shadow">
                                                                      <h5 className="text-xs font-bold text-orange-800 text-center mb-4 bg-orange-50 py-1.5 rounded-md truncate px-2" title={meterKey}>{meterKey}</h5>
                                                                      <div className="h-48">
                                                                          <ResponsiveContainer width="100%" height="100%">
                                                                              {utilityChartType === 'bar' ? (
                                                                                  <BarChart data={chartData} margin={{ top: 5, right: 5, left: -25, bottom: 0 }}>
                                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                                                      <XAxis dataKey="date" tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} dy={5} />
                                                                                      <YAxis tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} />
                                                                                      <RechartsTooltip cursor={{fill: '#f9fafb'}} contentStyle={{ fontSize: '12px', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                                      <Bar dataKey={meterKey} name="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" fill={color} radius={[3, 3, 0, 0]} maxBarSize={30} />
                                                                                  </BarChart>
                                                                              ) : (
                                                                                  <LineChart data={chartData} margin={{ top: 5, right: 5, left: -25, bottom: 0 }}>
                                                                                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                                                      <XAxis dataKey="date" tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} dy={5} />
                                                                                      <YAxis tick={{fontSize: 10, fill: '#9ca3af'}} axisLine={false} tickLine={false} />
                                                                                      <RechartsTooltip contentStyle={{ fontSize: '12px', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                                                      <Line type="monotone" dataKey={meterKey} name="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÑ‡∏ü‡∏ü‡πâ‡∏≤" stroke={color} strokeWidth={2} dot={{ r: 3, strokeWidth: 1 }} activeDot={{ r: 5 }} />
                                                                                  </LineChart>
                                                                              )}
                                                                          </ResponsiveContainer>
                                                                      </div>
                                                                  </div>
                                                              )
                                                          })}
                                                      </div>
                                                  )}
                                              </div>
                                          )}
                                      </div>
                                  );
                              })()}
                          </div>
                      )}
                  </div>
              </Card>
          )}

          {projectTab === 'repair' && (
              <div className="space-y-6 animate-fade-in">
                  {/* NEW: Summary Dashboard for Repairs */}
                  {(() => {
                      const projectRepairs = repairs.filter(r => r.projectId === selectedProject.id);
                      const totalRepairs = projectRepairs.length;
                      const statusCounts = { '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 0, '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': 0, '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà': 0, '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å': 0 };
                      projectRepairs.forEach(rep => {
                          if (statusCounts[rep.inspectionResult] !== undefined) statusCounts[rep.inspectionResult]++;
                      });

                      return (
                          <Card className="p-6">
                              <div className="flex justify-between items-center mb-4">
                                  <h3 className="font-bold flex items-center gap-2 text-gray-800">
                                      <BarChart3 size={20} className="text-orange-500" /> ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair Status Summary)
                                  </h3>
                                  <div className="text-sm font-bold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                      ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {totalRepairs} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                                  </div>
                              </div>
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                  <div className={`border p-4 rounded-xl text-center cursor-pointer transition-all ${repairFilter === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'bg-orange-50 border-orange-400 shadow-sm' : 'bg-white border-gray-200 hover:border-orange-300'}`} onClick={() => setRepairFilter(repairFilter === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'All' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')}>
                                      <div className="text-orange-600 text-sm font-bold mb-1">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                      <div className="text-3xl font-black text-orange-700">{statusCounts['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£']}</div>
                                  </div>
                                  <div className={`border p-4 rounded-xl text-center cursor-pointer transition-all ${repairFilter === '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' ? 'bg-yellow-50 border-yellow-400 shadow-sm' : 'bg-white border-gray-200 hover:border-yellow-300'}`} onClick={() => setRepairFilter(repairFilter === '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' ? 'All' : '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà')}>
                                      <div className="text-yellow-600 text-sm font-bold mb-1">‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</div>
                                      <div className="text-3xl font-black text-yellow-700">{statusCounts['‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà']}</div>
                                  </div>
                                  <div className={`border p-4 rounded-xl text-center cursor-pointer transition-all ${repairFilter === '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'bg-purple-50 border-purple-400 shadow-sm' : 'bg-white border-gray-200 hover:border-purple-300'}`} onClick={() => setRepairFilter(repairFilter === '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'All' : '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å')}>
                                      <div className="text-purple-600 text-sm font-bold mb-1">‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Ø</div>
                                      <div className="text-3xl font-black text-purple-700">{statusCounts['‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å']}</div>
                                  </div>
                                  <div className={`border p-4 rounded-xl text-center cursor-pointer transition-all ${repairFilter === '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-50 border-green-400 shadow-sm' : 'bg-white border-gray-200 hover:border-green-300'}`} onClick={() => setRepairFilter(repairFilter === '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'All' : '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô')}>
                                      <div className="text-green-600 text-sm font-bold mb-1">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
                                      <div className="text-3xl font-black text-green-700">{statusCounts['‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô']}</div>
                                  </div>
                              </div>
                          </Card>
                      );
                  })()}

                  <Card id="print-repair-area">
                      <div className="p-4 border-b flex flex-col xl:flex-row justify-between items-start xl:items-center gap-4 bg-white">
                          <h3 className="font-bold flex items-center gap-2 text-gray-800 whitespace-nowrap">
                              <Hammer size={20} className="text-orange-500" /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair Requests)
                          </h3>
                          
                          {/* NEW: Filter Buttons */}
                          <div className={`flex bg-gray-100 p-1 rounded-lg w-full xl:w-auto overflow-x-auto ${isExporting ? 'hidden' : ''}`}>
                              {[
                                  { id: 'All', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' },
                                  { id: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
                                  { id: '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', label: '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' },
                                  { id: '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å', label: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Ø' },
                                  { id: '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' }
                              ].map(status => (
                                  <button
                                      key={status.id}
                                      onClick={() => setRepairFilter(status.id)}
                                      className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all whitespace-nowrap ${repairFilter === status.id ? 'bg-white shadow text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
                                  >
                                      {status.label}
                                  </button>
                              ))}
                          </div>

                          <div className={`flex gap-2 shrink-0 ${isExporting ? 'hidden' : ''}`}>
                              <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(repairs.filter(r => r.projectId === selectedProject.id && (repairFilter === 'All' || r.inspectionResult === repairFilter)), 'repair_requests')}>{t('exportCSV')}</Button>
                              <Button variant="outline" size="sm" icon={isExporting ? Loader2 : PrinterIcon} onClick={() => handleExportPDF('print-repair-area', `Repairs_${selectedProject?.code || 'List'}.pdf`, 'landscape')} disabled={isExporting}>
                                  {isExporting ? t('downloading') : t('downloadPDF')}
                              </Button>
                              {hasPerm('proj_repair', 'save') && <Button size="sm" icon={Plus} onClick={() => {
                                  setNewRepair({ id: null, code: '', roomNo: '', floor: '', requesterName: '', phone: '', issueType: '', issueTypeOther: '', issueDetails: '', inspectionResult: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', staffDetails: '', cost: '', staffName: '', requesterSignName: '' });
                                  setShowAddRepairModal(true);
                              }}>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà</Button>}
                          </div>
                      </div>
                      <div className={isExporting ? "pb-4" : "overflow-x-auto"}>
                          <table className="w-full text-sm text-left">
                              <thead className="bg-gray-50 text-gray-600">
                                  <tr>
                                      <th className="p-3 border-b text-center w-12">{t('col_seq')}</th>
                                      <th className="p-3 border-b w-32">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</th>
                                      <th className="p-3 border-b">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                      <th className="p-3 border-b">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                      <th className="p-3 border-b text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                      <th className={`p-3 border-b text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-100 bg-white">
                                  {repairs.filter(r => r.projectId === selectedProject.id && (repairFilter === 'All' || r.inspectionResult === repairFilter)).length > 0 ? (
                                      repairs.filter(r => r.projectId === selectedProject.id && (repairFilter === 'All' || r.inspectionResult === repairFilter)).map((rep, index) => (
                                          <tr key={rep.id} className="hover:bg-gray-50 transition-colors">
                                              <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                              <td className="p-3 font-mono font-medium text-orange-600 cursor-pointer group" onClick={() => setSelectedRepairView(rep)}>
                                                  {rep.code}
                                                  <FileText size={12} className={`ml-1 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity inline ${isExporting ? 'hidden' : ''}`}/>
                                              </td>
                                              <td className="p-3 cursor-pointer" onClick={() => setSelectedRepairView(rep)}>
                                                  <div className="font-medium text-gray-800 flex items-center gap-1">
                                                      {rep.issueType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏)' || rep.issueType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? rep.issueTypeOther : rep.issueType}
                                                  </div>
                                                  <div className="text-xs text-gray-500 mt-0.5">‡∏´‡πâ‡∏≠‡∏á: {rep.roomNo || '-'} {rep.floor ? `(‡∏ä‡∏±‡πâ‡∏ô ${rep.floor})` : ''}</div>
                                                  <div className="text-xs text-gray-500 mt-0.5 line-clamp-1">{rep.issueDetails}</div>
                                              </td>
                                              <td className="p-3 text-gray-700">
                                                  <div className="text-sm font-medium">{rep.requesterName || '-'}</div>
                                                  <div className="text-xs text-gray-500">{rep.phone || '-'}</div>
                                              </td>
                                              <td className="p-3 text-center">
                                                  <span className={`px-2 py-1 rounded-md text-xs font-bold border inline-block w-40 text-center ${
                                                      rep.inspectionResult === '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-50 border-green-200 text-green-700' : 
                                                      rep.inspectionResult === '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' ? 'bg-yellow-50 border-yellow-200 text-yellow-700' : 
                                                      rep.inspectionResult === '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'bg-purple-50 border-purple-200 text-purple-700' :
                                                      'bg-gray-100 border-gray-300 text-gray-600'
                                                  }`}>
                                                      {rep.inspectionResult}
                                                  </span>
                                              </td>
                                              <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                                  <div className="flex justify-center items-center gap-1">
                                                      {hasPerm('proj_repair', 'edit') && (
                                                          <button 
                                                              onClick={(e) => { e.stopPropagation(); handleEditRepair(rep); }}
                                                              className="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors"
                                                              title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                                          >
                                                              <Edit size={16} />
                                                          </button>
                                                      )}
                                                      {hasPerm('proj_repair', 'delete') && (
                                                          <button 
                                                              onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ${rep.code} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setRepairs(repairs.filter(r => r.id !== rep.id))); }}
                                                              className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                              title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                                          >
                                                              <Trash2 size={16} />
                                                          </button>
                                                      )}
                                                  </div>
                                              </td>
                                          </tr>
                                      ))
                                  ) : (
                                      <tr><td colSpan="6" className="p-8 text-center text-gray-400 border-2 border-dashed border-gray-200 m-4 rounded-lg bg-gray-50">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </Card>
              </div>
          )}

          {projectTab === 'action' && (
              <div className="space-y-6">
                  {/* ‡πÄ‡∏û‡∏¥‡πà‡∏° ChartGradients ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡∏µ Gradient ‡πÅ‡∏ô‡∏ß 3D ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü */}
                  <ChartGradients />
                  
                  {/* Summary Pie Chart Card */}
                  <Card className="p-6">
                      <h3 className="font-bold flex items-center gap-3 mb-6 text-gray-800">
                          {/* 3D Icon Badge */}
                          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white shadow-[0_4px_10px_rgba(234,88,12,0.4),_inset_0_2px_0_rgba(255,255,255,0.3)]">
                              <BarChart3 size={20} /> 
                          </div>
                          ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Action Plan Summary)
                      </h3>
                      
                      {(() => {
                          const projectActionPlans = actionPlans.filter(a => a.projectId === selectedProject.id);
                          const totalActions = projectActionPlans.length;
                          
                          if (totalActions === 0) {
                              return <div className="text-center text-gray-400 py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</div>;
                          }

                          const statusCounts = { 'Pending': 0, 'In Progress': 0, 'Completed': 0, 'Cancelled': 0 };
                          projectActionPlans.forEach(ap => { if (statusCounts[ap.status] !== undefined) statusCounts[ap.status]++; });

                          // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô url() ‡∏à‡∏≤‡∏Å ChartGradients ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏á‡∏≤‡∏ö‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≤‡∏ü
                          const pieData = [
                              { name: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', value: statusCounts['Pending'], color: 'url(#colorOrange)' },
                              { name: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', value: statusCounts['In Progress'], color: 'url(#colorBlue)' },
                              { name: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', value: statusCounts['Completed'], color: 'url(#colorGreen)' },
                              { name: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', value: statusCounts['Cancelled'], color: 'url(#colorGray)' }
                          ].filter(d => d.value > 0);

                          const renderCustomizedLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, index }) => {
                              const RADIAN = Math.PI / 180;
                              const radius = innerRadius + (outerRadius - innerRadius) * 0.5;
                              const x = cx + radius * Math.cos(-midAngle * RADIAN);
                              const y = cy + radius * Math.sin(-midAngle * RADIAN);
                              return (
                                  <text x={x} y={y} fill="white" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize={12} fontWeight="bold" style={{ textShadow: '1px 1px 3px rgba(0,0,0,0.8)' }}>
                                      {`${(percent * 100).toFixed(0)}%`}
                                  </text>
                              );
                          };

                          return (
                              <div className="flex flex-col lg:flex-row items-center gap-10">
                                  {/* Pie Chart (3D Styled) */}
                                  <div className="w-full lg:w-5/12 h-[300px] flex justify-center relative">
                                      {/* ‡πÄ‡∏á‡∏≤‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏ö‡∏ö 3D */}
                                      <div className="absolute top-[15%] bottom-[15%] left-[15%] right-[15%] bg-gradient-to-b from-gray-50 to-gray-200 rounded-full scale-[0.8] opacity-60 blur-xl"></div>
                                      <ResponsiveContainer width="100%" height="100%">
                                          <PieChart style={{ filter: 'drop-shadow(3px 8px 10px rgba(0,0,0,0.25))' }}>
                                              <Pie
                                                  data={pieData}
                                                  cx="50%"
                                                  cy="50%"
                                                  labelLine={false}
                                                  label={renderCustomizedLabel}
                                                  outerRadius={110}
                                                  innerRadius={45}
                                                  dataKey="value"
                                                  stroke="#ffffff"
                                                  strokeWidth={2}
                                              >
                                                  {pieData.map((entry, index) => (
                                                      <Cell key={`cell-${index}`} fill={entry.color} />
                                                  ))}
                                              </Pie>
                                              <RechartsTooltip 
                                                  formatter={(value) => [`${value} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']}
                                                  contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.1)' }}
                                              />
                                              <Legend verticalAlign="bottom" height={36} iconType="circle" />
                                          </PieChart>
                                      </ResponsiveContainer>
                                  </div>
                                  
                                  {/* Stats Summary (3D Cards) */}
                                  <div className="w-full lg:w-7/12 grid grid-cols-2 gap-5">
                                      <div className="relative bg-gradient-to-b from-white to-orange-50 border border-orange-100 p-5 rounded-2xl text-center shadow-[0_8px_20px_-4px_rgba(234,88,12,0.15),_inset_0_2px_0_rgba(255,255,255,1),_inset_0_-4px_0_rgba(234,88,12,0.05)] transform transition-transform hover:-translate-y-1">
                                          <div className="absolute -top-3 -right-3 w-11 h-11 bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl flex items-center justify-center text-white shadow-[0_4px_8px_rgba(234,88,12,0.5),_inset_0_2px_0_rgba(255,255,255,0.4)] rotate-3">
                                              <Hourglass size={20}/>
                                          </div>
                                          <div className="text-orange-600 text-sm font-bold mb-1">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                          <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-orange-500 to-orange-800 drop-shadow-sm">{statusCounts['Pending']}</div>
                                          <div className="text-xs text-orange-600 mt-2 font-medium bg-white/80 py-1.5 rounded-full border border-orange-100 inline-block px-4 shadow-sm">{((statusCounts['Pending'] / totalActions) * 100).toFixed(1)}%</div>
                                      </div>
                                      
                                      <div className="relative bg-gradient-to-b from-white to-blue-50 border border-blue-100 p-5 rounded-2xl text-center shadow-[0_8px_20px_-4px_rgba(59,130,246,0.15),_inset_0_2px_0_rgba(255,255,255,1),_inset_0_-4px_0_rgba(59,130,246,0.05)] transform transition-transform hover:-translate-y-1">
                                          <div className="absolute -top-3 -right-3 w-11 h-11 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-[0_4px_8px_rgba(59,130,246,0.5),_inset_0_2px_0_rgba(255,255,255,0.4)] -rotate-3">
                                              <Wrench size={20}/>
                                          </div>
                                          <div className="text-blue-600 text-sm font-bold mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                                          <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-blue-500 to-blue-800 drop-shadow-sm">{statusCounts['In Progress']}</div>
                                          <div className="text-xs text-blue-600 mt-2 font-medium bg-white/80 py-1.5 rounded-full border border-blue-100 inline-block px-4 shadow-sm">{((statusCounts['In Progress'] / totalActions) * 100).toFixed(1)}%</div>
                                      </div>
                                      
                                      <div className="relative bg-gradient-to-b from-white to-green-50 border border-green-100 p-5 rounded-2xl text-center shadow-[0_8px_20px_-4px_rgba(16,185,129,0.15),_inset_0_2px_0_rgba(255,255,255,1),_inset_0_-4px_0_rgba(16,185,129,0.05)] transform transition-transform hover:-translate-y-1">
                                          <div className="absolute -top-3 -right-3 w-11 h-11 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center text-white shadow-[0_4px_8px_rgba(16,185,129,0.5),_inset_0_2px_0_rgba(255,255,255,0.4)] rotate-3">
                                              <CheckCircle size={20}/>
                                          </div>
                                          <div className="text-green-600 text-sm font-bold mb-1">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
                                          <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-green-500 to-green-800 drop-shadow-sm">{statusCounts['Completed']}</div>
                                          <div className="text-xs text-green-600 mt-2 font-medium bg-white/80 py-1.5 rounded-full border border-green-100 inline-block px-4 shadow-sm">{((statusCounts['Completed'] / totalActions) * 100).toFixed(1)}%</div>
                                      </div>
                                      
                                      <div className="relative bg-gradient-to-b from-white to-gray-50 border border-gray-200 p-5 rounded-2xl text-center shadow-[0_8px_20px_-4px_rgba(107,114,128,0.15),_inset_0_2px_0_rgba(255,255,255,1),_inset_0_-4px_0_rgba(107,114,128,0.05)] transform transition-transform hover:-translate-y-1">
                                          <div className="absolute -top-3 -right-3 w-11 h-11 bg-gradient-to-br from-gray-400 to-gray-600 rounded-xl flex items-center justify-center text-white shadow-[0_4px_8px_rgba(107,114,128,0.5),_inset_0_2px_0_rgba(255,255,255,0.4)] -rotate-3">
                                              <XCircle size={20}/>
                                          </div>
                                          <div className="text-gray-600 text-sm font-bold mb-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</div>
                                          <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-gray-500 to-gray-800 drop-shadow-sm">{statusCounts['Cancelled']}</div>
                                          <div className="text-xs text-gray-600 mt-2 font-medium bg-white/80 py-1.5 rounded-full border border-gray-200 inline-block px-4 shadow-sm">{((statusCounts['Cancelled'] / totalActions) * 100).toFixed(1)}%</div>
                                      </div>
                                  </div>
                              </div>
                          );
                      })()}
                  </Card>

                  {/* Action Plan Table Card */}
                  <Card id="print-action-plan-area">
                      <div className="p-4 border-b flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white">
                          <h3 className="font-bold flex items-center gap-3 text-gray-800 whitespace-nowrap">
                              <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white shadow-[0_2px_6px_rgba(234,88,12,0.4),_inset_0_1px_0_rgba(255,255,255,0.3)]">
                                  <CheckCircle size={16} />
                              </div>
                              ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Action Plan
                          </h3>
                          
                          {/* Filter Buttons */}
                          <div className={`flex bg-gray-100 p-1 rounded-lg w-full md:w-auto overflow-x-auto ${isExporting ? 'hidden' : ''}`}>
                              {[
                                  { id: 'All', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' },
                                  { id: 'Pending', label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
                                  { id: 'In Progress', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' },
                                  { id: 'Completed', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
                                  { id: 'Cancelled', label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' }
                              ].map(status => (
                                  <button
                                      key={status.id}
                                      onClick={() => setActionPlanFilter(status.id)}
                                      className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all whitespace-nowrap ${actionPlanFilter === status.id ? 'bg-white shadow text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
                                  >
                                      {status.label}
                                  </button>
                              ))}
                          </div>

                          <div className={`flex gap-2 shrink-0 ${isExporting ? 'hidden' : ''}`}>
                              <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(actionPlans.filter(a => a.projectId === selectedProject.id && (actionPlanFilter === 'All' || a.status === actionPlanFilter)), 'action_plans')}>{t('exportCSV')}</Button>
                              <Button variant="outline" size="sm" icon={isExporting ? Loader2 : PrinterIcon} onClick={() => handleExportPDF('print-action-plan-area', `Action_Plan_${selectedProject?.code || 'List'}.pdf`, 'landscape')} disabled={isExporting}>
                                  {isExporting ? t('downloading') : t('downloadPDF')}
                              </Button>
                              {hasPerm('proj_action', 'save') && <Button size="sm" icon={Plus} onClick={() => {
                                  setNewActionPlan({ id: null, issue: '', details: '', responsible: '', otherResponsible: '', startDate: new Date().toISOString().split('T')[0], deadline: '', status: 'Pending' });
                                  setShowAddActionPlanModal(true);
                              }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</Button>}
                          </div>
                      </div>
                      <div className={isExporting ? "pb-4" : "overflow-x-auto"}>
                          <table className="w-full text-sm text-left">
                              <thead className="bg-gray-50 text-gray-600">
                                  <tr>
                                      <th className="p-3 border-b text-center w-12">{t('col_seq')}</th>
                                      <th className="p-3 border-b">{t('col_issue')} / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                      <th className="p-3 border-b">{t('col_assignee')} (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)</th>
                                      <th className="p-3 border-b">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° - {t('col_deadline')}</th>
                                      <th className="p-3 border-b text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                      <th className={`p-3 border-b text-center w-16 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-100 bg-white">
                                  {actionPlans.filter(a => a.projectId === selectedProject.id && (actionPlanFilter === 'All' || a.status === actionPlanFilter)).length > 0 ? (
                                      actionPlans.filter(a => a.projectId === selectedProject.id && (actionPlanFilter === 'All' || a.status === actionPlanFilter)).map((ap, index) => (
                                          <tr key={ap.id} className="hover:bg-gray-50 transition-colors">
                                              <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                              <td className="p-3 cursor-pointer group" onClick={() => handleEditActionPlan(ap)}>
                                                  <div className="font-medium text-gray-800 group-hover:text-orange-600 flex items-center gap-1 transition-colors">
                                                      {ap.issue} <Edit size={14} className={`text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity ${isExporting ? 'hidden' : ''}`}/>
                                                  </div>
                                                  <div className="text-xs text-gray-500 mt-0.5 line-clamp-1 group-hover:text-gray-700">{ap.details || '-'}</div>
                                              </td>
                                              <td className="p-3 text-gray-700 flex items-center gap-2 mt-1">
                                                  <div className="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 shrink-0"><User size={12}/></div>
                                                  <span className="text-xs font-medium">{ap.responsible || '-'}</span>
                                              </td>
                                              <td className="p-3 text-gray-600 text-xs">
                                                  <div className="mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°: <span className="font-medium">{ap.startDate ? new Date(ap.startDate).toLocaleDateString('th-TH') : '-'}</span></div>
                                                  <div className={new Date(ap.deadline) < new Date() && !['Completed', 'Cancelled'].includes(ap.status) ? 'text-red-600 font-bold' : ''}>
                                                      ‡πÄ‡∏™‡∏£‡πá‡∏à: <span className="font-medium">{ap.deadline ? new Date(ap.deadline).toLocaleDateString('th-TH') : '-'}</span>
                                                  </div>
                                              </td>
                                              <td className="p-3 text-center">
                                                  {isExporting ? (
                                                      <span className={`px-2 py-1 rounded-md text-xs font-bold border inline-block w-36 text-center ${
                                                          ap.status === 'Completed' ? 'bg-green-50 border-green-200 text-green-700' : 
                                                          ap.status === 'In Progress' ? 'bg-blue-50 border-blue-200 text-blue-700' : 
                                                          ap.status === 'Cancelled' ? 'bg-gray-100 border-gray-300 text-gray-600' :
                                                          'bg-orange-50 border-orange-200 text-orange-700'
                                                      }`}>
                                                          {ap.status === 'Completed' ? '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à' : ap.status === 'In Progress' ? '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : ap.status === 'Cancelled' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
                                                      </span>
                                                  ) : (
                                                      <select 
                                                          value={ap.status}
                                                          onChange={(e) => handleActionPlanStatusChange(ap.id, e.target.value)}
                                                          className={`px-2 py-1 rounded-md text-xs font-bold border outline-none cursor-pointer hover:shadow-sm transition-all w-36 ${
                                                              ap.status === 'Completed' ? 'bg-green-50 border-green-200 text-green-700' : 
                                                              ap.status === 'In Progress' ? 'bg-blue-50 border-blue-200 text-blue-700' : 
                                                              ap.status === 'Cancelled' ? 'bg-gray-100 border-gray-300 text-gray-600' :
                                                              'bg-orange-50 border-orange-200 text-orange-700'
                                                          }`}
                                                      >
                                                          <option value="Pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                                          <option value="In Progress">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                                          <option value="Completed">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à</option>
                                                          <option value="Cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                                      </select>
                                                  )}
                                              </td>
                                              <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                                  {hasPerm('proj_action', 'delete') && (
                                                      <button 
                                                          onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Action Plan ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setActionPlans(actionPlans.filter(a => a.id !== ap.id))); }}
                                                          className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                          title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                                                      >
                                                          <Trash2 size={16} />
                                                      </button>
                                                  )}
                                              </td>
                                          </tr>
                                      ))
                                  ) : (
                                      <tr><td colSpan="6" className="p-8 text-center text-gray-400 border-2 border-dashed border-gray-200 m-4 rounded-lg bg-gray-50">{t('noData')}</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </Card>
              </div>
          )}

          {projectTab === 'daily' && (
             <div className="space-y-4">
                <div className="flex justify-between items-center">
                    <h3 className="font-bold text-lg">{t('dailyReports')}</h3>
                    {hasPerm('proj_daily', 'save') && <Button icon={Plus} onClick={() => {
                        setNewDailyReport({
                            id: null,
                            date: new Date().toISOString().split('T')[0],
                            manpower: { juristic: 0, security: 0, cleaning: 0, gardening: 0, sweeper: 0, other: 0, otherLabel: '' },
                            performance: { 
                                juristic: { details: '', images: [] }, security: { details: '', images: [] }, cleaning: { details: '', images: [] },
                                gardening: { details: '', images: [] }, sweeper: { details: '', images: [] }, other: { details: '', images: [] }
                            },
                            income: { commonFee: 0, lateFee: 0, water: 0, parking: 0, violation: 0, other: 0, otherLabel: '' },
                            note: '', reporter: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : ''
                        });
                        setShowAddDailyReportModal(true);
                    }}>{t('createDailyReport')}</Button>}
                </div>
                {/* List of reports */}
                <div className="grid grid-cols-1 gap-4">
                   {dailyReports.filter(r => r.projectId === selectedProject.id).length === 0 ? (
                       <div className="text-center p-8 text-gray-500 bg-white rounded border border-dashed">{t('noData')}</div>
                   ) : (
                       dailyReports.filter(r => r.projectId === selectedProject.id).map(report => (
                           <Card key={report.id} className="p-4 hover:shadow-md cursor-pointer relative group">
                               <div className="flex justify-between" onClick={() => setSelectedDailyReport(report)}>
                                   <span className="font-bold">{report.date}</span>
                                   <span className="text-sm text-gray-500 pr-8">{report.reporter}</span>
                               </div>
                               <div className="text-sm mt-2 text-gray-600 line-clamp-2" onClick={() => setSelectedDailyReport(report)}>{report.note || 'No additional notes'}</div>
                               
                               {!isExporting && hasPerm('proj_daily', 'delete') && (
                                   <button 
                                       onClick={(e) => { e.stopPropagation(); showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${report.date} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setDailyReports(dailyReports.filter(r => r.id !== report.id))); }}
                                       className="absolute top-3 right-3 text-gray-300 hover:text-red-500 p-1.5 rounded hover:bg-red-50 transition-all opacity-0 group-hover:opacity-100"
                                       title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
                                   >
                                       <Trash2 size={16} />
                                   </button>
                               )}
                           </Card>
                       ))
                   )}
                </div>
            </div>
          )}

          {projectTab === 'audit' && (
              <Card id="print-project-audit" className={isExporting ? 'w-[190mm] min-w-[190mm] max-w-[190mm] mx-auto box-border border-none shadow-none' : ''}>
                  <div className={`p-4 border-b flex justify-between items-center bg-white ${isExporting ? 'hidden' : ''}`}>
                      <h3 className="font-bold flex items-center gap-2 text-gray-800">
                          <ClipboardCheck size={20} className="text-blue-600" /> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Audit Records)
                      </h3>
                      <div className="flex gap-2">
                          <Button variant="outline" size="sm" icon={Download} onClick={() => exportToCSV(audits.filter(a => a.projectId === selectedProject.id), 'audit_records')}>{t('exportCSV')}</Button>
                          <Button variant="outline" size="sm" icon={isExporting ? Loader2 : PrinterIcon} onClick={() => {
                              const container = document.getElementById('print-project-audit');
                              if (container) container.scrollTop = 0;
                              handleExportPDF('print-project-audit', `Audit_Records_${selectedProject.code}.pdf`, 'portrait', [22, 10, 20, 10]);
                          }} disabled={isExporting}>
                              {isExporting ? t('downloading') : t('downloadPDF')}
                          </Button>
                          {hasPerm('proj_audit', 'save') && <Button size="sm" icon={Plus} onClick={() => {
                              setNewAudit(prev => ({...prev, projectId: selectedProject.id, inspector: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : ''}));
                              setShowAddAuditModal(true);
                          }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</Button>}
                      </div>
                  </div>
                  
                  {isExporting && (
                      <div className="text-center mb-6 pt-4">
                          <h2 className="text-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Audit Records)</h2>
                          <p className="text-gray-500 mt-1">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {selectedProject.name}</p>
                      </div>
                  )}

                  <div className={isExporting ? "w-full pb-4" : "overflow-x-auto"}>
                      <table className="w-full text-sm text-left table-fixed break-words">
                          <thead className="bg-gray-50 text-gray-600">
                              <tr>
                                  <th className="p-3 border-b text-center w-[10%]">{t('col_seq')}</th>
                                  <th className="p-3 border-b w-[20%]">{t('col_date')}</th>
                                  <th className="p-3 border-b w-[20%]">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)</th>
                                  <th className="p-3 border-b text-center w-[15%]">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                  <th className="p-3 border-b w-[20%]">{t('col_inspector')}</th>
                                  <th className="p-3 border-b w-[15%]">{t('col_remarks')}</th>
                                  <th className={`p-3 border-b text-center w-[10%] ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                              </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-100 bg-white">
                              {audits.filter(a => a.projectId === selectedProject.id).length > 0 ? (
                                  audits.filter(a => a.projectId === selectedProject.id).map((audit, index) => (
                                      <tr key={audit.id} className="hover:bg-gray-50 transition-colors">
                                          <td className="p-3 text-center text-gray-500">{index + 1}</td>
                                          <td className="p-3 font-medium text-blue-600 cursor-pointer hover:underline hover:text-blue-800 flex items-center gap-1 group" onClick={() => setSelectedAuditReport(audit)}>
                                              {audit.date} <Search size={14} className={`text-gray-400 group-hover:text-blue-500 transition-colors ${isExporting ? 'hidden' : ''}`}/>
                                          </td>
                                          <td className="p-3 text-gray-600 break-words whitespace-normal">{audit.category}</td>
                                          <td className="p-3 text-center">
                                              <span className={`font-bold px-2 py-1 rounded-md text-xs ${audit.score >= 90 ? 'bg-green-50 text-green-700 border border-green-200' : audit.score >= 70 ? 'bg-yellow-50 text-yellow-700 border border-yellow-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                                  {audit.rawScore ? `${audit.rawScore}/235` : `${audit.score}%`}
                                              </span>
                                          </td>
                                          <td className="p-3 text-gray-700 flex items-center gap-1 mt-1 break-words whitespace-normal"><User size={14} className={`text-gray-400 shrink-0 ${isExporting ? 'hidden' : ''}`}/> {audit.inspector}</td>
                                          <td className="p-3 text-gray-500 text-xs break-words whitespace-normal">{audit.remarks || '-'}</td>
                                          <td className={`p-3 text-center ${isExporting ? 'hidden' : ''}`}>
                                              {hasPerm('proj_audit', 'delete') && (
                                                  <button 
                                                      onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => setAudits(audits.filter(a => a.id !== audit.id)))}
                                                      className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                      title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
                                                  >
                                                      <Trash2 size={16} />
                                                  </button>
                                              )}
                                          </td>
                                      </tr>
                                  ))
                              ) : (
                                  <tr><td colSpan="7" className="p-8 text-center text-gray-400 border-2 border-dashed border-gray-200 m-4 rounded-lg bg-gray-50">{t('noData')}</td></tr>
                              )}
                          </tbody>
                      </table>
                  </div>
              </Card>
          )}

          {/* New Standard Forms Tab */}
          {projectTab === 'forms' && (
              <div className="space-y-6 animate-fade-in">
                  <Card>
                      <div className="p-4 border-b flex justify-between items-center bg-white">
                          <div className="flex flex-col">
                              <h3 className="font-bold flex items-center gap-2 text-gray-800">
                                  <Folder size={20} className="text-orange-500" /> {t('tab_forms')}
                              </h3>
                              <div className="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                  <FileText size={14}/> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
                              </div>
                          </div>
                          <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                              {hasPerm('proj_forms', 'save') && (
                                  <Button size="sm" icon={Plus} onClick={() => {
                                      setNewFormItem({ id: null, category: '‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)', name: '', format: 'PDF', size: '100 KB', description: '' });
                                      setShowAddFormModal(true);
                                  }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</Button>
                              )}
                          </div>
                      </div>
                      <div className="p-6">
                          {Array.from(new Set(formsList.map(f => f.category))).map(category => (
                              <div key={category} className="mb-8 last:mb-0">
                                  <h4 className="font-bold text-gray-700 border-b-2 border-gray-200 pb-2 mb-4 flex items-center gap-2">
                                      <Folder size={18} className="text-blue-600" /> {category}
                                  </h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                      {formsList.filter(f => f.category === category).map(form => (
                                          <div 
                                              key={form.id} 
                                              className="border border-gray-200 rounded-xl p-4 flex flex-col hover:shadow-md hover:border-orange-300 transition-all bg-white group cursor-pointer relative"
                                              onClick={() => setSelectedFormDetails(form)}
                                          >
                                              {/* Actions Overlay */}
                                              <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10" onClick={(e) => e.stopPropagation()}>
                                                  {hasPerm('proj_forms', 'edit') && (
                                                      <button className="bg-white p-1.5 rounded-md shadow-sm border border-gray-200 text-gray-400 hover:text-blue-600 hover:border-blue-300 transition-colors" onClick={() => handleEditFormItem(form)} title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°">
                                                          <Edit size={14} />
                                                      </button>
                                                  )}
                                                  {hasPerm('proj_forms', 'delete') && (
                                                      <button className="bg-white p-1.5 rounded-md shadow-sm border border-gray-200 text-gray-400 hover:text-red-600 hover:border-red-300 transition-colors" onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° "${form.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setFormsList(formsList.filter(f => f.id !== form.id)))} title="‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°">
                                                          <Trash2 size={14} />
                                                      </button>
                                                  )}
                                              </div>

                                              <div className="flex items-start gap-3 mb-4 pr-10">
                                                  <div className={`p-2.5 rounded-lg shrink-0 ${form.format === 'PDF' ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-600 border border-green-100'}`}>
                                                      <FileText size={24} />
                                                  </div>
                                                  <div className="flex-1 min-w-0">
                                                      <h5 className="font-bold text-gray-800 text-sm leading-tight group-hover:text-orange-600 transition-colors line-clamp-2" title={form.name}>{form.name}</h5>
                                                      <p className="text-[11px] text-gray-500 mt-1.5 line-clamp-2 leading-relaxed" title={form.description}>{form.description || '-'}</p>
                                                      <div className="flex items-center gap-2 mt-2">
                                                          <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${form.format === 'PDF' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{form.format}</span>
                                                          <span className="text-[10px] text-gray-500">{form.size}</span>
                                                      </div>
                                                  </div>
                                              </div>
                                              <Button 
                                                  variant="outline" 
                                                  size="sm" 
                                                  className="w-full mt-auto flex items-center justify-center gap-2 bg-gray-50 hover:bg-orange-50 hover:text-orange-700 hover:border-orange-300" 
                                                  onClick={(e) => {
                                                      e.stopPropagation();
                                                      setSelectedFormDetails(form);
                                                  }}
                                              >
                                                  <File size={16} /> ‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° / ‡∏û‡∏¥‡∏°‡∏û‡πå
                                              </Button>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          ))}
                      </div>
                  </Card>
              </div>
          )}

          {/* New Contractors/Suppliers Tab */}
          {projectTab === 'contractors' && ContractorVendorList()}

          {/* NEW: Others Tab */}
          {projectTab === 'others' && (
              <div className="space-y-6 animate-fade-in">
                  <Card>
                      <div className="p-4 border-b flex justify-between items-center bg-white">
                          <div>
                              <h3 className="font-bold flex items-center gap-2 text-gray-800">
                                  <Layers size={20} className="text-orange-500" /> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other Information)
                              </h3>
                              <p className="text-sm text-gray-500 mt-1">‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏•‡∏¥‡∏á‡∏Å‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</p>
                          </div>
                          <div className={`flex gap-2 ${isExporting ? 'hidden' : ''}`}>
                              {hasPerm('proj_others', 'save') && (
                                  <Button size="sm" icon={Plus} onClick={() => {
                                      setNewOther({ id: null, title: '', details: '', link: '' });
                                      setShowAddOtherModal(true);
                                  }}>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                              )}
                          </div>
                      </div>

                      <div className="overflow-x-auto">
                          <table className="w-full text-sm text-left">
                              <thead className="bg-gray-50 text-gray-600 uppercase">
                                  <tr>
                                      <th className="p-4 text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                      <th className="p-4 w-1/4">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                      <th className="p-4 w-1/3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                      <th className="p-4 w-1/4">‡πÅ‡∏ô‡∏ö Link</th>
                                      <th className={`p-4 text-center w-24 ${isExporting ? 'hidden' : ''}`}>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-gray-100 bg-white">
                                  {othersData.filter(o => o.projectId === selectedProject.id).length > 0 ? (
                                      othersData.filter(o => o.projectId === selectedProject.id).map((item, index) => (
                                          <tr key={item.id} className="hover:bg-gray-50 transition-colors">
                                              <td className="p-4 text-center text-gray-500 font-medium">{index + 1}</td>
                                              <td className="p-4 font-bold text-gray-800">{item.title}</td>
                                              <td className="p-4 text-gray-600 whitespace-pre-wrap">{item.details || '-'}</td>
                                              <td className="p-4">
                                                  {item.link ? (
                                                      <a href={item.link.startsWith('http') ? item.link : `https://${item.link}`} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1 text-xs font-medium bg-blue-50 px-2 py-1 rounded-md w-fit truncate max-w-[200px]" title={item.link}>
                                                          <LinkIcon size={14} className="shrink-0" /> <span className="truncate">{item.link}</span>
                                                      </a>
                                                  ) : (
                                                      <span className="text-gray-400">-</span>
                                                  )}
                                              </td>
                                              <td className={`p-4 text-center ${isExporting ? 'hidden' : ''}`}>
                                                  <div className="flex items-center justify-center gap-1">
                                                      {hasPerm('proj_others', 'edit') && (
                                                          <button 
                                                              onClick={() => { setNewOther(item); setShowAddOtherModal(true); }}
                                                              className="text-gray-400 hover:text-blue-600 p-1.5 rounded-md hover:bg-blue-50 transition-colors"
                                                              title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                          >
                                                              <Edit size={16} />
                                                          </button>
                                                      )}
                                                      {hasPerm('proj_others', 'delete') && (
                                                          <button 
                                                              onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${item.title}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => setOthersData(othersData.filter(o => o.id !== item.id)))}
                                                              className="text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-red-50 transition-colors"
                                                              title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                                          >
                                                              <Trash2 size={16} />
                                                          </button>
                                                      )}
                                                  </div>
                                              </td>
                                          </tr>
                                      ))
                                  ) : (
                                      <tr>
                                          <td colSpan="5" className="p-10 text-center text-gray-400 bg-gray-50 border-b border-dashed">
                                              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                                          </td>
                                      </tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </Card>
              </div>
          )}

        </div>
      </div>
    );
  };

  const SettingsView = () => {
      if (currentUser?.username !== 'admin') {
          return (
              <div className="flex flex-col items-center justify-center h-96 text-gray-400 animate-fade-in">
                  <Lock size={48} className="mb-4 opacity-50"/>
                  <h2 className="text-xl font-bold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h2>
                  <p>‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏á‡∏ß‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
              </div>
          );
      }

      return (
          <div className="space-y-6 animate-fade-in">
              <ReportHeader />
              <header className="flex justify-between items-center mb-6">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (System Settings)</h1>
                      <p className="text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                  </div>
              </header>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Backup Card */}
                  <Card className="p-6 border-t-4 border-blue-500">
                      <div className="flex items-center gap-3 mb-4">
                          <div className="p-3 bg-blue-100 text-blue-600 rounded-lg">
                              <Save size={24} />
                          </div>
                          <div>
                              <h3 className="text-lg font-bold text-gray-800">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Export Backup)</h3>
                              <p className="text-sm text-gray-500">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON</p>
                          </div>
                      </div>
                      <p className="text-sm text-gray-600 mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                          ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô, ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö 
                      </p>
                      <p className="text-xs text-orange-600 mb-6 font-medium">
                          *‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏ü‡∏•‡πå Backup ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
                      </p>
                      <Button 
                          className="w-full flex justify-center items-center gap-2 bg-blue-600 hover:bg-blue-700" 
                          onClick={handleExportBackup}
                          disabled={isBackingUp}
                      >
                          {isBackingUp ? <Loader2 size={18} className="animate-spin" /> : <Download size={18} />} 
                          {isBackingUp ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)'}
                      </Button>
                  </Card>

                  {/* Restore Card */}
                  <Card className="p-6 border-t-4 border-red-500">
                      <div className="flex items-center gap-3 mb-4">
                          <div className="p-3 bg-red-100 text-red-600 rounded-lg">
                              <Upload size={24} />
                          </div>
                          <div>
                              <h3 className="text-lg font-bold text-gray-800">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Import / Restore)</h3>
                              <p className="text-sm text-gray-500">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Backup</p>
                          </div>
                      </div>
                      <div className="text-sm text-red-700 font-medium mb-6 bg-red-50 p-4 rounded-lg border border-red-200 flex items-start gap-2">
                          <AlertTriangle size={20} className="shrink-0 mt-0.5 text-red-600" />
                          <div>
                              <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á:</strong><br/>
                              ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ <span className="underline">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö (Overwrite)</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                          </div>
                      </div>
                      <label className={`cursor-pointer w-full inline-block ${isRestoring ? 'opacity-50 pointer-events-none' : ''}`}>
                          <div className="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 px-4 rounded-md transition-colors flex justify-center items-center gap-2 shadow-sm">
                              {isRestoring ? <Loader2 size={18} className="animate-spin" /> : <Upload size={18} />} 
                              {isRestoring ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Import JSON)'}
                          </div>
                          <input 
                              type="file" 
                              accept=".json" 
                              className="hidden" 
                              onChange={handleImportBackup} 
                              onClick={(e) => { e.target.value = null; }} // Allow selecting the same file again
                              disabled={isRestoring}
                          />
                      </label>
                  </Card>

                  {/* Google Sheets Sync Card */}
                  <Card className="p-6 border-t-4 border-green-500 md:col-span-2">
                      <div className="flex items-center gap-3 mb-4">
                          <div className="p-3 bg-green-100 text-green-600 rounded-lg shadow-sm">
                              <Globe size={24} />
                          </div>
                          <div>
                              <h3 className="text-lg font-bold text-gray-800">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Sheets</h3>
                              <p className="text-sm text-gray-500">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á Spreadsheet</p>
                          </div>
                      </div>
                      <p className="text-sm text-gray-600 mb-6 bg-green-50 p-4 rounded-lg border border-green-100 leading-relaxed">
                          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡πÑ‡∏ü) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ID: <br/><span className="font-mono font-bold text-green-700 bg-white px-2 py-1 rounded inline-block mt-2 shadow-sm break-all">1J5rup8PlSmKStjO8G13EvGfau1yFCF5kSWFLFHfHklU</span><br/>‡πÇ‡∏î‡∏¢‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Sheet ‡∏¢‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                      </p>
                      
                      <Button 
                          className="w-full md:w-auto flex justify-center items-center gap-2 bg-green-600 hover:bg-green-700 shadow-md text-base py-3 px-6" 
                          onClick={handleSyncToGoogleSheets}
                          disabled={isSyncingSheets}
                      >
                          {isSyncingSheets ? <Loader2 size={18} className="animate-spin" /> : <Upload size={18} />} 
                          {isSyncingSheets ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà Google Sheets'}
                      </Button>
                  </Card>

                  {/* Google Drive Backup Card */}
                  <Card className="p-6 border-t-4 border-indigo-500 md:col-span-2">
                      <div className="flex items-center gap-3 mb-4">
                          <div className="p-3 bg-indigo-100 text-indigo-600 rounded-lg shadow-sm">
                              <Cloud size={24} />
                          </div>
                          <div>
                              <h3 className="text-lg font-bold text-gray-800">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Drive</h3>
                              <p className="text-sm text-gray-500">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                          </div>
                      </div>
                      <p className="text-sm text-gray-600 mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-100 leading-relaxed">
                          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (PDF), ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏±‡∏á Google Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà 
                          (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)
                      </p>
                      
                      <Button 
                          className="w-full md:w-auto flex justify-center items-center gap-2 bg-indigo-600 hover:bg-indigo-700 shadow-md text-base py-3 px-6" 
                          onClick={handleBackupToDrive}
                          disabled={isBackingUpToDrive}
                      >
                          {isBackingUpToDrive ? <Loader2 size={18} className="animate-spin" /> : <Cloud size={18} />} 
                          {isBackingUpToDrive ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà Drive ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Drive'}
                      </Button>
                  </Card>
              </div>
          </div>
      );
  };

  // --- NEW: Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Manual View) ---
  const ManualView = () => {
      const manualTopics = [
          { id: 'intro', icon: Info, title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Introduction)' },
          { id: 'dashboard', icon: BarChart3, title: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (Dashboard)' },
          { id: 'users', icon: Users, title: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Users)' },
          { id: 'projects', icon: Building2, title: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Projects)' },
          { id: 'staff_schedule', icon: Calendar, title: '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Staff & Schedule)' },
          { id: 'contracts_vendors', icon: Briefcase, title: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå (Contracts)' },
          { id: 'daily', icon: FileText, title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Daily Report)' },
          { id: 'utilities', icon: Zap, title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥-‡πÑ‡∏ü (Utilities)' },
          { id: 'repair', icon: Hammer, title: '‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair)' },
          { id: 'pm', icon: Wrench, title: '‡∏á‡∏≤‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (PM)' },
          { id: 'assets_tools', icon: Shield, title: '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Assets/Tools)' },
          { id: 'action', icon: CheckCircle, title: '‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Action Plan)' },
          { id: 'audits', icon: ClipboardCheck, title: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (Audit)' },
          { id: 'forms', icon: Folder, title: '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Forms)' },
          { id: 'settings', icon: Settings, title: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Settings)' },
      ];

      const WebImage = ({ srcStr, alt }) => {
          const [hasError, setHasError] = useState(false);
          
          let finalSrc = srcStr;
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô Markdown Image ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          const mdMatch = typeof srcStr === 'string' && srcStr.match(/!\[.*?\]\((.*?)\)/);
          if (mdMatch) {
              finalSrc = mdMatch[1];
          }

          // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
          if (hasError || !finalSrc || finalSrc.startsWith('[Image of')) {
              return (
                  <div className="w-full my-6 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center p-10 text-gray-500 shadow-inner">
                      <ImageIcon size={48} className="mb-3 text-gray-400" />
                      <p className="font-medium text-sm text-gray-600">{alt}</p>
                      <p className="text-xs text-gray-400 mt-2">(‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ)</p>
                  </div>
              );
          }

          return (
              <div className="w-full my-6 flex justify-center">
                  <img 
                      src={finalSrc} 
                      alt={alt} 
                      className="rounded-xl shadow-md border border-gray-200 max-w-full h-auto max-h-[400px] object-contain bg-white" 
                      onError={() => setHasError(true)} 
                  />
              </div>
          );
      };

      const renderManualContent = () => {
          switch (activeManualTab) {
              case 'intro':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Best Million Group</h2>
                          <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Enterprise ERP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login Screen)" />
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ <strong>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</strong> (Employee ID) ‡πÄ‡∏õ‡πá‡∏ô Username</li>
                              <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏£‡∏∑‡∏≠ Admin ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                              <li>‡∏´‡∏≤‡∏Å‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</li>
                          </ul>
                          <h3 className="text-lg font-bold mt-6">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Navigation & Themes)</h3>
                          <p>‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö:</p>
                          <ul className="list-disc pl-6 space-y-2">
                              <li><strong>‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏° (Theme Toggle):</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ 3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Light Mode, Dark Mode, Sweet Mode)</li>
                              <li><strong>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤:</strong> ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (TH) ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (EN)</li>
                              <li><strong>‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢:</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô</li>
                          </ul>
                          <div className="bg-orange-50 p-4 rounded-lg border border-orange-100 mt-6">
                              <h4 className="font-bold text-orange-800 flex items-center gap-2"><HelpCircle size={16}/> ‡∏ó‡∏£‡∏≤‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h4>
                              <p className="text-sm mt-1 text-orange-700">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏û‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ö‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏î‡πâ ‡∏ô‡∏±‡πà‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏±‡πâ‡∏ô</p>
                          </div>
                      </div>
                  );
              case 'dashboard':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (Corporate Dashboard)</h2>
                          <p>‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£" />
                          <h3 className="text-lg font-bold mt-6">‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á Dashboard</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li><strong>KPI Cards:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô Action Plan ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</li>
                              <li><strong>‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏∏‡∏î, ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô, ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</li>
                              <li><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô:</strong> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏î‡∏™‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á)</li>
                              <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Action Plan:</strong> ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</li>
                              <li><strong>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</li>
                          </ul>
                          <WebImage srcStr="" alt="‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ‡πÅ‡∏•‡∏∞ CSV ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î" />
                          <p><strong>‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° <code>Export PDF</code> ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                      </div>
                  );
              case 'users':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (User Management)</h2>
                          <p>‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏•‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (Add User)</h3>
                          <ol className="list-decimal pl-6 space-y-2">
                              <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° <strong>"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Add User)"</strong></li>
                              <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î Username/Password (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</li>
                              <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</strong> ‡πÅ‡∏•‡∏∞ <strong>‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</strong></li>
                              <li>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á <strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ (Accessible Depts)</strong>: ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å All) ‡∏´‡∏≤‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏¢‡∏π‡πà</li>
                              <li>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏î‡∏π, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç, ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, ‡∏•‡∏ö) ‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</li>
                              <li>‡∏Ñ‡∏•‡∏¥‡∏Å <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</strong></li>
                          </ol>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Role Permissions)" />
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Role Permissions)</h3>
                          <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á "‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£" ‡∏à‡∏∞‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏ô‡∏π "‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°" ‡πÅ‡∏•‡∏∞ "PM" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"</strong> ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏±‡πâ‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                          
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV (Import)</h3>
                          <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <code>username</code>, <code>firstName</code>, <code>lastName</code>, <code>employeeId</code>, <code>position</code>, <code>department</code> ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV"</strong></p>
                      </div>
                  );
              case 'projects':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Projects & Units)</h2>
                          <p>‡πÄ‡∏°‡∏ô‡∏π "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" ‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î (Grid) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (List)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Grid/List View)" />
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                          <p>‡∏Ñ‡∏•‡∏¥‡∏Å <strong>"‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"</strong> ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥), ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤, ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏≠‡∏ä.13, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Overview)" />
                          <h3 className="text-lg font-bold mt-6">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Overview Tab)</h3>
                          <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö <strong>"‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°"</strong> ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£ (Control Panel) ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ</p>
                          <ul className="list-disc pl-6 space-y-2">
                              <li><strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (Alerts):</strong> ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤/‡∏£‡∏õ‡∏†./‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 45 ‡∏ß‡∏±‡∏ô) ‡∏à‡∏∞‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î</li>
                              <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î-‡∏•‡∏≤-‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á, ‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡πÑ‡∏ü, ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡πÅ‡∏•‡∏∞ Action Plan</li>
                              <li><strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‡∏à‡∏∞‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ</li>
                          </ul>
                      </div>
                  );
              case 'staff_schedule':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Staff & Schedule)</h2>
                          
                          <h3 className="text-lg font-bold mt-4">‡πÅ‡∏ó‡πá‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ (Staff)</h3>
                          <p>‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (List) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö <strong>‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (Organization Chart)</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ &gt; ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô &gt; ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Organization Chart ‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£" />

                          <h3 className="text-lg font-bold mt-6">‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Schedule Tab)</h3>
                          <p>‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Work Schedule)" />
                          <ul className="list-disc pl-6 space-y-2">
                              <li><strong>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏≤‡∏Å‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Drag & Drop) ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô</li>
                              <li><strong>‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏Å‡∏∞ (Auto-fill):</strong> ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ <strong>"‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏Å‡∏∞ (Shift)"</strong> ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà M1 ‡∏´‡∏£‡∏∑‡∏≠ V) ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ô‡∏≥‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Å‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á</li>
                              <li><strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approval Workflow):</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î <strong>"‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ HR ‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>
                              <li><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô PDF:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° <strong>‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏¥‡∏ô‡∏ï‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î A4 ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥) ‡πÑ‡∏õ‡∏ï‡∏¥‡∏î‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                          </ul>
                      </div>
                  );
              case 'contracts_vendors':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå (Contracts & Vendors)</h2>
                          
                          <h3 className="text-lg font-bold mt-4">‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supplier (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</h3>
                          <p>‡πÄ‡∏°‡∏ô‡∏π "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Supplier" ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Vendor) ‡∏à‡∏≤‡∏Å <strong>"‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"</strong> ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏´‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏á‡∏≤‡∏ô‡∏•‡∏¥‡∏ü‡∏ï‡πå)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Supplier ‡πÅ‡∏•‡∏∞ Vendor" />

                          <h3 className="text-lg font-bold mt-6">‡πÅ‡∏ó‡πá‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á (Contracts - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)</h3>
                          <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö <strong>"‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á"</strong> ‡∏à‡∏∞‡∏û‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÇ‡∏î‡∏¢‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏£‡∏±‡∏ö (Income), ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πà‡∏≤‡∏¢ (Expense) ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ (Contractor)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏" />
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Days Remaining)</strong> ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</li>
                              <li>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏™‡πâ‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏µ‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤</li>
                              <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (PDF) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
                          </ul>
                      </div>
                  );
              case 'daily':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Daily Report)</h2>
                          <p>‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Committee) ‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" />
                          <h3 className="text-lg font-bold mt-6">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                          <ol className="list-decimal pl-6 space-y-2">
                              <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö <strong>"‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô"</strong> ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å <strong>"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"</strong></li>
                              <li><strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• (Manpower):</strong> ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å (‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•, ‡∏£‡∏õ‡∏†., ‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô, ‡∏Ñ‡∏ô‡∏™‡∏ß‡∏ô)</li>
                              <li><strong>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (Income):</strong> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á, ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                              <li><strong>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (Performance):</strong> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏° <strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</strong> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)</li>
                          </ol>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô" />
                          <h3 className="text-lg font-bold mt-4">‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                          <p>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4 ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏î <strong>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ</p>
                      </div>
                  );
              case 'utilities':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥-‡πÑ‡∏ü (Utilities)</h2>
                          <p>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</p>
                          
                          <h3 className="text-lg font-bold mt-4">1. ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Registry)</h3>
                          <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏ô‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤, ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏ö‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå) ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á <strong>‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initial Value)</strong></p>
                          
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå" />
                          <h3 className="text-lg font-bold mt-4">2. ‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Record)</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏î ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á</li>
                              <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á <strong>‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤ (Prev Value)</strong> ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏´‡∏±‡∏Å‡∏•‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (Usage)</strong> ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                              <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Enter) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</li>
                          </ul>

                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡πÑ‡∏ü" />
                          <h3 className="text-lg font-bold mt-4">3. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analysis)</h3>
                          <p>‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô (Line) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Filter)</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Combined) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ</p>
                      </div>
                  );
              case 'repair':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair Requests)</h2>
                          <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" />
                          <h3 className="text-lg font-bold mt-6">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
                          <ol className="list-decimal pl-6 space-y-2">
                              <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å <strong>"‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà"</strong></li>
                              <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á, ‡∏ä‡∏±‡πâ‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏î (‡∏õ‡∏£‡∏∞‡∏õ‡∏≤, ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡πÅ‡∏≠‡∏£‡πå ‡∏Ø‡∏•‡∏Ø)</li>
                              <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á <strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Ticket No.)</strong> ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô C-001-REP-001)</li>
                              <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà" ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà, ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤, ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏õ</li>
                          </ol>
                          <WebImage srcStr="" alt="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå (PDF)" />
                          <p className="mt-4"><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå (PDF) ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</p>
                      </div>
                  );
              case 'pm':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏á‡∏≤‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (Preventive Maintenance - PM)</h2>
                          <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏¥‡∏ü‡∏ï‡πå, ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥, ‡∏£‡∏∞‡∏ö‡∏ö Fire Alarm)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine Registry)" />
                          <h3 className="text-lg font-bold mt-6">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö PM (5 ‡πÅ‡∏ó‡πá‡∏ö)</h3>
                          <ul className="list-disc pl-6 space-y-4">
                              <li>
                                  <strong>1. ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Registry):</strong> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
                              </li>
                              <li>
                                  <strong>2. ‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô (Plan):</strong> ‡∏ô‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ ‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (Frequency) ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô, ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå, ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                              </li>
                              <li>
                                  <strong>3. ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (Calendar):</strong> <br/>
                                  <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô PM ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" />
                                  ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ Google Calendar) ‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ <strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                              </li>
                              <li>
                                  <strong>4. ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° PM (PM Form):</strong> <br/>
                                  <WebImage srcStr="" alt="‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checklist) ‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" />
                                  ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Checklist ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏∞‡∏ö‡∏ö" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏¥‡∏ü‡∏ï‡πå‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏•‡∏¥‡∏á/‡∏õ‡∏£‡∏∞‡∏ï‡∏π, ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô) ‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏õ‡∏Å‡∏ï‡∏¥/‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥/NA ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Evidence Photos) ‡πÑ‡∏î‡πâ
                              </li>
                              <li>
                                  <strong>5. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History):</strong> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ <strong>"‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"</strong> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PM ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
                              </li>
                          </ul>
                      </div>
                  );
              case 'assets_tools':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á (Assets & Tools)</h2>
                          <p>‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏ ‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏†‡∏≤‡∏û</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á" />
                          <h3 className="text-lg font-bold mt-6">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á <strong>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Assets)</strong> ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ã‡∏ü‡∏≤, ‡πÇ‡∏ï‡πä‡∏∞‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞ <strong>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á (Tools)</strong> ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ß‡πà‡∏≤‡∏ô, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°, ‡∏ö‡∏±‡∏ô‡πÑ‡∏î</li>
                              <li>‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å <strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-generate)</strong> ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠ A (Asset) ‡∏´‡∏£‡∏∑‡∏≠ T (Tool) ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</li>
                              <li>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ <strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û (Audit)</li>
                              <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏î‡πâ</li>
                          </ul>
                      </div>
                  );
              case 'action':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡πÅ‡∏ú‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ (Action Plan)</h2>
                          <p>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ß‡∏ô‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏ó‡∏±‡∏®‡∏ô‡πå, ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏™‡∏µ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà)</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Action Plan" />
                          <h3 className="text-lg font-bold mt-4">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Action Plan</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°-‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (Deadline)</li>
                              <li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤: <strong>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥, ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</strong></li>
                              <li>‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏°‡∏µ <strong>Dashboard ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° 3D</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏ó‡∏£‡∏≤‡∏ö‡∏ñ‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</li>
                              <li>‡∏´‡∏≤‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏î‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î Deadline (‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡πÅ‡∏î‡∏á</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</li>
                          </ul>
                      </div>
                  );
              case 'audits':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (Internal Audit)</h2>
                          <p>‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡∏° QC ‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Head Office) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Audit Checklist" />
                          <h3 className="text-lg font-bold mt-6">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Audit)</strong> ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î (‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏•‡∏≤‡∏á)</li>
                              <li>‡∏Ñ‡∏•‡∏¥‡∏Å <strong>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à (New Audit)"</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</li>
                              <li>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-5) ‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 10 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏Ø‡∏•‡∏Ø) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠</li>
                              <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° 235 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: <br/>
                                  <span className="text-green-600 font-bold">‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå (90-100%)</span>, 
                                  <span className="text-yellow-600 font-bold"> ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (70-89%)</span>, 
                                  <span className="text-red-600 font-bold"> ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 70%)</span>
                              </li>
                          </ul>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Leaderboard ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit" />
                          <p className="mt-4"><strong>Leaderboard:</strong> ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"</strong> ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Leaderboard) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ</p>
                      </div>
                  );
              case 'forms':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Standard Forms)</h2>
                          <p>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Template) ‡∏Ç‡∏≠‡∏á‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" />
                          <h3 className="text-lg font-bold mt-4">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</h3>
                          <ul className="list-disc pl-6 space-y-2">
                              <li>Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô, ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå (PDF, Excel)</li>
                              <li><strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°:</strong> <br/>‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Document Builder ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏•‡∏¥‡∏Å <strong>"‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°/‡∏û‡∏¥‡∏°‡∏û‡πå"</strong> ‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏≤‡∏á‡∏ä‡∏ô‡∏¥‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á, ‡πÉ‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ) ‡∏à‡∏∞‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>
                              <li>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° <strong>"‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°"</strong> ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á <strong>‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</strong> ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°, ‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å, ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° MS Word</li>
                              <li>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏û‡∏¥‡∏°‡∏û‡πå / PDF"</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                          </ul>
                      </div>
                  );
              case 'settings':
                  return (
                      <div className="space-y-4 text-gray-700 leading-relaxed">
                          <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (System Settings)</h2>
                          <p className="text-red-600 font-bold mb-4">* ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                          <p>‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô Local Browser (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) <strong>‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup) ‡∏à‡∏∂‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ Cache ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</p>
                          <WebImage srcStr="" alt="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞ Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" />
                          <h3 className="text-lg font-bold mt-6">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                          <ol className="list-decimal pl-6 space-y-2">
                              <li><strong>Export Backup (.json):</strong> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ PDF ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏ß‡πâ) ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</li>
                              <li><strong>Google Sheets Sync:</strong> (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏ô Google Sheets ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á</li>
                              <li><strong>Google Drive Backup:</strong> (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏¢‡∏≠‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤ PDF ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Google Drive ‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</li>
                          </ol>
                          <div className="bg-red-50 p-4 rounded-lg border border-red-200 mt-6">
                              <h4 className="font-bold text-red-800 flex items-center gap-2"><AlertTriangle size={16}/> ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</h4>
                              <p className="text-sm mt-1 text-red-700">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Import ‡πÑ‡∏ü‡∏•‡πå Backup (.json) ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ <strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö (Overwrite) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</strong> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                          </div>
                      </div>
                  );
              default:
                  return null;
          }
      };

      return (
          <div className="space-y-6 animate-fade-in h-full flex flex-col">
              <ReportHeader />
              <header className="flex justify-between items-center mb-2 shrink-0">
                  <div>
                      <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><BookOpen className="text-blue-600" size={28}/> ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (User Manual)</h1>
                      <p className="text-gray-500">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                  </div>
              </header>

              <div className="flex flex-col md:flex-row gap-6 flex-1 min-h-0">
                  {/* Left Sidebar Menu for Manual */}
                  <div className="w-full md:w-64 bg-white rounded-xl border border-gray-200 shadow-sm p-4 shrink-0 h-fit md:sticky top-24">
                      <h3 className="font-bold text-gray-800 mb-4 px-2 uppercase tracking-wide text-sm">‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç (Table of Contents)</h3>
                      <div className="flex flex-col space-y-1">
                          {manualTopics.map(topic => (
                              <button
                                  key={topic.id}
                                  onClick={() => setActiveManualTab(topic.id)}
                                  className={`flex items-center gap-3 px-4 py-3 rounded-lg text-sm transition-all text-left ${activeManualTab === topic.id ? 'bg-blue-50 text-blue-700 font-bold border-l-4 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-blue-600'}`}
                              >
                                  <topic.icon size={18} className={activeManualTab === topic.id ? 'text-blue-600' : 'text-gray-400'} />
                                  {topic.title}
                              </button>
                          ))}
                      </div>
                  </div>

                  {/* Main Content Area */}
                  <div className="flex-1 bg-white rounded-xl border border-gray-200 shadow-sm p-6 md:p-10 overflow-y-auto">
                      {renderManualContent()}
                  </div>
              </div>
          </div>
      );
  };

  if (!currentUser) return renderLoginView();

  return (
    <div className={`flex min-h-screen font-sans transition-colors duration-300 w-full overflow-x-hidden ${!isExporting ? (theme === 'dark' ? 'dark-theme' : theme === 'sweet' ? 'sweet-theme' : theme === 'crimson' ? 'crimson-theme' : theme === 'sunset' ? 'sunset-theme' : 'bg-gray-100 text-gray-900') : 'bg-gray-100 text-gray-900'}`}>
      {/* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á ‡∏Ç‡∏≠‡∏á input type="number" ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Dark Mode Styles */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Caveat:wght@700&display=swap');
        
        body, .font-sans, p, span, div, h1, h2, h3, h4, h5, h6, input, textarea, select, button, table {
          font-family: 'Noto Sans Thai', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type="number"] {
          -moz-appearance: textfield;
        }
        
        /* Dark Theme Global Overrides */
        .dark-theme { background-color: #111827 !important; color: #f3f4f6 !important; }
        .dark-theme .bg-white { background-color: #1f2937 !important; }
        .dark-theme .bg-gray-50 { background-color: #111827 !important; }
        .dark-theme .bg-gray-100 { background-color: #374151 !important; }
        .dark-theme .bg-gray-200 { background-color: #4b5563 !important; }
        .dark-theme .text-gray-900 { color: #f9fafb !important; }
        .dark-theme .text-gray-800 { color: #f3f4f6 !important; }
        .dark-theme .text-gray-700 { color: #e5e7eb !important; }
        .dark-theme .text-gray-600 { color: #d1d5db !important; }
        .dark-theme .text-gray-500 { color: #9ca3af !important; }
        .dark-theme .text-gray-400 { color: #6b7280 !important; }
        .dark-theme .border-gray-100 { border-color: #1f2937 !important; }
        .dark-theme .border-gray-200 { border-color: #374151 !important; }
        .dark-theme .border-gray-300 { border-color: #4b5563 !important; }
        .dark-theme .border-gray-400 { border-color: #6b7280 !important; }
        .dark-theme .divide-gray-100 > :not([hidden]) ~ :not([hidden]) { border-color: #1f2937 !important; }
        .dark-theme .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #374151 !important; }
        
        /* Inputs & Forms */
        .dark-theme input:not([type="radio"]):not([type="checkbox"]), .dark-theme select, .dark-theme textarea {
            background-color: #1f2937 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563 !important;
        }
        .dark-theme input:not([type="radio"]):not([type="checkbox"]):focus, .dark-theme select:focus, .dark-theme textarea:focus {
            background-color: #374151 !important;
        }
        .dark-theme input::placeholder, .dark-theme textarea::placeholder { color: #9ca3af !important; }
        
        /* Badges & Accents */
        .dark-theme .bg-green-50, .dark-theme .bg-green-100 { background-color: rgba(5, 150, 105, 0.15) !important; border-color: rgba(5, 150, 105, 0.3) !important; color: #6ee7b7 !important; }
        .dark-theme .text-green-500, .dark-theme .text-green-600, .dark-theme .text-green-700, .dark-theme .text-green-800 { color: #6ee7b7 !important; }
        .dark-theme .border-green-100, .dark-theme .border-green-200, .dark-theme .border-green-300 { border-color: rgba(5, 150, 105, 0.4) !important; }
        
        .dark-theme .bg-red-50, .dark-theme .bg-red-100 { background-color: rgba(220, 38, 38, 0.15) !important; border-color: rgba(220, 38, 38, 0.3) !important; color: #fca5a5 !important; }
        .dark-theme .text-red-500, .dark-theme .text-red-600, .dark-theme .text-red-700, .dark-theme .text-red-800 { color: #fca5a5 !important; }
        .dark-theme .border-red-100, .dark-theme .border-red-200, .dark-theme .border-red-300 { border-color: rgba(220, 38, 38, 0.4) !important; }
        
        .dark-theme .bg-orange-50, .dark-theme .bg-orange-100 { background-color: rgba(234, 88, 12, 0.15) !important; border-color: rgba(234, 88, 12, 0.3) !important; color: #fdba74 !important; }
        .dark-theme .text-orange-500, .dark-theme .text-orange-600, .dark-theme .text-orange-700, .dark-theme .text-orange-800 { color: #fdba74 !important; }
        .dark-theme .border-orange-100, .dark-theme .border-orange-200, .dark-theme .border-orange-300 { border-color: rgba(234, 88, 12, 0.4) !important; }
        
        .dark-theme .bg-blue-50, .dark-theme .bg-blue-100 { background-color: rgba(37, 99, 235, 0.15) !important; border-color: rgba(37, 99, 235, 0.3) !important; color: #93c5fd !important; }
        .dark-theme .text-blue-500, .dark-theme .text-blue-600, .dark-theme .text-blue-700, .dark-theme .text-blue-800 { color: #93c5fd !important; }
        .dark-theme .border-blue-100, .dark-theme .border-blue-200, .dark-theme .border-blue-300 { border-color: rgba(37, 99, 235, 0.4) !important; }
        
        .dark-theme .bg-yellow-50, .dark-theme .bg-yellow-100 { background-color: rgba(202, 138, 4, 0.15) !important; border-color: rgba(202, 138, 4, 0.3) !important; color: #fde047 !important; }
        .dark-theme .text-yellow-500, .dark-theme .text-yellow-600, .dark-theme .text-yellow-700, .dark-theme .text-yellow-800 { color: #fde047 !important; }
        .dark-theme .border-yellow-100, .dark-theme .border-yellow-200, .dark-theme .border-yellow-300 { border-color: rgba(202, 138, 4, 0.4) !important; }
        
        .dark-theme .bg-purple-50, .dark-theme .bg-purple-100 { background-color: rgba(124, 58, 237, 0.15) !important; border-color: rgba(124, 58, 237, 0.3) !important; color: #c4b5fd !important; }
        .dark-theme .text-purple-500, .dark-theme .text-purple-600, .dark-theme .text-purple-700, .dark-theme .text-purple-800 { color: #c4b5fd !important; }
        .dark-theme .border-purple-100, .dark-theme .border-purple-200, .dark-theme .border-purple-300 { border-color: rgba(124, 58, 237, 0.4) !important; }

        .dark-theme .bg-cyan-50, .dark-theme .bg-cyan-100 { background-color: rgba(6, 182, 212, 0.15) !important; border-color: rgba(6, 182, 212, 0.3) !important; color: #67e8f9 !important; }
        .dark-theme .text-cyan-500, .dark-theme .text-cyan-600, .dark-theme .text-cyan-700, .dark-theme .text-cyan-800 { color: #67e8f9 !important; }

        /* Modals & Shadows */
        .dark-theme .bg-white.rounded-lg.shadow-xl { background-color: #1f2937 !important; border: 1px solid #374151; }
        .dark-theme .shadow-sm, .dark-theme .shadow, .dark-theme .shadow-md, .dark-theme .shadow-lg, .dark-theme .shadow-xl {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
        }
        
        /* Tables */
        .dark-theme table th { color: #9ca3af !important; background-color: #111827 !important; border-color: #374151 !important; }
        .dark-theme table td { border-color: #374151 !important; }
        .dark-theme tr:hover td { background-color: #374151 !important; }

        /* Recharts */
        .dark-theme .recharts-cartesian-axis-tick-value { fill: #9ca3af !important; }
        .dark-theme .recharts-legend-item-text { color: #e5e7eb !important; }
        .dark-theme .recharts-default-tooltip { background-color: #1f2937 !important; border: 1px solid #374151 !important; color: #f3f4f6 !important; }
        .dark-theme .recharts-tooltip-item-name, .dark-theme .recharts-tooltip-item-value { color: #f3f4f6 !important; }

        /* Sweet Theme Global Overrides (Pastel Pink) */
        .sweet-theme { background-color: #FFF5F8 !important; color: #5C434B !important; }
        .sweet-theme .bg-white { background-color: #ffffff !important; border-color: #FCE1E8 !important; }
        .sweet-theme .bg-gray-50 { background-color: #FFEDF1 !important; }
        .sweet-theme .bg-gray-100 { background-color: #FCE1E8 !important; }
        .sweet-theme .bg-gray-200 { background-color: #F8C8D4 !important; }
        
        .sweet-theme .text-gray-900, .sweet-theme .text-gray-800 { color: #5C434B !important; }
        .sweet-theme .text-gray-700, .sweet-theme .text-gray-600 { color: #7A5F69 !important; }
        .sweet-theme .text-gray-500 { color: #967E88 !important; }
        .sweet-theme .text-gray-400 { color: #B39CA6 !important; }
        
        .sweet-theme .border-gray-100, .sweet-theme .border-gray-200 { border-color: #FCE1E8 !important; }
        .sweet-theme .border-gray-300, .sweet-theme .border-gray-400 { border-color: #F8C8D4 !important; }
        .sweet-theme .divide-gray-100 > :not([hidden]) ~ :not([hidden]), .sweet-theme .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #FCE1E8 !important; }
        
        /* Sidebar in Sweet Theme (Soft Pastel) */
        .sweet-theme .bg-gray-900 { background-color: #FDE8ED !important; color: #5C434B !important; }
        .sweet-theme .bg-gray-900.text-white { color: #5C434B !important; } 
        .sweet-theme .bg-gray-900 .text-white { color: #5C434B !important; } 
        .sweet-theme .bg-gray-900 .text-gray-400 { color: #997B86 !important; }
        .sweet-theme .bg-gray-900 .text-gray-500 { color: #8C6D78 !important; }
        .sweet-theme .bg-gray-900 .hover\:text-white:hover { color: #D4758B !important; }
        .sweet-theme .border-gray-800 { border-color: #F4C4D0 !important; }
        .sweet-theme .bg-gray-800, .sweet-theme .hover\:bg-gray-800:hover, .sweet-theme .group:hover .group-hover\:bg-gray-800 { background-color: #F4C4D0 !important; }
        
        /* Inputs in Sweet Theme */
        .sweet-theme input:not([type="radio"]):not([type="checkbox"]), .sweet-theme select, .sweet-theme textarea {
            background-color: #FFFDFE !important;
            color: #5C434B !important;
            border-color: #FCE1E8 !important;
        }
        .sweet-theme input:not([type="radio"]):not([type="checkbox"]):focus, .sweet-theme select:focus, .sweet-theme textarea:focus {
            border-color: #F4A6B7 !important;
            box-shadow: 0 0 0 2px rgba(244, 166, 183, 0.3) !important;
            background-color: #ffffff !important;
        }
        
        /* Overriding Primary Accents (Orange to Pastel Pink) */
        .sweet-theme .bg-orange-50 { background-color: #FFF5F8 !important; }
        .sweet-theme .bg-orange-100 { background-color: #FFEDF1 !important; }
        .sweet-theme .bg-orange-500, .sweet-theme .bg-orange-600 { background-color: #F4A6B7 !important; color: white !important; }
        .sweet-theme .hover\:bg-orange-700:hover { background-color: #E88FA4 !important; }
        
        .sweet-theme .text-orange-400, .sweet-theme .text-orange-500, .sweet-theme .text-orange-600, .sweet-theme .text-orange-700 { color: #D4758B !important; }
        .sweet-theme .border-orange-200, .sweet-theme .border-orange-300, .sweet-theme .border-orange-500 { border-color: #F4A6B7 !important; }
        
        /* Tables in Sweet Theme */
        .sweet-theme table th { color: #7A5F69 !important; background-color: #FFEDF1 !important; border-color: #FCE1E8 !important; }
        .sweet-theme table td { border-color: #FCE1E8 !important; }
        .sweet-theme tr:hover td { background-color: #FFF5F8 !important; }

        /* Crimson Theme Global Overrides (Black Background, Dark Red Sidebar) */
        .crimson-theme { background-color: #000000 !important; color: #f3f4f6 !important; }
        .crimson-theme .bg-white { background-color: #121212 !important; border-color: #330000 !important; }
        .crimson-theme .bg-gray-50 { background-color: #1a1a1a !important; }
        .crimson-theme .bg-gray-100 { background-color: #222222 !important; }
        .crimson-theme .bg-gray-200 { background-color: #2a2a2a !important; }
        
        .crimson-theme .text-gray-900, .crimson-theme .text-gray-800 { color: #f9fafb !important; }
        .crimson-theme .text-gray-700, .crimson-theme .text-gray-600 { color: #e5e7eb !important; }
        .crimson-theme .text-gray-500 { color: #9ca3af !important; }
        .crimson-theme .text-gray-400 { color: #6b7280 !important; }
        
        .crimson-theme .border-gray-100, .crimson-theme .border-gray-200 { border-color: #330000 !important; }
        .crimson-theme .border-gray-300, .crimson-theme .border-gray-400 { border-color: #4a0404 !important; }
        .crimson-theme .divide-gray-100 > :not([hidden]) ~ :not([hidden]), .crimson-theme .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #330000 !important; }
        
        /* Sidebar in Crimson Theme */
        .crimson-theme .bg-gray-900 { background-color: #4A0404 !important; color: #FFFFFF !important; }
        .crimson-theme .bg-gray-900.text-white { color: #FFFFFF !important; } 
        .crimson-theme .bg-gray-900 .text-white { color: #FFFFFF !important; } 
        .crimson-theme .bg-gray-900 .text-gray-400 { color: #FCA5A5 !important; }
        .crimson-theme .bg-gray-900 .text-gray-500 { color: #F87171 !important; }
        .crimson-theme .bg-gray-900 .hover\:text-white:hover { color: #FFFFFF !important; }
        .crimson-theme .border-gray-800 { border-color: #7F1D1D !important; }
        .crimson-theme .bg-gray-800, .crimson-theme .hover\:bg-gray-800:hover, .crimson-theme .group:hover .group-hover\:bg-gray-800 { background-color: #7F1D1D !important; }
        
        /* Inputs in Crimson Theme */
        .crimson-theme input:not([type="radio"]):not([type="checkbox"]), .crimson-theme select, .crimson-theme textarea {
            background-color: #1A1A1A !important;
            color: #F3F4F6 !important;
            border-color: #4A0404 !important;
        }
        .crimson-theme input:not([type="radio"]):not([type="checkbox"]):focus, .crimson-theme select:focus, .crimson-theme textarea:focus {
            border-color: #DC2626 !important;
            background-color: #222222 !important;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3) !important;
        }
        .crimson-theme input::placeholder, .crimson-theme textarea::placeholder { color: #6b7280 !important; }
        
        /* Accents in Crimson Theme */
        .crimson-theme .bg-orange-50, .crimson-theme .bg-orange-100 { background-color: rgba(220, 38, 38, 0.15) !important; border-color: rgba(220, 38, 38, 0.3) !important; color: #FCA5A5 !important; }
        .crimson-theme .bg-orange-500, .crimson-theme .bg-orange-600 { background-color: #DC2626 !important; color: white !important; }
        .crimson-theme .hover\:bg-orange-700:hover { background-color: #B91C1C !important; }
        
        .crimson-theme .text-orange-400, .crimson-theme .text-orange-500, .crimson-theme .text-orange-600, .crimson-theme .text-orange-700 { color: #FCA5A5 !important; }
        .crimson-theme .border-orange-200, .crimson-theme .border-orange-300, .crimson-theme .border-orange-500 { border-color: rgba(220, 38, 38, 0.4) !important; }
        
        /* Tables in Crimson Theme */
        .crimson-theme table th { color: #FCA5A5 !important; background-color: #1A0505 !important; border-color: #330000 !important; }
        .crimson-theme table td { border-color: #330000 !important; }
        .crimson-theme tr:hover td { background-color: #2A0A0A !important; }

        /* Modals & Shadows in Crimson */
        .crimson-theme .bg-white.rounded-lg.shadow-xl { background-color: #121212 !important; border: 1px solid #330000; }
        .crimson-theme .shadow-sm, .crimson-theme .shadow, .crimson-theme .shadow-md, .crimson-theme .shadow-lg, .crimson-theme .shadow-xl {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.8), 0 2px 4px -1px rgba(0, 0, 0, 0.6) !important;
        }

        /* Charts / Recharts Tooltips for dark background */
        .crimson-theme .recharts-cartesian-axis-tick-value { fill: #9ca3af !important; }
        .crimson-theme .recharts-legend-item-text { color: #e5e7eb !important; }
        .crimson-theme .recharts-default-tooltip { background-color: #121212 !important; border: 1px solid #4a0404 !important; color: #f3f4f6 !important; }
        .crimson-theme .recharts-tooltip-item-name, .crimson-theme .recharts-tooltip-item-value { color: #f3f4f6 !important; }
        
        /* Status Badges for Crimson Theme */
        .crimson-theme .bg-green-50, .crimson-theme .bg-green-100 { background-color: rgba(5, 150, 105, 0.15) !important; border-color: rgba(5, 150, 105, 0.3) !important; color: #6ee7b7 !important; }
        .crimson-theme .text-green-500, .crimson-theme .text-green-600, .crimson-theme .text-green-700, .crimson-theme .text-green-800 { color: #6ee7b7 !important; }
        .crimson-theme .border-green-100, .crimson-theme .border-green-200, .crimson-theme .border-green-300 { border-color: rgba(5, 150, 105, 0.4) !important; }
        
        .crimson-theme .bg-red-50, .crimson-theme .bg-red-100 { background-color: rgba(220, 38, 38, 0.15) !important; border-color: rgba(220, 38, 38, 0.3) !important; color: #fca5a5 !important; }
        .crimson-theme .text-red-500, .crimson-theme .text-red-600, .crimson-theme .text-red-700, .crimson-theme .text-red-800 { color: #fca5a5 !important; }
        .crimson-theme .border-red-100, .crimson-theme .border-red-200, .crimson-theme .border-red-300 { border-color: rgba(220, 38, 38, 0.4) !important; }

        .crimson-theme .bg-blue-50, .crimson-theme .bg-blue-100 { background-color: rgba(37, 99, 235, 0.15) !important; border-color: rgba(37, 99, 235, 0.3) !important; color: #93c5fd !important; }
        .crimson-theme .text-blue-500, .crimson-theme .text-blue-600, .crimson-theme .text-blue-700, .crimson-theme .text-blue-800 { color: #93c5fd !important; }
        .crimson-theme .border-blue-100, .crimson-theme .border-blue-200, .crimson-theme .border-blue-300 { border-color: rgba(37, 99, 235, 0.4) !important; }

        .crimson-theme .bg-yellow-50, .crimson-theme .bg-yellow-100 { background-color: rgba(202, 138, 4, 0.15) !important; border-color: rgba(202, 138, 4, 0.3) !important; color: #fde047 !important; }
        .crimson-theme .text-yellow-500, .crimson-theme .text-yellow-600, .crimson-theme .text-yellow-700, .crimson-theme .text-yellow-800 { color: #fde047 !important; }
        .crimson-theme .border-yellow-100, .crimson-theme .border-yellow-200, .crimson-theme .border-yellow-300 { border-color: rgba(202, 138, 4, 0.4) !important; }

        .crimson-theme .bg-purple-50, .crimson-theme .bg-purple-100 { background-color: rgba(124, 58, 237, 0.15) !important; border-color: rgba(124, 58, 237, 0.3) !important; color: #c4b5fd !important; }
        .crimson-theme .text-purple-500, .crimson-theme .text-purple-600, .crimson-theme .text-purple-700, .crimson-theme .text-purple-800 { color: #c4b5fd !important; }
        .crimson-theme .border-purple-100, .crimson-theme .border-purple-200, .crimson-theme .border-purple-300 { border-color: rgba(124, 58, 237, 0.4) !important; }

        .crimson-theme .bg-cyan-50, .crimson-theme .bg-cyan-100 { background-color: rgba(6, 182, 212, 0.15) !important; border-color: rgba(6, 182, 212, 0.3) !important; color: #67e8f9 !important; }
        .crimson-theme .text-cyan-500, .crimson-theme .text-cyan-600, .crimson-theme .text-cyan-700, .crimson-theme .text-cyan-800 { color: #67e8f9 !important; }

        /* Sunset Theme Global Overrides (Red-Orange Sidebar / Light Yellow BG) */
        .sunset-theme { background-color: #FFFDE7 !important; color: #431407 !important; }
        .sunset-theme .bg-white { background-color: #ffffff !important; border-color: #FDE047 !important; }
        .sunset-theme .bg-gray-50 { background-color: #FEF9C3 !important; }
        .sunset-theme .bg-gray-100 { background-color: #FEF08A !important; }
        .sunset-theme .bg-gray-200 { background-color: #FDE047 !important; }
        
        .sunset-theme .text-gray-900, .sunset-theme .text-gray-800 { color: #431407 !important; }
        .sunset-theme .text-gray-700, .sunset-theme .text-gray-600 { color: #7C2D12 !important; }
        .sunset-theme .text-gray-500 { color: #9A3412 !important; }
        .sunset-theme .text-gray-400 { color: #C2410C !important; }
        
        .sunset-theme .border-gray-100, .sunset-theme .border-gray-200 { border-color: #FEF08A !important; }
        .sunset-theme .border-gray-300, .sunset-theme .border-gray-400 { border-color: #FDE047 !important; }
        .sunset-theme .divide-gray-100 > :not([hidden]) ~ :not([hidden]), .sunset-theme .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #FEF08A !important; }
        
        /* Sidebar in Sunset Theme */
        .sunset-theme .bg-gray-900 { background-color: #E84D22 !important; color: #FFFDE7 !important; }
        .sunset-theme .bg-gray-900.text-white { color: #FFFDE7 !important; } 
        .sunset-theme .bg-gray-900 .text-white { color: #FFFDE7 !important; } 
        .sunset-theme .bg-gray-900 .text-gray-400 { color: #FDE047 !important; }
        .sunset-theme .bg-gray-900 .text-gray-500 { color: #FEF08A !important; }
        .sunset-theme .bg-gray-900 .hover\:text-white:hover { color: #FFFFFF !important; }
        .sunset-theme .border-gray-800 { border-color: #C23A1D !important; }
        .sunset-theme .bg-gray-800, .sunset-theme .hover\:bg-gray-800:hover, .sunset-theme .group:hover .group-hover\:bg-gray-800 { background-color: #C23A1D !important; }
        
        /* Inputs in Sunset Theme */
        .sunset-theme input:not([type="radio"]):not([type="checkbox"]), .sunset-theme select, .sunset-theme textarea {
            background-color: #FFF !important;
            color: #431407 !important;
            border-color: #FDE047 !important;
        }
        .sunset-theme input:not([type="radio"]):not([type="checkbox"]):focus, .sunset-theme select:focus, .sunset-theme textarea:focus {
            border-color: #EA580C !important;
            box-shadow: 0 0 0 2px rgba(234, 88, 12, 0.3) !important;
        }
        
        /* Accents in Sunset Theme */
        .sunset-theme .bg-orange-50 { background-color: #FFEDD5 !important; }
        .sunset-theme .bg-orange-100 { background-color: #FED7AA !important; }
        .sunset-theme .bg-orange-500, .sunset-theme .bg-orange-600 { background-color: #EA580C !important; color: white !important; }
        .sunset-theme .hover\:bg-orange-700:hover { background-color: #C2410C !important; }
        
        .sunset-theme .text-orange-400, .sunset-theme .text-orange-500, .sunset-theme .text-orange-600, .sunset-theme .text-orange-700 { color: #EA580C !important; }
        .sunset-theme .border-orange-200, .sunset-theme .border-orange-300, .sunset-theme .border-orange-500 { border-color: #EA580C !important; }
        
        /* Tables in Sunset Theme */
        .sunset-theme table th { color: #9A3412 !important; background-color: #FEF9C3 !important; border-color: #FEF08A !important; }
        .sunset-theme table td { border-color: #FEF08A !important; }
        .sunset-theme tr:hover td { background-color: #FFFDE7 !important; }
      `}</style>
      {Sidebar()}
      <main className={`flex-1 transition-all flex flex-col min-w-0 ${isExporting ? 'ml-0 p-0 bg-white w-max min-w-full absolute top-0 left-0 z-[9999]' : (isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0')}`}>
        
        {/* Header (Hamburger Menu) */}
        {!isExporting && (
            <div className={`bg-white shadow-sm border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 z-30 transition-colors duration-300 ${isSidebarOpen ? 'lg:hidden' : ''}`}>
                <div className="flex items-center gap-3 min-w-0">
                    <button 
                        onClick={() => { setIsMobileMenuOpen(true); setIsSidebarOpen(true); }} 
                        className="text-gray-600 hover:text-orange-600 focus:outline-none p-1.5 rounded-md bg-gray-100 hover:bg-orange-50 transition-colors shrink-0"
                        title="‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π (Show Menu)"
                    >
                        <List size={24} />
                    </button>
                    <div className="flex flex-col min-w-0">
                        <h1 className="font-bold text-gray-800 text-sm truncate">{companyInfo.name}</h1>
                        {selectedProject && <span className="text-[10px] text-orange-600 font-medium truncate">{selectedProject.name}</span>}
                    </div>
                </div>
                <div className="w-9 h-9 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-sm font-bold text-white shadow-sm border-2 border-white shrink-0">
                    {currentUser?.firstName?.charAt(0) || 'U'}
                </div>
            </div>
        )}

        <div id="print-area" className={`${isExporting ? 'w-max min-w-full' : 'max-w-7xl mx-auto w-full p-4 md:p-6 lg:p-8 h-full flex flex-col'}`}>
          {selectedProject ? ProjectDetail() : (
            <>
              {activeMenu === 'dashboard' && DashboardView()}
              {activeMenu === 'users' && UserManagement()}
              {activeMenu === 'projects' && ProjectList()}
              {activeMenu === 'audits' && GlobalAuditList()}
              {activeMenu === 'manual' && ManualView()}
              {activeMenu === 'settings' && SettingsView()}
            </>
          )}
        </div>
      </main>
      
      {/* ... (Previous Modals) ... */}
      
      {/* Modals */}
      {showAddUserModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800">{isEditingUser ? t('editUserTitle') : t('newUserTitle')}</h2><button onClick={() => setShowAddUserModal(false)}><X size={24} /></button></div>
            <form onSubmit={handleSaveUser} className="space-y-6">
              <div className="flex flex-col md:flex-row gap-6">
                <div className="flex flex-col items-center gap-3">
                  <div className="w-32 h-32 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-300 relative group">
                    {newUser.photo ? <img src={newUser.photo} alt="Preview" className="w-full h-full object-cover" /> : <User size={48} className="text-gray-400" />}
                    <div className="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><label htmlFor="photo-upload" className="cursor-pointer text-white text-xs font-bold flex flex-col items-center"><Upload size={20} className="mb-1" />{t('uploadPhoto')}</label><input id="photo-upload" type="file" accept="image/*" className="hidden" onChange={handlePhotoUpload} /></div>
                  </div>
                  {newUser.photo && <button type="button" onClick={() => setNewUser({...newUser, photo: null})} className="text-red-500 text-xs hover:underline">{t('removePhoto')}</button>}
                </div>
                <div className="flex-1 space-y-4">
                  <h3 className="text-lg font-semibold text-gray-700 border-b pb-2">{t('personalInfo')}</h3>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('empId')}</label><input type="text" className={`w-full border rounded-md p-2 ${isEditingUser ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`} value={newUser.employeeId} onChange={e => setNewUser({...newUser, employeeId: e.target.value})} placeholder="e.g., EMP-001" disabled={isEditingUser} /></div>
                  <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('firstName')}</label><input type="text" required className="w-full border rounded-md p-2" value={newUser.firstName} onChange={e => setNewUser({...newUser, firstName: e.target.value})} /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('lastName')}</label><input type="text" required className="w-full border rounded-md p-2" value={newUser.lastName} onChange={e => setNewUser({...newUser, lastName: e.target.value})} /></div></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('phone')}</label><input type="tel" className="w-full border rounded-md p-2" value={newUser.phone} onChange={e => setNewUser({...newUser, phone: e.target.value})} /></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('username')}</label><input type="text" required className="w-full border rounded-md p-2" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('password')}</label><input type="text" required className="w-full border rounded-md p-2" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} /></div>
                  </div>
                </div>
              </div>
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 flex items-center justify-between">
                    <span>{t('position')} & {t('col_dept')}</span>
                    {isEditingUser && currentUser?.username !== 'admin' && <span className="text-xs text-red-500 font-normal">* ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ</span>}
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">{t('position')}</label>
                      <select 
                          className={`w-full border rounded-md p-2 ${isEditingUser && currentUser?.username !== 'admin' ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`} 
                          value={newUser.position} 
                          onChange={e => {
                              const newPos = e.target.value;
                              setNewUser({
                                  ...newUser, 
                                  position: newPos,
                                  // ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                  permissions: rolePermissions[newPos] || getDefaultPermissions()
                              });
                          }} 
                          disabled={isEditingUser && currentUser?.username !== 'admin'}
                      >
                          {EMPLOYEE_POSITIONS.map(pos => <option key={pos} value={pos}>{pos}</option>)}
                      </select>
                      {newUser.position.startsWith("‡∏≠‡∏∑‡πà‡∏ô‡πÜ") && <input type="text" className={`mt-2 w-full border rounded-md p-2 ${isEditingUser && currentUser?.username !== 'admin' ? 'bg-gray-100 cursor-not-allowed text-gray-500' : 'bg-gray-50'}`} placeholder={t('specifyOther')} value={newUser.otherPosition} onChange={e => setNewUser({...newUser, otherPosition: e.target.value})} disabled={isEditingUser && currentUser?.username !== 'admin'} />}
                  </div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('currentDept')}</label><select className={`w-full border rounded-md p-2 ${isEditingUser && currentUser?.username !== 'admin' ? 'bg-gray-100 cursor-not-allowed text-gray-500' : ''}`} value={newUser.department} onChange={e => setNewUser({...newUser, department: e.target.value})} disabled={isEditingUser && currentUser?.username !== 'admin'}><option value="">{t('selectDept')}</option><option value="Head Office">Head Office</option>{projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}</select></div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('accessibleDepts')}</label>
                    {currentUser?.username === 'admin' ? (
                        <div className="flex gap-2 mb-2">
                            <select className="w-full border rounded-md p-2" onChange={handleAddAccessibleDept} defaultValue="">
                                <option value="" disabled>{t('selectDept')}</option>
                                <option value="All">All (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</option>
                                <option value="Head Office">Head Office</option>
                                {projects.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                            </select>
                        </div>
                    ) : (
                        <div className="text-xs text-red-500 mb-2">* ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                    )}
                    <div className="flex flex-wrap gap-2 mt-2">
                        {newUser.accessibleDepts.length > 0 ? newUser.accessibleDepts.map((dept, index) => (
                            <div key={index} className="flex items-center gap-1 bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm">
                                <span>{dept === 'All' ? 'All (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)' : dept}</span>
                                {currentUser?.username === 'admin' && (
                                    <button type="button" onClick={() => removeAccessibleDept(dept)} className="text-orange-600 hover:text-orange-900"><XCircle size={14} /></button>
                                )}
                            </div>
                        )) : (
                            <span className="text-gray-400 text-sm">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ -</span>
                        )}
                    </div>
                </div>
              </div>
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 flex items-center justify-between">
                    <span>{t('accessControl')}</span>
                    {currentUser?.username !== 'admin' && <span className="text-xs text-red-500 font-normal">* ‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>}
                </h3>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">{t('permissions')}</label>
                    <div className="overflow-x-auto border border-gray-200 rounded-lg">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-gray-700">
                                <tr>
                                    <th className="p-3 border-b">‡πÇ‡∏°‡∏î‡∏π‡∏• (Module)</th>
                                    <th className="p-3 border-b text-center w-16">‡∏î‡∏π</th>
                                    <th className="p-3 border-b text-center w-16">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                                    <th className="p-3 border-b text-center w-16">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                    <th className="p-3 border-b text-center w-16">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                                    <th className="p-3 border-b text-center w-16">‡∏•‡∏ö</th>
                                    <th className="p-3 border-b text-center w-16">‡∏û‡∏¥‡∏°‡∏û‡πå</th>
                                    <th className="p-3 border-b text-center w-20 bg-gray-200">All</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100 bg-white">
                                {AVAILABLE_MENUS.map(menu => {
                                    const renderRow = (item, isSub = false) => {
                                        const perms = newUser.permissions[item.id] || {};
                                        const isAll = perms.view && perms.save && perms.edit && perms.approve && perms.delete && perms.print;
                                        return (
                                            <tr key={item.id} className={`hover:bg-gray-50 transition-colors ${isSub ? 'bg-gray-50/50' : ''}`}>
                                                <td className={`p-3 font-medium text-gray-800 ${isSub ? 'pl-8 text-xs text-gray-600 border-l-2 border-orange-200' : ''}`}>
                                                    {isSub && <span className="mr-2 text-gray-400">‚îî</span>}
                                                    {t(item.label)}
                                                </td>
                                                {['view', 'save', 'edit', 'approve', 'delete', 'print'].map(ptype => (
                                                    <td key={ptype} className="p-3 text-center">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-4 h-4 accent-orange-600 cursor-pointer disabled:opacity-50" 
                                                            checked={!!perms[ptype]} 
                                                            onChange={(e) => handlePermissionChange(item.id, ptype, e.target.checked)} 
                                                            disabled={currentUser?.username !== 'admin'} 
                                                        />
                                                    </td>
                                                ))}
                                                <td className="p-3 text-center bg-gray-50 border-l border-gray-100">
                                                    <input 
                                                        type="checkbox" 
                                                        className="w-4 h-4 accent-orange-600 cursor-pointer disabled:opacity-50" 
                                                        checked={isAll} 
                                                        onChange={(e) => handlePermissionAll(item.id, e.target.checked)} 
                                                        disabled={currentUser?.username !== 'admin'} 
                                                    />
                                                </td>
                                            </tr>
                                        );
                                    };

                                    return (
                                        <React.Fragment key={menu.id}>
                                            {renderRow(menu)}
                                            {menu.submenus && menu.submenus.map(sub => renderRow(sub, true))}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
              </div>
              <div className="flex justify-end gap-2 pt-4 border-t"><Button variant="secondary" onClick={() => setShowAddUserModal(false)}>{t('cancel')}</Button><Button type="submit">{t('save')}</Button></div>
            </form>
          </div>
        </div>
      )}

      {showAddProjectModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800">{isEditingProject ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô' : t('newProjectTitle')}</h2><button onClick={() => setShowAddProjectModal(false)}><X size={24} /></button></div>
            <form onSubmit={handleSaveProject} className="space-y-6">
              <div className="flex flex-col md:flex-row gap-6">
                <div className="flex flex-col items-center gap-3">
                  <div className="w-32 h-32 rounded-lg bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-300 relative group">{newProject.logo ? <img src={newProject.logo} alt="Project Logo" className="w-full h-full object-cover" /> : <div className="text-center text-gray-400 p-2"><ImageIcon size={32} className="mx-auto mb-1" /><span className="text-xs">{t('projLogo')}</span></div>}<div className="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><label htmlFor="logo-upload" className="cursor-pointer text-white text-xs font-bold flex flex-col items-center"><Upload size={20} className="mb-1" />{t('uploadLogo')}</label><input id="logo-upload" type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} /></div></div>
                  {newProject.logo && <button type="button" onClick={() => setNewProject({...newProject, logo: null})} className="text-red-500 text-xs hover:underline">{t('removePhoto')}</button>}
                </div>
                <div className="flex-1 space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-2">{t('projType')}</label><div className="flex gap-2">{PROJECT_TYPES.map(type => (<button key={type} type="button" onClick={() => setNewProject({...newProject, type})} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors border ${newProject.type === type ? 'bg-orange-50 border-orange-500 text-orange-700' : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'}`}>{type === 'Condo' ? t('tab_condo') : type === 'Village' ? t('tab_village') : t('tab_office')}</button>))}</div></div>
                  <div className="grid grid-cols-3 gap-4"><div className="col-span-1"><label className="block text-sm font-medium text-gray-700 mb-1">{t('projCode')}</label><input type="text" readOnly className="w-full border rounded-md p-2 bg-gray-100 text-gray-500 cursor-not-allowed font-mono" value={newProject.code || '-'} /></div><div className="col-span-2"><label className="block text-sm font-medium text-gray-700 mb-1">{t('projName')}</label><input type="text" required className="w-full border rounded-md p-2" value={newProject.name} onChange={e => setNewProject({...newProject, name: e.target.value})} /></div></div>
                  <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('officePhone')}</label><input type="tel" className="w-full border rounded-md p-2" value={newProject.phone} onChange={e => setNewProject({...newProject, phone: e.target.value})} /></div><div><label className="block text-sm font-medium text-gray-700 mb-1">{t('taxId')}</label><input type="text" className="w-full border rounded-md p-2" value={newProject.taxId} onChange={e => setNewProject({...newProject, taxId: e.target.value})} /></div></div>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('projAddress')}</label><textarea className="w-full border rounded-md p-2 h-[120px] resize-none" value={newProject.address} onChange={e => setNewProject({...newProject, address: e.target.value})}></textarea></div>
                <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-3">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('contractStartDate')}</label><input type="date" className="w-full border rounded-md p-2 text-sm" value={newProject.contractStartDate} onChange={e => setNewProject({...newProject, contractStartDate: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">{t('contractEndDate')}</label><input type="date" className="w-full border rounded-md p-2 text-sm" value={newProject.contractEndDate} onChange={e => setNewProject({...newProject, contractEndDate: e.target.value})} /></div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                        <div className="relative">
                            <span className="absolute left-3 top-2 text-gray-500">‡∏ø</span>
                            <input type="number" className="w-full border rounded-md pl-8 p-2 text-sm" value={newProject.contractValue || ''} onChange={e => setNewProject({...newProject, contractValue: e.target.value})} placeholder="0.00" />
                        </div>
                    </div>
                </div>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">{t('uploadDocs')}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{[{ key: 'orchor', label: t('doc_orchor') }, { key: 'committee', label: t('doc_committee') }, { key: 'regulations', label: t('doc_regulations') }, { key: 'resident_rules', label: t('doc_resident_rules') }].map((doc) => (<div key={doc.key} className="border rounded-md p-3 flex items-center justify-between bg-gray-50"><div className="flex items-center gap-2 overflow-hidden"><File size={20} className="text-gray-400 flex-shrink-0" /><span className="text-sm truncate font-medium text-gray-700">{doc.label}</span></div><div className="flex items-center gap-2">{newProject.files && newProject.files[doc.key] ? <span className="text-xs text-green-600 flex items-center gap-1"><CheckCircle size={12} /> Uploaded</span> : <label className="cursor-pointer bg-white border border-gray-300 text-gray-600 px-2 py-1 rounded text-xs hover:bg-gray-50 transition-colors">Upload<input type="file" className="hidden" onChange={(e) => handleProjectFileUpload(e, doc.key)} /></label>}</div></div>))}</div>
              </div>
              <div className="flex justify-end gap-2 pt-4 border-t"><Button variant="secondary" onClick={() => setShowAddProjectModal(false)}>{t('cancel')}</Button><Button type="submit">{t('save')}</Button></div>
            </form>
          </div>
        </div>
      )}

      {/* Add Contract Modal */}
      {showAddContractModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 m-4">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-gray-800">{isEditingContract ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Edit Contract)' : t('addContract')}</h2>
              <button onClick={() => setShowAddContractModal(false)}><X size={24} /></button>
            </div>
            <form onSubmit={handleSaveContract} className="space-y-4">
              
              {/* Contract Type Tabs */}
              <div className="flex p-1 bg-gray-100 rounded-lg mb-4">
                {Object.values(CONTRACT_TYPES).map(type => (
                    <button
                        key={type}
                        type="button"
                        onClick={() => setNewContract({...newContract, type})}
                        className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${newContract.type === type ? 'bg-white shadow text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        {type.split(' (')[0]}
                    </button>
                ))}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('contractCategory')}</label>
                <select 
                    className="w-full border rounded-md p-2"
                    value={newContract.category}
                    onChange={e => setNewContract({...newContract, category: e.target.value})}
                    required
                >
                    <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ --</option>
                    {SERVICE_TYPES[newContract.type]?.map(service => (
                        <option key={service} value={service}>{service}</option>
                    ))}
                </select>
                {(newContract.category === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ)' || newContract.category === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Other)') && (
                    <input 
                        type="text" 
                        className="mt-2 w-full border rounded-md p-2 bg-gray-50 focus:bg-white transition-colors"
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                        value={newContract.customCategory}
                        onChange={e => setNewContract({...newContract, customCategory: e.target.value})}
                        required
                    />
                )}
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_vendor')}</label>
                <input 
                    type="text" 
                    required 
                    className="w-full border rounded-md p-2"
                    list="contractor-list"
                    value={newContract.vendorName}
                    onChange={e => setNewContract({...newContract, vendorName: e.target.value})} 
                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤"
                />
                <datalist id="contractor-list">
                    {contractors.map(c => <option key={c.id} value={c.name} />)}
                </datalist>
              </div>

              {/* Added Contact Person and Phone */}
              <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_contact_person')}</label>
                    <input 
                        type="text" 
                        className="w-full border rounded-md p-2"
                        value={newContract.contactPerson}
                        onChange={e => setNewContract({...newContract, contactPerson: e.target.value})} 
                        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_contact_phone')}</label>
                    <input 
                        type="tel" 
                        className="w-full border rounded-md p-2"
                        value={newContract.contactPhone}
                        onChange={e => setNewContract({...newContract, contactPhone: e.target.value})} 
                        placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"
                    />
                  </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('contractStartDate')}</label>
                    <input type="date" required className="w-full border rounded-md p-2" value={newContract.startDate} onChange={e => setNewContract({...newContract, startDate: e.target.value})} />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('contractEndDate')}</label>
                    <input type="date" required className="w-full border rounded-md p-2" value={newContract.endDate} onChange={e => setNewContract({...newContract, endDate: e.target.value})} />
                </div>
              </div>
              
              {/* Remaining Days Warning */}
              {newContract.endDate && (
                  <div className={`text-sm text-right font-medium ${calculateDaysRemaining(newContract.endDate) < 30 ? 'text-red-600' : 'text-green-600'}`}>
                      ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {calculateDaysRemaining(newContract.endDate)} ‡∏ß‡∏±‡∏ô
                  </div>
              )}

              <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_amount')} {t('beforeVat')}</label>
                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span className="text-gray-500 sm:text-sm">‡∏ø</span>
                        </div>
                        <input type="number" className="w-full border rounded-md pl-7 p-2" value={newContract.amount} onChange={e => setNewContract({...newContract, amount: e.target.value})} placeholder="0.00" />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('paymentCycle')}</label>
                    <select className="w-full border rounded-md p-2" value={newContract.paymentCycle} onChange={e => setNewContract({...newContract, paymentCycle: e.target.value})}>
                        <option value="Monthly">{t('monthly')}</option>
                        <option value="Yearly">{t('yearly')}</option>
                    </select>
                </div>
              </div>

              <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (PDF)</label>
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 cursor-pointer relative">
                      <input type="file" accept=".pdf" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleContractFileUpload} />
                      {newContract.file ? (
                          <div className="text-green-600 flex items-center justify-center gap-2"><FileCheck size={20}/> {newContract.file.name}</div>
                      ) : (
                          <div className="text-gray-500 flex flex-col items-center gap-1"><Upload size={24}/><span className="text-xs">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span></div>
                      )}
                  </div>
              </div>

              <div className="flex justify-end gap-2 pt-4 border-t">
                <Button variant="secondary" onClick={() => setShowAddContractModal(false)}>{t('cancel')}</Button>
                <Button type="submit">{t('save')}</Button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: Selected Asset Details View Modal */}
      {selectedAssetView && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 max-h-[95vh] overflow-y-auto relative animate-fade-in">
                <button 
                    onClick={() => setSelectedAssetView(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div className="mb-6 border-b pb-4">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <Shield className="text-orange-500"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Asset Details)</p>
                </div>

                <div className="flex flex-col md:flex-row gap-8 mb-6">
                    {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */}
                    <div className="w-full md:w-1/3 flex flex-col items-center">
                        <div className="w-48 h-48 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden shadow-sm">
                            {selectedAssetView.photo ? (
                                <img src={selectedAssetView.photo} alt={selectedAssetView.name} className="w-full h-full object-cover" />
                            ) : (
                                <ImageIcon className="text-gray-300" size={64} />
                            )}
                        </div>
                    </div>
                    {/* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
                    <div className="w-full md:w-2/3 space-y-4">
                        <div className="grid grid-cols-2 gap-y-5 gap-x-4 text-sm bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Code)</span>
                                <span className="font-mono font-bold text-lg text-orange-600 bg-white border border-orange-100 px-2 py-1 rounded shadow-sm">{selectedAssetView.code}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (Name)</span>
                                <span className="font-bold text-gray-800 text-base">{selectedAssetView.name}</span>
                            </div>
                            <div className="border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</span>
                                <span className="text-gray-800 font-bold">{selectedAssetView.qty} Unit(s)</span>
                            </div>
                            <div className="border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (Location)</span>
                                <span className="text-gray-800 flex items-center gap-1 font-medium"><MapPin size={14} className="text-gray-400"/> {selectedAssetView.location || '-'}</span>
                            </div>
                            <div className="col-span-2 border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Details)</span>
                                <span className="text-gray-700 whitespace-pre-wrap">{selectedAssetView.details || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2 pt-4 border-t">
                    {hasPerm('proj_assets', 'edit') && (
                        <Button variant="outline" icon={Edit} onClick={() => handleEditAsset(selectedAssetView)}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                    )}
                    <Button variant="secondary" onClick={() => setSelectedAssetView(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Selected Tool Details View Modal */}
      {selectedToolView && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 max-h-[95vh] overflow-y-auto relative animate-fade-in">
                <button 
                    onClick={() => setSelectedToolView(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div className="mb-6 border-b pb-4">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <Wrench className="text-orange-500"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Tool Details)</p>
                </div>

                <div className="flex flex-col md:flex-row gap-8 mb-6">
                    {/* ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */}
                    <div className="w-full md:w-1/3 flex flex-col items-center">
                        <div className="w-48 h-48 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden shadow-sm">
                            {selectedToolView.photo ? (
                                <img src={selectedToolView.photo} alt={selectedToolView.name} className="w-full h-full object-cover" />
                            ) : (
                                <ImageIcon className="text-gray-300" size={64} />
                            )}
                        </div>
                    </div>
                    {/* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */}
                    <div className="w-full md:w-2/3 space-y-4">
                        <div className="grid grid-cols-2 gap-y-5 gap-x-4 text-sm bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Code)</span>
                                <span className="font-mono font-bold text-lg text-orange-600 bg-white border border-orange-100 px-2 py-1 rounded shadow-sm">{selectedToolView.code}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Name)</span>
                                <span className="font-bold text-gray-800 text-base">{selectedToolView.name}</span>
                            </div>
                            <div className="border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</span>
                                <span className="text-gray-800 font-bold">{selectedToolView.qty} Unit(s)</span>
                            </div>
                            <div className="border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö (Location)</span>
                                <span className="text-gray-800 flex items-center gap-1 font-medium"><MapPin size={14} className="text-gray-400"/> {selectedToolView.location || '-'}</span>
                            </div>
                            <div className="col-span-2 border-t border-gray-200 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Details)</span>
                                <span className="text-gray-700 whitespace-pre-wrap">{selectedToolView.details || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2 pt-4 border-t">
                    {hasPerm('proj_tools', 'edit') && (
                        <Button variant="outline" icon={Edit} onClick={() => handleEditTool(selectedToolView)}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                    )}
                    <Button variant="secondary" onClick={() => setSelectedToolView(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* Add Asset Modal */}
      {showAddAssetModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-gray-800">{isEditingAsset ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô' : t('registerAsset')}</h2>
              <button onClick={() => setShowAddAssetModal(false)}><X size={24} /></button>
            </div>
            <form onSubmit={handleSaveAsset} className="space-y-4">
                
                {/* Auto Generated Code */}
                <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">{t('col_assetCode')}</label>
                    <input 
                        type="text" 
                        readOnly 
                        className="w-full border rounded-md p-2 bg-gray-100 text-gray-600 font-mono"
                        value={newAsset.code}
                    />
                </div>

                {/* Name */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_assetName')}</label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border rounded-md p-2"
                        value={newAsset.name}
                        onChange={e => setNewAsset({...newAsset, name: e.target.value})}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô"
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {/* Qty */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_qty')}</label>
                        <input 
                            type="number" 
                            min="1"
                            className="w-full border rounded-md p-2"
                            value={newAsset.qty}
                            onChange={e => setNewAsset({...newAsset, qty: parseInt(e.target.value)})}
                        />
                    </div>
                    {/* Location */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_location')}</label>
                        <div className="relative">
                            <MapPin size={16} className="absolute left-2 top-2.5 text-gray-400"/>
                            <input 
                                type="text" 
                                className="w-full border rounded-md pl-8 p-2"
                                value={newAsset.location}
                                onChange={e => setNewAsset({...newAsset, location: e.target.value})}
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô 1, ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á"
                            />
                        </div>
                    </div>
                </div>

                {/* Details */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('assetDetails')}</label>
                    <textarea 
                        className="w-full border rounded-md p-2 h-20 resize-none"
                        value={newAsset.details}
                        onChange={e => setNewAsset({...newAsset, details: e.target.value})}
                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                    ></textarea>
                </div>

                {/* Photo Upload */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô</label>
                    <div className="flex items-center gap-4">
                        <div className="w-24 h-24 bg-gray-100 rounded-lg border border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                            {newAsset.photo ? (
                                <img src={newAsset.photo} alt="Preview" className="w-full h-full object-cover" />
                            ) : (
                                <Box className="text-gray-300" size={32} />
                            )}
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center">
                                <ImageIcon size={16}/> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                <input type="file" accept="image/*" className="hidden" onChange={handleAssetPhotoUpload} />
                            </label>
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center text-orange-600 border-orange-200">
                                <Camera size={16}/> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                                <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleAssetPhotoUpload} />
                            </label>
                        </div>
                    </div>
                </div>

                <div className="flex justify-end gap-2 pt-4 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddAssetModal(false)}>{t('cancel')}</Button>
                    <Button type="submit">{t('save')}</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Tool Modal */}
      {showAddToolModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-gray-800">{isEditingTool ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á' : t('regTool')}</h2>
              <button onClick={() => setShowAddToolModal(false)}><X size={24} /></button>
            </div>
            <form onSubmit={handleSaveTool} className="space-y-4">
                
                {/* Auto Generated Code */}
                <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">{t('col_toolCode')}</label>
                    <input 
                        type="text" 
                        readOnly 
                        className="w-full border rounded-md p-2 bg-gray-100 text-gray-600 font-mono"
                        value={newTool.code}
                    />
                </div>

                {/* Name */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_toolName')}</label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border rounded-md p-2"
                        value={newTool.name}
                        onChange={e => setNewTool({...newTool, name: e.target.value})}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"
                    />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {/* Qty */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_qty')}</label>
                        <input 
                            type="number" 
                            min="1"
                            className="w-full border rounded-md p-2"
                            value={newTool.qty}
                            onChange={e => setNewTool({...newTool, qty: parseInt(e.target.value)})}
                        />
                    </div>
                    {/* Location */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_location')}</label>
                        <div className="relative">
                            <MapPin size={16} className="absolute left-2 top-2.5 text-gray-400"/>
                            <input 
                                type="text" 
                                className="w-full border rounded-md pl-8 p-2"
                                value={newTool.location}
                                onChange={e => setNewTool({...newTool, location: e.target.value})}
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á, ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠"
                            />
                        </div>
                    </div>
                </div>

                {/* Details */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('assetDetails')}</label>
                    <textarea 
                        className="w-full border rounded-md p-2 h-20 resize-none"
                        value={newTool.details}
                        onChange={e => setNewTool({...newTool, details: e.target.value})}
                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                    ></textarea>
                </div>

                {/* Photo Upload */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á</label>
                    <div className="flex items-center gap-4">
                        <div className="w-24 h-24 bg-gray-100 rounded-lg border border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                            {newTool.photo ? (
                                <img src={newTool.photo} alt="Preview" className="w-full h-full object-cover" />
                            ) : (
                                <Wrench className="text-gray-300" size={32} />
                            )}
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center">
                                <ImageIcon size={16}/> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                <input type="file" accept="image/*" className="hidden" onChange={handleToolPhotoUpload} />
                            </label>
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center text-orange-600 border-orange-200">
                                <Camera size={16}/> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                                <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleToolPhotoUpload} />
                            </label>
                        </div>
                    </div>
                </div>

                <div className="flex justify-end gap-2 pt-4 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddToolModal(false)}>{t('cancel')}</Button>
                    <Button type="submit">{t('save')}</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Machine Modal (PM) */}
      {showAddMachineModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-gray-800">{isEditingMachine ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : t('addMachine')}</h2>
              <button onClick={() => setShowAddMachineModal(false)}><X size={24} /></button>
            </div>
            <form onSubmit={handleSaveMachine} className="space-y-4">
                
                {/* Auto Generated Code */}
                <div>
                    <label className="block text-xs font-medium text-gray-500 mb-1">{t('col_machineCode')}</label>
                    <input 
                        type="text" 
                        readOnly 
                        className="w-full border rounded-md p-2 bg-gray-100 text-gray-600 font-mono"
                        value={newMachine.code}
                    />
                </div>

                {/* Name */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_machineName')}</label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border rounded-md p-2"
                        value={newMachine.name}
                        onChange={e => setNewMachine({...newMachine, name: e.target.value})}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£"
                    />
                </div>
                
                {/* System */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_system')}</label>
                    <select 
                        className="w-full border rounded-md p-2"
                        value={newMachine.system}
                        onChange={e => setNewMachine({...newMachine, system: e.target.value})}
                        required
                    >
                        <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö --</option>
                        {MACHINE_SYSTEMS.map(sys => (
                            <option key={sys} value={sys}>{sys}</option>
                        ))}
                    </select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    {/* Qty */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_qty')}</label>
                        <input 
                            type="number" 
                            min="1"
                            className="w-full border rounded-md p-2"
                            value={newMachine.qty}
                            onChange={e => setNewMachine({...newMachine, qty: parseInt(e.target.value)})}
                        />
                    </div>
                    {/* Location */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_location')}</label>
                        <div className="relative">
                            <MapPin size={16} className="absolute left-2 top-2.5 text-gray-400"/>
                            <input 
                                type="text" 
                                className="w-full border rounded-md pl-8 p-2"
                                value={newMachine.location}
                                onChange={e => setNewMachine({...newMachine, location: e.target.value})}
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô‡∏î‡∏≤‡∏î‡∏ü‡πâ‡∏≤, ‡∏´‡πâ‡∏≠‡∏á Generator"
                            />
                        </div>
                    </div>
                </div>

                {/* Photo Upload */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
                    <div className="flex items-center gap-4">
                        <div className="w-24 h-24 bg-gray-100 rounded-lg border border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                            {newMachine.photo ? (
                                <img src={newMachine.photo} alt="Preview" className="w-full h-full object-cover" />
                            ) : (
                                <Settings className="text-gray-300" size={32} />
                            )}
                        </div>
                        <div className="flex flex-col gap-2">
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center">
                                <ImageIcon size={16}/> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                <input type="file" accept="image/*" className="hidden" onChange={handleMachinePhotoUpload} />
                            </label>
                            <label className="cursor-pointer bg-white border border-gray-300 px-4 py-2 rounded-md text-sm hover:bg-gray-50 transition-colors flex items-center gap-2 justify-center text-orange-600 border-orange-200">
                                <Camera size={16}/> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
                                <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handleMachinePhotoUpload} />
                            </label>
                        </div>
                    </div>
                </div>

                <div className="flex justify-end gap-2 pt-4 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddMachineModal(false)}>{t('cancel')}</Button>
                    <Button type="submit">{t('save')}</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Add PM Plan Modal */}
      {showAddPmPlanModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <h2 className="text-xl font-bold text-gray-800">{newPmPlan.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô PM (Edit PM Plan)' : t('addPmPlan')}</h2>
              <button onClick={() => setShowAddPmPlanModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            <form onSubmit={handleSavePmPlan} className="space-y-4">
                
                {/* Select Machine */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">{t('col_machineName')}</label>
                    <select 
                        className="w-full border rounded-md p-2 bg-gray-50"
                        value={newPmPlan.machineId}
                        onChange={e => setNewPmPlan({...newPmPlan, machineId: e.target.value})}
                        required
                    >
                        <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ --</option>
                        {machines.filter(m => m.projectId === selectedProject.id).map(machine => (
                            <option key={machine.id} value={machine.id}>
                                {machine.code} : {machine.name}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Frequency */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">{t('pmFrequency')}</label>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                        {['Daily', 'Weekly', 'Monthly', 'Yearly'].map(freq => (
                            <button
                                key={freq}
                                type="button"
                                onClick={() => setNewPmPlan({...newPmPlan, frequency: freq})}
                                className={`py-2 text-xs font-medium rounded border transition-colors ${newPmPlan.frequency === freq ? 'bg-blue-50 border-blue-500 text-blue-700 shadow-sm' : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'}`}
                            >
                                {t(`freq_${freq}`)}
                            </button>
                        ))}
                    </div>
                </div>

                {/* Dynamic Schedule Details based on Frequency */}
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                    <h4 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                        <Calendar size={16}/> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Schedule Details)
                    </h4>
                    
                    {newPmPlan.frequency === 'Daily' && (
                        <div className="text-center text-gray-500 text-sm py-2">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PM ‡∏ô‡∏µ‡πâ <b>‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</b> ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </div>
                    )}

                    {newPmPlan.frequency === 'Weekly' && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
                            <select 
                                className="w-full border rounded-md p-2" 
                                value={newPmPlan.scheduleDetails.dayOfWeek} 
                                onChange={e => setNewPmPlan({...newPmPlan, scheduleDetails: {...newPmPlan.scheduleDetails, dayOfWeek: e.target.value}})}
                            >
                                <option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå (Monday)</option>
                                <option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ (Tuesday)</option>
                                <option value="3">‡∏û‡∏∏‡∏ò (Wednesday)</option>
                                <option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ (Thursday)</option>
                                <option value="5">‡∏®‡∏∏‡∏Å‡∏£‡πå (Friday)</option>
                                <option value="6">‡πÄ‡∏™‡∏≤‡∏£‡πå (Saturday)</option>
                                <option value="0">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (Sunday)</option>
                            </select>
                        </div>
                    )}

                    {newPmPlan.frequency === 'Monthly' && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-600">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                <input 
                                    type="number" 
                                    min="1" 
                                    max="31" 
                                    required
                                    className="w-24 border rounded-md p-2 text-center" 
                                    value={newPmPlan.scheduleDetails.date} 
                                    onChange={e => setNewPmPlan({...newPmPlan, scheduleDetails: {...newPmPlan.scheduleDetails, date: e.target.value}})} 
                                />
                                <span className="text-sm text-gray-600">‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            </div>
                        </div>
                    )}

                    {newPmPlan.frequency === 'Yearly' && (
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                <select 
                                    className="w-full border rounded-md p-2" 
                                    value={newPmPlan.scheduleDetails.month} 
                                    onChange={e => setNewPmPlan({...newPmPlan, scheduleDetails: {...newPmPlan.scheduleDetails, month: e.target.value}})}
                                >
                                    {['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'].map((m, idx) => (
                                        <option key={idx+1} value={idx+1}>{m}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input 
                                    type="number" 
                                    min="1" 
                                    max="31" 
                                    required
                                    className="w-full border rounded-md p-2" 
                                    value={newPmPlan.scheduleDetails.date} 
                                    onChange={e => setNewPmPlan({...newPmPlan, scheduleDetails: {...newPmPlan.scheduleDetails, date: e.target.value}})} 
                                />
                            </div>
                        </div>
                    )}
                </div>

                <div className="flex justify-end gap-2 pt-4 border-t mt-6">
                    <Button variant="secondary" onClick={() => setShowAddPmPlanModal(false)}>{t('cancel')}</Button>
                    <Button type="submit">{t('save')}</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Daily Report Modal (Adjusted Layout for A4) */}
      {showAddDailyReportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-[210mm] p-8 m-4 max-h-[95vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-6 border-b pb-4">
              <div>
                  <h2 className="text-2xl font-bold text-gray-800">{newDailyReport.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Edit Report)' : t('dailyReportTitle')}</h2>
                  <p className="text-sm text-gray-500">{t('col_date')}: {new Date(newDailyReport.date).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
              </div>
              <button onClick={() => setShowAddDailyReportModal(false)}><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveDailyReport}>
                {/* Section 1: Manpower & Income (Side by Side) */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    {/* Left: Manpower */}
                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h3 className="font-bold text-blue-800 mb-3 flex items-center gap-2 text-sm"><Users size={16}/> {t('manpowerReport')}</h3>
                        <div className="space-y-2 text-xs">
                            {['juristic', 'security', 'cleaning', 'gardening', 'sweeper'].map(dept => (
                                <div key={dept} className="flex justify-between items-center bg-white p-1.5 rounded border">
                                    <span>{t('dept_' + dept)}</span>
                                    <input type="number" min="0" className="w-12 text-right border rounded p-0.5" value={newDailyReport.manpower[dept]} onChange={(e) => handleDailyManpowerChange(dept, e.target.value)} />
                                </div>
                            ))}
                            <div className="flex gap-2 items-center bg-white p-1.5 rounded border">
                                <input type="text" className="flex-1 border-b border-dashed outline-none text-xs" placeholder={t('dept_other')} value={newDailyReport.manpower.otherLabel} onChange={(e) => handleDailyManpowerChange('otherLabel', e.target.value)} />
                                <input type="number" min="0" className="w-12 text-right border rounded p-0.5" value={newDailyReport.manpower.other} onChange={(e) => handleDailyManpowerChange('other', e.target.value)} />
                            </div>
                        </div>
                    </div>

                    {/* Right: Income */}
                    <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                        <h3 className="font-bold text-green-800 mb-3 flex items-center gap-2 text-sm"><DollarSign size={16}/> {t('incomeReport')}</h3>
                        <div className="space-y-2 text-xs">
                            {['commonFee', 'lateFee', 'water', 'parking', 'violation'].map(item => (
                                <div key={item} className="flex justify-between items-center">
                                    <span className="text-gray-600">{t('inc_' + item)}</span>
                                    <div className="relative w-24">
                                        <input type="number" className="w-full text-right border rounded p-0.5" value={newDailyReport.income[item]} onChange={(e) => handleDailyIncomeChange(item, e.target.value)} placeholder="0" />
                                    </div>
                                </div>
                            ))}
                            <div className="flex justify-between items-center">
                                <input type="text" className="text-xs border-b border-dashed outline-none bg-transparent w-24" placeholder={t('inc_other')} value={newDailyReport.income.otherLabel} onChange={(e) => handleDailyIncomeChange('otherLabel', e.target.value)} />
                                <div className="relative w-24">
                                    <input type="number" className="w-full text-right border rounded p-0.5" value={newDailyReport.income.other} onChange={(e) => handleDailyIncomeChange('other', e.target.value)} placeholder="0" />
                                </div>
                            </div>
                            <div className="border-t border-green-200 pt-2 mt-2 flex justify-between items-center font-bold text-green-900 text-sm">
                                <span>{t('totalIncome')}</span>
                                <span>‡∏ø {calculateTotalDailyIncome().toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Section 2: Performance (Grid Layout) */}
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2 text-sm"><ClipboardList size={16}/> {t('performanceReport')}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {['juristic', 'security', 'cleaning', 'gardening', 'sweeper', 'other'].map(dept => (
                            <div key={dept} className="bg-white p-3 rounded border shadow-sm flex flex-col">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="font-semibold text-xs text-orange-600">{t('dept_' + dept)}</div>
                                    <div className="flex items-center gap-2">
                                        <label className="cursor-pointer text-gray-400 hover:text-blue-500 transition-colors" title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                                            <ImageIcon size={14} />
                                            <input type="file" accept="image/*" className="hidden" onChange={(e) => handleDailyPerformanceImageUpload(dept, e.target.files[0])} />
                                        </label>
                                        <label className="cursor-pointer text-gray-400 hover:text-orange-500 transition-colors" title="‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á">
                                            <Camera size={14} />
                                            <input type="file" accept="image/*" capture="environment" className="hidden" onChange={(e) => handleDailyPerformanceImageUpload(dept, e.target.files[0])} />
                                        </label>
                                    </div>
                                </div>
                                <textarea 
                                    className="w-full border rounded p-2 text-xs h-20 mb-2 focus:ring-1 focus:ring-orange-300 outline-none resize-none bg-gray-50 focus:bg-white transition-colors" 
                                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô..."
                                    value={newDailyReport.performance[dept]?.details || ''}
                                    onChange={(e) => handleDailyPerformanceChange(dept, e.target.value)}
                                ></textarea>
                                
                                {/* Tiny Image Preview */}
                                {newDailyReport.performance[dept]?.images?.length > 0 && (
                                    <div className="flex flex-wrap gap-1 mt-auto pt-1 border-t border-dashed">
                                        {newDailyReport.performance[dept].images.map((img, idx) => (
                                            <div key={idx} className="relative w-8 h-8 rounded overflow-hidden border group">
                                                <img src={img} alt="Work" className="w-full h-full object-cover" />
                                                <button 
                                                    type="button"
                                                    onClick={() => removeDailyPerformanceImage(dept, idx)}
                                                    className="absolute inset-0 bg-red-500 bg-opacity-50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                                >
                                                    <X size={10} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                {/* Section 3: Additional Note */}
                <div className="mb-6">
                     <h3 className="font-bold text-gray-700 mb-2 text-sm">{t('additionalDetails')}</h3>
                     <textarea 
                        className="w-full border rounded-md p-3 text-sm h-20 focus:ring-2 focus:ring-orange-500 outline-none resize-none"
                        value={newDailyReport.note}
                        onChange={(e) => setNewDailyReport({...newDailyReport, note: e.target.value})}
                        placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."
                     ></textarea>
                </div>

                <div className="mt-6 flex justify-between items-center border-t pt-4">
                    <div className="flex items-center gap-2 text-sm text-gray-600">
                        <User size={16} /> {t('reporter')}: <span className="font-semibold text-gray-800">{newDailyReport.reporter}</span>
                    </div>
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={() => setShowAddDailyReportModal(false)}>{t('cancel')}</Button>
                        <Button type="submit" icon={Save}>{t('save')}</Button>
                    </div>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Selected Daily Report View Modal */}
      {selectedDailyReport && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-[210mm] p-8 m-4 max-h-[95vh] overflow-y-auto relative">
                <button 
                    onClick={() => setSelectedDailyReport(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div id="print-daily-report" className="space-y-6">
                    {/* Header */}
                    <div className="text-center border-b pb-4 mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">{t('dailyReportTitle')}</h2>
                        <div className="flex justify-center gap-4 text-sm text-gray-500 mt-2">
                             <span>{t('col_project')}: {projects.find(p => p.id === selectedDailyReport.projectId)?.name}</span>
                             <span>|</span>
                             <span>{t('col_date')}: {new Date(selectedDailyReport.date).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</span>
                        </div>
                    </div>

                    {/* Content Body (Read-only A4 Layout) */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Manpower */}
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 className="font-bold text-blue-800 mb-3 flex items-center gap-2 text-sm"><Users size={16}/> {t('manpowerReport')}</h3>
                            <div className="space-y-1 text-xs">
                                {['juristic', 'security', 'cleaning', 'gardening', 'sweeper'].map(dept => (
                                    <div key={dept} className="flex justify-between py-1 border-b border-blue-200 last:border-0">
                                        <span>{t('dept_' + dept)}</span>
                                        <span className="font-bold">{selectedDailyReport.manpower[dept] || 0}</span>
                                    </div>
                                ))}
                                {selectedDailyReport.manpower.otherLabel && (
                                    <div className="flex justify-between py-1 border-t border-blue-200 mt-1">
                                        <span>{selectedDailyReport.manpower.otherLabel}</span>
                                        <span className="font-bold">{selectedDailyReport.manpower.other || 0}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Income */}
                        <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                            <h3 className="font-bold text-green-800 mb-3 flex items-center gap-2 text-sm"><DollarSign size={16}/> {t('incomeReport')}</h3>
                             <div className="space-y-1 text-xs">
                                {['commonFee', 'lateFee', 'water', 'parking', 'violation'].map(item => (
                                    <div key={item} className="flex justify-between py-1 border-b border-green-200 last:border-0">
                                        <span>{t('inc_' + item)}</span>
                                        <span>{Number(selectedDailyReport.income[item] || 0).toLocaleString()}</span>
                                    </div>
                                ))}
                                {selectedDailyReport.income.otherLabel && (
                                    <div className="flex justify-between py-1">
                                        <span>{selectedDailyReport.income.otherLabel}</span>
                                        <span>{Number(selectedDailyReport.income.other || 0).toLocaleString()}</span>
                                    </div>
                                )}
                                <div className="border-t border-green-300 pt-2 mt-2 flex justify-between font-bold text-green-900">
                                    <span>{t('totalIncome')}</span>
                                    <span>‡∏ø {(() => {
                                        const { commonFee, lateFee, water, parking, violation, other } = selectedDailyReport.income;
                                        return (Number(commonFee) + Number(lateFee) + Number(water) + Number(parking) + Number(violation) + Number(other)).toLocaleString();
                                    })()}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Performance */}
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2 text-sm"><ClipboardList size={16}/> {t('performanceReport')}</h3>
                        <div className="grid grid-cols-2 gap-4">
                            {['juristic', 'security', 'cleaning', 'gardening', 'sweeper', 'other'].map(dept => {
                                const deptData = selectedDailyReport.performance?.[dept];
                                if (!deptData || (!deptData.details && (!deptData.images || deptData.images.length === 0))) return null;
                                return (
                                    <div key={dept} className="bg-white p-3 rounded border shadow-sm">
                                        <div className="font-semibold text-xs text-orange-600 mb-1">{t('dept_' + dept)}</div>
                                        <div className="text-xs text-gray-700 whitespace-pre-wrap mb-2">{deptData.details || '-'}</div>
                                        {deptData.images && deptData.images.length > 0 && (
                                            <div className="flex flex-wrap gap-1">
                                                {deptData.images.map((img, idx) => (
                                                    <div key={idx} className="w-12 h-12 rounded overflow-hidden border">
                                                        <img src={img} className="w-full h-full object-cover" />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* Notes */}
                    {selectedDailyReport.note && (
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                             <h3 className="font-bold text-yellow-800 mb-1 text-sm">{t('additionalDetails')}</h3>
                             <p className="text-xs text-gray-700">{selectedDailyReport.note}</p>
                        </div>
                    )}
                    
                    {/* Footer */}
                    <div className="flex justify-between items-end pt-8 mt-4 border-t">
                        <div className="text-xs text-gray-400">Ref: {selectedDailyReport.id}</div>
                        <div className="text-center">
                            <div className="text-sm font-bold">{selectedDailyReport.reporter}</div>
                            <div className="text-xs text-gray-500">{t('reporter')}</div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2">
                    {hasPerm('proj_daily', 'edit') && !isExporting && (
                        <Button variant="outline" icon={Edit} onClick={() => handleEditDailyReport(selectedDailyReport)}>
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </Button>
                    )}
                    <Button variant="secondary" onClick={() => setSelectedDailyReport(null)}>{t('close')}</Button>
                    <Button icon={Printer} onClick={() => handleExportPDF('print-daily-report', `DailyReport_${selectedDailyReport.date}.pdf`, 'portrait')} disabled={isExporting}>{isExporting ? t('downloading') : t('printPDF')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: PM Checklist Form Modal */}
      {showPmFormModal && currentPmTask && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 m-4 max-h-[95vh] overflow-y-auto">
            <div className="flex justify-between items-start mb-4 border-b pb-4">
              <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      <CheckSquare className="text-orange-600" size={24}/>
                      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (PM Checklist)
                  </h2>
                  <p className="text-sm text-gray-500 mt-1 flex items-center gap-2">
                      <Calendar size={14} /> ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}
                  </p>
              </div>
              <button onClick={() => setShowPmFormModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 grid grid-cols-2 gap-4 text-sm">
                <div><span className="text-gray-500">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <span className="font-bold font-mono text-gray-800">{currentPmTask.machine?.code}</span></div>
                <div><span className="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <span className="font-bold text-gray-800">{currentPmTask.machine?.name}</span></div>
                <div><span className="text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö:</span> <span className="text-gray-800">{currentPmTask.machine?.system}</span></div>
            </div>

            <form onSubmit={handleSavePmForm} className="space-y-6">
                <div>
                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2 border-b pb-2">
                        <Wrench size={16}/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (Standard Checklist)
                    </h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-100 text-gray-600">
                                <tr>
                                    <th className="p-2 text-center w-10 rounded-tl-md">#</th>
                                    <th className="p-2 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspection Item)</th>
                                    <th className="p-2 text-center w-20">‡∏õ‡∏Å‡∏ï‡∏¥<br/><span className="text-[10px] font-normal">(Pass)</span></th>
                                    <th className="p-2 text-center w-20">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥<br/><span className="text-[10px] font-normal">(Fail)</span></th>
                                    <th className="p-2 text-center w-48 rounded-tr-md">‡πÑ‡∏°‡πà‡∏°‡∏µ (N/A) / ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {getChecklistForSystem(currentPmTask.machine?.system).map((item, idx) => {
                                    const key = `item_${idx}`;
                                    const answer = pmFormAnswers[key];
                                    return (
                                        <tr key={idx} className="hover:bg-gray-50">
                                            <td className="p-2 text-center text-gray-500 font-medium">{idx + 1}</td>
                                            <td className="p-2 text-gray-800">{item}</td>
                                            <td className="p-2 text-center">
                                                <label className="cursor-pointer flex justify-center">
                                                    <input 
                                                        type="radio" 
                                                        name={key} 
                                                        className="w-5 h-5 text-green-500 accent-green-600 cursor-pointer" 
                                                        checked={answer === 'pass'} 
                                                        onChange={() => {
                                                            setPmFormAnswers({...pmFormAnswers, [key]: 'pass'});
                                                            setPmFormIssues({...pmFormIssues, [key]: ''}); // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏õ‡∏Å‡∏ï‡∏¥
                                                        }} 
                                                        required
                                                    />
                                                </label>
                                            </td>
                                            <td className="p-2 text-center">
                                                <label className="cursor-pointer flex justify-center">
                                                    <input 
                                                        type="radio" 
                                                        name={key} 
                                                        className="w-5 h-5 text-red-500 accent-red-600 cursor-pointer" 
                                                        checked={answer === 'fail'} 
                                                        onChange={() => setPmFormAnswers({...pmFormAnswers, [key]: 'fail'})} 
                                                        required
                                                    />
                                                </label>
                                            </td>
                                            <td className="p-2 text-center">
                                                {answer === 'fail' ? (
                                                    <input 
                                                        type="text"
                                                        className="w-full border border-red-300 rounded p-1 text-xs focus:ring-1 focus:ring-red-500 outline-none bg-red-50 text-red-700 placeholder-red-300"
                                                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏±‡∏ç‡∏´‡∏≤..."
                                                        value={pmFormIssues[key] || ''}
                                                        onChange={(e) => setPmFormIssues({...pmFormIssues, [key]: e.target.value})}
                                                        required
                                                    />
                                                ) : (
                                                    <label className="cursor-pointer flex justify-center">
                                                        <input 
                                                            type="radio" 
                                                            name={key} 
                                                            className="w-5 h-5 text-gray-400 accent-gray-500 cursor-pointer" 
                                                            checked={answer === 'na'} 
                                                            onChange={() => {
                                                                setPmFormAnswers({...pmFormAnswers, [key]: 'na'});
                                                                setPmFormIssues({...pmFormIssues, [key]: ''});
                                                            }} 
                                                            required={answer !== 'fail'}
                                                        />
                                                    </label>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                     <h3 className="font-bold text-gray-700 mb-2 text-sm border-b pb-2 flex items-center gap-2">
                         <PenTool size={16}/> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (Remarks & Recommendations)
                     </h3>
                     <textarea 
                        className="w-full border rounded-md p-3 text-sm h-24 focus:ring-2 focus:ring-orange-500 outline-none resize-none bg-yellow-50 focus:bg-white transition-colors"
                        value={pmFormRemark}
                        onChange={(e) => setPmFormRemark(e.target.value)}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô..."
                     ></textarea>
                </div>

                {/* Photo Upload Area for PM */}
                <div>
                     <h3 className="font-bold text-gray-700 mb-2 text-sm border-b pb-2 flex items-center gap-2">
                         <Camera size={16}/> ‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Photos)
                     </h3>
                     <div className="flex flex-wrap gap-2">
                         {pmFormImages.map((img, idx) => (
                             <div key={idx} className="relative w-24 h-24 rounded-lg overflow-hidden border border-gray-300 group">
                                 <img src={img} alt={`PM Photo ${idx+1}`} className="w-full h-full object-cover" />
                                 <button 
                                     type="button"
                                     onClick={() => removePmFormImage(idx)}
                                     className="absolute inset-0 bg-red-500 bg-opacity-50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                                 >
                                     <X size={20} />
                                 </button>
                             </div>
                         ))}
                         <div className="flex flex-col gap-2">
                             <label className="w-24 h-[44px] bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-500 cursor-pointer hover:bg-gray-100 transition-colors">
                                 <ImageIcon size={14} className="mr-1"/> <span className="text-[10px]">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span>
                                 <input type="file" accept="image/*" className="hidden" onChange={handlePmFormImageUpload} />
                             </label>
                             <label className="w-24 h-[44px] bg-orange-50 border-2 border-dashed border-orange-300 rounded-lg flex items-center justify-center text-orange-600 cursor-pointer hover:bg-orange-100 transition-colors">
                                 <Camera size={14} className="mr-1"/> <span className="text-[10px] font-bold">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
                                 <input type="file" accept="image/*" capture="environment" className="hidden" onChange={handlePmFormImageUpload} />
                             </label>
                         </div>
                     </div>
                </div>

                <div className="flex justify-between items-center border-t pt-4">
                    <div className="text-sm text-gray-500 flex items-center gap-2">
                        <User size={16}/> ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: <span className="font-semibold text-gray-800">{currentUser?.firstName} {currentUser?.lastName}</span>
                    </div>
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={() => setShowPmFormModal(false)}>{t('cancel')}</Button>
                        <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</Button>
                    </div>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: Selected PM History View Modal */}
      {selectedPmHistory && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-[210mm] p-8 m-4 max-h-[95vh] overflow-y-auto relative">
                <button 
                    onClick={() => setSelectedPmHistory(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div id="print-pm-history-report" className="space-y-6">
                    {/* Header */}
                    <div className="text-center border-b pb-4 mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô (PM Report)</h2>
                        <div className="flex justify-center gap-4 text-sm text-gray-500 mt-2">
                             <span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {projects.find(p => p.id === selectedPmHistory.projectId)?.name}</span>
                             <span>|</span>
                             <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (Plan): {new Date(selectedPmHistory.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</span>
                             {selectedPmHistory.executedDate && selectedPmHistory.executedDate !== selectedPmHistory.date && (
                                 <>
                                     <span>|</span>
                                     <span className="text-gray-700 font-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á (Act): {new Date(selectedPmHistory.executedDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</span>
                                 </>
                             )}
                        </div>
                    </div>

                    {/* Machine Info */}
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 grid grid-cols-2 gap-4 text-sm">
                        <div><span className="text-gray-500">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <span className="font-bold font-mono text-gray-800">{selectedPmHistory.machineCode}</span></div>
                        <div><span className="text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</span> <span className="font-bold text-gray-800">{selectedPmHistory.machineName}</span></div>
                        <div className="flex items-center gap-2">
                            <span className="text-gray-500">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span> 
                            {selectedPmHistory.executionTimingStatus ? (
                                <span className={`px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 w-fit ${
                                    selectedPmHistory.executionTimingStatus === '‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? 'bg-blue-100 text-blue-700 border border-blue-200' :
                                    selectedPmHistory.executionTimingStatus === '‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? 'bg-red-100 text-red-700 border border-red-200' :
                                    'bg-green-100 text-green-700 border border-green-200'
                                }`}>
                                    {selectedPmHistory.executionTimingStatus === '‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? <ChevronLeft size={12}/> : selectedPmHistory.executionTimingStatus === '‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' ? <Clock size={12}/> : <CheckCircle size={12}/>}
                                    {selectedPmHistory.executionTimingStatus}
                                </span>
                            ) : (
                                <span className="text-gray-400">-</span>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-gray-500">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏ß‡∏°:</span> 
                            {selectedPmHistory.status === 'Pass' ? (
                                <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1"><CheckCircle size={14}/> ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span>
                            ) : (
                                <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1"><AlertTriangle size={14}/> ‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</span> 
                            {selectedPmHistory.approvalStatus === 'Approved' || !selectedPmHistory.approvalStatus ? (
                                <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                            ) : selectedPmHistory.approvalStatus === 'Pending Chief' ? (
                                <span className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded text-xs font-bold">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            ) : selectedPmHistory.approvalStatus === 'Pending Manager' ? (
                                <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            ) : selectedPmHistory.approvalStatus === 'Rejected' ? (
                                <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                            ) : null}
                        </div>
                    </div>

                    {/* Checklist Results */}
                    <div>
                        <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2 border-b pb-2">
                            <ClipboardCheck size={16}/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspection Results)
                        </h3>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm border-collapse">
                                <thead className="bg-gray-100 text-gray-600">
                                    <tr>
                                        <th className="p-2 border border-gray-200 text-center w-10">#</th>
                                        <th className="p-2 border border-gray-200 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                                        <th className="p-2 border border-gray-200 text-center w-24">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                                        <th className="p-2 border border-gray-200 text-left">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        const machine = machines.find(m => m.id === selectedPmHistory.machineId);
                                        const systemName = machine ? machine.system : '';
                                        const checklist = getChecklistForSystem(systemName);
                                        
                                        return checklist.map((item, idx) => {
                                            const key = `item_${idx}`;
                                            const answer = selectedPmHistory.answers[key];
                                            const issue = selectedPmHistory.issues[key];
                                            
                                            let statusBadge;
                                            if (answer === 'pass') statusBadge = <span className="text-green-600 font-bold flex items-center justify-center"><CheckCircle size={16} className="mr-1"/> ‡∏õ‡∏Å‡∏ï‡∏¥</span>;
                                            else if (answer === 'fail') statusBadge = <span className="text-red-600 font-bold flex items-center justify-center"><XCircle size={16} className="mr-1"/> ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>;
                                            else if (answer === 'na') statusBadge = <span className="text-gray-400 font-medium">N/A</span>;
                                            else statusBadge = <span className="text-gray-300">-</span>;

                                            return (
                                                <tr key={idx}>
                                                    <td className="p-2 border border-gray-200 text-center text-gray-500 font-medium">{idx + 1}</td>
                                                    <td className="p-2 border border-gray-200 text-gray-800">{item}</td>
                                                    <td className="p-2 border border-gray-200 text-center">{statusBadge}</td>
                                                    <td className={`p-2 border border-gray-200 text-xs ${answer === 'fail' ? 'text-red-600 font-medium' : 'text-gray-500'}`}>
                                                        {issue || '-'}
                                                    </td>
                                                </tr>
                                            );
                                        });
                                    })()}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Summary & Remarks */}
                    <div className="pt-4">
                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                             <h3 className="font-bold text-yellow-800 mb-1 text-sm flex items-center gap-1"><PenTool size={14}/> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</h3>
                             <p className="text-xs text-gray-700 whitespace-pre-wrap">{selectedPmHistory.remark || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p>
                        </div>
                    </div>
                    
                    {/* Photos */}
                    {selectedPmHistory.images && selectedPmHistory.images.length > 0 && (
                        <div className="pt-4">
                            <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2 border-b pb-2">
                                <Camera size={16}/> ‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                            </h3>
                            <div className="flex flex-wrap gap-2">
                                {selectedPmHistory.images.map((img, idx) => (
                                    <div key={idx} className="w-32 h-32 rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                        <img src={img} alt="PM Evidence" className="w-full h-full object-cover" />
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Signatures Area */}
                    <div className="flex justify-between px-4 pt-16 pb-4 mt-6 border-t border-gray-300 gap-4 flex-wrap">
                        <div className="text-center w-48">
                            <div className="border-b border-gray-400 mb-2 h-8 text-blue-800 font-serif italic flex items-end justify-center pb-1">
                                {selectedPmHistory.inspector}
                            </div>
                            <div className="text-xs font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspector)</div>
                            <div className="text-[10px] text-gray-500 mt-1">{new Date(selectedPmHistory.date).toLocaleDateString('th-TH')}</div>
                        </div>

                        {/* Map Dynamic Approvals */}
                        {selectedPmHistory.approvals && selectedPmHistory.approvals.map((app, idx) => (
                             <div className="text-center w-48" key={idx}>
                                <div className="border-b border-gray-400 mb-2 h-8 text-blue-800 font-serif italic flex items-end justify-center pb-1 relative">
                                    {app.action === 'Rejected' && <span className="absolute -top-4 right-0 text-red-500 font-sans font-bold border-2 border-red-500 rounded px-1.5 py-0.5 transform rotate-12 text-xs">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>}
                                    {app.action === 'Approved' && <span className="absolute -top-4 right-0 text-green-500 font-sans font-bold border-2 border-green-500 rounded px-1.5 py-0.5 transform rotate-12 text-xs">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>}
                                    {app.approver}
                                </div>
                                <div className="text-xs font-bold text-gray-800 mt-1 truncate px-2" title={app.role}>{app.role}</div>
                                <div className="text-[10px] text-gray-500 mt-1">{new Date(app.date).toLocaleDateString('th-TH')}</div>
                            </div>
                        ))}
                        
                        {/* Placeholder for Pending Approvals */}
                        {selectedPmHistory.approvalStatus === 'Pending Chief' && (
                            <div className="text-center w-48 opacity-50">
                                <div className="border-b border-gray-400 mb-2 h-8"></div>
                                <div className="text-xs font-bold text-gray-800 mt-1">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á (Chief)</div>
                            </div>
                        )}
                        {(selectedPmHistory.approvalStatus === 'Pending Manager' || selectedPmHistory.approvalStatus === 'Pending Chief') && (
                            <div className="text-center w-48 opacity-50">
                                <div className="border-b border-gray-400 mb-2 h-8"></div>
                                <div className="text-xs font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Manager)</div>
                            </div>
                        )}
                    </div>
                    
                    {/* Footer Info */}
                    <div className="flex justify-between items-end mt-4 pt-4 border-t text-[10px] text-gray-400">
                        <div>Ref ID: {selectedPmHistory.id}</div>
                        <div>Generated by Best Million Group System</div>
                    </div>
                </div>

                <div className="mt-8 flex justify-between items-center gap-2 border-t pt-4 bg-white">
                    <div>
                        {(() => {
                            // Check if current user can approve
                            if (!selectedPmHistory) return null;
                            const status = selectedPmHistory.approvalStatus;
                            if (status === 'Approved' || status === 'Rejected' || !status) return null; // Old data doesn't have status

                            const isChiefUser = currentUser?.position.includes('‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á');
                            const isManagerUser = currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£') && !currentUser?.position.includes('‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢');
                            const isAdminUser = currentUser?.username === 'admin' || currentUser?.position === 'Super Admin';

                            let canApprove = false;
                            if (isAdminUser) canApprove = true;
                            if (status === 'Pending Chief' && isChiefUser) canApprove = true;
                            if (status === 'Pending Manager' && isManagerUser) canApprove = true;

                            if (canApprove && !isExporting) {
                                return (
                                    <div className="flex gap-2">
                                        <Button variant="danger" icon={XCircle} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥) ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => handleApprovePmAction(selectedPmHistory, 'Rejected'))}>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</Button>
                                        <Button variant="success" icon={CheckCircle} onClick={() => showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => handleApprovePmAction(selectedPmHistory, 'Approved'))}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                                    </div>
                                );
                            }
                            return null;
                        })()}
                    </div>
                    <div className="flex gap-2">
                        <Button variant="secondary" onClick={() => setSelectedPmHistory(null)}>{t('close')}</Button>
                        <Button icon={Printer} onClick={() => handleExportPDF('print-pm-history-report', `PM_Report_${selectedPmHistory.machineCode}.pdf`, 'portrait')} disabled={isExporting}>
                            {isExporting ? t('downloading') : '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF'}
                        </Button>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Selected Machine Details Modal */}
      {selectedMachineDetails && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 max-h-[95vh] overflow-y-auto relative animate-fade-in">
                <button 
                    onClick={() => setSelectedMachineDetails(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div className="mb-6 border-b pb-4">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Settings className="text-red-600"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h2>
                    <p className="text-sm text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Machine Details)</p>
                </div>

                <div className="flex flex-col md:flex-row gap-8 mb-6">
                    {/* Photo */}
                    <div className="w-full md:w-1/3 flex flex-col items-center">
                        <div className="w-48 h-48 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden shadow-sm">
                            {selectedMachineDetails.photo ? (
                                <img src={selectedMachineDetails.photo} alt={selectedMachineDetails.name} className="w-full h-full object-cover" />
                            ) : (
                                <Settings className="text-gray-300" size={64} />
                            )}
                        </div>
                    </div>
                    {/* Details */}
                    <div className="w-full md:w-2/3 space-y-4">
                        <div className="grid grid-cols-2 gap-y-5 gap-x-4 text-sm">
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Code)</span>
                                <span className="font-mono font-bold text-lg text-red-600 bg-red-50 px-2 py-1 rounded">{selectedMachineDetails.code}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Name)</span>
                                <span className="font-bold text-gray-800 text-base">{selectedMachineDetails.name}</span>
                            </div>
                            <div className="col-span-2 border-t border-gray-100 pt-3">
                                <span className="text-gray-500 block text-xs mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (System)</span>
                                <span className="text-gray-700 bg-gray-100 px-3 py-1.5 rounded-md inline-block font-medium border border-gray-200">{selectedMachineDetails.system}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á (Location)</span>
                                <span className="text-gray-800 flex items-center gap-1"><MapPin size={14} className="text-gray-400"/> {selectedMachineDetails.location || '-'}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Qty)</span>
                                <span className="text-gray-800 font-bold">{selectedMachineDetails.qty} Unit(s)</span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Linked PM Plans */}
                <div className="mt-4">
                    <h3 className="font-bold text-gray-700 mb-3 text-sm flex items-center gap-2 border-b pb-2">
                        <Calendar size={16} className="text-blue-600"/> ‡πÅ‡∏ú‡∏ô‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ (Linked PM Plans)
                    </h3>
                    <div className="bg-gray-50 rounded-lg border border-gray-200 max-h-40 overflow-y-auto">
                        {pmPlans.filter(p => p.machineId === selectedMachineDetails.id).length > 0 ? (
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-100 text-gray-600 text-xs">
                                    <tr>
                                        <th className="p-2 pl-4">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Frequency)</th>
                                        <th className="p-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£</th>
                                        <th className="p-2 text-center pr-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {pmPlans.filter(p => p.machineId === selectedMachineDetails.id).map(plan => {
                                        let scheduleText = '-';
                                        const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
                                        const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                                        if (plan.frequency === 'Weekly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô${days[plan.scheduleDetails.dayOfWeek] || ''}`;
                                        else if (plan.frequency === 'Monthly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${plan.scheduleDetails.date} ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
                                        else if (plan.frequency === 'Yearly') scheduleText = `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${plan.scheduleDetails.date} ${months[parseInt(plan.scheduleDetails.month)-1] || ''}`;
                                        else if (plan.frequency === 'Daily') scheduleText = '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô (Everyday)';

                                        return (
                                            <tr key={plan.id}>
                                                <td className="p-2 pl-4 font-medium text-blue-700">{t(`freq_${plan.frequency}`)}</td>
                                                <td className="p-2 text-gray-600">{scheduleText}</td>
                                                <td className="p-2 text-center pr-4"><Badge status={plan.status} /></td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                        ) : (
                            <div className="text-center text-gray-500 text-xs py-6 flex flex-col items-center gap-2">
                                <FileText size={24} className="text-gray-300"/>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô PM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ô‡∏µ‡πâ
                            </div>
                        )}
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2 pt-4 border-t">
                    {hasPerm('proj_pm', 'edit') && (
                        <Button variant="outline" icon={Edit} onClick={() => handleEditMachine(selectedMachineDetails)}>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                    )}
                    <Button variant="secondary" onClick={() => setSelectedMachineDetails(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* Add Meter Modal */}
      {showAddMeterModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-8 m-4 animate-fade-in">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    {newMeter.id ? <Edit className="text-orange-500" size={20}/> : <Plus className="text-red-600" size={20}/>} 
                    {newMeter.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'}
                </h2>
                <p className="text-sm text-gray-500 mt-1">{newMeter.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå' : '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà'}</p>
              </div>
              <button onClick={() => setShowAddMeterModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            <form onSubmit={handleSaveMeter} className="space-y-5">
                
                {/* Type Selection */}
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</label>
                    <div className="grid grid-cols-2 gap-3">
                        <button
                            type="button"
                            onClick={() => setNewMeter({...newMeter, type: 'Water'})}
                            className={`py-3 px-4 rounded-lg border-2 flex items-center justify-center gap-2 transition-all ${newMeter.type === 'Water' ? 'bg-blue-50 border-blue-500 text-blue-700 font-bold shadow-sm' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50 hover:border-gray-300'}`}
                        >
                            <Droplet size={20} /> ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤
                        </button>
                        <button
                            type="button"
                            onClick={() => setNewMeter({...newMeter, type: 'Electricity'})}
                            className={`py-3 px-4 rounded-lg border-2 flex items-center justify-center gap-2 transition-all ${newMeter.type === 'Electricity' ? 'bg-orange-50 border-orange-500 text-orange-700 font-bold shadow-sm' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50 hover:border-gray-300'}`}
                        >
                            <Zap size={20} /> ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
                        </button>
                    </div>
                </div>

                <div className="border-t border-gray-100 pt-4">
                    <label className="block text-sm font-bold text-gray-700 mb-4">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</label>
                    <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Code)</label>
                                <input 
                                    type="text" 
                                    required 
                                    className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-red-200 focus:border-red-500 outline-none uppercase font-mono text-sm bg-gray-50 focus:bg-white transition-colors"
                                    value={newMeter.code}
                                    onChange={e => setNewMeter({...newMeter, code: e.target.value})}
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô M-001"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                <input 
                                    type="text" 
                                    className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-red-200 focus:border-red-500 outline-none text-sm bg-gray-50 focus:bg-white transition-colors"
                                    value={newMeter.name}
                                    onChange={e => setNewMeter({...newMeter, name: e.target.value})}
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A"
                                />
                            </div>
                        </div>

                        {/* Location */}
                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</label>
                            <div className="relative">
                                <MapPin size={16} className="absolute left-3 top-3 text-gray-400"/>
                                <input 
                                    type="text" 
                                    required
                                    className="w-full border border-gray-300 rounded-md pl-9 p-2.5 focus:ring-2 focus:ring-red-200 focus:border-red-500 outline-none text-sm bg-gray-50 focus:bg-white transition-colors"
                                    value={newMeter.location}
                                    onChange={e => setNewMeter({...newMeter, location: e.target.value})}
                                    placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô 1 ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡πÄ‡∏™‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"
                                />
                            </div>
                        </div>

                        {/* Initial Value */}
                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">{newMeter.id ? '‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)' : '‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤ / ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Initial Value)'}</label>
                            <input 
                                type="number" 
                                step="0.01"
                                required
                                className="w-full border border-gray-300 rounded-md p-3 focus:ring-2 focus:ring-red-200 focus:border-red-500 outline-none text-right font-bold text-gray-800 text-lg bg-gray-50 focus:bg-white transition-colors"
                                value={newMeter.initialValue}
                                onChange={e => setNewMeter({...newMeter, initialValue: e.target.value})}
                                placeholder="0.00"
                            />
                            <p className="text-[11px] text-gray-400 mt-1 flex items-center gap-1">
                                *‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏¢‡∏Å‡∏°‡∏≤ (Prev Value) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏î‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                            </p>
                        </div>
                    </div>
                </div>

                <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddMeterModal(false)}>{t('cancel')}</Button>
                    <Button type="submit" icon={Save} className={newMeter.id ? "bg-orange-600 hover:bg-orange-700 px-6" : "bg-red-600 hover:bg-red-700 px-6"}>
                        {newMeter.id ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'}
                    </Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Add/Edit Action Plan Modal */}
      {showAddActionPlanModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 animate-fade-in">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <CheckCircle className="text-orange-500" size={24}/> 
                    {newActionPlan.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Action Plan' : '‡πÄ‡∏û‡∏¥‡πà‡∏° Action Plan'}
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</p>
              </div>
              <button onClick={() => setShowAddActionPlanModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveActionPlan} className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏á‡∏≤‡∏ô (Issue/Task) <span className="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm transition-colors"
                        value={newActionPlan.issue}
                        onChange={e => setNewActionPlan({...newActionPlan, issue: e.target.value})}
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏£‡∏±‡πà‡∏ß‡∏ä‡∏±‡πâ‡∏ô 5, ‡πÑ‡∏ü‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢"
                    />
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</label>
                    <textarea 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm h-24 resize-none transition-colors"
                        value={newActionPlan.details}
                        onChange={e => setNewActionPlan({...newActionPlan, details: e.target.value})}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..."
                    ></textarea>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Assignee)</label>
                    <select 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 outline-none text-sm bg-white"
                        value={newActionPlan.responsible}
                        onChange={e => setNewActionPlan({...newActionPlan, responsible: e.target.value})}
                    >
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö --</option>
                        {EMPLOYEE_POSITIONS.map(pos => (
                            <option key={pos} value={pos}>
                                {pos}
                            </option>
                        ))}
                    </select>
                    {newActionPlan.responsible?.startsWith('‡∏≠‡∏∑‡πà‡∏ô‡πÜ') && (
                        <input 
                            type="text" 
                            className="mt-2 w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm bg-gray-50 focus:bg-white transition-colors"
                            placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö..."
                            value={newActionPlan.otherResponsible || ''}
                            onChange={e => setNewActionPlan({...newActionPlan, otherResponsible: e.target.value})}
                            required
                        />
                    )}
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (Start Date)</label>
                        <input 
                            type="date" 
                            required
                            className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 outline-none text-sm text-gray-700 bg-white"
                            value={newActionPlan.startDate}
                            onChange={e => setNewActionPlan({...newActionPlan, startDate: e.target.value})}
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (Deadline)</label>
                        <input 
                            type="date" 
                            className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 outline-none text-sm text-gray-700 bg-white"
                            value={newActionPlan.deadline}
                            onChange={e => setNewActionPlan({...newActionPlan, deadline: e.target.value})}
                        />
                    </div>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Status)</label>
                    <div className="grid grid-cols-2 gap-2">
                        {['Pending', 'In Progress', 'Completed', 'Cancelled'].map(status => (
                            <button
                                key={status}
                                type="button"
                                onClick={() => setNewActionPlan({...newActionPlan, status})}
                                className={`py-2 text-xs font-bold rounded-md border transition-all ${
                                    newActionPlan.status === status 
                                        ? status === 'Completed' ? 'bg-green-50 border-green-500 text-green-700 shadow-sm'
                                        : status === 'In Progress' ? 'bg-blue-50 border-blue-500 text-blue-700 shadow-sm'
                                        : status === 'Cancelled' ? 'bg-gray-100 border-gray-500 text-gray-700 shadow-sm'
                                        : 'bg-orange-50 border-orange-500 text-orange-700 shadow-sm'
                                    : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'
                                }`}
                            >
                                {status === 'Completed' ? '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏™‡∏£‡πá‡∏à' : status === 'In Progress' ? '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : status === 'Cancelled' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddActionPlanModal(false)}>{t('cancel')}</Button>
                    <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Audit Form Modal */}
      {showAddAuditModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 m-4 max-h-[95vh] flex flex-col animate-fade-in">
            <div className="flex justify-between items-start mb-4 border-b pb-4 shrink-0">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <ClipboardCheck className="text-blue-600" size={24}/> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Audit Checklist)
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
              </div>
              <button onClick={() => setShowAddAuditModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveAudit} className="flex-1 overflow-y-auto pr-2 custom-scrollbar space-y-6">
                
                {/* General Info */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project)</label>
                        <select 
                            className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                            value={newAudit.projectId}
                            onChange={(e) => setNewAudit({...newAudit, projectId: e.target.value})}
                            disabled={!!selectedProject} // Lock if opened from Project Detail
                        >
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ --</option>
                            {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à (Audit Date)</label>
                        <input 
                            type="date" 
                            required
                            className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                            value={newAudit.date}
                            onChange={(e) => setNewAudit({...newAudit, date: e.target.value})}
                        />
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Audit Type)</label>
                        <select 
                            className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                            value={newAudit.type}
                            onChange={(e) => setNewAudit({...newAudit, type: e.target.value})}
                        >
                            <option value="Internal Audit">Internal Audit</option>
                            <option value="Quality Check">Quality Check</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Risk Assessment">Risk Assessment</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-xs font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Auditor Name)</label>
                        <input 
                            type="text" 
                            required
                            className="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"
                            value={newAudit.inspector}
                            onChange={(e) => setNewAudit({...newAudit, inspector: e.target.value})}
                        />
                    </div>
                </div>

                {/* Checklist Categories */}
                <div className="space-y-6">
                    {AUDIT_FORM_TEMPLATE.map((category, catIdx) => (
                        <div key={catIdx} className="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                            <div className="bg-gray-100 px-4 py-2 border-b border-gray-200 font-bold text-gray-800 text-sm">
                                {category.title}
                            </div>
                            <table className="w-full text-sm">
                                <thead className="bg-gray-50 text-gray-600 hidden md:table-header-group">
                                    <tr>
                                        <th className="p-2 pl-4 text-left font-medium w-1/2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checklist Items)</th>
                                        <th className="p-2 text-center font-medium w-1/4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (1-5)</th>
                                        <th className="p-2 pr-4 text-left font-medium w-1/4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Remark)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {category.items.map((item, itemIdx) => (
                                        <tr key={itemIdx} className="flex flex-col md:table-row hover:bg-gray-50 border-b md:border-b-0 border-gray-100 last:border-0">
                                            <td className="p-3 pl-4 md:py-3 text-gray-800 font-medium md:font-normal">{item}</td>
                                            <td className="p-3 md:py-3 border-t md:border-t-0 border-dashed border-gray-200">
                                                <div className="flex gap-1 justify-center">
                                                    {[1, 2, 3, 4, 5].map(score => {
                                                        const isSelected = newAudit.scores[`${catIdx}_${itemIdx}`] === score;
                                                        return (
                                                            <label key={score} className={`w-8 h-8 rounded-full border flex items-center justify-center cursor-pointer transition-all ${isSelected ? 'bg-blue-600 text-white border-blue-700 shadow-md scale-110 font-bold' : 'bg-white text-gray-600 hover:bg-blue-50 border-gray-300'}`}>
                                                                <input 
                                                                    type="radio" 
                                                                    name={`score_${catIdx}_${itemIdx}`} 
                                                                    value={score} 
                                                                    checked={isSelected}
                                                                    onChange={() => handleAuditScoreChange(catIdx, itemIdx, score)}
                                                                    className="hidden"
                                                                />
                                                                {score}
                                                            </label>
                                                        )
                                                    })}
                                                </div>
                                            </td>
                                            <td className="p-3 pr-4 md:py-3">
                                                <input 
                                                    type="text" 
                                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." 
                                                    className="w-full border border-gray-200 rounded p-1.5 text-xs outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-200"
                                                    value={newAudit.remarks[`${catIdx}_${itemIdx}`] || ''}
                                                    onChange={(e) => handleAuditRemarkChange(catIdx, itemIdx, e.target.value)}
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ))}
                </div>

                {/* Additional Comments */}
                <div className="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm p-4">
                    <label className="block text-sm font-bold text-gray-800 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Additional Comments)</label>
                    <textarea 
                        className="w-full border border-gray-300 rounded p-3 text-sm focus:ring-2 focus:ring-blue-200 outline-none resize-none h-20"
                        placeholder="‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ..."
                        value={newAudit.additionalComments}
                        onChange={(e) => setNewAudit({...newAudit, additionalComments: e.target.value})}
                    ></textarea>
                </div>

                {/* Sticky Footer */}
                <div className="sticky bottom-0 bg-white border-t border-gray-200 py-4 px-2 mt-6 flex flex-col md:flex-row justify-between items-center gap-4 shrink-0">
                    <div className="flex items-center gap-3">
                        <span className="text-gray-600 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</span>
                        <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-2xl font-black shadow-inner border border-blue-200 tracking-wider flex items-baseline gap-1">
                            {calculateTotalAuditScore()} <span className="text-sm font-medium text-blue-600">/ 235</span>
                        </div>
                    </div>
                    <div className="flex gap-3 w-full md:w-auto">
                        <Button variant="secondary" onClick={() => setShowAddAuditModal(false)} className="flex-1 md:flex-none py-3">{t('cancel')}</Button>
                        <Button type="submit" icon={Save} className="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 py-3 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</Button>
                    </div>
                </div>

            </form>
          </div>
        </div>
      )}

      {/* Selected Audit Report View Modal */}
      {selectedAuditReport && (
        <div className={`fixed inset-0 bg-black bg-opacity-50 flex justify-center z-50 ${isExporting ? 'items-start overflow-visible' : 'items-center overflow-y-auto'}`}>
            <div id="audit-modal-container" className={`w-full max-w-4xl m-4 relative animate-fade-in ${isExporting ? 'bg-white shadow-none p-4 h-max overflow-visible' : 'bg-white rounded-lg shadow-xl max-h-[95vh] p-8 overflow-y-auto'}`}>
                <button 
                    onClick={() => setSelectedAuditReport(null)} 
                    className={`absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors z-10 ${isExporting ? 'hidden' : ''}`}
                >
                    <X size={24} />
                </button>

                {/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 186mm (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö A4 210mm ‡∏´‡∏±‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡∏∞ 12mm) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏†‡∏≤‡∏û */}
                <div id="print-audit-report" className={`space-y-6 bg-white ${isExporting ? 'w-[186mm] min-w-[186mm] max-w-[186mm] mx-auto box-border' : 'w-full'}`}>
                    {/* Header */}
                    <div className="text-center border-b border-gray-400 pb-4 mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (Audit Report)</h2>
                        <h3 className="text-lg text-blue-600 font-medium mt-1">{projects.find(p => p.id === selectedAuditReport.projectId)?.name || 'Unknown Project'}</h3>
                    </div>

                    {/* Meta Info */}
                    <div className="grid grid-cols-2 gap-y-4 gap-x-8 text-sm bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                        <div className="flex"><span className="w-32 font-bold text-gray-700 shrink-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à:</span> <span className="text-gray-800">{new Date(selectedAuditReport.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</span></div>
                        <div className="flex"><span className="w-32 font-bold text-gray-700 shrink-0">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span> <span className="text-gray-800 truncate" title={selectedAuditReport.inspector}>{selectedAuditReport.inspector}</span></div>
                        <div className="flex"><span className="w-32 font-bold text-gray-700 shrink-0">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</span> <span className="text-gray-800">{selectedAuditReport.category}</span></div>
                        <div className="flex"><span className="w-32 font-bold text-gray-700 shrink-0">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°:</span> 
                            <span className={`font-bold ${selectedAuditReport.score >= 90 ? 'text-green-600' : selectedAuditReport.score >= 70 ? 'text-yellow-600' : 'text-red-600'}`}>
                                {selectedAuditReport.rawScore ? `${selectedAuditReport.rawScore} / 235 (${selectedAuditReport.score}%)` : `${selectedAuditReport.score}%`}
                            </span>
                        </div>
                    </div>

                    {/* Detailed Checklist (Only show if new format with itemScores exists) */}
                    {selectedAuditReport.itemScores ? (
                        <div className="space-y-4">
                            {AUDIT_FORM_TEMPLATE.map((category, catIdx) => (
                                <div key={catIdx} className="mb-4">
                                    <h4 className="font-bold text-gray-800 text-sm bg-gray-100 p-2 border border-gray-300 rounded-t-md">
                                        {category.title}
                                    </h4>
                                    {/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö table-fixed ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î */}
                                    <table className="w-full text-xs border-x border-b border-gray-300 border-collapse table-fixed break-words">
                                        <thead className="bg-gray-50 text-gray-600">
                                            <tr>
                                                <th className="p-2 border border-gray-300 text-left w-[50%]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                                                <th className="p-2 border border-gray-300 text-center w-[15%]">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                                <th className="p-2 border border-gray-300 text-left w-[35%]">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {category.items.map((item, itemIdx) => {
                                                const score = selectedAuditReport.itemScores[`${catIdx}_${itemIdx}`];
                                                const remark = selectedAuditReport.itemRemarks[`${catIdx}_${itemIdx}`];
                                                return (
                                                    <tr key={itemIdx}>
                                                        <td className="p-2 border border-gray-300 text-gray-800 break-words whitespace-normal">{item}</td>
                                                        <td className="p-2 border border-gray-300 text-center font-bold">{score || '-'}</td>
                                                        <td className="p-2 border border-gray-300 text-gray-600 break-words whitespace-normal">{remark || '-'}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="p-10 text-center border-2 border-dashed border-gray-200 rounded-lg bg-gray-50 text-gray-500">
                            ( ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠ )
                        </div>
                    )}

                    {/* Overall Remarks */}
                    <div className="mt-6 border border-gray-300 rounded-lg p-4 break-words">
                        <h4 className="font-bold text-gray-800 text-sm mb-2 border-b pb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h4>
                        <p className="text-sm text-gray-700 whitespace-pre-wrap break-words whitespace-normal">{selectedAuditReport.remarks || '-'}</p>
                    </div>

                    {/* Signature Area */}
                    <div className="flex justify-between px-10 pt-16 pb-4">
                        <div className="text-center">
                            <div className="border-b border-gray-400 w-40 mb-2 h-8"></div>
                            <div className="text-xs text-gray-600 truncate w-40">( {selectedAuditReport.inspector} )</div>
                            <div className="text-sm font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Auditor)</div>
                        </div>
                        <div className="text-center">
                            <div className="border-b border-gray-400 w-40 mb-2 h-8"></div>
                            <div className="text-xs text-gray-600 w-40">( ........................................ )</div>
                            <div className="text-sm font-bold text-gray-800 mt-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Manager)</div>
                        </div>
                    </div>
                </div>

                {/* Print Buttons (Not visible in PDF) */}
                <div className={`mt-8 flex justify-end gap-2 border-t pt-4 bg-white ${isExporting ? 'hidden' : ''}`}>
                    <Button variant="secondary" onClick={() => setSelectedAuditReport(null)}>{t('close')}</Button>
                    <Button icon={Printer} onClick={() => {
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Scroll ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å html2canvas
                        const modalContainer = document.getElementById('audit-modal-container');
                        if (modalContainer) modalContainer.scrollTop = 0;
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö (Margin) ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö A4: ‡∏ö‡∏ô 22mm, ‡∏ã‡πâ‡∏≤‡∏¢ 12mm, ‡∏•‡πà‡∏≤‡∏á 20mm, ‡∏Ç‡∏ß‡∏≤ 12mm
                        setTimeout(() => handleExportPDF('print-audit-report', `AuditReport_${selectedAuditReport.date}.pdf`, 'portrait', [22, 12, 20, 12]), 100);
                    }} disabled={isExporting}>
                        {isExporting ? t('downloading') : '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF'}
                    </Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Selected Form Details Modal (Upgraded to Printable Form Viewer) */}
      {selectedFormDetails && (
        <div className={`fixed inset-0 bg-black bg-opacity-50 flex justify-center z-50 ${isExporting ? 'items-start overflow-hidden' : 'items-center overflow-y-auto'}`}>
            <div className={`w-full max-w-4xl m-4 flex flex-col relative animate-fade-in ${isExporting ? 'bg-transparent shadow-none' : 'bg-gray-100 rounded-lg shadow-xl max-h-[95vh]'}`}>
                
                {/* Header Actions */}
                <div className={`bg-white p-4 border-b flex justify-between items-center rounded-t-lg shrink-0 z-10 sticky top-0 shadow-sm ${isExporting ? 'hidden' : ''}`}>
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <FileText className="text-orange-600" size={24} /> 
                            ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (Form Preview)
                            {isEditingForm && <span className="ml-2 bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full animate-pulse">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit Mode)</span>}
                        </h2>
                        <p className="text-sm text-gray-500 mt-1">{selectedFormDetails.name}</p>
                    </div>
                    <div className="flex items-center gap-2">
                        {isEditingForm && <span className="text-xs text-blue-600 mr-2 hidden md:inline">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>}
                        <Button 
                            variant={isEditingForm ? "primary" : "secondary"} 
                            icon={isEditingForm ? Save : Edit} 
                            onClick={() => setIsEditingForm(!isEditingForm)}
                        >
                            {isEditingForm ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°'}
                        </Button>
                        <Button 
                            variant="outline" 
                            icon={PrinterIcon} 
                            onClick={() => {
                                setIsEditingForm(false); // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏ö
                                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Scroll ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô/‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô html2canvas
                                const modalContainer = document.getElementById('form-modal-container');
                                if (modalContainer) modalContainer.scrollTop = 0;
                                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Margin ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ px-[20mm] ‡πÉ‡∏ô HTML ‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏î‡πâ 1:1 ‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏õ‡πä‡∏∞ ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö
                                setTimeout(() => handleExportPDF('print-standard-form', `Form_${selectedFormDetails.id}.pdf`, 'portrait', [22, 0, 20, 0]), 100);
                            }} 
                            disabled={isExporting}
                        >
                            {isExporting ? t('downloading') : '‡∏û‡∏¥‡∏°‡∏û‡πå / PDF'}
                        </Button>
                        <button 
                            onClick={() => { setSelectedFormDetails(null); setIsEditingForm(false); }} 
                            className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                        >
                            <X size={24} />
                        </button>
                    </div>
                </div>

                {/* Document Container */}
                <div id="form-modal-container" className={`flex-1 flex justify-center ${isExporting ? 'p-0 overflow-visible' : 'overflow-y-auto p-4 md:p-8'}`}>
                    <div id="print-standard-form" className={`bg-white w-[210mm] min-h-[297mm] px-[20mm] pb-[10mm] relative mx-auto box-border flex flex-col ${isExporting ? 'pt-[2mm] border-none shadow-none' : 'pt-[10mm] shadow-md border border-gray-200 text-gray-800'}`}>
                        
                        {/* Common Document Header */}
                        {/* ‡πÉ‡∏ä‡πâ isExporting ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å handleExportPDF ‡∏à‡∏∞‡πÅ‡∏™‡∏ï‡∏°‡∏õ‡πå‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏•‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß */}
                        <div className={`flex justify-between items-start mb-6 border-b-2 border-gray-800 pb-4 shrink-0 ${isExporting ? 'hidden' : ''}`}>
                            <div className="flex items-center gap-4">
                                {selectedProject?.logo ? (
                                    <img src={selectedProject.logo} className="w-16 h-16 object-contain" />
                                ) : (
                                    <div className="w-16 h-16 bg-gray-100 border border-gray-300 rounded flex items-center justify-center">
                                        <Building2 size={32} className="text-gray-400"/>
                                    </div>
                                )}
                                <div>
                                    <h1 className={`text-xl font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>{selectedProject?.name || '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏∏‡∏î / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£'}</h1>
                                    <p className={`text-sm text-gray-600 mt-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>{selectedProject?.address || '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'}</p>
                                    <p className={`text-sm text-gray-600 mt-1 inline-block ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÇ‡∏ó‡∏£. {selectedProject?.phone || '02-XXX-XXXX'}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className={`text-sm font-bold bg-gray-100 px-3 py-1 rounded border border-gray-300 mb-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>Doc No: {selectedFormDetails.id.toUpperCase()}-{new Date().getFullYear()}</div>
                                <div className={`text-sm ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date): ______/______/________</div>
                            </div>
                        </div>

                        {/* Document Title */}
                        <h2 className={`text-2xl font-bold text-center mb-8 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>
                            {selectedFormDetails.name.split(' (')[0]}
                        </h2>

                        {/* Dynamic Form Content */}
                        <div className="text-sm space-y-6">
                            
                            {/* --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ (Common Section) --- */}
                            <div className="mb-6">
                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ (Applicant Information)</h3>
                                <div className="grid grid-cols-2 gap-y-4 gap-x-6">
                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                    <div className="flex items-end"><span className={`w-32 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                    <div className="flex items-center gap-4">
                                        <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                        <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°</span></label>
                                        <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</span></label>
                                        <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</span></label>
                                    </div>
                                </div>
                            </div>

                            {/* --- Render Form Specific Content --- */}
                            {(() => {
                                const id = selectedFormDetails.id;

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å (Move In/Out)
                                if (id === 'f1' || id === 'f2') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Details)</h3>
                                                <div className="grid grid-cols-2 gap-y-4 gap-x-6 mb-4">
                                                    <div className="flex items-end"><span className={`w-32 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-16 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏ß‡∏•‡∏≤:</span><div className="flex-1 border-b border-dotted border-gray-400 text-center"></div> <span className={`mx-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ñ‡∏∂‡∏á</span> <div className="flex-1 border-b border-dotted border-gray-400 text-center"></div></div>
                                                    <div className="col-span-2 flex items-end"><span className={`w-48 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                </div>
                                                
                                                <p className={`font-bold mb-2 inline-block ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (List of Items):</p>
                                                <table className="w-full border-collapse border border-gray-400 text-center">
                                                    <thead className="bg-gray-100">
                                                        <tr>
                                                            <th className={`border border-gray-400 p-2 w-12 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                                            <th className={`border border-gray-400 p-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Description)</th>
                                                            <th className={`border border-gray-400 p-2 w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                                            <th className={`border border-gray-400 p-2 w-48 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {[1,2,3,4,5].map(i => (
                                                            <tr key={i}>
                                                                <td className="border border-gray-400 p-3 h-8">{i}</td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="mb-6 bg-gray-50 p-4 border border-gray-200 text-xs">
                                                <p className={`font-bold text-red-600 mb-1 inline-block ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ):</p>
                                                <ol className={`list-decimal pl-4 space-y-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text p-2' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>
                                                    <li>‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</li>
                                                    <li>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡πÄ‡∏™‡∏≤‡∏£‡πå ‡πÄ‡∏ß‡∏•‡∏≤ 09.00 - 17.00 ‡∏ô. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏á‡∏î‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå)</li>
                                                    <li>‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏¢‡πâ‡∏≤‡∏¢</li>
                                                </ol>
                                            </div>
                                        </>
                                    );
                                }

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå / ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ (Vehicle)
                                if (id === 'f3' || id === 'f4') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ (Vehicle Details)</h3>
                                                <div className="flex items-center gap-6 mb-4">
                                                    <label className="flex items-center gap-2 font-bold"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå (Car)</span></label>
                                                    <label className="flex items-center gap-2 font-bold"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå (Motorcycle)</span></label>
                                                </div>
                                                <table className="w-full border-collapse border border-gray-400 text-center mb-4">
                                                    <thead className="bg-gray-100">
                                                        <tr>
                                                            <th className={`border border-gray-400 p-2 w-12 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                                            <th className={`border border-gray-400 p-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ (Brand)</th>
                                                            <th className={`border border-gray-400 p-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏∏‡πà‡∏ô (Model)</th>
                                                            <th className={`border border-gray-400 p-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡∏µ (Color)</th>
                                                            <th className={`border border-gray-400 p-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Plate)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {[1,2].map(i => (
                                                            <tr key={i}>
                                                                <td className="border border-gray-400 p-3 h-10">{i}</td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                                <td className="border border-gray-400 p-3"></td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                                <div className="flex items-end mt-4"><span className={`w-40 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</span><label className="mr-4"><input type="checkbox"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</span></label><label className="mr-4"><input type="checkbox"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span></label></div>
                                            </div>
                                        </>
                                    );
                                }

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair)
                                if (id === 'f10') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Problem Description)</h3>
                                                <div className="flex flex-wrap gap-4 mb-4">
                                                    <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span></label>
                                                    <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</span></label>
                                                    <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</span></label>
                                                    <label className="flex items-center gap-1"><input type="checkbox" className="w-4 h-4"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå</span></label>
                                                    <div className="flex items-end w-48"><span className={`mr-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                </div>
                                                <div className="w-full h-32 border border-gray-400 rounded p-2 mb-4 bg-gray-50">
                                                    <span className={`text-gray-400 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>(‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö)</span>
                                                </div>
                                            </div>
                                            
                                            <div className="mb-6 border-2 border-dashed border-gray-300 p-4 relative">
                                                <div className={`absolute -top-3 left-4 bg-white px-2 font-bold text-gray-500 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (For Staff Only)</div>
                                                <div className="grid grid-cols-2 gap-y-4 gap-x-6 mt-2">
                                                    <div className="col-span-2 flex items-center gap-4">
                                                        <span className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
                                                        <label><input type="radio" name="rep_status"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span></label>
                                                        <label><input type="radio" name="rep_status"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</span></label>
                                                        <label><input type="radio" name="rep_status"/> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</span></label>
                                                    </div>
                                                    <div className="col-span-2 flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</span><div className="flex-1 border-b border-dotted border-gray-400"></div> <span className="ml-2">‡∏ö‡∏≤‡∏ó</span></div>
                                                    <div className="flex justify-end gap-2 items-end"><span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô:</span><div className="w-32 border-b border-dotted border-gray-400"></div></div>
                                                </div>
                                            </div>
                                        </>
                                    );
                                }

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° (Renovation)
                                if (id === 'f8') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏° (Renovation Details)</h3>
                                                <div className="grid grid-cols-2 gap-y-4 gap-x-6 mb-4">
                                                    <div className="col-span-2 flex items-end"><span className={`w-32 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-32 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏á‡∏≤‡∏ô:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-32 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô:</span><span className={`mx-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏£‡∏¥‡πà‡∏°</span> <div className="w-20 border-b border-dotted border-gray-400 text-center"></div><span className={`mx-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ñ‡∏∂‡∏á</span> <div className="w-20 border-b border-dotted border-gray-400 text-center"></div></div>
                                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</span><div className="w-16 border-b border-dotted border-gray-400 text-center"></div> <span className="ml-1">‡∏ß‡∏±‡∏ô</span></div>
                                                </div>
                                                <div className="w-full h-24 border border-gray-400 rounded p-2 mb-4 bg-gray-50 flex flex-col">
                                                    <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏á‡∏≤‡∏ô (Scope of Work):</span>
                                                </div>
                                                <div className="flex items-center gap-4 bg-gray-100 p-3 rounded border border-gray-300">
                                                    <span className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (Deposit):</span>
                                                    <div className="w-32 border-b border-gray-800 bg-white"></div> ‡∏ö‡∏≤‡∏ó
                                                    <span className={`text-gray-500 text-xs ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>(‡∏ä‡∏≥‡∏£‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢)</span>
                                                </div>
                                            </div>
                                        </>
                                    );
                                }

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á (Renovation Deposit Refund)
                                if (id === 'f17') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Refund Details)</h3>
                                                <div className="grid grid-cols-2 gap-y-4 gap-x-6 mb-4">
                                                    <div className="col-span-2 flex items-end"><span className={`w-40 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-44 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ:</span><div className="flex-1 border-b border-dotted border-gray-400 text-center font-bold"></div><span className="ml-2">‡∏ö‡∏≤‡∏ó</span></div>
                                                    <div className="flex items-end"><span className={`w-24 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÄ‡∏á‡∏¥‡∏ô:</span><div className="flex-1 border-b border-dotted border-gray-400 text-center"></div></div>
                                                    
                                                    <div className="col-span-2 mt-4 font-bold"><span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Bank Account Details):</span></div>
                                                    <div className="flex items-end"><span className={`w-16 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-16 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-16 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡∏≤‡∏Ç‡∏≤:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="flex items-end"><span className={`w-20 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span><div className="flex-1 border-b border-dotted border-gray-400 font-mono tracking-widest"></div></div>
                                                </div>
                                            </div>

                                            <div className="mb-6 border-2 border-dashed border-gray-300 p-5 relative bg-gray-50 rounded">
                                                <div className={`absolute -top-3 left-4 bg-gray-50 px-2 font-bold text-gray-500 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (For Staff Only)</div>
                                                <div className="space-y-4 mt-2">
                                                    <div className="flex items-center gap-6">
                                                        <span className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</span>
                                                        <label className="flex items-center gap-1"><input type="radio" name="insp" /> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</span></label>
                                                        <label className="flex items-center gap-1"><input type="radio" name="insp" /> <span className={`${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)</span></label>
                                                    </div>
                                                    <div className="flex items-end w-full"><span className={`w-36 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:</span><div className="flex-1 border-b border-dotted border-gray-400"></div></div>
                                                    <div className="grid grid-cols-2 gap-6 pt-4 border-t border-gray-200">
                                                        <div className="flex items-end bg-red-50 p-2 rounded border border-red-100"><span className={`w-32 text-red-600 font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</span><div className="flex-1 border-b border-dotted border-red-300 text-center text-red-600 font-bold"></div><span className="ml-2 text-red-600">‡∏ö‡∏≤‡∏ó</span></div>
                                                        <div className="flex items-end bg-green-50 p-2 rounded border border-green-100"><span className={`w-32 text-green-600 font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span><div className="flex-1 border-b border-dotted border-green-300 text-center text-green-600 font-bold"></div><span className="ml-2 text-green-600">‡∏ö‡∏≤‡∏ó</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    );
                                }

                                // ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Installment Payment)
                                if (id === 'f16') {
                                    return (
                                        <>
                                            <div className="mb-6">
                                                <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (Debt and Installment Details)</h3>
                                                <div className="grid grid-cols-2 gap-y-6 gap-x-6 mb-4">
                                                    <div className="col-span-2 flex items-end"><span className={`w-48 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span><div className="flex-1 border-b border-dotted border-gray-400"></div><span className={`ml-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ö‡∏≤‡∏ó</span></div>
                                                    <div className="col-span-2 flex items-end"><span className={`w-36 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞:</span><div className="w-24 border-b border-dotted border-gray-400 text-center"></div><span className={`mx-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏á‡∏ß‡∏î (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)  ‡∏á‡∏ß‡∏î‡∏•‡∏∞:</span><div className="w-32 border-b border-dotted border-gray-400 text-center"></div><span className={`ml-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ö‡∏≤‡∏ó</span></div>
                                                    <div className="col-span-2 flex items-end"><span className={`w-40 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span><div className="w-32 border-b border-dotted border-gray-400 text-center"></div><span className={`mx-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÅ‡∏•‡∏∞‡∏á‡∏ß‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span><div className="w-24 border-b border-dotted border-gray-400 text-center"></div><span className={`ml-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>
                                                </div>
                                                <div className="mt-8 bg-red-50 p-4 border border-red-200 text-sm rounded-lg text-red-800">
                                                    <p className={`font-bold mb-2 inline-block ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (Conditions):</p>
                                                    <ol className={`list-decimal pl-5 space-y-2 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>
                                                        <li>‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î</li>
                                                        <li>‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏á‡∏ß‡∏î‡πÉ‡∏î‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                                                        <li>‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ø ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</li>
                                                    </ol>
                                                </div>
                                            </div>
                                        </>
                                    );
                                }

                                // Default Generic Form / ‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                return (
                                    <>
                                        <div className="mb-6">
                                            <h3 className={`font-bold text-base mb-3 border-b pb-1 ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block w-full' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description)</h3>
                                            <div className="w-full h-48 border border-gray-400 rounded p-2 mb-4">
                                                <div className="border-b border-dotted border-gray-400 h-8 mt-2"></div>
                                                <div className="border-b border-dotted border-gray-400 h-8 mt-2"></div>
                                                <div className="border-b border-dotted border-gray-400 h-8 mt-2"></div>
                                                <div className="border-b border-dotted border-gray-400 h-8 mt-2"></div>
                                                <div className="border-b border-dotted border-gray-400 h-8 mt-2"></div>
                                            </div>
                                        </div>
                                    </>
                                );
                            })()}

                            {/* --- Signatures (Common Section) --- */}
                            <div className="mt-12 flex justify-between px-4">
                                <div className="text-center w-56">
                                    <div className="border-b border-gray-800 mb-2 h-8"></div>
                                    <div className="mb-1">( ....................................................... )</div>
                                    <div className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ / ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏ß‡∏°</div>
                                    <div className="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ....... / ....... / ...........</div>
                                </div>
                                <div className="text-center w-56">
                                    <div className="border-b border-gray-800 mb-2 h-8"></div>
                                    <div className="mb-1">( ....................................................... )</div>
                                    <div className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ø</div>
                                    <div className="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ....... / ....... / ...........</div>
                                </div>
                                <div className="text-center w-56">
                                    <div className="border-b border-gray-800 mb-2 h-8"></div>
                                    <div className="mb-1">( ....................................................... )</div>
                                    <div className={`font-bold ${isEditingForm ? 'outline-dashed outline-1 outline-blue-400 bg-blue-50 cursor-text inline-block' : ''}`} contentEditable={isEditingForm} suppressContentEditableWarning>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ø (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</div>
                                    <div className="text-xs text-gray-500 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ....... / ....... / ...........</div>
                                </div>
                            </div>

                        </div>

                        {/* Watermark/Footer */}
                        {/* ‡πÉ‡∏ä‡πâ isExporting ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô */}
                        <div className={`absolute bottom-4 left-0 w-full text-center text-[10px] text-gray-400 ${isExporting ? 'hidden' : ''}`}>
                            Managed by Best Million Group Co., Ltd.
                        </div>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Audit Ranking Leaderboard Modal */}
      {showAuditRankingModal && (
        <div className={`fixed inset-0 bg-black bg-opacity-50 flex justify-center z-50 ${isExporting ? 'items-start overflow-visible' : 'items-center overflow-y-auto'}`}>
          <div id="audit-ranking-container" className={`w-full max-w-3xl m-4 relative animate-fade-in ${isExporting ? 'bg-white shadow-none p-4 h-max overflow-visible' : 'bg-white rounded-lg shadow-xl max-h-[90vh] flex flex-col'}`}>
            <button 
                onClick={() => setShowAuditRankingModal(false)} 
                className={`absolute top-6 right-6 text-gray-400 hover:text-red-500 transition-colors z-10 ${isExporting ? 'hidden' : ''}`}
            >
                <X size={24} />
            </button>
            
            {/* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 180mm (‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö A4 210mm ‡∏´‡∏±‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡∏∞ 15mm) */}
            <div id="print-audit-ranking" className={`bg-white rounded-t-lg ${isExporting ? 'w-[180mm] min-w-[180mm] max-w-[180mm] mx-auto box-border px-[5mm] pt-[5mm] pb-[10mm]' : 'p-8 flex flex-col flex-1 overflow-y-auto custom-scrollbar'}`}>
                <div className="mb-4 border-b pb-4 shrink-0 pr-8">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <BarChart3 className="text-blue-600" size={28} />
                        ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit (Leaderboard)
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</p>
                </div>
                
                <div className={isExporting ? "w-full" : "overflow-y-auto flex-1 custom-scrollbar pr-2"}>
                    <table className="w-full text-sm text-left table-fixed break-words">
                        <thead className="bg-blue-50 text-blue-800 sticky top-0 shadow-sm z-10">
                            <tr>
                                <th className="p-3 text-center w-[15%] rounded-tl-md">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th className="p-3 w-[60%]">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                <th className="p-3 text-center w-[25%] rounded-tr-md">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {(() => {
                                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                                const projectAvgScores = projects.map(p => {
                                    const pAudits = audits.filter(a => a.projectId === p.id);
                                    const avg = pAudits.length > 0 ? (pAudits.reduce((sum, a) => sum + a.score, 0) / pAudits.length) : 0;
                                    return { id: p.id, name: p.name, type: p.type, avg };
                                }).sort((a, b) => b.avg - a.avg); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢

                                return projectAvgScores.map((p, idx) => {
                                    const isCurrent = selectedProject && p.id === selectedProject.id;
                                    return (
                                        <tr key={p.id} className={`transition-colors ${isCurrent ? 'bg-orange-50 font-bold border-l-4 border-orange-500' : 'hover:bg-gray-50'}`}>
                                            <td className="p-3 text-center font-bold text-gray-600">
                                                {idx === 0 ? <span className="text-yellow-500 text-xl drop-shadow-sm" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1">ü•á</span> : 
                                                 idx === 1 ? <span className="text-gray-400 text-xl drop-shadow-sm" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2">ü•à</span> : 
                                                 idx === 2 ? <span className="text-amber-600 text-xl drop-shadow-sm" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3">ü•â</span> : 
                                                 idx + 1}
                                            </td>
                                            <td className="p-3 break-words whitespace-normal">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <Building2 size={16} className={`shrink-0 ${isCurrent ? "text-orange-500" : "text-gray-400"}`} />
                                                    <span className={isCurrent ? "text-orange-700" : "text-gray-800"}>{p.name}</span>
                                                    {isCurrent && <span className="ml-1 text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full whitespace-nowrap shrink-0">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>}
                                                </div>
                                                <div className="text-[10px] text-gray-400 mt-0.5 ml-6">{p.type}</div>
                                            </td>
                                            <td className="p-3 text-center">
                                                <span className={`px-2 py-1 rounded-md text-xs font-bold whitespace-nowrap ${p.avg >= 90 ? 'bg-green-100 text-green-700 border border-green-200' : p.avg >= 70 ? 'bg-yellow-100 text-yellow-700 border border-yellow-200' : p.avg > 0 ? 'bg-red-100 text-red-700 border border-red-200' : 'bg-gray-100 text-gray-500 border border-gray-200'}`}>
                                                    {p.avg > 0 ? `${p.avg.toFixed(1)}%` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                });
                            })()}
                        </tbody>
                    </table>
                </div>
            </div>

            <div className={`px-8 py-4 border-t flex justify-end shrink-0 gap-2 bg-gray-50 rounded-b-lg ${isExporting ? 'hidden' : ''}`}>
                <Button variant="secondary" onClick={() => setShowAuditRankingModal(false)}>{t('close')}</Button>
                <Button icon={Printer} onClick={() => {
                    const container = document.getElementById('audit-ranking-container');
                    if (container) container.scrollTop = 0;
                    setTimeout(() => handleExportPDF('print-audit-ranking', 'Audit_Ranking_Report.pdf', 'portrait', [22, 15, 20, 15]), 100);
                }} disabled={isExporting}>
                    {isExporting ? t('downloading') : '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF'}
                </Button>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Role Permissions Setting Modal */}
      {showRolePermModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 m-4 max-h-[90vh] flex flex-col animate-fade-in">
            <div className="flex justify-between items-start mb-4 border-b pb-4 shrink-0">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <Shield className="text-orange-500" size={24}/> ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Role Permissions)
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô (Default Role Settings)</p>
              </div>
              <button onClick={() => setShowRolePermModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <div className="mb-6 flex flex-col sm:flex-row sm:items-center gap-4 bg-orange-50 p-4 rounded-lg border border-orange-100 shrink-0">
               <label className="font-bold text-orange-800 whitespace-nowrap">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</label>
               <select 
                   className="w-full max-w-sm border border-orange-300 text-orange-900 rounded-md p-2 outline-none focus:ring-2 focus:ring-orange-500 bg-white font-medium shadow-sm"
                   value={editingRole}
                   onChange={(e) => {
                       const r = e.target.value;
                       setEditingRole(r);
                       setEditingRolePerms(rolePermissions[r] || getDefaultPermissions());
                   }}
               >
                   {EMPLOYEE_POSITIONS.map(pos => <option key={pos} value={pos}>{pos}</option>)}
               </select>
               <span className="text-xs text-orange-600 hidden md:block">*‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
            </div>

            <div className="flex-1 overflow-y-auto border border-gray-200 rounded-lg custom-scrollbar">
                <table className="w-full text-sm text-left">
                    <thead className="bg-gray-100 text-gray-700 sticky top-0 shadow-sm z-10">
                        <tr>
                            <th className="p-3 border-b">‡πÇ‡∏°‡∏î‡∏π‡∏• (Module)</th>
                            <th className="p-3 border-b text-center w-16">‡∏î‡∏π</th>
                            <th className="p-3 border-b text-center w-16">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                            <th className="p-3 border-b text-center w-16">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                            <th className="p-3 border-b text-center w-16">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                            <th className="p-3 border-b text-center w-16">‡∏•‡∏ö</th>
                            <th className="p-3 border-b text-center w-16">‡∏û‡∏¥‡∏°‡∏û‡πå</th>
                            <th className="p-3 border-b text-center w-20 bg-gray-200">All</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100 bg-white">
                        {AVAILABLE_MENUS.map(menu => {
                            const renderRow = (item, isSub = false) => {
                                const perms = editingRolePerms[item.id] || {};
                                const isAll = perms.view && perms.save && perms.edit && perms.approve && perms.delete && perms.print;
                                return (
                                    <tr key={item.id} className={`hover:bg-gray-50 transition-colors ${isSub ? 'bg-gray-50/50' : ''}`}>
                                        <td className={`p-3 font-medium text-gray-800 ${isSub ? 'pl-8 text-xs text-gray-600 border-l-2 border-orange-200' : ''}`}>
                                            {isSub && <span className="mr-2 text-gray-400">‚îî</span>}
                                            {t(item.label)}
                                        </td>
                                        {['view', 'save', 'edit', 'approve', 'delete', 'print'].map(ptype => (
                                            <td key={ptype} className="p-3 text-center">
                                                <input 
                                                    type="checkbox" 
                                                    className="w-4 h-4 accent-orange-600 cursor-pointer" 
                                                    checked={!!perms[ptype]} 
                                                    onChange={(e) => handleRolePermissionChange(item.id, ptype, e.target.checked)} 
                                                />
                                            </td>
                                        ))}
                                        <td className="p-3 text-center bg-gray-50 border-l border-gray-100">
                                            <input 
                                                type="checkbox" 
                                                className="w-4 h-4 accent-orange-600 cursor-pointer" 
                                                checked={isAll} 
                                                onChange={(e) => handleRolePermissionAll(item.id, e.target.checked)} 
                                            />
                                        </td>
                                    </tr>
                                );
                            };

                            return (
                                <React.Fragment key={menu.id}>
                                    {renderRow(menu)}
                                    {menu.submenus && menu.submenus.map(sub => renderRow(sub, true))}
                                </React.Fragment>
                            );
                        })}
                    </tbody>
                </table>
            </div>

            <div className="flex justify-end gap-3 pt-6 border-t mt-4 shrink-0">
                <Button variant="secondary" onClick={() => setShowRolePermModal(false)}>{t('cancel')}</Button>
                <Button icon={Save} onClick={() => {
                    setRolePermissions({...rolePermissions, [editingRole]: editingRolePerms});
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô');
                    setShowRolePermModal(false);
                }}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</Button>
            </div>
          </div>
        </div>
      )}

      {/* NEW: Edit Company Profile Modal */}
      {showEditCompanyModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 animate-fade-in">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                  <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                      <Settings className="text-orange-500" /> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (Company Profile)
                  </h2>
                  <p className="text-sm text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô Header ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</p>
              </div>
              <button onClick={() => setShowEditCompanyModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveCompanyInfo} className="space-y-6">
              <div className="flex flex-col md:flex-row gap-8">
                
                {/* Logo Section */}
                <div className="flex flex-col items-center gap-3">
                  <div className="w-40 h-40 rounded-xl bg-gray-50 flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-300 relative group shadow-sm">
                    {editCompanyForm.logo ? (
                        <img src={editCompanyForm.logo} alt="Company Logo" className="w-full h-full object-contain p-2" />
                    ) : (
                        <div className="text-center text-gray-400 p-2"><ImageIcon size={40} className="mx-auto mb-2 text-gray-300" /><span className="text-sm font-medium">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ</span></div>
                    )}
                    <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
                        <label className="cursor-pointer text-white text-sm font-bold flex flex-col items-center">
                            <Upload size={24} className="mb-2" /> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ
                            <input type="file" accept="image/*" className="hidden" onChange={handleCompanyLogoUpload} />
                        </label>
                    </div>
                  </div>
                  {editCompanyForm.logo && (
                      <button type="button" onClick={() => setEditCompanyForm({...editCompanyForm, logo: null})} className="text-red-500 text-xs hover:text-red-700 font-medium">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
                  )}
                </div>
                
                {/* Details Section */}
                <div className="flex-1 space-y-5">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö/‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (System/Company Name)</label>
                          <input type="text" required className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-colors" value={editCompanyForm.name} onChange={e => setEditCompanyForm({...editCompanyForm, name: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô BM GROUP" />
                      </div>
                      <div>
                          <label className="block text-sm font-bold text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏¢ (Subtitle)</label>
                          <input type="text" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-colors" value={editCompanyForm.subtitle} onChange={e => setEditCompanyForm({...editCompanyForm, subtitle: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô Enterprise ERP" />
                      </div>
                  </div>
                  <div>
                      <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (Head Office Address)</label>
                      <textarea className="w-full border border-gray-300 rounded-md p-2.5 h-20 resize-none focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-colors" value={editCompanyForm.address} onChange={e => setEditCompanyForm({...editCompanyForm, address: e.target.value})} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà..."></textarea>
                  </div>
                  <div>
                      <label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Phone Number)</label>
                      <input type="tel" className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-colors" value={editCompanyForm.phone} onChange={e => setEditCompanyForm({...editCompanyForm, phone: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô 02-111-2222" />
                  </div>
                </div>
              </div>
              
              <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                <Button variant="secondary" onClick={() => setShowEditCompanyModal(false)}>{t('cancel')}</Button>
                <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</Button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: Add/Edit Form Item Modal */}
      {showAddFormModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 animate-fade-in">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <Folder className="text-orange-500" size={24}/> 
                    {newFormItem.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (Edit Form)' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà (Add Form)'}
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</p>
              </div>
              <button onClick={() => setShowAddFormModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveFormItem} className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (Category) <span className="text-red-500">*</span></label>
                    <select 
                        required 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm transition-colors bg-white"
                        value={newFormItem.category}
                        onChange={e => setNewFormItem({...newFormItem, category: e.target.value})}
                    >
                        <option value="‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)">‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (Resident Services)</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)">‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (Contractor & Maint.)</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)">‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (Juristic & Mgmt.)</option>
                        <option value="‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal)">‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal)</option>
                    </select>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° (Form Name) <span className="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm transition-colors"
                        value={newFormItem.name}
                        onChange={e => setNewFormItem({...newFormItem, name: e.target.value})}
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
                    />
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Description)</label>
                    <textarea 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm h-24 resize-none transition-colors"
                        value={newFormItem.description}
                        onChange={e => setNewFormItem({...newFormItem, description: e.target.value})}
                        placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°..."
                    ></textarea>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Format)</label>
                        <select 
                            className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 outline-none text-sm bg-white"
                            value={newFormItem.format}
                            onChange={e => setNewFormItem({...newFormItem, format: e.target.value})}
                        >
                            <option value="PDF">PDF</option>
                            <option value="Excel">Excel</option>
                            <option value="Word">Word</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)</label>
                        <input 
                            type="text" 
                            className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 outline-none text-sm bg-white"
                            value={newFormItem.size}
                            onChange={e => setNewFormItem({...newFormItem, size: e.target.value})}
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô 100 KB"
                        />
                    </div>
                </div>

                <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddFormModal(false)}>{t('cancel')}</Button>
                    <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: Supplier Details Modal */}
      {selectedSupplierDetails && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 max-h-[95vh] overflow-y-auto relative animate-fade-in">
                <button 
                    onClick={() => setSelectedSupplierDetails(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div className="mb-6 border-b pb-4">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <Building2 className="text-orange-500"/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Supplier Details)</p>
                </div>

                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-4 text-sm bg-gray-50 p-6 rounded-xl border border-gray-200">
                        <div className="col-span-1 md:col-span-2 flex justify-between items-start">
                            <div>
                                <span className="text-gray-500 block text-xs mb-1 font-bold uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Company Name)</span>
                                <span className="font-black text-gray-800 text-xl">{selectedSupplierDetails.name}</span>
                            </div>
                            <div className="text-right">
                                <span className="text-gray-500 block text-xs mb-1 font-bold uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Status)</span>
                                <Badge status={selectedSupplierDetails.status} />
                            </div>
                        </div>

                        <div className="col-span-1 md:col-span-2 border-t border-gray-200 pt-4">
                            <span className="text-gray-500 block text-xs mb-1 font-bold uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Service Category)</span>
                            <div className="flex gap-2">
                                <span className="text-gray-700 bg-white px-3 py-1.5 rounded-md inline-block font-bold border border-gray-300 shadow-sm">
                                    {selectedSupplierDetails.category}
                                </span>
                                <span className="text-gray-600 bg-gray-200 px-3 py-1.5 rounded-md inline-block font-medium border border-gray-300">
                                    {selectedSupplierDetails.type}
                                </span>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <span className="text-gray-500 block text-xs mb-2 font-bold uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Contact Person)</span>
                            <span className="text-gray-800 font-bold flex items-center gap-2 text-base">
                                <User size={18} className="text-orange-500"/> {selectedSupplierDetails.contact || '-'}
                            </span>
                        </div>

                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-3">
                            <div>
                                <span className="text-gray-500 block text-xs mb-1 font-bold uppercase tracking-wider">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Phone)</span>
                                <a href={`tel:${selectedSupplierDetails.phone}`} className="text-blue-600 hover:text-blue-800 hover:underline font-bold flex items-center gap-2">
                                    <Phone size={16} className="text-blue-500"/> {selectedSupplierDetails.phone || '-'}
                                </a>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1 font-bold uppercase tracking-wider">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</span>
                                <a href={`mailto:${selectedSupplierDetails.email}`} className="text-blue-600 hover:text-blue-800 hover:underline font-bold flex items-center gap-2 break-all">
                                    <Mail size={16} className="text-blue-500"/> {selectedSupplierDetails.email || '-'}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2 pt-4 border-t">
                    <Button variant="secondary" onClick={() => setSelectedSupplierDetails(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: View Selected Contract Modal */}
      {selectedContractView && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 m-4 max-h-[95vh] overflow-y-auto relative animate-fade-in">
                <button 
                    onClick={() => setSelectedContractView(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div className="mb-6 border-b pb-4">
                    <div className="flex justify-between items-start">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                <Briefcase className="text-orange-500"/> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Contract Details)
                            </h2>
                            <p className="text-sm text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                        </div>
                        <Badge status={selectedContractView.status} />
                    </div>
                </div>

                <div className="space-y-6">
                    {/* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤ */}
                    <div className="bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <h3 className="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2 border-b border-gray-200 pb-2">
                            <Building2 size={16} className="text-gray-500"/> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤ / ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 text-sm">
                            <div className="col-span-1 md:col-span-2">
                                <span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏π‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                                <span className="font-bold text-gray-900 text-lg">{selectedContractView.vendorName}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</span>
                                <span className="font-medium text-gray-800 flex items-center gap-1.5"><User size={14} className="text-gray-400"/> {selectedContractView.contactPerson || '-'}</span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span>
                                <span className="font-medium text-gray-800 flex items-center gap-1.5">
                                    <Phone size={14} className="text-gray-400"/> 
                                    {selectedContractView.contactPhone ? <a href={`tel:${selectedContractView.contactPhone}`} className="text-blue-600 hover:underline">{selectedContractView.contactPhone}</a> : '-'}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-3 text-sm">
                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                            <div>
                                <span className="text-gray-500 block text-xs">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                                <span className={`inline-block mt-1 px-2 py-0.5 rounded text-xs font-bold ${
                                    selectedContractView.type === CONTRACT_TYPES.INCOME ? 'bg-green-100 text-green-700 border border-green-200' :
                                    selectedContractView.type === CONTRACT_TYPES.EXPENSE ? 'bg-red-100 text-red-700 border border-red-200' :
                                    'bg-blue-100 text-blue-700 border border-blue-200'
                                }`}>
                                    {selectedContractView.type}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
                                <span className="font-medium text-gray-800">{selectedContractView.category}</span>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm space-y-3 text-sm">
                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô - ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</span>
                                <span className="font-medium text-gray-800 flex items-center gap-1.5">
                                    <Calendar size={14} className="text-gray-400"/> {selectedContractView.startDate} <ArrowRight size={12} className="text-gray-300"/> {selectedContractView.endDate}
                                </span>
                            </div>
                            <div>
                                <span className="text-gray-500 block text-xs mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</span>
                                {(() => {
                                    const remDays = calculateDaysRemaining(selectedContractView.endDate);
                                    return (
                                        <span className={`font-bold flex items-center gap-1.5 ${remDays < 0 ? 'text-red-600' : remDays < 30 ? 'text-orange-600' : 'text-green-600'}`}>
                                            <Hourglass size={14}/> {remDays < 0 ? '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remDays} ‡∏ß‡∏±‡∏ô`}
                                        </span>
                                    );
                                })()}
                            </div>
                        </div>
                    </div>

                    {/* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô */}
                    <div className="bg-orange-50 p-5 rounded-xl border border-orange-100 flex items-center justify-between">
                        <div>
                            <span className="text-orange-800 block text-sm font-bold mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Contract Amount)</span>
                            <span className="text-orange-600 text-xs">‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (VAT)</span>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-black text-orange-700 mb-1">‡∏ø {Number(selectedContractView.amount).toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                            <div className="text-xs font-bold bg-white px-2 py-1 rounded-md text-orange-600 border border-orange-200 inline-block">
                                ‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢: {selectedContractView.paymentCycle === 'Monthly' ? '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly)' : '‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Yearly)'}
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-between items-center gap-2 pt-4 border-t border-gray-200 bg-white">
                    <div>
                        {(selectedContractView.fileUrl || (selectedContractView.file && (selectedContractView.file.data || selectedContractView.file.isLocal))) ? (
                            <Button 
                                variant="outline" 
                                className="border-blue-500 text-blue-600 hover:bg-blue-50 font-bold" 
                                icon={Download}
                                onClick={() => handleDownloadFile(selectedContractView.file || { fileUrl: selectedContractView.fileUrl, name: `${selectedContractView.vendorName}_Contract.pdf` })}
                            >
                                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö
                            </Button>
                        ) : (
                            <span className="text-sm text-gray-400 flex items-center gap-1"><File size={16}/> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</span>
                        )}
                    </div>
                    <div className="flex gap-2">
                        {hasPerm('proj_contracts', 'edit') && (
                            <Button 
                                variant="outline" 
                                className="border-orange-500 text-orange-600 hover:bg-orange-50 font-bold" 
                                icon={Edit} 
                                onClick={() => handleEditContract(selectedContractView)}
                            >
                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤
                            </Button>
                        )}
                        <Button variant="secondary" onClick={() => setSelectedContractView(null)}>{t('close')}</Button>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Add/Edit Form Item Modal */}
      {/* NEW: Global Confirm Modal */}
      {confirmModal.isOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] animate-fade-in">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 m-4 transform transition-all scale-100 opacity-100">
            <div className="flex items-center gap-3 mb-4 text-red-600">
              <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center shrink-0">
                  <AlertTriangle size={24} className="text-red-600" />
              </div>
              <h3 className="text-lg font-bold text-gray-900">{confirmModal.title}</h3>
            </div>
            <p className="text-gray-600 mb-6 text-sm ml-1">{confirmModal.message}</p>
            <div className="flex justify-end gap-3">
              <Button variant="secondary" onClick={closeConfirm}>{t('cancel')}</Button>
              <Button variant="danger" onClick={() => { confirmModal.onConfirm(); closeConfirm(); }} icon={Trash2}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</Button>
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Repair Modal */}
      {showAddRepairModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 m-4 animate-fade-in max-h-[95vh] overflow-y-auto">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <Hammer className="text-orange-500" size={24}/> 
                    {newRepair.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Edit Repair Request)' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (New Repair Request)'}
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
              </div>
              <button onClick={() => setShowAddRepairModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveRepair} className="space-y-6">
                {/* Section 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á */}
                <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Requester Information)</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair No.)</label>
                            <input type="text" readOnly className="w-full border border-gray-300 rounded-md p-2 bg-gray-100 text-gray-600 font-mono" value={newRepair.code} />
                        </div>
                        <div></div> {/* Empty column for spacing */}
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏∏‡∏î (Unit/Room No.)</label>
                            <input type="text" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none transition-colors" value={newRepair.roomNo} onChange={e => setNewRepair({...newRepair, roomNo: e.target.value})} required placeholder="‡πÄ‡∏ä‡πà‡∏ô 101/25" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏±‡πâ‡∏ô (Floor)</label>
                            <input type="text" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none transition-colors" value={newRepair.floor} onChange={e => setNewRepair({...newRepair, floor: e.target.value})} placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Requester Name)</label>
                            <input type="text" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none transition-colors" value={newRepair.requesterName} onChange={e => setNewRepair({...newRepair, requesterName: e.target.value})} required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (Phone)</label>
                            <input type="tel" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none transition-colors" value={newRepair.phone} onChange={e => setNewRepair({...newRepair, phone: e.target.value})} placeholder="08X-XXX-XXXX" />
                        </div>
                    </div>
                </div>

                {/* Section 2: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */}
                <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Issue Details)</h3>
                    <div className="mb-4">
                        <label className="block text-sm font-bold text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type) <span className="text-red-500">*</span></label>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {['‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏õ‡∏≤', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'].map(type => (
                                <label key={type} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded transition-colors">
                                    <input type="radio" name="issueType" className="w-4 h-4 accent-orange-600" value={type} checked={newRepair.issueType === type} onChange={(e) => setNewRepair({...newRepair, issueType: e.target.value})} required />
                                    {type}
                                </label>
                            ))}
                        </div>
                        {newRepair.issueType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && (
                            <input type="text" className="mt-2 w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm transition-colors" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏ (Please specify)..." value={newRepair.issueTypeOther} onChange={e => setNewRepair({...newRepair, issueTypeOther: e.target.value})} required />
                        )}
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description) <span className="text-red-500">*</span></label>
                        <textarea className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm h-24 resize-none transition-colors" value={newRepair.issueDetails} onChange={e => setNewRepair({...newRepair, issueDetails: e.target.value})} placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..." required></textarea>
                    </div>
                </div>

                {/* Section 3: Staff Only */}
                <div className="bg-gray-50 p-5 rounded-lg border-2 border-dashed border-gray-300 relative mt-8">
                    <div className="absolute -top-3 left-4 bg-gray-50 px-2 font-bold text-gray-600 text-sm">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (For Staff Only)</div>
                    
                    <div className="space-y-4 mt-2">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: (Inspection Result)</label>
                            <div className="flex flex-wrap gap-3">
                                {['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å'].map(status => (
                                    <label key={status} className={`flex items-center gap-2 text-sm cursor-pointer border rounded-md px-3 py-2 transition-all ${newRepair.inspectionResult === status ? 'bg-white border-orange-500 shadow-sm text-orange-700 font-bold' : 'bg-white border-gray-200 hover:bg-gray-50 text-gray-600'}`}>
                                        <input type="radio" name="inspectionResult" className="w-4 h-4 accent-orange-600" value={status} checked={newRepair.inspectionResult === status} onChange={(e) => setNewRepair({...newRepair, inspectionResult: e.target.value})} />
                                        {status}
                                    </label>
                                ))}
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: (Staff Details)</label>
                            <textarea className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm h-16 resize-none transition-colors" value={newRepair.staffDetails} onChange={e => setNewRepair({...newRepair, staffDetails: e.target.value})} placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á..."></textarea>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ): (Cost in THB)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" min="0" className="flex-1 border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm transition-colors text-right" value={newRepair.cost} onChange={e => setNewRepair({...newRepair, cost: e.target.value})} placeholder="0.00" />
                                    <span className="font-bold text-gray-600">‡∏ö‡∏≤‡∏ó</span>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200 mt-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô: (Staff Signature)</label>
                                <input type="text" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm transition-colors text-center font-medium" value={newRepair.staffName} onChange={e => setNewRepair({...newRepair, staffName: e.target.value})} placeholder="(‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô/‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á : (Requester Signature)</label>
                                <input type="text" className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-orange-200 outline-none text-sm transition-colors text-center font-medium" value={newRepair.requesterSignName} onChange={e => setNewRepair({...newRepair, requesterSignName: e.target.value})} placeholder="(‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)" />
                            </div>
                        </div>
                    </div>
                </div>

                <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddRepairModal(false)}>{t('cancel')}</Button>
                    <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: View / Print Selected Repair Modal */}
      {selectedRepairView && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-[210mm] p-8 m-4 max-h-[95vh] overflow-y-auto relative">
                <button 
                    onClick={() => setSelectedRepairView(null)} 
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors"
                >
                    <X size={24} />
                </button>

                <div id="print-repair-detail-area" className="space-y-6">
                    {/* Header */}
                    <div className="text-center border-b pb-4 mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Repair Request)</h2>
                        <div className="flex justify-center gap-4 text-sm text-gray-500 mt-2">
                             <span>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: {projects.find(p => p.id === selectedRepairView.projectId)?.name}</span>
                             <span>|</span>
                             <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: {selectedRepairView.date ? new Date(selectedRepairView.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</span>
                        </div>
                    </div>

                    <div className="space-y-6 text-sm">
                        {/* 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á */}
                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á (Requester Information)</h3>
                            <div className="grid grid-cols-2 gap-y-4 gap-x-8">
                                <div className="flex items-center"><span className="w-36 text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</span><span className="font-bold font-mono text-orange-600 bg-orange-50 px-2 py-0.5 rounded">{selectedRepairView.code}</span></div>
                                <div className="flex items-center"><span className="w-36 text-gray-500">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏∏‡∏î:</span><span className="font-bold text-gray-800">{selectedRepairView.roomNo || '-'}</span></div>
                                <div className="flex items-center"><span className="w-36 text-gray-500">‡∏ä‡∏±‡πâ‡∏ô:</span><span className="text-gray-800">{selectedRepairView.floor || '-'}</span></div>
                                <div className="flex items-center"><span className="w-36 text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</span><span className="text-gray-800">{selectedRepairView.requesterName || '-'}</span></div>
                                <div className="flex items-center"><span className="w-36 text-gray-500">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</span><span className="text-gray-800">{selectedRepairView.phone || '-'}</span></div>
                            </div>
                        </div>

                        {/* 2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° */}
                        <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">2. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Issue Details)</h3>
                            <div className="space-y-4">
                                <div className="flex items-start">
                                    <span className="w-36 text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</span>
                                    <span className="font-bold text-gray-800 bg-gray-100 px-3 py-1 rounded">
                                        {selectedRepairView.issueType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏)' || selectedRepairView.issueType === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ? selectedRepairView.issueTypeOther : selectedRepairView.issueType}
                                    </span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Description):</span>
                                    <div className="p-3 bg-gray-50 rounded border border-gray-100 min-h-[80px] whitespace-pre-wrap text-gray-800">
                                        {selectedRepairView.issueDetails}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 3. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà */}
                        <div className="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                            <h3 className="font-bold text-gray-800 mb-4 border-b border-gray-300 pb-2">‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (For Staff Only)</h3>
                            <div className="space-y-4">
                                <div className="flex items-center">
                                    <span className="w-36 text-gray-500">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span>
                                    <span className={`px-3 py-1 rounded text-xs font-bold border ${
                                        selectedRepairView.inspectionResult === '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'bg-green-50 border-green-200 text-green-700' : 
                                        selectedRepairView.inspectionResult === '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' ? 'bg-yellow-50 border-yellow-200 text-yellow-700' : 
                                        selectedRepairView.inspectionResult === '‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' ? 'bg-purple-50 border-purple-200 text-purple-700' :
                                        'bg-gray-100 border-gray-300 text-gray-600'
                                    }`}>
                                        {selectedRepairView.inspectionResult}
                                    </span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-gray-500 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô:</span>
                                    <div className="p-3 bg-white rounded border border-gray-200 min-h-[60px] whitespace-pre-wrap text-gray-800">
                                        {selectedRepairView.staffDetails || '-'}
                                    </div>
                                </div>
                                <div className="flex items-center">
                                    <span className="w-36 text-gray-500">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</span>
                                    <span className="text-gray-800 font-bold">{selectedRepairView.cost ? Number(selectedRepairView.cost).toLocaleString() : '0'} ‡∏ö‡∏≤‡∏ó</span>
                                </div>
                            </div>

                            {/* Signatures */}
                            <div className="flex justify-between px-10 pt-10 pb-4 mt-6 border-t border-gray-300">
                                <div className="text-center">
                                    <div className="border-b border-gray-400 w-48 mb-2 h-8">
                                        {selectedRepairView.staffName && <span className="font-medium text-blue-800 text-base font-serif italic">{selectedRepairView.staffName}</span>}
                                    </div>
                                    <div className="text-xs text-gray-600">( {selectedRepairView.staffName || '....................................................'} )</div>
                                    <div className="text-xs font-bold text-gray-800 mt-1">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</div>
                                </div>
                                <div className="text-center">
                                    <div className="border-b border-gray-400 w-48 mb-2 h-8">
                                        {selectedRepairView.requesterSignName && <span className="font-medium text-blue-800 text-base font-serif italic">{selectedRepairView.requesterSignName}</span>}
                                    </div>
                                    <div className="text-xs text-gray-600">( {selectedRepairView.requesterSignName || '....................................................'} )</div>
                                    <div className="text-xs font-bold text-gray-800 mt-1">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡πâ‡∏≤‡∏ô/‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 flex justify-end gap-2">
                    <Button variant="secondary" onClick={() => setSelectedRepairView(null)}>{t('close')}</Button>
                    <Button icon={Printer} onClick={() => handleExportPDF('print-repair-detail-area', `Repair_${selectedRepairView.code}.pdf`, 'portrait')} disabled={isExporting}>{isExporting ? t('downloading') : '‡∏û‡∏¥‡∏°‡∏û‡πå / PDF'}</Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: Add/Edit Others Modal */}
      {showAddOtherModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 animate-fade-in">
            <div className="flex justify-between items-start mb-6 border-b pb-4">
              <div>
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <Layers className="text-orange-500" size={24}/> 
                    {newOther.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit)' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Add Other Info)'}
                </h2>
                <p className="text-sm text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</p>
              </div>
              <button onClick={() => setShowAddOtherModal(false)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
            </div>
            
            <form onSubmit={handleSaveOther} className="space-y-4">
                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Title) <span className="text-red-500">*</span></label>
                    <input 
                        type="text" 
                        required 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm transition-colors"
                        value={newOther.title}
                        onChange={e => setNewOther({...newOther, title: e.target.value})}
                        placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                    />
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Details)</label>
                    <textarea 
                        className="w-full border border-gray-300 rounded-md p-2.5 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm h-24 resize-none transition-colors"
                        value={newOther.details}
                        onChange={e => setNewOther({...newOther, details: e.target.value})}
                        placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                    ></textarea>
                </div>

                <div>
                    <label className="block text-sm font-bold text-gray-700 mb-1">‡πÅ‡∏ô‡∏ö Link (URL)</label>
                    <div className="relative">
                        <LinkIcon size={16} className="absolute left-3 top-3 text-gray-400" />
                        <input 
                            type="text" 
                            className="w-full border border-gray-300 rounded-md p-2.5 pl-9 focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none text-sm transition-colors"
                            value={newOther.link}
                            onChange={e => setNewOther({...newOther, link: e.target.value})}
                            placeholder="https://www.example.com"
                        />
                    </div>
                </div>

                <div className="flex justify-end gap-3 pt-6 border-t mt-4">
                    <Button variant="secondary" onClick={() => setShowAddOtherModal(false)}>{t('cancel')}</Button>
                    <Button type="submit" icon={Save}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</Button>
                </div>
            </form>
          </div>
        </div>
      )}

      {/* NEW: KPI Details Modal */}
      {selectedKpiDetail && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 m-4 max-h-[90vh] flex flex-col animate-fade-in relative">
            <div className="flex justify-between items-start mb-4 border-b pb-4 shrink-0">
              <div>
                  <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                      {selectedKpiDetail === 'projects' && <><Building2 className="text-blue-500" /> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</>}
                      {selectedKpiDetail === 'employees' && <><Users className="text-green-500" /> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</>}
                      {selectedKpiDetail === 'audits' && <><ClipboardCheck className="text-purple-500" /> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°</>}
                      {selectedKpiDetail === 'actionPlans' && <><Wrench className="text-orange-500" /> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô Action Plan ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</>}
                  </h2>
              </div>
              <div className="flex items-center gap-2">
                  <Button variant="outline" size="sm" icon={PrinterIcon} onClick={() => handleExportPDF('kpi-detail-print-area', `Dashboard_${selectedKpiDetail}_Details.pdf`, 'portrait')} disabled={isExporting}>
                      {isExporting ? t('downloading') : t('downloadPDF')}
                  </Button>
                  <button onClick={() => setSelectedKpiDetail(null)} className="text-gray-400 hover:text-red-500 transition-colors p-1"><X size={24} /></button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto custom-scrollbar" id="kpi-detail-print-area">
                <div className="bg-white p-2">
                    {/* Header for PDF - Hidden in UI, visible in print */}
                    <div className="text-center mb-6 hidden print:block">
                        <h2 className="text-2xl font-bold">
                            {selectedKpiDetail === 'projects' && '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                            {selectedKpiDetail === 'employees' && '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}
                            {selectedKpiDetail === 'audits' && '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Audit ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°'}
                            {selectedKpiDetail === 'actionPlans' && '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô Action Plan ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà'}
                        </h2>
                        <p className="text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {new Date().toLocaleDateString('th-TH')}</p>
                    </div>

                    {selectedKpiDetail === 'projects' && (
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-blue-50 text-blue-800">
                                <tr>
                                    <th className="p-3 border-b-2 border-blue-200 text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th className="p-3 border-b-2 border-blue-200">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th className="p-3 border-b-2 border-blue-200">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th className="p-3 border-b-2 border-blue-200">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
                                    <th className="p-3 border-b-2 border-blue-200 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {projects.map((p, idx) => (
                                    <tr key={p.id} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-3 text-center text-gray-500">{idx + 1}</td>
                                        <td className="p-3 font-medium text-gray-800">{p.name}</td>
                                        <td className="p-3 text-gray-600">{p.type === 'Condo' ? t('tab_condo') : p.type === 'Village' ? t('tab_village') : t('tab_office')}</td>
                                        <td className="p-3 text-gray-600">
                                            {p.contractEndDate}
                                            <div className="text-[10px] text-gray-400">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {calculateDaysRemaining(p.contractEndDate)} ‡∏ß‡∏±‡∏ô</div>
                                        </td>
                                        <td className="p-3 text-center"><Badge status={p.status} /></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}

                    {selectedKpiDetail === 'employees' && (
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-green-50 text-green-800">
                                <tr>
                                    <th className="p-3 border-b-2 border-green-200 text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th className="p-3 border-b-2 border-green-200">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th className="p-3 border-b-2 border-green-200">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th className="p-3 border-b-2 border-green-200">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {users.map((u, idx) => (
                                    <tr key={u.id} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-3 text-center text-gray-500">{idx + 1}</td>
                                        <td className="p-3 font-medium text-gray-800">{u.firstName} {u.lastName}</td>
                                        <td className="p-3 text-gray-600"><span className="bg-gray-100 px-2 py-1 rounded text-xs">{u.position}</span></td>
                                        <td className="p-3 font-medium text-green-700">{u.department || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}

                    {selectedKpiDetail === 'audits' && (
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-purple-50 text-purple-800">
                                <tr>
                                    <th className="p-3 border-b-2 border-purple-200 text-center w-24">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</th>
                                    <th className="p-3 border-b-2 border-purple-200">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th className="p-3 border-b-2 border-purple-200 text-center w-32">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {(() => {
                                    const rankData = projects.map(p => {
                                        const pAudits = audits.filter(a => a.projectId === p.id);
                                        const avg = pAudits.length > 0 ? (pAudits.reduce((sum, a) => sum + a.score, 0) / pAudits.length) : 0;
                                        return { name: p.name, avg };
                                    }).filter(d => d.avg > 0).sort((a, b) => b.avg - a.avg);

                                    if(rankData.length === 0) return <tr><td colSpan="3" className="p-8 text-center text-gray-500 bg-gray-50 border-dashed border-2 border-gray-200 rounded-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</td></tr>;

                                    return rankData.map((d, idx) => (
                                        <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                            <td className="p-3 text-center font-bold text-gray-600">
                                                {idx === 0 ? <span className="text-yellow-500 text-xl" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1">ü•á</span> : 
                                                 idx === 1 ? <span className="text-gray-400 text-xl" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2">ü•à</span> : 
                                                 idx === 2 ? <span className="text-amber-600 text-xl" title="‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3">ü•â</span> : 
                                                 idx + 1}
                                            </td>
                                            <td className="p-3 font-medium text-gray-800">{d.name}</td>
                                            <td className="p-3 text-center">
                                                <span className={`font-bold px-3 py-1 rounded text-xs ${d.avg >= 90 ? 'bg-green-100 text-green-700' : d.avg >= 70 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                                    {d.avg.toFixed(1)}%
                                                </span>
                                            </td>
                                        </tr>
                                    ));
                                })()}
                            </tbody>
                        </table>
                    )}

                    {selectedKpiDetail === 'actionPlans' && (
                        <table className="w-full text-sm text-left border-collapse">
                            <thead className="bg-orange-50 text-orange-800">
                                <tr>
                                    <th className="p-3 border-b-2 border-orange-200 text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th className="p-3 border-b-2 border-orange-200">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</th>
                                    <th className="p-3 border-b-2 border-orange-200">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ / ‡∏á‡∏≤‡∏ô</th>
                                    <th className="p-3 border-b-2 border-orange-200">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                                    <th className="p-3 border-b-2 border-orange-200 text-center w-32">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {(() => {
                                    const pendingAPs = actionPlans.filter(a => a.status === 'Pending' || a.status === 'In Progress');
                                    if(pendingAPs.length === 0) return <tr><td colSpan="5" className="p-8 text-center text-gray-500 bg-gray-50 border-dashed border-2 border-gray-200 rounded-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô Action Plan ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</td></tr>;

                                    return pendingAPs.map((ap, idx) => {
                                        const proj = projects.find(p => p.id === ap.projectId);
                                        return (
                                            <tr key={ap.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="p-3 text-center text-gray-500">{idx + 1}</td>
                                                <td className="p-3 font-medium text-orange-700">{proj ? proj.name : '-'}</td>
                                                <td className="p-3 text-gray-800 font-medium">{ap.issue}</td>
                                                <td className="p-3 text-gray-600 flex items-center gap-1"><User size={14} className="text-gray-400"/> {ap.responsible || '-'}</td>
                                                <td className="p-3 text-center">
                                                    <span className={`px-2 py-1 rounded-md text-xs font-bold border inline-block w-full text-center ${ap.status === 'In Progress' ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                                                        {ap.status === 'In Progress' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}
                                                    </span>
                                                </td>
                                            </tr>
                                        );
                                    });
                                })()}
                            </tbody>
                        </table>
                    )}
                </div>
            </div>
          </div>
        </div>
      )}

      {/* NEW: PM Tasks Full List Modal */}
      {selectedDateTasks && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md p-6 m-4 max-h-[90vh] flex flex-col animate-fade-in">
                <div className="flex justify-between items-center mb-4 border-b pb-4 shrink-0">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <Calendar size={24} className="text-purple-600"/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PM ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h2>
                        <p className="text-sm text-gray-500 mt-1">
                            ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {selectedDateTasks.dateObj.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}
                        </p>
                    </div>
                    <button onClick={() => setSelectedDateTasks(null)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
                </div>
                
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                    {selectedDateTasks.tasks.map(task => {
                        const machine = machines.find(m => m.id === task.machineId);
                        const historyRecord = pmHistoryList.find(h => h.pmPlanId === task.id && h.date === selectedDateTasks.dateString);
                        
                        let itemClass = '';
                        let statusIcon = null;
                        let statusLabel = '';

                        if (historyRecord) {
                            if (historyRecord.approvalStatus === 'Approved') {
                                itemClass = 'bg-green-50 border-green-500 text-green-800 hover:bg-green-100 border-l-4';
                                statusIcon = <CheckCircle size={20} className="text-green-600" />;
                                statusLabel = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
                            } else if (historyRecord.approvalStatus === 'Pending Chief' || historyRecord.approvalStatus === 'Pending Manager') {
                                itemClass = 'bg-yellow-50 border-yellow-500 text-yellow-900 hover:bg-yellow-100 border-l-4';
                                statusIcon = <Clock size={20} className="text-yellow-600" />;
                                statusLabel = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                            } else {
                                itemClass = 'bg-blue-50 border-blue-500 text-blue-800 hover:bg-blue-100 border-l-4';
                                statusIcon = <CheckSquare size={20} className="text-blue-600" />;
                                statusLabel = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                            }
                        } else {
                            itemClass = 'bg-white border-gray-300 border-dashed text-gray-700 hover:bg-gray-50 hover:border-solid hover:border-gray-400';
                            statusIcon = <Square size={20} className="text-gray-400" />;
                            statusLabel = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•';
                        }

                        return (
                            <div 
                                key={task.id}
                                onClick={() => {
                                    handleOpenPmForm(task, machine, selectedDateTasks.dateString);
                                    setSelectedDateTasks(null); // ‡∏õ‡∏¥‡∏î modal ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°
                                }}
                                className={`p-3 border rounded-lg cursor-pointer transition-colors flex items-center justify-between group shadow-sm ${itemClass}`}
                            >
                                <div>
                                    <div className="font-bold text-sm flex items-center gap-2">
                                        <span className="truncate">{machine?.name || 'Unknown'}</span>
                                    </div>
                                    <div className="text-xs font-mono mt-0.5 flex items-center gap-1 opacity-70">
                                        <Settings size={12} /> {machine?.code || '-'}
                                    </div>
                                </div>
                                <div className="flex flex-col items-center opacity-80 group-hover:opacity-100 transition-opacity shrink-0">
                                    {statusIcon}
                                    <span className="text-[10px] mt-1 font-bold">{statusLabel}</span>
                                </div>
                            </div>
                        );
                    })}
                </div>
                
                <div className="mt-4 pt-4 border-t border-gray-200 flex justify-end shrink-0">
                    <Button variant="secondary" onClick={() => setSelectedDateTasks(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

      {/* NEW: PM Dashboard Detail Modal */}
      {selectedPmStatusDetail && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] overflow-y-auto">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 m-4 max-h-[90vh] flex flex-col animate-fade-in">
                <div className="flex justify-between items-center mb-4 border-b pb-4 shrink-0">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm ${
                            selectedPmStatusDetail.status === 'Not Started' ? 'bg-orange-500' :
                            selectedPmStatusDetail.status === 'Pending Approval' ? 'bg-blue-500' :
                            selectedPmStatusDetail.status === 'Approved' ? 'bg-green-500' : 'bg-red-500'
                        }`}>
                            <List size={20} />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {selectedPmStatusDetail.label}
                            </h2>
                            <p className="text-sm text-gray-500 mt-1">
                                ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: {new Date(pmMonth + '-01').toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })} 
                                <span className="ml-2 font-bold text-gray-700">({selectedPmStatusDetail.tasks.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                            </p>
                        </div>
                    </div>
                    <button onClick={() => setSelectedPmStatusDetail(null)} className="text-gray-400 hover:text-red-500 transition-colors"><X size={24} /></button>
                </div>

                <div className="flex-1 overflow-y-auto custom-scrollbar">
                    {selectedPmStatusDetail.tasks.length > 0 ? (
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-600 sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th className="p-3 border-b text-center w-12">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                    <th className="p-3 border-b w-28">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                                    <th className="p-3 border-b">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ / ‡∏£‡∏∞‡∏ö‡∏ö</th>
                                    <th className="p-3 border-b text-center w-32">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</th>
                                    <th className="p-3 border-b text-center w-28">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {selectedPmStatusDetail.tasks.sort((a,b) => new Date(a.dateString) - new Date(b.dateString)).map((task, idx) => {
                                    const { dateString, dateObj, machine, plan, historyRecord } = task;
                                    const isPastDue = new Date(dateString) < new Date(new Date().setHours(0,0,0,0)) && !historyRecord;

                                    return (
                                        <tr key={`${plan.id}-${dateString}`} className={`hover:bg-gray-50 transition-colors ${isPastDue ? 'bg-red-50/30' : ''}`}>
                                            <td className="p-3 text-center text-gray-500">{idx + 1}</td>
                                            <td className="p-3">
                                                <div className={`font-medium ${isPastDue ? 'text-red-600 font-bold' : 'text-gray-800'}`}>
                                                    {dateObj.toLocaleDateString('th-TH', { day: '2-digit', month: 'short' })}
                                                </div>
                                                {isPastDue && <div className="text-[10px] text-red-500 flex items-center gap-1 mt-0.5"><AlertTriangle size={10}/> ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>}
                                            </td>
                                            <td className="p-3">
                                                <div className="font-bold text-gray-800">{machine?.name || 'Unknown'}</div>
                                                <div className="text-xs text-gray-500 font-mono mt-0.5">{machine?.code || '-'}</div>
                                                <div className="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full inline-block mt-1">{machine?.system}</div>
                                            </td>
                                            <td className="p-3 text-center">
                                                <span className="text-xs text-gray-600 bg-gray-100 border px-2 py-1 rounded">
                                                    {t(`freq_${plan.frequency}`)}
                                                </span>
                                            </td>
                                            <td className="p-3 text-center">
                                                {selectedPmStatusDetail.status === 'Not Started' ? (
                                                    <Button 
                                                        size="sm" 
                                                        className="w-full text-xs py-1.5"
                                                        onClick={() => {
                                                            handleOpenPmForm(plan, machine, dateString);
                                                            setSelectedPmStatusDetail(null); // Close modal to focus on form
                                                        }}
                                                    >
                                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
                                                    </Button>
                                                ) : (
                                                    <Button 
                                                        size="sm" 
                                                        variant="outline" 
                                                        className="w-full text-xs py-1.5 border-blue-400 text-blue-600 hover:bg-blue-50"
                                                        onClick={() => {
                                                            setSelectedPmHistory(historyRecord);
                                                        }}
                                                    >
                                                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                                                    </Button>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    ) : (
                        <div className="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏µ‡πâ</div>
                    )}
                </div>

                <div className="mt-4 pt-4 border-t border-gray-200 flex justify-end shrink-0">
                    <Button variant="secondary" onClick={() => setSelectedPmStatusDetail(null)}>{t('close')}</Button>
                </div>
            </div>
        </div>
      )}

    </div>
  );
}
